<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMIEIRA MARINA - Boat Reservation System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <?!= include('css-base'); ?>
    <?!= include('css-calendar'); ?>
    <?!= include('css-ui'); ?>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
</head>

<body class="bg-gray-100">
    <div id="loading-overlay">
        <div class="pro-spinner"></div>
        <p id="loading-message" data-translate-key="notifications.processing">Processing,
            please wait...</p>
    </div>
    <div id="notification-popup">Notification</div>
    < !-- REPLACE your existing mooringDetailsModal -->
        <div id="mooringDetailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header-gradient">
                    <h3 class="text-xl font-semibold text-gray-700" id="mooringDetailsTitle">Mooring Details</h3>
                </div><span class="close-button" onclick="closeModal('mooringDetailsModal')">×</span>
                <div id="mooringDetailsBody" class="mt-4 text-sm space-y-2">
                    < !-- Content will be populated by JS -->
                </div>
                <div class="mt-6 flex justify-end space-x-3 pt-4 border-t"><button id="mooringDetailsDeleteBtn"
                        class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-md shadow-md flex items-center transition-transform hover:scale-105"><i
                            data-lucide="trash-2" class="mr-2 h-4 w-4"></i>Delete</button><button
                        id="mooringDetailsEditBtn"
                        class="px-4 py-2 btn-gradient-blue text-white font-semibold rounded-md shadow-md flex items-center transition-transform hover:scale-105"><i
                            data-lucide="edit" class="mr-2 h-4 w-4"></i>Edit</button></div>
            </div>
        </div>
        < !-- Mooring Form Modal -->
            <div id="mooringFormModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header-gradient">
                        <h3 class="text-xl font-semibold text-gray-700" id="mooringFormTitle">Add New Mooring</h3>
                    </div><span class="close-button" onclick="closeModal('mooringFormModal')">×</span>
                    <form id="mooringForm" class="space-y-2 mt-2"><input type="hidden" id="mooringFormMode"
                            name="mooringFormMode" value="add"><input type="hidden" id="originalMooringId"
                            name="originalMooringId"><input type="hidden" id="mooringRecordedBy" name="recordedBy">
                        <fieldset>
                            <legend>Client & Boat</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                <div><label for="mooringClientName"
                                        class="block text-sm font-medium text-gray-700">Client Name</label><input
                                        type="text" id="mooringClientName" name="clientName" required class="input">
                                </div>
                                <div><label for="mooringBoatName" class="block text-sm font-medium text-gray-700">Boat
                                        Name</label><input type="text" id="mooringBoatName" name="boatName" required
                                        class="input"></div>
                                <div><label for="mooringClientPhone"
                                        class="block text-sm font-medium text-gray-700">Client Phone</label><input
                                        type="tel" id="mooringClientPhone" name="clientPhone" class="input"></div>
                                <div><label for="mooringClientEmail"
                                        class="block text-sm font-medium text-gray-700">Client Email</label><input
                                        type="email" id="mooringClientEmail" name="clientEmail" class="input"></div>
                            </div>
                        </fieldset>
                        <fieldset>
                            <legend>Mooring Details</legend>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                                <div><label for="mooringPlace" class="block text-sm font-medium text-gray-700">Place
                                        (e.g.,
                                        A.46)</label><input type="text" id="mooringPlace" name="place" required
                                        class="input"></div>
                                < !-- *** CHANGE: Replaced number input with a select dropdown *** -->
                                    <div> <label for="mooringBoatLength"
                                            class="block text-sm font-medium text-gray-700">Boat Class</label> <select
                                            id="mooringBoatLength" name="boatLength" class="input">
                                            <option value="Classe 1">Classe 1</option>
                                            <option value="Classe 2">Classe 2</option>
                                            <option value="Classe 3">Classe 3</option>
                                            <option value="Classe 4">Classe 4</option>
                                        </select> </div>
                                    <div><label for="mooringValue" class="block text-sm font-medium text-gray-700">Value
                                            (€)</label><input type="number" id="mooringValue" name="value" step="0.01"
                                            class="input"></div>
                                    <div><label for="mooringPaymentStatus"
                                            class="block text-sm font-medium text-gray-700">Payment
                                            Status</label><select id="mooringPaymentStatus" name="paymentStatus"
                                            required class="input">
                                            <option value="Paid">Paid</option>
                                            <option value="Due">Due</option>
                                            <option value="Overdue">Overdue</option>
                                        </select></div>
                                    <div><label for="mooringInsurancePaid"
                                            class="block text-sm font-medium text-gray-700">Insurance
                                            Paid</label><select id="mooringInsurancePaid" name="insurancePaid" required
                                            class="input">
                                            <option value="Yes">Yes</option>
                                            <option value="No">No</option>
                                        </select></div>
                                    <div><label for="mooringNextPaymentDate"
                                            class="block text-sm font-medium text-gray-700">Next Payment
                                            Date</label><input type="date" id="mooringNextPaymentDate"
                                            name="nextPaymentDate" required class="input"></div>
                            </div>
                        </fieldset>
                        <div><label for="mooringNotes"
                                class="block text-sm font-medium text-gray-700">Notes</label><textarea id="mooringNotes"
                                name="notes" rows="2" class="input"></textarea></div>
                        <div class="flex justify-end space-x-3 pt-4"> <button type="button"
                                onclick="closeModal('mooringFormModal')"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md">Cancel</button>
                            <button type="submit" id="mooringFormSubmitBtn"
                                class="px-4 py-2 btn-gradient-blue text-white font-semibold rounded-md shadow-md">Save
                                Mooring</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="reservationDetailsModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header-gradient">
                        <h3 class="text-xl font-semibold text-gray-700" id="modalTitle"
                            data-translate-key="reservationDetailsModal.title">Reservation Details</h3>
                    </div> <span class="close-button no-print" onclick="closeModal('reservationDetailsModal')">×</span>
                    <div id="modalBody" class="text-sm space-y-2">
                        <p data-translate-key="reservationDetailsModal.loading">Loading details...</p>
                    </div>
                    <div class="mt-6 flex justify-end no-print"> <button onclick="closeModal('reservationDetailsModal')"
                            class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md transition-colors"
                            data-translate-key="buttons.close">Close</button> </div>
                </div>
            </div>
            < !-- NEW: Modal for Travel Booking Details -->
                <div id="travelDetailsModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header-gradient">
                            <h3 class="text-xl font-semibold text-gray-700" id="travelModalTitle"
                                data-translate-key="dailyTravels.details.title">Travel Booking Details</h3>
                        </div> <span class="close-button no-print" onclick="closeModal('travelDetailsModal')">×</span>
                        <div id="travelModalBody" class="text-sm space-y-2 mt-4">
                            <p data-translate-key="reservationDetailsModal.loading">Loading details...</p>
                        </div>
                        <div class="mt-6 flex justify-end no-print"> <button onclick="closeModal('travelDetailsModal')"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md transition-colors"
                                data-translate-key="buttons.close">Close</button> </div>
                    </div>
                </div>
                <div id="invoiceModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header-gradient no-print">
                            <h3 class="text-xl font-semibold text-gray-700" data-translate-key="invoiceModal.title">
                                Invoice Preview </h3>
                        </div> <span class="close-button no-print" onclick="closeModal('invoiceModal')">×</span>
                        <div id="invoiceDisplayContainer">
                            <div id="invoiceDisplayContent">
                                <div id="invoiceHeaderDisplay" class="mb-6 pb-4 border-b-2 border-gray-700">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h2 class="text-2xl font-bold text-gray-800"
                                                data-translate-key="invoice.header"> BREAKDOWN</h2>
                                            <p class="text-gray-600">AMIEIRA MARINA</p>
                                        </div>
                                    </div>
                                    <div class="mt-4 text-sm">
                                        <p><strong data-translate-key="invoice.dateIssuedLabel">Date Issued:</strong>
                                            <span id="invoiceDateIssuedDisplay"></span>
                                        </p>
                                    </div>
                                </div>
                                <div id="invoiceClientDetailsDisplay" class="mb-6 text-sm">
                                    <p class="font-semibold text-gray-700" id="invoiceClientNameDisplay"></p>
                                    <p id="invoiceClientEmailDisplay" class="text-gray-600"></p>
                                </div>
                                <div id="invoiceBookingDatesDisplay" class="mb-4 text-sm">
                                    <p><strong data-translate-key="invoice_check_in_datetime_label">Check-in:</strong>
                                        <span id="invoiceCheckInDisplay"></span>
                                    </p>
                                    <p><strong data-translate-key="invoice_check_out_datetime_label">Check-out:</strong>
                                        <span id="invoiceCheckOutDisplay"></span>
                                    </p>
                                </div>
                                <div class="mb-3">
                                    <table class="w-full border-collapse items-table">
                                        <thead>
                                            <tr>
                                                <th class="text-left" data-translate-key="invoice.table.description">
                                                    Description </th>
                                                <th class="text-center" data-translate-key="invoice.table.quantity">
                                                    Quantity/Nights </th>
                                                <th class="text-right" data-translate-key="invoice.table.unitPrice">Unit
                                                    Price (€) </th>
                                                <th class="text-right" data-translate-key="invoice.table.total">Total
                                                    (€)</th>
                                            </tr>
                                        </thead>
                                        <tbody id="invoiceItemsBodyDisplay"></tbody>
                                    </table>
                                </div>
                                <div id="invoicePaymentsMadeSection" class="mb-4" style="display: none;">
                                    <h4 data-translate-key="invoice_payments_made">Payments Made:</h4>
                                    <table id="invoicePaymentsTableDisplay" class="w-full border-collapse items-table">
                                        <thead>
                                            <tr>
                                                <th class="text-left" data-translate-key="payments_date">Date</th>
                                                <th class="text-left" data-translate-key="payments_method">Method</th>
                                                <th class="text-right" data-translate-key="payments_amount">Amount (€)
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="invoicePaymentsBodyDisplay"></tbody>
                                    </table>
                                </div>
                                <div id="invoiceTotalsDisplay" class="text-sm">
                                    <div class="grid grid-cols-2 gap-x-4">
                                        <div></div>
                                        <div class="space-y-1">
                                            <p class="flex justify-between"><span
                                                    data-translate-key="invoice.subtotalBoatExtras">Subtotal (Boat +
                                                    Extras):</span> <span id="invoiceSubtotalDisplay">€0.00</span> </p>
                                            <p class="flex justify-between"><span
                                                    data-translate-key="invoice.taxApplied">Tax Applied:</span> <span
                                                    id="invoiceTaxAmountDisplay">€0.00</span></p>
                                            <p class="flex justify-between"><span
                                                    data-translate-key="invoice.totalBeforeDiscount">Total Before
                                                    Discount:</span> <span
                                                    id="invoiceTotalBeforeDiscountDisplay">€0.00</span> </p>
                                            <p id="invoiceDiscountLine" class="flex justify-between"
                                                style="display: none;"><span
                                                    data-translate-key="invoice.discount">Discount:</span> <span
                                                    id="invoiceDiscountAmountDisplay">-€0.00</span></p>
                                            <p class="flex justify-between font-semibold"><span
                                                    data-translate-key="newReservation.summaryTotalCost">Total
                                                    Cost:</span> <span id="invoiceTotalCostDisplay">€0.00</span></p>
                                            <p class="flex justify-between font-semibold"><span
                                                    data-translate-key="payments_total_paid">Total Paid:</span> <span
                                                    id="invoiceTotalPaidDisplay">€0.00</span></p>
                                            <hr class="my-1 border-gray-400">
                                            <p class="flex justify-between font-bold text-lg"><span
                                                    data-translate-key="invoice.totalDue">TOTAL DUE:</span> <span
                                                    id="invoiceGrandTotalDisplay" class="amount-due">€0.00</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3 no-print p-4 border-t border-gray-200"> <button
                                id="downloadPdfButton"
                                class="px-4 py-2 btn-gradient-green text-white font-semibold rounded-md shadow-md flex items-center transition-transform hover:scale-105"><i
                                    data-lucide="download" class="mr-2 h-4 w-4"></i> <span
                                    data-translate-key="buttons.downloadPdf">Download PDF</span></button> <button
                                onclick="closeModal('invoiceModal')"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md transition-colors"
                                data-translate-key="buttons.close">Close</button> </div>
                    </div>
                </div>
                <div id="travelInvoiceModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header-gradient no-print">
                            <h3 class="text-xl font-semibold text-gray-700"
                                data-translate-key="dailyTravels.invoice.title">Travel Breakdown</h3>
                        </div> <span class="close-button no-print" onclick="closeModal('travelInvoiceModal')">×</span>
                        <div id="travelInvoiceDisplayContainer">
                            <div id="travelInvoiceDisplayContent">
                                <div id="travelInvoiceHeaderDisplay" class="mb-6 pb-4 border-b-2 border-gray-700">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <h2 class="text-2xl font-bold text-gray-800"
                                                data-translate-key="dailyTravels.invoice.title">Travel Breakdown</h2>
                                            <p class="text-gray-600">AMIEIRA MARINA</p>
                                        </div>
                                    </div>
                                    <div class="mt-4 text-sm">
                                        <p><strong data-translate-key="dailyTravels.invoice.travelId">Travel
                                                ID:</strong> <span id="travelInvoiceIdDisplay"></span></p>
                                        <p><strong data-translate-key="invoice.dateIssuedLabel">Date Issued:</strong>
                                            <span id="travelInvoiceDateIssuedDisplay"></span>
                                        </p>
                                    </div>
                                </div>
                                <div id="travelInvoiceClientDetailsDisplay" class="mb-6 text-sm">
                                    <p class="font-semibold text-gray-700" id="travelInvoiceClientNameDisplay"></p>
                                    <p><strong data-translate-key="dailyTravels.list.date">Date:</strong> <span
                                            id="travelInvoiceDateTimeDisplay"></span></p>
                                </div>
                                <div class="mb-3">
                                    <table class="w-full border-collapse items-table">
                                        <thead>
                                            <tr>
                                                <th class="text-left" data-translate-key="invoice.table.description">
                                                    Description </th>
                                                <th class="text-right" data-translate-key="invoice.table.total">Cost (€)
                                                </th>
                                            </tr>
                                        </thead>
                                        <tbody id="travelInvoiceItemsBodyDisplay"></tbody>
                                    </table>
                                </div>
                                <div id="travelInvoiceTotalsDisplay" class="text-sm">
                                    <div class="grid grid-cols-2 gap-x-4">
                                        <div></div>
                                        <div class="space-y-1">
                                            <p class="flex justify-between"><span
                                                    data-translate-key="dailyTravels.summary.subtotal">Subtotal:</span>
                                                <span id="travelInvoiceSubtotalDisplay">€0.00</span>
                                            </p>
                                            <p id="travelInvoiceDiscountLine" class="flex justify-between"
                                                style="display: none;"> <span
                                                    data-translate-key="invoice.discount">Discount:</span> <span
                                                    id="travelInvoiceDiscountAmountDisplay">-€0.00</span> </p>
                                            <p id="travelInvoiceTaxLine" class="flex justify-between"
                                                style="display: none;"><span
                                                    data-translate-key="dailyTravels.invoice.tax">Tax:</span> <span
                                                    id="travelInvoiceTaxAmountDisplay">€0.00</span></p>
                                            <hr class="my-1 border-gray-400">
                                            <p class="flex justify-between font-semibold"><span
                                                    data-translate-key="newReservation.summaryTotalCost">Total
                                                    Cost:</span> <span id="travelInvoiceTotalCostDisplay">€0.00</span>
                                            </p>
                                            <p class="flex justify-between font-semibold"><span
                                                    data-translate-key="payments_total_paid">Total Paid:</span> <span
                                                    id="travelInvoiceTotalPaidDisplay">€0.00</span></p>
                                            <hr class="my-1 border-gray-400">
                                            <p class="flex justify-between font-bold text-lg"><span
                                                    data-translate-key="invoice.totalDue">TOTAL DUE:</span> <span
                                                    id="travelInvoiceGrandTotalDisplay" class="amount-due">€0.00</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end space-x-3 no-print p-4 border-t border-gray-200"> <button
                                id="downloadTravelPdfButton"
                                class="px-4 py-2 btn-gradient-green text-white font-semibold rounded-md shadow-md flex items-center transition-transform hover:scale-105"><i
                                    data-lucide="download" class="mr-2 h-4 w-4"></i> <span
                                    data-translate-key="buttons.downloadPdf">Download PDF</span></button> <button
                                onclick="closeModal('travelInvoiceModal')"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md transition-colors"
                                data-translate-key="buttons.close">Close</button> </div>
                    </div>
                </div>
                <div id="boatModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header-gradient">
                            <h3 class="text-xl font-semibold text-gray-700" id="boatModalTitle"
                                data-translate-key="boatModal.titleAdd">Add New Boat</h3>
                        </div> <span class="close-button" onclick="closeModal('boatModal')">×</span>
                        <form id="boatForm" class="space-y-4 mt-2"> <input type="hidden" id="boatFormMode"
                                name="boatFormMode" value="add"> <input type="hidden" id="originalBoatUniqueId"
                                name="originalUniqueId">
                            <div> <label for="boatUniqueId" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="boatModal.idLabel">Unique ID</label> <input type="text"
                                    id="boatUniqueId" name="uniqueId" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div> <label for="boatName" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="boatModal.nameLabel">Boat Name</label> <input type="text"
                                    id="boatName" name="name" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div> <label for="boatModel" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="boatModal.modelLabel">Boat Model</label> <input type="text"
                                    id="boatModel" name="model" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div class="flex justify-end space-x-3 pt-4"> <button type="button"
                                    onclick="closeModal('boatModal') ; document.getElementById('boatForm').reset();"
                                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md transition-colors"
                                    data-translate-key="buttons.cancel">Cancel</button> <button type="submit"
                                    id="boatFormSubmitBtn"
                                    class="px-4 py-2 btn-gradient-blue text-white font-semibold rounded-md shadow-md transition-transform hover:scale-105"
                                    data-translate-key="buttons.addBoat">Add Boat</button> </div>
                        </form>
                    </div>
                </div>
                <div id="tariffPriceModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header-gradient">
                            <h3 class="text-xl font-semibold mb-4 text-gray-700" id="tariffPriceModalTitle"
                                data-translate-key="tariffModal.titleAdd">Add New Tariff/Price</h3>
                        </div> <span class="close-button" onclick="closeModal('tariffPriceModal')">×</span>
                        <form id="tariffPriceForm" class="space-y-4 mt-2"> <input type="hidden" id="tariffPriceFormMode"
                                name="tariffPriceFormMode" value="add"> <input type="hidden"
                                id="originalTariffBoatModel" name="originalBoatModel"> <input type="hidden"
                                id="originalTariffName" name="originalTariffName">
                            <div> <label for="tariffName" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="tariffModal.nameLabel">Tariff Name</label> <input type="text"
                                    id="tariffName" name="tariffName" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div> <label for="tariffStartDate" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="tariffModal.startDateLabel">Start Date (YYYY-MM-DD)</label>
                                <input type="date" id="tariffStartDate" name="startDate" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div> <label for="tariffEndDate" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="tariffModal.endDateLabel">End Date (YYYY-MM-DD)</label> <input
                                    type="date" id="tariffEndDate" name="endDate" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div> <label for="tariffBoatModel" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="tariffModal.boatModelLabel">Boat Model</label> <input
                                    type="text" id="tariffBoatModel" name="boatModel" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                    data-translate-key="tariffModal.boatModelPlaceholder"
                                    data-translate-type="placeholder" placeholder="Match existing boat model"> </div>
                            <div> <label for="tariffRateNormal" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="tariffModal.priceNormalLabel">Price Normal Night</label> <input
                                    type="number" id="tariffRateNormal" name="rateNormalNight" step="0.01" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div> <label for="tariffRateWeekend" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="tariffModal.priceWeekendLabel">Price Weekend Night</label>
                                <input type="number" id="tariffRateWeekend" name="rateWeekendNight" step="0.01" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div class="flex justify-end space-x-3 pt-4"> <button type="button"
                                    onclick="closeModal('tariffPriceModal') ; document.getElementById('tariffPriceForm').reset();"
                                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md transition-colors"
                                    data-translate-key="buttons.cancel">Cancel</button> <button type="submit"
                                    id="tariffPriceFormSubmitBtn"
                                    class="px-4 py-2 btn-gradient-blue text-white font-semibold rounded-md shadow-md transition-transform hover:scale-105"
                                    data-translate-key="buttons.addTariff">Add Tariff/Price</button> </div>
                        </form>
                    </div>
                </div>
                <div id="extraModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header-gradient">
                            <h3 class="text-xl font-semibold text-gray-700" id="extraModalTitle"
                                data-translate-key="extraModal.titleAdd">Add New Extra</h3>
                        </div> <span class="close-button" onclick="closeModal('extraModal')">×</span>
                        <form id="extraForm" class="space-y-4 mt-2"> <input type="hidden" id="extraFormMode"
                                name="extraFormMode" value="add"> <input type="hidden" id="originalExtraName"
                                name="originalName">
                            <div> <label for="extraName" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="extraModal.nameLabel">Extra Name</label> <input type="text"
                                    id="extraName" name="name" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div> <label for="extraPrice" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="extraModal.priceLabel">Price</label> <input type="number"
                                    id="extraPrice" name="price" step="0.01" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            </div>
                            <div> <label for="extraUnit" class="block text-sm font-medium text-gray-700"
                                    data-translate-key="extraModal.unitLabel">Unit</label> <select id="extraUnit"
                                    name="unit" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="per day" data-translate-key="extraModal.unitPerDay">per day</option>
                                    <option value="per booking" data-translate-key="extraModal.unitPerBooking">per
                                        booking</option>
                                </select> </div>
                            <div class="flex justify-end space-x-3 pt-4"> <button type="button"
                                    onclick="closeModal('extraModal') ; document.getElementById('extraForm').reset();"
                                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md transition-colors"
                                    data-translate-key="buttons.cancel">Cancel</button> <button type="submit"
                                    id="extraFormSubmitBtn"
                                    class="px-4 py-2 btn-gradient-blue text-white font-semibold rounded-md shadow-md transition-transform hover:scale-105"
                                    data-translate-key="buttons.addExtra">Add Extra</button> </div>
                        </form>
                    </div>
                </div>
                <div id="paymentManagementModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header-gradient">
                            <h3 class="text-xl font-semibold text-gray-700" id="paymentModalTitle"
                                data-translate-key="payments_modal_title">Manage Payments</h3>
                        </div> <span class="close-button no-print"
                            onclick="closeModal('paymentManagementModal')">×</span> <input type="hidden"
                            id="paymentBookingId"> <input type="hidden" id="paymentBookingType">
                        <div class="mt-2 space-y-4">
                            <div class="payment-summary-grid">
                                <div class="payment-summary-item">
                                    <p class="label" data-translate-key="payments_total_cost">Total Cost:</p>
                                    <p class="value" id="paymentModalTotalCost">€0.00</p>
                                </div>
                                <div class="payment-summary-item">
                                    <p class="label" data-translate-key="payments_total_paid">Total Paid:</p>
                                    <p class="value paid" id="paymentModalTotalPaid">€0.00</p>
                                </div>
                                <div class="payment-summary-item">
                                    <p class="label" data-translate-key="payments_amount_due">Amount Due:</p>
                                    <p class="value due" id="paymentModalAmountDue">€0.00</p>
                                </div>
                            </div>
                            <hr>
                            <h4 class="text-lg font-medium text-gray-700" data-translate-key="payments_add_new">Add New
                                Payment</h4>
                            <form id="addPaymentForm" class="space-y-3">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div> <label for="paymentDate" class="block text-sm font-medium text-gray-700"
                                            data-translate-key="payments_date">Date</label> <input type="date"
                                            id="paymentDate" name="paymentDate" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div> <label for="paymentAmount" class="block text-sm font-medium text-gray-700"
                                            data-translate-key="payments_amount">Amount (€)</label> <input type="number"
                                            id="paymentAmount" name="paymentAmount" step="0.01" min="0.01" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                </div>
                                <div> <label for="paymentMethod" class="block text-sm font-medium text-gray-700"
                                        data-translate-key="payments_method">Method</label> <select id="paymentMethod"
                                        name="paymentMethod" required
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                        <option value="" data-translate-key="payments_method_select">Select Method...
                                        </option>
                                        <option value="Cash" data-translate-key="payments_method_cash">Cash</option>
                                        <option value="Card" data-translate-key="payments_method_card">Card</option>
                                        <option value="Bank Transfer" data-translate-key="payments_method_transfer">Bank
                                            Transfer </option>
                                        <option value="Other" data-translate-key="payments_method_other">Other</option>
                                    </select> </div>
                                <div> <label for="paymentNotes" class="block text-sm font-medium text-gray-700"
                                        data-translate-key="payments_notes">Notes</label> <textarea id="paymentNotes"
                                        name="paymentNotes" rows="2"
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                                </div>
                                <div class="flex justify-end"> <button type="submit"
                                        class="px-4 py-2 btn-gradient-green text-white font-semibold rounded-md shadow-md flex items-center transition-transform hover:scale-105"><i
                                            data-lucide="plus-circle" class="mr-2 h-4 w-4"></i> <span
                                            data-translate-key="buttons.addPayment">Add Payment</span></button> </div>
                            </form>
                            <hr>
                            <h4 class="text-lg font-medium text-gray-700" data-translate-key="payments_history">Payment
                                History</h4>
                            <div class="overflow-x-auto max-h-60">
                                <table id="paymentHistoryTable" class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                data-translate-key="payments_date">Date</th>
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                data-translate-key="payments_amount">Amount</th>
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                data-translate-key="payments_method">Method</th>
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                data-translate-key="payments_notes">Notes</th>
                                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                data-translate-key="viewReservations.table.actions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentHistoryTableBody" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="5" class="text-center py-3 text-gray-500"
                                                data-translate-key="payments_no_payments_recorded">No payments recorded
                                                yet.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end no-print"> <button
                                onclick="closeModal('paymentManagementModal')"
                                class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md transition-colors"
                                data-translate-key="buttons.close">Close</button> </div>
                    </div>
                </div>
                < !-- NEW MODAL FOR TRIPS -->
                    <div id="tripModal" class="modal">
                        <div class="modal-content">
                            <div class="modal-header-gradient">
                                <h3 class="text-xl font-semibold text-gray-700" id="tripModalTitle"
                                    data-translate-key="manageTrips.modal.titleAdd">Add New Trip</h3>
                            </div> <span class="close-button" onclick="closeModal('tripModal')">×</span>
                            <form id="tripForm" class="space-y-4 mt-2"> <input type="hidden" id="tripFormMode"
                                    name="tripFormMode" value="add"> <input type="hidden" id="originalTripName"
                                    name="originalTripName">
                                <div> <label for="tripName" class="block text-sm font-medium text-gray-700"
                                        data-translate-key="manageTrips.modal.name">Trip Name</label> <input type="text"
                                        id="tripName" name="tripName" required
                                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div> <label for="tripPriceAdult" class="block text-sm font-medium text-gray-700"
                                            data-translate-key="manageTrips.modal.priceAdult">Price/Adult</label> <input
                                            type="number" id="tripPriceAdult" name="pricePerAdult" step="0.01" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div> <label for="tripPriceKid" class="block text-sm font-medium text-gray-700"
                                            data-translate-key="manageTrips.modal.priceKid">Price/Kid</label> <input
                                            type="number" id="tripPriceKid" name="pricePerKid" step="0.01" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div> <label for="tripPriceSenior" class="block text-sm font-medium text-gray-700"
                                            data-translate-key="manageTrips.modal.priceSenior">Price/Senior</label>
                                        <input type="number" id="tripPriceSenior" name="pricePerSenior" step="0.01"
                                            required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div> <label for="tripDuration" class="block text-sm font-medium text-gray-700"
                                            data-translate-key="manageTrips.modal.duration">Duration (hours)</label>
                                        <input type="number" id="tripDuration" name="duration" step="0.1" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                </div>
                                <div class="flex justify-end space-x-3 pt-4"> <button type="button"
                                        onclick="closeModal('tripModal'); document.getElementById('tripForm').reset();"
                                        class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md transition-colors"
                                        data-translate-key="buttons.cancel">Cancel</button> <button type="submit"
                                        id="tripFormSubmitBtn"
                                        class="px-4 py-2 btn-gradient-blue text-white font-semibold rounded-md shadow-md transition-transform hover:scale-105"
                                        data-translate-key="buttons.addTrip">Add Trip</button> </div>
                            </form>
                        </div>
                    </div>
                    < !-- NEW MODAL FOR FOOD -->
                        <div id="foodModal" class="modal">
                            <div class="modal-content">
                                <div class="modal-header-gradient">
                                    <h3 class="text-xl font-semibold text-gray-700" id="foodModalTitle"
                                        data-translate-key="manageFood.modal.titleAdd">Add New Food Option</h3>
                                </div> <span class="close-button" onclick="closeModal('foodModal')">×</span>
                                <form id="foodForm" class="space-y-4 mt-2"> <input type="hidden" id="foodFormMode"
                                        name="foodFormMode" value="add"> <input type="hidden" id="originalFoodName"
                                        name="originalFoodName">
                                    <div> <label for="foodOptionName" class="block text-sm font-medium text-gray-700"
                                            data-translate-key="manageFood.modal.name">Option Name</label> <input
                                            type="text" id="foodOptionName" name="optionName" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div> <label for="foodPrice" class="block text-sm font-medium text-gray-700"
                                            data-translate-key="manageFood.modal.price">Price</label> <input
                                            type="number" id="foodPrice" name="price" step="0.01" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    </div>
                                    <div> <label for="foodDescription" class="block text-sm font-medium text-gray-700"
                                            data-translate-key="manageFood.modal.description">Description</label>
                                        <textarea id="foodDescription" name="description" rows="3"
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                                    </div>
                                    <div class="flex justify-end space-x-3 pt-4"> <button type="button"
                                            onclick="closeModal('foodModal'); document.getElementById('foodForm').reset();"
                                            class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-md transition-colors"
                                            data-translate-key="buttons.cancel">Cancel</button> <button type="submit"
                                            id="foodFormSubmitBtn"
                                            class="px-4 py-2 btn-gradient-blue text-white font-semibold rounded-md shadow-md transition-transform hover:scale-105"
                                            data-translate-key="buttons.addFood">Add Food Option</button> </div>
                                </form>
                            </div>
                        </div>
                        < !-- Custom Confirmation Modal -->
                            <div id="customConfirmModal" class="modal">
                                <div class="modal-content" style="max-width: 500px;">
                                    <div id="confirmModalHeader" class="modal-header-gradient">
                                        <h3 class="text-xl font-semibold text-gray-800 flex items-center"> <i
                                                data-lucide="alert-circle" class="h-6 w-6 mr-2 text-amber-600"></i>
                                            <span id="confirmModalTitle">Confirm Action</span>
                                        </h3>
                                    </div> <span class="close-button no-print" onclick="closeCustomConfirm()">×</span>
                                    <div class="mt-4">
                                        < !-- Icon and main message -->
                                            <div class="flex items-start gap-4 mb-4">
                                                <div id="confirmModalIcon"
                                                    class="flex-shrink-0 w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center">
                                                    <i data-lucide="help-circle" class="h-6 w-6 text-amber-600"></i>
                                                </div>
                                                <div class="flex-1">
                                                    <p id="confirmModalMessage"
                                                        class="text-gray-700 text-base leading-relaxed"></p>
                                                </div>
                                            </div>
                                            < !-- Details section (optional) -->
                                                <div id="confirmModalDetails"
                                                    class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4 hidden">
                                                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Details:</h4>
                                                    <div id="confirmModalDetailsContent"
                                                        class="text-sm text-gray-600 space-y-1"></div>
                                                </div>
                                                < !-- Warning message (optional) -->
                                                    <div id="confirmModalWarning"
                                                        class="bg-red-50 border-l-4 border-red-400 p-3 mb-4 hidden">
                                                        <p class="text-sm text-red-700 flex items-center"> <i
                                                                data-lucide="alert-triangle" class="h-4 w-4 mr-2"></i>
                                                            <span id="confirmModalWarningText"></span>
                                                        </p>
                                                    </div>
                                                    < !-- Action buttons -->
                                                        <div class="flex justify-end gap-3 pt-4 border-t"> <button
                                                                onclick="closeCustomConfirm()"
                                                                class="px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors">
                                                                Cancel </button> <button id="confirmModalConfirmBtn"
                                                                class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition-colors shadow-md">
                                                                Confirm </button> </div>
                                    </div>
                                </div>
                            </div>
                            < !-- Right-click context menu for reservations -->
                                <div id="reservationContextMenu" class="reservation-context-menu"> <button
                                        class="reservation-context-menu-item" id="contextMenuEdit"> <i
                                            data-lucide="edit-2"></i> <span>Edit Reservation</span> </button> <button
                                        class="reservation-context-menu-item" id="contextMenuInvoice"> <i
                                            data-lucide="file-text"></i> <span>View Invoice</span> </button> <button
                                        class="reservation-context-menu-item" id="contextMenuPayments"> <i
                                            data-lucide="credit-card"></i> <span>Manage Payments</span> </button>
                                    <div class="reservation-context-menu-separator"></div> <button
                                        class="reservation-context-menu-item" id="contextMenuStaySheet"> <i
                                            data-lucide="printer"></i> <span>Print Stay Sheet</span> </button>
                                    <div class="reservation-context-menu-separator"></div> <button
                                        class="reservation-context-menu-item danger" id="contextMenuCancel"> <i
                                            data-lucide="x-circle"></i> <span>Cancel Reservation</span> </button>
                                </div>
                                < !-- Reservation Action Modal -->
                                    <div id="reservationActionModal" class="modal">
                                        <div class="modal-content" style="max-width: 400px;"> <span class="close-button"
                                                onclick="closeModal('reservationActionModal')">×</span>
                                            <div class="p-4">
                                                <h3 class="text-xl font-semibold text-gray-800 mb-2">Open Reservation
                                                </h3>
                                                <p class="text-sm text-gray-600 mb-6">How would you like to view this
                                                    reservation?</p>
                                                <div class="space-y-3"> <button id="viewInCalendarBtn"
                                                        class="w-full flex items-center justify-between p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-lg hover:from-blue-100 hover:to-indigo-100 hover:border-blue-300 transition-all group">
                                                        <div class="flex items-center gap-3">
                                                            <div
                                                                class="p-2 bg-blue-500 rounded-lg group-hover:scale-110 transition-transform">
                                                                <i data-lucide="calendar-search"
                                                                    class="h-5 w-5 text-white"></i>
                                                            </div>
                                                            <div class="text-left">
                                                                <div class="font-semibold text-gray-900">View in
                                                                    Calendar</div>
                                                                <div class="text-xs text-gray-600">See reservation on
                                                                    timeline</div>
                                                            </div>
                                                        </div> <i data-lucide="chevron-right"
                                                            class="h-5 w-5 text-gray-400 group-hover:text-blue-600 group-hover:translate-x-1 transition-all"></i>
                                                    </button> <button id="editReservationBtn"
                                                        class="w-full flex items-center justify-between p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-lg hover:from-green-100 hover:to-emerald-100 hover:border-green-300 transition-all group">
                                                        <div class="flex items-center gap-3">
                                                            <div
                                                                class="p-2 bg-green-500 rounded-lg group-hover:scale-110 transition-transform">
                                                                <i data-lucide="edit-3" class="h-5 w-5 text-white"></i>
                                                            </div>
                                                            <div class="text-left">
                                                                <div class="font-semibold text-gray-900">Edit Details
                                                                </div>
                                                                <div class="text-xs text-gray-600">Modify reservation
                                                                    info</div>
                                                            </div>
                                                        </div> <i data-lucide="chevron-right"
                                                            class="h-5 w-5 text-gray-400 group-hover:text-green-600 group-hover:translate-x-1 transition-all"></i>
                                                    </button> </div> <button
                                                    onclick="closeModal('reservationActionModal')"
                                                    class="w-full mt-4 px-4 py-2 text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
                                                    Cancel </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex h-screen">
                                        < !-- SIDEBAR WITH COLLAPSE BUTTON -->
                                            <aside id="sidebar"
                                                class="sidebar w-64 space-y-2 py-5 px-2 absolute inset-y-0 left-0 transform md:relative md:translate-x-0 z-30 shadow-lg sidebar-hidden md:sidebar-visible flex flex-col">
                                                < !-- Toggle Button --> <button id="sidebarToggleBtn"
                                                        class="sidebar-toggle-btn" title="Collapse Sidebar"> <i
                                                            data-lucide="chevrons-left" class="icon-collapse"></i> <i
                                                            data-lucide="chevrons-right" class="icon-expand hidden"></i>
                                                    </button>
                                                    <div> <a href="#" onclick="showView('dashboard')"
                                                            class="text-white flex flex-col items-center space-y-1 px-2 py-3 group mb-3">
                                                            <img src="https://www.amieiramarina.com/assets/img/logo.png"
                                                                alt="AMIEIRA MARINA Logo"
                                                                class="h-12 w-auto object-contain mb-1"
                                                                onerror="this.style.display='none'; const p=document.createElement('p'); p.className='text-center text-sm font-semibold text-slate-300'; p.textContent='AMIEIRA MARINA Logo Missing'; this.parentNode.insertBefore(p, this.nextSibling);">
                                                        </a>
                                                        <nav class="space-y-1"> <a href="#"
                                                                onclick="showView('dashboard')"
                                                                class="nav-link group flex items-center space-x-3 rounded-md px-3 py-2.5 text-sm font-medium">
                                                                <i data-lucide="layout-dashboard"
                                                                    class="h-5 w-5"></i><span
                                                                    data-translate-key="nav.dashboard">Dashboard</span>
                                                            </a> <a href="#" onclick="showView('new-reservation')"
                                                                class="nav-link group flex items-center space-x-3 rounded-md px-3 py-2.5 text-sm font-medium">
                                                                <i data-lucide="plus-circle" class="h-5 w-5"></i><span
                                                                    id="newOrEditReservationLinkText"
                                                                    data-translate-key="nav.newReservation">New
                                                                    Reservation</span> </a> <a href="#"
                                                                onclick="showView('view-reservations')"
                                                                class="nav-link group flex items-center space-x-3 rounded-md px-3 py-2.5 text-sm font-medium">
                                                                <i data-lucide="list-checks" class="h-5 w-5"></i><span
                                                                    data-translate-key="nav.viewReservations">View
                                                                    Reservations</span> </a> <a href="#"
                                                                onclick="showView('calendar')"
                                                                class="nav-link group flex items-center space-x-3 rounded-md px-3 py-2.5 text-sm font-medium">
                                                                <i data-lucide="calendar-days" class="h-5 w-5"></i><span
                                                                    data-translate-key="nav.calendarView">Calendar
                                                                    View</span> </a> <a href="#"
                                                                onclick="showView('manage-moorings')"
                                                                class="nav-link group flex items-center space-x-3 rounded-md px-3 py-2.5 text-sm font-medium">
                                                                <i data-lucide="anchor" class="h-5 w-5"></i><span
                                                                    data-translate-key="nav.moorings">Moorings</span>
                                                            </a> <a href="#" onclick="showView('restaurant')"
                                                                class="nav-link group flex items-center space-x-3 rounded-md px-3 py-2.5 text-sm font-medium">
                                                                <i data-lucide="utensils-crossed"
                                                                    class="h-5 w-5"></i><span
                                                                    data-translate-key="nav.restaurant">Restaurant</span>
                                                            </a> <a href="#" onclick="showView('reports')"
                                                                class="nav-link group flex items-center space-x-3 rounded-md px-3 py-2.5 text-sm font-medium">
                                                                <i data-lucide="file-text" class="h-5 w-5"></i><span
                                                                    data-translate-key="nav.reports">Reports</span> </a>
                                                            <div class="pt-4">
                                                                <p class="px-3 text-xs font-semibold uppercase nav-section-title tracking-wider"
                                                                    data-translate-key="nav.dailyTravels.title">Daily
                                                                    Travels</p> <a href="#"
                                                                    onclick="showView('daily-travels')"
                                                                    class="nav-link group flex items-center space-x-3 rounded-md px-3 py-2.5 text-sm font-medium mt-1">
                                                                    <i data-lucide="sailboat" class="h-5 w-5"></i><span
                                                                        data-translate-key="nav.dailyTravels.bookings">Travel
                                                                        Bookings</span> </a> <a href="#"
                                                                    onclick="showView('travel-calendar')"
                                                                    class="nav-link group flex items-center space-x-3 rounded-md px-3 py-2.5 text-sm font-medium">
                                                                    <i data-lucide="calendar" class="h-5 w-5"></i><span
                                                                        data-translate-key="nav.dailyTravels.calendar">Travel
                                                                        Calendar</span> </a>
                                                            </div>
                                                            <div class="pt-4">
                                                                <p class="px-3 text-xs font-semibold uppercase nav-section-title tracking-wider"
                                                                    data-translate-key="nav.manage">Manage</p> <a
                                                                    href="#" onclick="showView('settings')"
                                                                    class="nav-link group flex items-center space-x-3 rounded-md px-3 py-2.5 text-sm font-medium mt-1">
                                                                    <i data-lucide="settings" class="h-5 w-5"></i><span
                                                                        data-translate-key="nav.settings">Settings</span>
                                                                </a>
                                                            </div>
                                                        </nav>
                                                    </div>
                                                    <div id="sidebarPriceCalculator"
                                                        class="mt-auto p-3 bg-slate-800/50 rounded-lg border border-slate-700 hidden">
                                                        <h4
                                                            class="text-sm font-semibold text-slate-300 mb-2 border-b border-slate-700 pb-2 flex items-center">
                                                            <i data-lucide="calculator" class="h-4 w-4 mr-2"></i> Quick
                                                            Cost
                                                        </h4>
                                                        <div class="space-y-1 text-xs text-slate-400">
                                                            <p class="flex justify-between"><span>Boat:</span> <span
                                                                    id="sidebarCalcBoat"
                                                                    class="font-mono text-slate-200">€0.00</span></p>
                                                            <p class="flex justify-between"><span>Extras:</span> <span
                                                                    id="sidebarCalcExtras"
                                                                    class="font-mono text-slate-200">€0.00</span></p>
                                                            <p class="flex justify-between"><span>Subtotal:</span> <span
                                                                    id="sidebarCalcSubtotal"
                                                                    class="font-mono text-slate-200">€0.00</span></p>
                                                            <p class="flex justify-between"><span>Discount:</span> <span
                                                                    id="sidebarCalcDiscount"
                                                                    class="font-mono text-slate-200">-€0.00</span></p>
                                                            <p
                                                                class="flex justify-between font-bold text-sm text-slate-200 mt-2 pt-2 border-t border-slate-700">
                                                                <span>Total:</span> <span id="sidebarCalcTotal"
                                                                    class="font-mono text-white">€0.00</span>
                                                            </p>
                                                        </div>
                                                    </div>
                                            </aside>
                                            <div class="flex-1 flex flex-col overflow-hidden main-content">
                                                <header
                                                    class="bg-white shadow-md px-4 py-3 flex justify-between items-center bg-gradient-to-r from-slate-50 to-gray-100 gap-4">
                                                    <button id="menu-button"
                                                        class="md:hidden text-gray-600 hover:text-gray-800 flex-shrink-0">
                                                        <i data-lucide="menu" class="h-6 w-6"></i> </button>
                                                    <h1 id="view-title"
                                                        class="text-xl font-semibold text-gray-700 hidden md:block"
                                                        data-translate-key="dashboard.title">Dashboard</h1>
                                                    < !-- Global Search Bar -->
                                                        <div class="global-search-container flex-1 max-w-md relative">
                                                            <div class="relative"> <i data-lucide="search"
                                                                    class="global-search-icon"></i> <input type="text"
                                                                    id="globalSearchInput" class="global-search-input"
                                                                    placeholder="Search clients, boats, bookings..."
                                                                    autocomplete="off"> <button type="button"
                                                                    id="globalSearchClear" class="global-search-clear">
                                                                    <i data-lucide="x" class="h-4 w-4"></i> </button>
                                                            </div>
                                                            <div id="globalSearchResults" class="global-search-results">
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center space-x-3 flex-shrink-0"> <button
                                                                onclick="manualRefreshData()"
                                                                class="text-gray-600 hover:text-indigo-600 transition-colors p-2 rounded-lg hover:bg-indigo-50"
                                                                title="Refresh Data"> <i data-lucide="refresh-cw"
                                                                    class="h-5 w-5"></i> </button>
                                                            <div id="language-switcher" class="flex gap-1"> <button
                                                                    onclick="setLanguage('en')"
                                                                    class="px-3 py-1.5 rounded-md lang-btn transition-all"
                                                                    data-lang="en">EN</button> <button
                                                                    onclick="setLanguage('pt')"
                                                                    class="px-3 py-1.5 rounded-md lang-btn transition-all"
                                                                    data-lang="pt">PT</button> </div>
                                                        </div>
                                                </header>
                                                <main
                                                    class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6 main-content">
                                                    <div id="dashboard-view" class="view-content">
                                                        <h2 class="text-2xl font-semibold text-gray-800 mb-6"
                                                            data-translate-key="dashboard.overviewTitle"> Dashboard
                                                            Overview</h2>
                                                        <div
                                                            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                                            <div
                                                                class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
                                                                <div class="flex items-center">
                                                                    <div
                                                                        class="p-3 rounded-full bg-blue-500 bg-opacity-20">
                                                                        <i data-lucide="ship"
                                                                            class="h-6 w-6 text-blue-600"></i>
                                                                    </div>
                                                                    <div class="ml-4">
                                                                        <p class="text-sm text-gray-600"
                                                                            data-translate-key="dashboard.activeReservations">
                                                                            Active Reservations</p>
                                                                        <p class="text-2xl font-semibold text-gray-800"
                                                                            id="db-active-reservations">--</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div
                                                                class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
                                                                <div class="flex items-center">
                                                                    <div
                                                                        class="p-3 rounded-full bg-green-500 bg-opacity-20">
                                                                        <i data-lucide="calendar-check"
                                                                            class="h-6 w-6 text-green-600"></i>
                                                                    </div>
                                                                    <div class="ml-4">
                                                                        <p class="text-sm text-gray-600"
                                                                            data-translate-key="dashboard.upcomingCheckins">
                                                                            Upcoming Check-ins (7 days)</p>
                                                                        <p class="text-2xl font-semibold text-gray-800"
                                                                            id="db-upcoming-checkins">--</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div
                                                                class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
                                                                <div class="flex items-center">
                                                                    <div
                                                                        class="p-3 rounded-full bg-yellow-500 bg-opacity-20">
                                                                        <i data-lucide="credit-card"
                                                                            class="h-6 w-6 text-yellow-600"></i>
                                                                    </div>
                                                                    <div class="ml-4">
                                                                        <p class="text-sm text-gray-600"
                                                                            data-translate-key="dashboard.pendingPayments">
                                                                            Pending Payments</p>
                                                                        <p class="text-2xl font-semibold text-gray-800"
                                                                            id="db-pending-payments">--</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div
                                                                class="bg-white p-6 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
                                                                <div class="flex items-center">
                                                                    <div
                                                                        class="p-3 rounded-full bg-red-500 bg-opacity-20">
                                                                        <i data-lucide="anchor"
                                                                            class="h-6 w-6 text-red-600"></i>
                                                                    </div>
                                                                    <div class="ml-4">
                                                                        <p class="text-sm text-gray-600"
                                                                            data-translate-key="dashboard.availableBoats">
                                                                            Available Boats Now</p>
                                                                        <p class="text-2xl font-semibold text-gray-800"
                                                                            id="db-available-boats">-- / --</p>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        < !-- REDESIGNED DASHBOARD GRID -->
                                                            <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                                < !-- LEFT COLUMN: Quick Actions & Reports Combined -->
                                                                    <div class="dashboard-activity-card">
                                                                        <h3
                                                                            class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                                                                            <i data-lucide="zap"
                                                                                class="h-6 w-6 mr-2 text-indigo-600"></i>
                                                                            Quick Actions & Reports
                                                                        </h3>
                                                                        < !-- Reservations Actions -->
                                                                            <div class="mb-4">
                                                                                <h4
                                                                                    class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-2">
                                                                                    Reservations</h4>
                                                                                <div class="grid grid-cols-2 gap-2">
                                                                                    <button
                                                                                        onclick="showView('new-reservation', { mode: 'new' })"
                                                                                        class="btn-gradient-blue text-white font-semibold py-2 px-3 rounded-lg shadow flex items-center justify-center text-sm transition-transform hover:scale-105">
                                                                                        <i data-lucide="plus"
                                                                                            class="mr-1 h-4 w-4"></i>
                                                                                        New </button> <button
                                                                                        onclick="showView('view-reservations')"
                                                                                        class="btn-gradient-green text-white font-semibold py-2 px-3 rounded-lg shadow flex items-center justify-center text-sm transition-transform hover:scale-105">
                                                                                        <i data-lucide="list"
                                                                                            class="mr-1 h-4 w-4"></i>
                                                                                        View All </button> <button
                                                                                        onclick="openQuickReportDialog()"
                                                                                        class="btn-gradient-indigo text-white font-semibold py-2 px-3 rounded-lg shadow flex items-center justify-center text-sm transition-transform hover:scale-105">
                                                                                        <i data-lucide="file-text"
                                                                                            class="mr-1 h-4 w-4"></i>
                                                                                        Report </button> <button
                                                                                        onclick="openQuickStaySheetsDialog()"
                                                                                        class="btn-gradient-teal text-white font-semibold py-2 px-3 rounded-lg shadow flex items-center justify-center text-sm transition-transform hover:scale-105">
                                                                                        <i data-lucide="printer"
                                                                                            class="mr-1 h-4 w-4"></i>
                                                                                        Sheets </button>
                                                                                </div>
                                                                            </div>
                                                                            < !-- Passeios Actions -->
                                                                                <div class="mb-4">
                                                                                    <h4
                                                                                        class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-2">
                                                                                        Passeios (Travels)</h4>
                                                                                    <div class="grid grid-cols-2 gap-2">
                                                                                        <button
                                                                                            onclick="showView('daily-travels')"
                                                                                            class="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-2 px-3 rounded-lg shadow flex items-center justify-center text-sm transition-transform hover:scale-105">
                                                                                            <i data-lucide="sailboat"
                                                                                                class="mr-1 h-4 w-4"></i>
                                                                                            New Travel </button> <button
                                                                                            onclick="showView('travel-calendar')"
                                                                                            class="bg-gradient-to-r from-teal-500 to-cyan-600 hover:from-teal-600 hover:to-cyan-700 text-white font-semibold py-2 px-3 rounded-lg shadow flex items-center justify-center text-sm transition-transform hover:scale-105">
                                                                                            <i data-lucide="calendar"
                                                                                                class="mr-1 h-4 w-4"></i>
                                                                                            Calendar </button>
                                                                                    </div>
                                                                                </div>
                                                                                < !-- Restaurant Actions -->
                                                                                    <div>
                                                                                        <h4
                                                                                            class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-2">
                                                                                            Restaurant </h4>
                                                                                        <div
                                                                                            class="grid grid-cols-2 gap-2">
                                                                                            <button
                                                                                                onclick="showView('restaurant')"
                                                                                                class="bg-gradient-to-r from-pink-500 to-rose-600 hover:from-pink-600 hover:to-rose-700 text-white font-semibold py-2 px-3 rounded-lg shadow flex items-center justify-center text-sm transition-transform hover:scale-105">
                                                                                                <i data-lucide="utensils-crossed"
                                                                                                    class="mr-1 h-4 w-4"></i>
                                                                                                New Booking </button>
                                                                                            <button
                                                                                                onclick="generateRestaurantQuickReport()"
                                                                                                class="bg-gradient-to-r from-purple-500 to-violet-600 hover:from-purple-600 hover:to-violet-700 text-white font-semibold py-2 px-3 rounded-lg shadow flex items-center justify-center text-sm transition-transform hover:scale-105">
                                                                                                <i data-lucide="file-down"
                                                                                                    class="mr-1 h-4 w-4"></i>
                                                                                                Report </button>
                                                                                        </div>
                                                                                    </div>
                                                                    </div>
                                                                    < !-- RIGHT COLUMN: Check-ins, Check-outs, Travels
                                                                        -->
                                                                        <div class="space-y-4">
                                                                            < !-- Check-ins -->
                                                                                <div class="dashboard-activity-card">
                                                                                    <div
                                                                                        class="flex justify-between items-center mb-3">
                                                                                        <h4
                                                                                            class="flex items-center text-base font-semibold">
                                                                                            <i data-lucide="log-in"
                                                                                                class="h-5 w-5 mr-2 text-blue-600"></i>
                                                                                            Check-ins
                                                                                        </h4>
                                                                                        <div class="flex gap-1"> <button
                                                                                                onclick="filterDashboardCheckins('today')"
                                                                                                id="dash-checkin-today"
                                                                                                class="px-2 py-1 text-xs font-medium rounded bg-blue-600 text-white">Today</button>
                                                                                            <button
                                                                                                onclick="filterDashboardCheckins('tomorrow')"
                                                                                                id="dash-checkin-tomorrow"
                                                                                                class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Tomorrow</button>
                                                                                            <button
                                                                                                onclick="filterDashboardCheckins('week')"
                                                                                                id="dash-checkin-week"
                                                                                                class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300">7
                                                                                                Days</button>
                                                                                        </div>
                                                                                    </div>
                                                                                    <ul id="db-today-checkins-list"
                                                                                        class="dashboard-activity-list max-h-40 overflow-y-auto">
                                                                                        <li class="text-gray-500">
                                                                                            Loading...</li>
                                                                                    </ul>
                                                                                </div>
                                                                                < !-- Check-outs -->
                                                                                    <div
                                                                                        class="dashboard-activity-card">
                                                                                        <div
                                                                                            class="flex justify-between items-center mb-3">
                                                                                            <h4
                                                                                                class="flex items-center text-base font-semibold">
                                                                                                <i data-lucide="log-out"
                                                                                                    class="h-5 w-5 mr-2 text-purple-600"></i>
                                                                                                Check-outs
                                                                                            </h4>
                                                                                            <div class="flex gap-1">
                                                                                                <button
                                                                                                    onclick="filterDashboardCheckouts('today')"
                                                                                                    id="dash-checkout-today"
                                                                                                    class="px-2 py-1 text-xs font-medium rounded bg-purple-600 text-white">Today</button>
                                                                                                <button
                                                                                                    onclick="filterDashboardCheckouts('tomorrow')"
                                                                                                    id="dash-checkout-tomorrow"
                                                                                                    class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Tomorrow</button>
                                                                                                <button
                                                                                                    onclick="filterDashboardCheckouts('week')"
                                                                                                    id="dash-checkout-week"
                                                                                                    class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300">7
                                                                                                    Days</button>
                                                                                            </div>
                                                                                        </div>
                                                                                        <ul id="db-today-checkouts-list"
                                                                                            class="dashboard-activity-list max-h-40 overflow-y-auto">
                                                                                            <li class="text-gray-500">
                                                                                                Loading...</li>
                                                                                        </ul>
                                                                                    </div>
                                                                                    < !-- Travels -->
                                                                                        <div
                                                                                            class="dashboard-activity-card">
                                                                                            <div
                                                                                                class="flex justify-between items-center mb-3">
                                                                                                <h4
                                                                                                    class="flex items-center text-base font-semibold">
                                                                                                    <i data-lucide="sailboat"
                                                                                                        class="h-5 w-5 mr-2 text-green-600"></i>
                                                                                                    Passeios
                                                                                                </h4>
                                                                                                <div class="flex gap-1">
                                                                                                    <button
                                                                                                        onclick="filterDashboardTravels('today')"
                                                                                                        id="dash-travel-today"
                                                                                                        class="px-2 py-1 text-xs font-medium rounded bg-green-600 text-white">Today</button>
                                                                                                    <button
                                                                                                        onclick="filterDashboardTravels('tomorrow')"
                                                                                                        id="dash-travel-tomorrow"
                                                                                                        class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300">Tomorrow</button>
                                                                                                    <button
                                                                                                        onclick="filterDashboardTravels('week')"
                                                                                                        id="dash-travel-week"
                                                                                                        class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300">7
                                                                                                        Days</button>
                                                                                                </div>
                                                                                            </div>
                                                                                            <ul id="db-travels-list"
                                                                                                class="dashboard-activity-list max-h-40 overflow-y-auto">
                                                                                                <li
                                                                                                    class="text-gray-500">
                                                                                                    Loading...</li>
                                                                                            </ul>
                                                                                        </div>
                                                                        </div>
                                                            </div>
                                                    </div>
                                                    < !-- REPLACE the entire contents of your manage-moorings-view div
                                                        -->
                                                        <div id="manage-moorings-view" class="view-content hidden">
                                                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                                                <div
                                                                    class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                                                    <h2 class="text-2xl font-semibold text-gray-800"
                                                                        data-translate-key="moorings.title">Mooring
                                                                        Management</h2>
                                                                    <div class="flex items-center space-x-2">
                                                                        < !-- PDF Export Dropdown -->
                                                                            <div
                                                                                class="relative inline-block text-left">
                                                                                <div> <button type="button"
                                                                                        class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none"
                                                                                        id="pdf-menu-button"
                                                                                        aria-expanded="true"
                                                                                        aria-haspopup="true"> <i
                                                                                            data-lucide="file-down"
                                                                                            class="mr-2 h-5 w-5"></i>
                                                                                        Export PDF <i
                                                                                            data-lucide="chevron-down"
                                                                                            class="ml-2 -mr-1 h-5 w-5"></i>
                                                                                    </button> </div>
                                                                                <div id="pdf-export-options"
                                                                                    class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden"
                                                                                    role="menu"
                                                                                    aria-orientation="vertical"
                                                                                    aria-labelledby="pdf-menu-button">
                                                                                    <div class="py-1" role="none"> <a
                                                                                            href="#"
                                                                                            id="generateMooringsMapPdfButton"
                                                                                            class="text-gray-700 block px-4 py-2 text-sm"
                                                                                            role="menuitem">Export Map
                                                                                            View</a>
                                                                                        < !-- The table export is
                                                                                            removed as per your request
                                                                                            -->
                                                                                    </div>
                                                                                </div>
                                                                            </div> <button
                                                                                onclick="openMooringFormModal('add')"
                                                                                class="btn-gradient-blue text-white font-semibold py-2 px-4 rounded-lg shadow flex items-center transition-transform hover:scale-105">
                                                                                <i data-lucide="plus"
                                                                                    class="mr-2 h-5 w-5"></i> <span
                                                                                    data-translate-key="moorings.addNewBtn">New
                                                                                    Mooring</span> </button>
                                                                    </div>
                                                                </div>
                                                                < !-- NEW: Mooring Notification Area -->
                                                                    <div id="mooring-notifications"
                                                                        class="mb-6 space-y-3">
                                                                        < !-- Notifications will be dynamically inserted
                                                                            here -->
                                                                    </div>
                                                                    <div id="mooringMapView">
                                                                        < !-- The mooringMapContainer and its contents
                                                                            remain unchanged -->
                                                                            <div id="mooringMapContainer">
                                                                                <div class="pier-row company-boat-row">
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot company-boat-spot"
                                                                                            onclick="renameCompanyBoat(this)">
                                                                                            <span
                                                                                                class="place-id">B.1</span><span
                                                                                                class="client-name">ALQUEVA</span>
                                                                                        </div>
                                                                                        <div class="mooring-spot company-boat-spot"
                                                                                            onclick="renameCompanyBoat(this)">
                                                                                            <span
                                                                                                class="place-id">B.2</span><span
                                                                                                class="client-name">CAMPINHO</span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot company-boat-spot"
                                                                                            onclick="renameCompanyBoat(this)">
                                                                                            <span
                                                                                                class="place-id">B.3</span><span
                                                                                                class="client-name">MOURAO</span>
                                                                                        </div>
                                                                                        <div class="mooring-spot company-boat-spot"
                                                                                            onclick="renameCompanyBoat(this)">
                                                                                            <span
                                                                                                class="place-id">B.4</span><span
                                                                                                class="client-name">MOURA</span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot company-boat-spot"
                                                                                            onclick="renameCompanyBoat(this)">
                                                                                            <span
                                                                                                class="place-id">B.5</span><span
                                                                                                class="client-name">AMIEIRA</span>
                                                                                        </div>
                                                                                        <div class="mooring-spot company-boat-spot"
                                                                                            onclick="renameCompanyBoat(this)">
                                                                                            <span
                                                                                                class="place-id">B.6</span><span
                                                                                                class="client-name">ESTRELA</span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot company-boat-spot"
                                                                                            onclick="renameCompanyBoat(this)">
                                                                                            <span
                                                                                                class="place-id">B.7</span><span
                                                                                                class="client-name">ALANDROAL</span>
                                                                                        </div>
                                                                                        <div class="mooring-spot company-boat-spot"
                                                                                            onclick="renameCompanyBoat(this)">
                                                                                            <span
                                                                                                class="place-id">B.8</span><span
                                                                                                class="client-name">REGUENGOS</span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot company-boat-spot"
                                                                                            onclick="renameCompanyBoat(this)">
                                                                                            <span
                                                                                                class="place-id">B.9</span><span
                                                                                                class="client-name">TERENA</span>
                                                                                        </div>
                                                                                        <div class="mooring-spot company-boat-spot"
                                                                                            onclick="renameCompanyBoat(this)">
                                                                                            <span
                                                                                                class="place-id">B.10</span><span
                                                                                                class="client-name">MONSARAZ</span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="pier-walkway-horizontal">B
                                                                                </div>
                                                                                <div class="pier-row">
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.22"><span
                                                                                                class="place-id">B.22</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.21"><span
                                                                                                class="place-id">B.21</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.20"><span
                                                                                                class="place-id">B.20</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.19"><span
                                                                                                class="place-id">B.19</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.18"><span
                                                                                                class="place-id">B.18</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.17"><span
                                                                                                class="place-id">B.17</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.16"><span
                                                                                                class="place-id">B.16</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.15"><span
                                                                                                class="place-id">B.15</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.14"><span
                                                                                                class="place-id">B.14</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.13"><span
                                                                                                class="place-id">B.13</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.12"><span
                                                                                                class="place-id">B.12</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="B.11"><span
                                                                                                class="place-id">B.11</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="pier-gap"></div>
                                                                                <div class="pier-row">
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.23"><span
                                                                                                class="place-id">A.23</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.24"><span
                                                                                                class="place-id">A.24</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.25"><span
                                                                                                class="place-id">A.25</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.26"><span
                                                                                                class="place-id">A.26</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.27"><span
                                                                                                class="place-id">A.27</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.28"><span
                                                                                                class="place-id">A.28</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.29"><span
                                                                                                class="place-id">A.29</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.30"><span
                                                                                                class="place-id">A.30</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.31"><span
                                                                                                class="place-id">A.31</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.32"><span
                                                                                                class="place-id">A.32</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.33"><span
                                                                                                class="place-id">A.33</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.34"><span
                                                                                                class="place-id">A.34</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="pier-walkway-horizontal">A
                                                                                </div>
                                                                                <div class="pier-row">
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.46"><span
                                                                                                class="place-id">A.46</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.45"><span
                                                                                                class="place-id">A.45</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.44"><span
                                                                                                class="place-id">A.44</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.43"><span
                                                                                                class="place-id">A.43</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.42"><span
                                                                                                class="place-id">A.42</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.41"><span
                                                                                                class="place-id">A.41</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.40"><span
                                                                                                class="place-id">A.40</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.39"><span
                                                                                                class="place-id">A.39</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.38"><span
                                                                                                class="place-id">A.38</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.37"><span
                                                                                                class="place-id">A.37</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="pier-separator-horizontal">
                                                                                    </div>
                                                                                    <div class="pier-boat-pair">
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.36"><span
                                                                                                class="place-id">A.36</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                        <div class="mooring-spot rentable"
                                                                                            data-place-id="A.35"><span
                                                                                                class="place-id">A.35</span><span
                                                                                                class="client-name"></span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                    </div>
                                                            </div>
                                                        </div>
                                                        <div id="new-reservation-view" class="view-content hidden">
                                                            <div class="max-w-7xl mx-auto">
                                                                < !-- Header -->
                                                                    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                                                                        <h2 id="reservationFormTitle"
                                                                            class="text-3xl font-bold text-gray-900">
                                                                            Create New Reservation</h2>
                                                                        <p class="text-gray-600 mt-2">Fill in the
                                                                            details below to create a new reservation
                                                                        </p>
                                                                    </div>
                                                                    < !-- Main Form -->
                                                                        <form id="newReservationForm"
                                                                            data-current-extras="{}"> <input
                                                                                type="hidden" id="reservationIdToUpdate"
                                                                                name="reservationIdToUpdate" value="">
                                                                            <div
                                                                                class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                                                                < !-- LEFT COLUMN: Form Fields (2/3
                                                                                    width) -->
                                                                                    <div
                                                                                        class="lg:col-span-2 space-y-6">
                                                                                        < !-- Booking & Client Details
                                                                                            Row -->
                                                                                            <div
                                                                                                class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                                                                                < !-- Booking Details
                                                                                                    -->
                                                                                                    <div
                                                                                                        class="bg-white rounded-lg shadow-sm p-6">
                                                                                                        <h3
                                                                                                            class="text-lg font-semibold text-gray-900 mb-4 pb-3 border-b-2 border-indigo-500 flex items-center">
                                                                                                            <i data-lucide="calendar"
                                                                                                                class="h-5 w-5 mr-2 text-indigo-600"></i>
                                                                                                            <span
                                                                                                                data-translate-key="newReservation.bookingDetailsLegend">Booking
                                                                                                                Details</span>
                                                                                                        </h3>
                                                                                                        <div
                                                                                                            class="space-y-4">
                                                                                                            <div> <label
                                                                                                                    for="boatId"
                                                                                                                    class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                    <span
                                                                                                                        data-translate-key="newReservation.boatSelectLabel">Select
                                                                                                                        Boat</span>
                                                                                                                    <span
                                                                                                                        class="text-red-500 ml-1">*</span>
                                                                                                                </label>
                                                                                                                <select
                                                                                                                    id="boatId"
                                                                                                                    name="boatId"
                                                                                                                    required
                                                                                                                    class="wizard-input price-trigger">
                                                                                                                    <option
                                                                                                                        value=""
                                                                                                                        disabled
                                                                                                                        selected>
                                                                                                                        Loading
                                                                                                                        boats...
                                                                                                                    </option>
                                                                                                                </select>
                                                                                                            </div>
                                                                                                            <div
                                                                                                                class="grid grid-cols-2 gap-3">
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="checkInDate"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        <span
                                                                                                                            data-translate-key="newReservation.checkInDateLabel">Check-in
                                                                                                                            Date</span>
                                                                                                                        <span
                                                                                                                            class="text-red-500 ml-1">*</span>
                                                                                                                    </label>
                                                                                                                    <input
                                                                                                                        type="date"
                                                                                                                        id="checkInDate"
                                                                                                                        name="checkInDate"
                                                                                                                        required
                                                                                                                        class="wizard-input price-trigger">
                                                                                                                </div>
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="checkInTime"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        <span
                                                                                                                            data-translate-key="newReservation.checkInTimeLabel">Time</span>
                                                                                                                    </label>
                                                                                                                    <input
                                                                                                                        type="time"
                                                                                                                        id="checkInTime"
                                                                                                                        name="checkInTime"
                                                                                                                        required
                                                                                                                        value="09:00"
                                                                                                                        class="wizard-input price-trigger">
                                                                                                                </div>
                                                                                                            </div>
                                                                                                            <div
                                                                                                                class="grid grid-cols-2 gap-3">
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="checkOutDate"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        <span
                                                                                                                            data-translate-key="newReservation.checkOutDateLabel">Check-out
                                                                                                                            Date</span>
                                                                                                                        <span
                                                                                                                            class="text-red-500 ml-1">*</span>
                                                                                                                    </label>
                                                                                                                    <input
                                                                                                                        type="date"
                                                                                                                        id="checkOutDate"
                                                                                                                        name="checkOutDate"
                                                                                                                        required
                                                                                                                        class="wizard-input price-trigger">
                                                                                                                </div>
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="checkOutTime"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        <span
                                                                                                                            data-translate-key="newReservation.checkOutTimeLabel">Time</span>
                                                                                                                    </label>
                                                                                                                    <input
                                                                                                                        type="time"
                                                                                                                        id="checkOutTime"
                                                                                                                        name="checkOutTime"
                                                                                                                        required
                                                                                                                        value="09:00"
                                                                                                                        class="wizard-input price-trigger">
                                                                                                                </div>
                                                                                                            </div>
                                                                                                            <div
                                                                                                                class="grid grid-cols-2 gap-3">
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="status"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        <span
                                                                                                                            data-translate-key="newReservation.statusLabel">Status</span>
                                                                                                                        <span
                                                                                                                            class="text-red-500 ml-1">*</span>
                                                                                                                    </label>
                                                                                                                    <select
                                                                                                                        id="status"
                                                                                                                        name="status"
                                                                                                                        required
                                                                                                                        class="wizard-input">
                                                                                                                        <option
                                                                                                                            value="Confirmed">
                                                                                                                            Confirmed
                                                                                                                        </option>
                                                                                                                        <option
                                                                                                                            value="Pending">
                                                                                                                            Pending
                                                                                                                        </option>
                                                                                                                        <option
                                                                                                                            value="Cancelled">
                                                                                                                            Cancelled
                                                                                                                        </option>
                                                                                                                    </select>
                                                                                                                </div>
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="reservationSource"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        <span
                                                                                                                            data-translate-key="newReservation.sourceLabel">Source</span>
                                                                                                                        <span
                                                                                                                            class="text-red-500 ml-1">*</span>
                                                                                                                    </label>
                                                                                                                    <select
                                                                                                                        id="reservationSource"
                                                                                                                        name="reservationSource"
                                                                                                                        required
                                                                                                                        class="wizard-input price-trigger">
                                                                                                                        <option
                                                                                                                            value="AMIEIRA">
                                                                                                                            AMIEIRA
                                                                                                                        </option>
                                                                                                                        <option
                                                                                                                            value="NICOLS">
                                                                                                                            NICOLS
                                                                                                                        </option>
                                                                                                                        <option
                                                                                                                            value="Ancorado">
                                                                                                                            Ancorado
                                                                                                                        </option>
                                                                                                                        <option
                                                                                                                            value="Diaria">
                                                                                                                            Diaria
                                                                                                                        </option>
                                                                                                                        <option
                                                                                                                            value="OTHER">
                                                                                                                            OTHER
                                                                                                                        </option>
                                                                                                                    </select>
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    < !-- Client Details
                                                                                                        -->
                                                                                                        <div
                                                                                                            class="bg-white rounded-lg shadow-sm p-6">
                                                                                                            <h3
                                                                                                                class="text-lg font-semibold text-gray-900 mb-4 pb-3 border-b-2 border-green-500 flex items-center">
                                                                                                                <i data-lucide="user"
                                                                                                                    class="h-5 w-5 mr-2 text-green-600"></i>
                                                                                                                <span
                                                                                                                    data-translate-key="newReservation.clientDetailsLegend">Client
                                                                                                                    Details</span>
                                                                                                            </h3>
                                                                                                            <div
                                                                                                                class="space-y-4">
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="clientName"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        <span
                                                                                                                            data-translate-key="newReservation.clientFullNameLabel">Full
                                                                                                                            Name</span>
                                                                                                                        <span
                                                                                                                            class="text-red-500 ml-1">*</span>
                                                                                                                    </label>
                                                                                                                    <input
                                                                                                                        type="text"
                                                                                                                        id="clientName"
                                                                                                                        name="clientName"
                                                                                                                        required
                                                                                                                        class="wizard-input"
                                                                                                                        autocomplete="name"
                                                                                                                        placeholder="Enter client name">
                                                                                                                </div>
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="clientPhone"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        <span
                                                                                                                            data-translate-key="newReservation.clientPhoneLabel">Phone
                                                                                                                            Number</span>
                                                                                                                    </label>
                                                                                                                    <input
                                                                                                                        type="tel"
                                                                                                                        id="clientPhone"
                                                                                                                        name="clientPhone"
                                                                                                                        class="wizard-input"
                                                                                                                        autocomplete="tel"
                                                                                                                        placeholder="+351 123 456 789">
                                                                                                                </div>
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="clientEmail"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        <span
                                                                                                                            data-translate-key="newReservation.clientEmailLabel">Email
                                                                                                                            Address</span>
                                                                                                                    </label>
                                                                                                                    <input
                                                                                                                        type="email"
                                                                                                                        id="clientEmail"
                                                                                                                        name="clientEmail"
                                                                                                                        class="wizard-input"
                                                                                                                        autocomplete="email"
                                                                                                                        placeholder="client@example.com">
                                                                                                                </div>
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="notes"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        <span
                                                                                                                            data-translate-key="newReservation.notesLabel">Notes</span>
                                                                                                                    </label>
                                                                                                                    <textarea
                                                                                                                        id="notes"
                                                                                                                        name="notes"
                                                                                                                        rows="3"
                                                                                                                        class="wizard-input"
                                                                                                                        placeholder="Any special requests or notes..."></textarea>
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        </div>
                                                                                            </div>
                                                                                            < !-- Collapsible Extras
                                                                                                Section -->
                                                                                                <div
                                                                                                    class="bg-white rounded-lg shadow-sm overflow-hidden">
                                                                                                    <button
                                                                                                        type="button"
                                                                                                        id="toggleExtrasBtn"
                                                                                                        class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                                                                                                        <div
                                                                                                            class="flex items-center">
                                                                                                            <i data-lucide="package-plus"
                                                                                                                class="h-5 w-5 mr-2 text-purple-600"></i>
                                                                                                            <h3
                                                                                                                class="text-lg font-semibold text-gray-900">
                                                                                                                <span
                                                                                                                    data-translate-key="newReservation.extrasLegend">Add
                                                                                                                    Extras</span>
                                                                                                                <span
                                                                                                                    class="text-sm font-normal text-gray-500 ml-2">(Optional)</span>
                                                                                                            </h3>
                                                                                                        </div> <i
                                                                                                            data-lucide="chevron-down"
                                                                                                            id="extrasChevron"
                                                                                                            class="h-5 w-5 text-gray-400 transition-transform"></i>
                                                                                                    </button>
                                                                                                    <div id="extrasSection"
                                                                                                        class="hidden border-t border-gray-200">
                                                                                                        <div
                                                                                                            class="p-6">
                                                                                                            <div
                                                                                                                class="mb-4 p-3 bg-purple-50 rounded-lg border border-purple-200">
                                                                                                                <p
                                                                                                                    class="text-sm text-purple-800">
                                                                                                                    <i data-lucide="info"
                                                                                                                        class="inline h-4 w-4 mr-1"></i>
                                                                                                                    Select
                                                                                                                    extras
                                                                                                                    and
                                                                                                                    specify
                                                                                                                    quantities.
                                                                                                                    Costs
                                                                                                                    will
                                                                                                                    be
                                                                                                                    calculated
                                                                                                                    based
                                                                                                                    on
                                                                                                                    your
                                                                                                                    booking
                                                                                                                    duration.
                                                                                                                </p>
                                                                                                            </div>
                                                                                                            <div id="extrasContainer"
                                                                                                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                                                                                                < !--
                                                                                                                    Populated
                                                                                                                    by
                                                                                                                    JS
                                                                                                                    -->
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </div>
                                                                                                < !-- Pricing Controls
                                                                                                    -->
                                                                                                    <div
                                                                                                        class="bg-white rounded-lg shadow-sm p-6">
                                                                                                        <h3
                                                                                                            class="text-lg font-semibold text-gray-900 mb-4 pb-3 border-b-2 border-amber-500 flex items-center">
                                                                                                            <i data-lucide="settings"
                                                                                                                class="h-5 w-5 mr-2 text-amber-600"></i>
                                                                                                            <span
                                                                                                                data-translate-key="newReservation.pricingPaymentLegend">Pricing
                                                                                                                Adjustments</span>
                                                                                                        </h3>
                                                                                                        <div
                                                                                                            class="grid grid-cols-2 gap-4">
                                                                                                            <div> <label
                                                                                                                    for="taxValue"
                                                                                                                    class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                    <span
                                                                                                                        data-translate-key="newReservation.taxValueLabel">Tax
                                                                                                                        Value
                                                                                                                        (€)</span>
                                                                                                                </label>
                                                                                                                <input
                                                                                                                    type="number"
                                                                                                                    id="taxValue"
                                                                                                                    name="taxValue"
                                                                                                                    value="76"
                                                                                                                    min="0"
                                                                                                                    step="0.01"
                                                                                                                    readonly
                                                                                                                    class="wizard-input bg-gray-100 cursor-not-allowed">
                                                                                                                <p
                                                                                                                    class="text-xs text-gray-500 mt-1">
                                                                                                                    Standard
                                                                                                                    tax
                                                                                                                    applied
                                                                                                                    automatically
                                                                                                                </p>
                                                                                                            </div>
                                                                                                            <div> <label
                                                                                                                    for="discountPercentage"
                                                                                                                    class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                    <span
                                                                                                                        data-translate-key="newReservation.discountPercentageLabel">Discount
                                                                                                                        (%)</span>
                                                                                                                </label>
                                                                                                                <input
                                                                                                                    type="number"
                                                                                                                    id="discountPercentage"
                                                                                                                    name="discountPercentage"
                                                                                                                    value="0"
                                                                                                                    min="0"
                                                                                                                    max="100"
                                                                                                                    step="0.01"
                                                                                                                    class="wizard-input price-trigger"
                                                                                                                    placeholder="0">
                                                                                                            </div>
                                                                                                        </div>
                                                                                                        < !-- Manual
                                                                                                            Cost Input
                                                                                                            (for NICOLS
                                                                                                            etc) -->
                                                                                                            <div id="manualTotalCostContainer"
                                                                                                                class="hidden mt-4 p-4 bg-amber-50 border-2 border-amber-300 rounded-lg">
                                                                                                                <label
                                                                                                                    for="manualTotalCost"
                                                                                                                    class="block text-sm font-bold text-amber-900 mb-2">
                                                                                                                    <i data-lucide="alert-triangle"
                                                                                                                        class="inline h-4 w-4 mr-1"></i>
                                                                                                                    Manual
                                                                                                                    Total
                                                                                                                    Cost
                                                                                                                    Entry
                                                                                                                    (€)
                                                                                                                </label>
                                                                                                                <input
                                                                                                                    type="number"
                                                                                                                    id="manualTotalCost"
                                                                                                                    name="manualTotalCost"
                                                                                                                    step="0.01"
                                                                                                                    class="wizard-input border-amber-400">
                                                                                                                <p
                                                                                                                    class="text-xs text-amber-700 mt-2">
                                                                                                                    For
                                                                                                                    external
                                                                                                                    booking
                                                                                                                    sources,
                                                                                                                    enter
                                                                                                                    the
                                                                                                                    total
                                                                                                                    cost
                                                                                                                    manually
                                                                                                                </p>
                                                                                                            </div>
                                                                                                    </div>
                                                                                                    < !-- Initial
                                                                                                        Payment Section
                                                                                                        -->
                                                                                                        <div id="initialPaymentSection"
                                                                                                            class="bg-white rounded-lg shadow-sm p-6">
                                                                                                            <h3
                                                                                                                class="text-lg font-semibold text-gray-900 mb-4 pb-3 border-b-2 border-blue-500 flex items-center">
                                                                                                                <i data-lucide="wallet"
                                                                                                                    class="h-5 w-5 mr-2 text-blue-600"></i>
                                                                                                                Initial
                                                                                                                Payment
                                                                                                                <span
                                                                                                                    class="text-sm font-normal text-gray-500 ml-2">(Optional)</span>
                                                                                                            </h3>
                                                                                                            <div
                                                                                                                class="grid grid-cols-2 gap-4">
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="initialPaymentAmount"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        Amount
                                                                                                                        (€)
                                                                                                                    </label>
                                                                                                                    <input
                                                                                                                        type="number"
                                                                                                                        id="initialPaymentAmount"
                                                                                                                        name="initialPaymentAmount"
                                                                                                                        step="0.01"
                                                                                                                        min="0"
                                                                                                                        class="wizard-input"
                                                                                                                        placeholder="0.00">
                                                                                                                </div>
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        for="initialPaymentMethod"
                                                                                                                        class="block text-sm font-semibold text-gray-700 mb-2">
                                                                                                                        Payment
                                                                                                                        Method
                                                                                                                    </label>
                                                                                                                    <select
                                                                                                                        id="initialPaymentMethod"
                                                                                                                        name="initialPaymentMethod"
                                                                                                                        class="wizard-input">
                                                                                                                        <option
                                                                                                                            value="">
                                                                                                                            Select
                                                                                                                            Method...
                                                                                                                        </option>
                                                                                                                        <option
                                                                                                                            value="Cash">
                                                                                                                            Cash
                                                                                                                        </option>
                                                                                                                        <option
                                                                                                                            value="Card">
                                                                                                                            Card
                                                                                                                        </option>
                                                                                                                        <option
                                                                                                                            value="Bank Transfer">
                                                                                                                            Bank
                                                                                                                            Transfer
                                                                                                                        </option>
                                                                                                                        <option
                                                                                                                            value="Other">
                                                                                                                            Other
                                                                                                                        </option>
                                                                                                                    </select>
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        </div>
                                                                                    </div>
                                                                                    < !-- RIGHT COLUMN: Live Price
                                                                                        Summary (1/3 width, sticky) -->
                                                                                        <div class="lg:col-span-1">
                                                                                            <div class="sticky top-6">
                                                                                                <div
                                                                                                    class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg shadow-lg p-6 border-2 border-green-200">
                                                                                                    <h3
                                                                                                        class="text-xl font-bold text-gray-900 mb-4 flex items-center">
                                                                                                        <i data-lucide="receipt"
                                                                                                            class="h-6 w-6 mr-2 text-green-600"></i>
                                                                                                        <span
                                                                                                            data-translate-key="newReservation.priceSummaryTitle">Price
                                                                                                            Summary</span>
                                                                                                    </h3>
                                                                                                    <div id="priceSummaryContainer"
                                                                                                        class="space-y-4">
                                                                                                        < !-- Tariff
                                                                                                            Info -->
                                                                                                            <div
                                                                                                                class="bg-white p-3 rounded-lg border-l-4 border-cyan-500 shadow-sm">
                                                                                                                <div
                                                                                                                    class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">
                                                                                                                    Applied
                                                                                                                    Tariff
                                                                                                                </div>
                                                                                                                <div id="summaryTariffName"
                                                                                                                    class="text-sm font-bold text-cyan-700">
                                                                                                                    Calculating...
                                                                                                                </div>
                                                                                                            </div>
                                                                                                            < !--
                                                                                                                Breakdown
                                                                                                                -->
                                                                                                                <div
                                                                                                                    class="space-y-2">
                                                                                                                    <div
                                                                                                                        class="flex justify-between items-center py-2 border-b border-green-200">
                                                                                                                        <span
                                                                                                                            class="text-sm font-medium text-gray-700">Total
                                                                                                                            Nights:</span>
                                                                                                                        <span
                                                                                                                            id="summaryTotalNights"
                                                                                                                            class="text-lg font-bold text-gray-900 font-mono">0</span>
                                                                                                                    </div>
                                                                                                                    <div
                                                                                                                        class="pl-4 space-y-1.5 text-xs border-l-2 border-gray-300 ml-2">
                                                                                                                        <div
                                                                                                                            class="flex justify-between items-center">
                                                                                                                            <span
                                                                                                                                class="text-gray-600">Normal
                                                                                                                                (<span
                                                                                                                                    id="summaryNormalNights">0</span>
                                                                                                                                ×
                                                                                                                                €<span
                                                                                                                                    id="summaryUnitPriceNormal">0.00</span>):</span>
                                                                                                                            <span
                                                                                                                                class="font-mono font-semibold text-gray-700">€<span
                                                                                                                                    id="summaryTotalNormalNightCost">0.00</span></span>
                                                                                                                        </div>
                                                                                                                        <div
                                                                                                                            class="flex justify-between items-center">
                                                                                                                            <span
                                                                                                                                class="text-gray-600">Weekend
                                                                                                                                (<span
                                                                                                                                    id="summaryWeekendNights">0</span>
                                                                                                                                ×
                                                                                                                                €<span
                                                                                                                                    id="summaryUnitPriceWeekend">0.00</span>):</span>
                                                                                                                            <span
                                                                                                                                class="font-mono font-semibold text-gray-700">€<span
                                                                                                                                    id="summaryTotalWeekendNightCost">0.00</span></span>
                                                                                                                        </div>
                                                                                                                    </div>
                                                                                                                    <div
                                                                                                                        class="flex justify-between items-center py-2 border-t border-green-200">
                                                                                                                        <span
                                                                                                                            class="text-sm font-medium text-gray-700">Boat
                                                                                                                            Cost:</span>
                                                                                                                        <span
                                                                                                                            class="text-base font-bold text-gray-900 font-mono">€<span
                                                                                                                                id="summaryBoatCost">0.00</span></span>
                                                                                                                    </div>
                                                                                                                    <div
                                                                                                                        class="flex justify-between items-center py-2">
                                                                                                                        <span
                                                                                                                            class="text-sm font-medium text-gray-700">Extras
                                                                                                                            Cost:</span>
                                                                                                                        <span
                                                                                                                            class="text-base font-bold text-gray-900 font-mono">€<span
                                                                                                                                id="summaryExtrasCost">0.00</span></span>
                                                                                                                    </div>
                                                                                                                    <div
                                                                                                                        class="flex justify-between items-center py-2 border-t border-green-200">
                                                                                                                        <span
                                                                                                                            class="text-sm font-medium text-gray-700">Subtotal:</span>
                                                                                                                        <span
                                                                                                                            class="text-base font-bold text-gray-900 font-mono">€<span
                                                                                                                                id="summarySubtotal">0.00</span></span>
                                                                                                                    </div>
                                                                                                                    <div
                                                                                                                        class="flex justify-between items-center py-2">
                                                                                                                        <span
                                                                                                                            class="text-sm font-medium text-gray-700">Tax:</span>
                                                                                                                        <span
                                                                                                                            class="text-base font-semibold text-amber-600 font-mono">+€<span
                                                                                                                                id="summaryTaxAmountApplied">0.00</span></span>
                                                                                                                    </div>
                                                                                                                    <div
                                                                                                                        class="flex justify-between items-center py-2">
                                                                                                                        <span
                                                                                                                            class="text-sm font-medium text-gray-700">Discount:</span>
                                                                                                                        <span
                                                                                                                            class="text-base font-semibold text-red-600 font-mono">-€<span
                                                                                                                                id="summaryDiscountAmount">0.00</span></span>
                                                                                                                    </div>
                                                                                                                    <div
                                                                                                                        class="flex justify-between items-center py-4 border-t-2 border-green-400 bg-white rounded-lg px-3 shadow-sm">
                                                                                                                        <span
                                                                                                                            class="text-lg font-bold text-gray-900">Total
                                                                                                                            Cost:</span>
                                                                                                                        <span
                                                                                                                            class="text-2xl font-black text-green-600 font-mono tracking-tight">€<span
                                                                                                                                id="summaryTotalCost">0.00</span></span>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                                < !--
                                                                                                                    Calculation
                                                                                                                    Status
                                                                                                                    -->
                                                                                                                    <div id="calculationStatus"
                                                                                                                        class="text-center text-xs text-gray-500 italic py-2">
                                                                                                                        Enter
                                                                                                                        booking
                                                                                                                        details
                                                                                                                        to
                                                                                                                        calculate
                                                                                                                        price
                                                                                                                    </div>
                                                                                                    </div>
                                                                                                    < !-- Action Buttons
                                                                                                        -->
                                                                                                        <div
                                                                                                            class="space-y-2 mt-6 pt-4 border-t-2 border-green-200">
                                                                                                            <button
                                                                                                                type="button"
                                                                                                                onclick="calculatePriceNow()"
                                                                                                                class="w-full btn-secondary flex items-center justify-center">
                                                                                                                <i data-lucide="calculator"
                                                                                                                    class="mr-2 h-4 w-4"></i>
                                                                                                                <span>Calculate
                                                                                                                    Price</span>
                                                                                                            </button>
                                                                                                            <button
                                                                                                                type="button"
                                                                                                                onclick="previewInvoice()"
                                                                                                                class="w-full btn-secondary-alt flex items-center justify-center">
                                                                                                                <i data-lucide="eye"
                                                                                                                    class="mr-2 h-4 w-4"></i>
                                                                                                                <span
                                                                                                                    data-translate-key="buttons.previewInvoice">Preview
                                                                                                                    Invoice</span>
                                                                                                            </button>
                                                                                                            <button
                                                                                                                type="button"
                                                                                                                onclick="handleSaveOrUpdateReservation()"
                                                                                                                class="w-full btn-primary text-lg py-3 flex items-center justify-center">
                                                                                                                <i data-lucide="check-circle"
                                                                                                                    class="mr-2 h-5 w-5"></i>
                                                                                                                <span
                                                                                                                    id="mainSubmitBtnText"
                                                                                                                    data-translate-key="buttons.saveReservation">Save
                                                                                                                    Reservation</span>
                                                                                                            </button>
                                                                                                        </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                            </div>
                                                                        </form>
                                                            </div>
                                                        </div>
                                                        <div id="view-reservations-view" class="view-content hidden">
                                                            < !-- Header with Title and Export Buttons -->
                                                                <div
                                                                    class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                                                    <h2 class="text-2xl font-semibold text-gray-800"
                                                                        data-translate-key="viewReservations.title">
                                                                        Current Reservations</h2>
                                                                    <div class="flex gap-2"> <button
                                                                            onclick="exportReservationsToCSV()"
                                                                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg shadow-md flex items-center gap-2 transition-all hover:scale-105">
                                                                            <i data-lucide="file-spreadsheet"
                                                                                class="h-4 w-4"></i> <span>Export
                                                                                CSV</span> </button> <button
                                                                            onclick="exportReservationsToPDF()"
                                                                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg shadow-md flex items-center gap-2 transition-all hover:scale-105">
                                                                            <i data-lucide="file-text"
                                                                                class="h-4 w-4"></i> <span>Export
                                                                                PDF</span> </button> </div>
                                                                </div>
                                                                < !-- Advanced Filters Panel -->
                                                                    <div class="bg-white rounded-lg shadow-md p-4 mb-4">
                                                                        <div
                                                                            class="flex items-center justify-between mb-3">
                                                                            <h3
                                                                                class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                                                                <i data-lucide="filter"
                                                                                    class="h-5 w-5 text-indigo-600"></i>
                                                                                Filters
                                                                            </h3> <button
                                                                                onclick="clearReservationFilters()"
                                                                                class="text-sm text-gray-600 hover:text-indigo-600 font-medium flex items-center gap-1">
                                                                                <i data-lucide="x-circle"
                                                                                    class="h-4 w-4"></i> Clear All
                                                                            </button>
                                                                        </div>
                                                                        <div
                                                                            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                                                                            < !-- Search -->
                                                                                <div> <label
                                                                                        class="block text-xs font-medium text-gray-600 mb-1">Search</label>
                                                                                    <input type="text"
                                                                                        id="reservationSearch"
                                                                                        placeholder="Name, Boat, ID..."
                                                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                                                </div>
                                                                                < !-- Status Filter -->
                                                                                    <div> <label
                                                                                            class="block text-xs font-medium text-gray-600 mb-1">Status</label>
                                                                                        <select id="filterStatus"
                                                                                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                                                            <option value="">All
                                                                                                Statuses</option>
                                                                                            <option value="Confirmed">
                                                                                                Confirmed</option>
                                                                                            <option value="Pending">
                                                                                                Pending</option>
                                                                                            <option value="Cancelled">
                                                                                                Cancelled</option>
                                                                                        </select>
                                                                                    </div>
                                                                                    < !-- Source Filter -->
                                                                                        <div> <label
                                                                                                class="block text-xs font-medium text-gray-600 mb-1">Source</label>
                                                                                            <select id="filterSource"
                                                                                                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                                                                <option value="">All
                                                                                                    Sources</option>
                                                                                                <option value="AMIEIRA">
                                                                                                    AMIEIRA</option>
                                                                                                <option value="NICOLS">
                                                                                                    NICOLS</option>
                                                                                                <option
                                                                                                    value="Ancorado">
                                                                                                    Ancorado</option>
                                                                                                <option value="Diaria">
                                                                                                    Diaria</option>
                                                                                                <option value="OTHER">
                                                                                                    OTHER</option>
                                                                                            </select>
                                                                                        </div>
                                                                                        < !-- Date From -->
                                                                                            <div> <label
                                                                                                    class="block text-xs font-medium text-gray-600 mb-1">Check-in
                                                                                                    From</label> <input
                                                                                                    type="date"
                                                                                                    id="filterDateFrom"
                                                                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                                                            </div>
                                                                                            < !-- Date To -->
                                                                                                <div> <label
                                                                                                        class="block text-xs font-medium text-gray-600 mb-1">Check-in
                                                                                                        To</label>
                                                                                                    <input type="date"
                                                                                                        id="filterDateTo"
                                                                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                                                                </div>
                                                                        </div>
                                                                        < !-- Payment Status Filter (Full Width Row) -->
                                                                            <div
                                                                                class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-3">
                                                                                <div> <label
                                                                                        class="block text-xs font-medium text-gray-600 mb-1">Payment
                                                                                        Status</label> <select
                                                                                        id="filterPaymentStatus"
                                                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                                                                        <option value="">All Payments
                                                                                        </option>
                                                                                        <option value="paid">Fully Paid
                                                                                        </option>
                                                                                        <option value="partial">
                                                                                            Partially Paid</option>
                                                                                        <option value="unpaid">Unpaid
                                                                                        </option>
                                                                                    </select> </div>
                                                                                < !-- Apply Filters Button -->
                                                                                    <div
                                                                                        class="md:col-span-2 flex items-end">
                                                                                        <button
                                                                                            onclick="applyReservationFilters()"
                                                                                            class="w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-md shadow-md flex items-center justify-center gap-2 transition-all hover:scale-105">
                                                                                            <i data-lucide="search"
                                                                                                class="h-4 w-4"></i>
                                                                                            Apply Filters </button>
                                                                                    </div>
                                                                            </div>
                                                                            < !-- Active Filters Display -->
                                                                                <div id="activeFiltersDisplay"
                                                                                    class="mt-3 hidden">
                                                                                    <div
                                                                                        class="flex flex-wrap gap-2 items-center">
                                                                                        <span
                                                                                            class="text-xs font-medium text-gray-600">Active:</span>
                                                                                        <div id="activeFilterTags"
                                                                                            class="flex flex-wrap gap-2">
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                    </div>
                                                                    < !-- Table Container -->
                                                                        <div
                                                                            class="bg-white rounded-lg shadow-lg overflow-hidden">
                                                                            <table
                                                                                class="min-w-full divide-y divide-gray-200">
                                                                                <thead class="bg-gray-50">
                                                                                    <tr>
                                                                                        <th scope="col"
                                                                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                            data-translate-key="viewReservations.table.client">
                                                                                            Client</th>
                                                                                        <th scope="col"
                                                                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                            data-translate-key="viewReservations.table.boat">
                                                                                            Boat</th>
                                                                                        <th scope="col"
                                                                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                            data-translate-key="viewReservations.table.checkIn">
                                                                                            Check-in</th>
                                                                                        <th scope="col"
                                                                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                            data-translate-key="viewReservations.table.checkOut">
                                                                                            Check-out</th>
                                                                                        <th scope="col"
                                                                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                            data-translate-key="viewReservations.table.total">
                                                                                            Total</th>
                                                                                        <th scope="col"
                                                                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                            data-translate-key="payments_total_paid">
                                                                                            Paid</th>
                                                                                        <th scope="col"
                                                                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                            data-translate-key="payments_amount_due">
                                                                                            Due</th>
                                                                                        <th scope="col"
                                                                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                            data-translate-key="viewReservations.table.status">
                                                                                            Status</th>
                                                                                        <th scope="col"
                                                                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                            data-translate-key="viewReservations.table.source">
                                                                                            Source</th>
                                                                                        <th scope="col"
                                                                                            class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                            data-translate-key="viewReservations.table.actions">
                                                                                            Actions</th>
                                                                                    </tr>
                                                                                </thead>
                                                                                <tbody id="reservationsTableBody"
                                                                                    class="bg-white divide-y divide-gray-200">
                                                                                    <tr>
                                                                                        <td colspan="10"
                                                                                            class="text-center py-4 text-gray-500"
                                                                                            data-translate-key="viewReservations.table.loading">
                                                                                            Loading reservations...</td>
                                                                                    </tr>
                                                                                </tbody>
                                                                            </table>
                                                                        </div>
                                                                        <div id="paginationControls"
                                                                            class="mt-6 flex justify-center items-center space-x-2">
                                                                        </div>
                                                        </div>
                                                        <div id="calendar-view" class="view-content hidden">
                                                            <h2 class="text-2xl font-semibold text-gray-800 mb-6 calendar-title-bar"
                                                                data-translate-key="calendar.title">Yearly Reservations
                                                                Calendar</h2>
                                                            <div class="bg-white p-6 rounded-lg shadow-lg">
                                                                <div
                                                                    class="flex flex-wrap justify-between items-center mb-4 gap-4">
                                                                    < !-- Year navigation -->
                                                                        <div class="flex items-center space-x-2">
                                                                            <button id="prevYearBtn"
                                                                                class="p-2 rounded-md hover:bg-gray-200 flex items-center text-sm transition-colors"><i
                                                                                    data-lucide="chevron-left"
                                                                                    class="h-4 w-4 mr-1"></i> <span
                                                                                    data-translate-key="calendar.prevYear">Prev
                                                                                    Year</span></button>
                                                                            <h3 id="currentYearDisplay"
                                                                                class="text-xl font-semibold">Year</h3>
                                                                            <button id="nextYearBtn"
                                                                                class="p-2 rounded-md hover:bg-gray-200 flex items-center text-sm transition-colors"><span
                                                                                    data-translate-key="calendar.nextYear">Next
                                                                                    Year</span> <i
                                                                                    data-lucide="chevron-right"
                                                                                    class="h-4 w-4 ml-1"></i></button>
                                                                        </div>
                                                                        < !-- Client Search -->
                                                                            <div class="flex items-center space-x-2">
                                                                                <label for="calendarClientSearch"
                                                                                    class="text-sm font-medium text-gray-700"
                                                                                    data-translate-key="calendar.searchClientLabel">Search
                                                                                    Client:</label> <input type="text"
                                                                                    id="calendarClientSearch"
                                                                                    data-translate-key="calendar.searchClientPlaceholder"
                                                                                    data-translate-type="placeholder"
                                                                                    placeholder="Client Name..."
                                                                                    class="form-input px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500 w-48">
                                                                                <button id="calendarSearchBtn"
                                                                                    class="btn-gradient-indigo text-white font-semibold py-1.5 px-3 rounded-md shadow text-sm flex items-center transition-transform hover:scale-105"><i
                                                                                        data-lucide="search"
                                                                                        class="h-4 w-4 mr-1"></i> <span
                                                                                        data-translate-key="buttons.find">Find</span></button>
                                                                            </div>
                                                                            < !-- UPDATED: Availability Range Filter -->
                                                                                <div
                                                                                    class="flex items-center space-x-2 p-2 bg-indigo-50 border border-indigo-200 rounded-lg">
                                                                                    <label for="availabilityCheckIn"
                                                                                        class="text-sm font-medium text-gray-700"
                                                                                        data-translate-key="calendar.checkinLabel">Check-in:</label>
                                                                                    <input type="date"
                                                                                        id="availabilityCheckIn"
                                                                                        class="form-input px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                                                                    <label for="availabilityCheckOut"
                                                                                        class="text-sm font-medium text-gray-700"
                                                                                        data-translate-key="calendar.checkoutLabel">Check-out:</label>
                                                                                    <input type="date"
                                                                                        id="availabilityCheckOut"
                                                                                        class="form-input px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500">
                                                                                    <button id="findAvailabilityBtn"
                                                                                        class="btn-gradient-teal text-white font-semibold py-1.5 px-3 rounded-md shadow text-sm flex items-center transition-transform hover:scale-105">
                                                                                        <i data-lucide="calendar-search"
                                                                                            class="h-4 w-4 mr-1"></i>
                                                                                        <span
                                                                                            data-translate-key="buttons.findAvailability">Find</span>
                                                                                    </button>
                                                                                </div>
                                                                                < !-- Refresh and Fullscreen -->
                                                                                    <div
                                                                                        class="flex items-center space-x-2">
                                                                                        <button id="refreshCalendarBtn"
                                                                                            class="btn-gradient-green text-white font-semibold py-1.5 px-3 rounded-md shadow text-sm flex items-center transition-transform hover:scale-105">
                                                                                            <i data-lucide="rotate-cw"
                                                                                                class="h-4 w-4 mr-1"></i>
                                                                                            <span>Refresh</span>
                                                                                        </button>
                                                                                        < !-- Find and REPLACE this
                                                                                            entire button --> <button
                                                                                                id="calendarFullscreenBtn"
                                                                                                onclick="toggleCalendarFullscreen()"
                                                                                                class="btn-gradient-purple text-white font-semibold py-1.5 px-3 rounded-md shadow text-sm flex items-center transition-transform hover:scale-105">
                                                                                                <i data-lucide="maximize"
                                                                                                    class="h-4 w-4 mr-1 icon-maximize"></i>
                                                                                                <i data-lucide="minimize"
                                                                                                    class="h-4 w-4 mr-1 icon-minimize hidden"></i>
                                                                                                <span
                                                                                                    data-translate-key="calendar.fullscreen">Fullscreen</span>
                                                                                            </button>
                                                                                    </div>
                                                                </div>
                                                                <div class="mt-4 mb-2 legend-bar">
                                                                    <h4 class="font-semibold"
                                                                        data-translate-key="calendar.legendTitle">
                                                                        Legend:</h4>
                                                                    <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm">
                                                                        <p><span
                                                                                class="inline-block w-3 h-3 status-Confirmed rounded-sm mr-1 align-middle"></span>
                                                                            <span
                                                                                data-translate-key="calendar.legend.confirmedOther">Confirmed
                                                                                (Other)</span>
                                                                        </p>
                                                                        <p><span
                                                                                class="inline-block w-3 h-3 status-Pending rounded-sm mr-1 align-middle"></span>
                                                                            <span
                                                                                data-translate-key="calendar.legend.pendingOther">Pending
                                                                                (Other)</span>
                                                                        </p>
                                                                        <p><span
                                                                                class="inline-block w-3 h-3 source-AMIEIRA status-Confirmed rounded-sm mr-1 align-middle"></span>
                                                                            <span
                                                                                data-translate-key="calendar.legend.confirmedAmieira">Confirmed
                                                                                (AMIEIRA)</span>
                                                                        </p>
                                                                        <p><span
                                                                                class="inline-block w-3 h-3 source-AMIEIRA status-Pending rounded-sm mr-1 align-middle"></span>
                                                                            <span
                                                                                data-translate-key="calendar.legend.pendingAmieira">Pending
                                                                                (AMIEIRA)</span>
                                                                        </p>
                                                                        <p><span
                                                                                class="inline-block w-3 h-3 source-NICOLS rounded-sm mr-1 align-middle"></span>
                                                                            <span
                                                                                data-translate-key="calendar.legend.anyNicols">Any
                                                                                (NICOLS)</span>
                                                                        </p>
                                                                        <p><span
                                                                                class="inline-block w-3 h-3 status-Cancelled rounded-sm mr-1 align-middle"></span>
                                                                            <span
                                                                                data-translate-key="calendar.legend.cancelled">Cancelled</span>
                                                                        </p>
                                                                    </div>
                                                                </div>
                                                                <div id="calendarYearGridContainer"
                                                                    class="calendar-grid-container border border-gray-300 rounded">
                                                                    <div
                                                                        class="p-8 text-center text-gray-500 flex items-center justify-center">
                                                                        <div
                                                                            class="pro-spinner !border-slate-500 !border-t-transparent mr-2 !w-6 !h-6">
                                                                        </div> $ {
                                                                        _t('calendar.loadingGrid')
                                                                        }

                                                                    </div>
                                                                </div>
                                                                < !-- REPLACE your existing #quickAddPanel div with this
                                                                    -->
                                                                    <div id="quickAddPanel"
                                                                        class="absolute top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl z-40 transform translate-x-full transition-transform duration-300 ease-in-out border-l border-gray-200 flex flex-col">
                                                                        <div
                                                                            class="flex justify-between items-center p-4 border-b bg-gray-50">
                                                                            <h3 id="quickAddPanelTitle"
                                                                                class="text-lg font-semibold text-gray-800">
                                                                                New Reservation </h3><button
                                                                                onclick="closeQuickAddPanel()"
                                                                                class="p-2 rounded-full hover:bg-gray-200 transition-colors"><i
                                                                                    data-lucide="x"
                                                                                    class="h-5 w-5 text-gray-600"></i></button>
                                                                        </div>
                                                                        <div class="flex-grow overflow-y-auto p-6">
                                                                            <form id="quickAddReservationForm"
                                                                                class="space-y-4">
                                                                                <fieldset
                                                                                    class="border border-gray-200 p-3 rounded-md">
                                                                                    <legend
                                                                                        class="text-md font-medium text-gray-700 px-2">
                                                                                        Booking Details</legend>
                                                                                    <div
                                                                                        class="grid grid-cols-2 gap-4 mt-2">
                                                                                        <div class="col-span-2"><label
                                                                                                class="block text-sm font-medium text-gray-700">Boat</label><input
                                                                                                type="text"
                                                                                                id="quickAddBoatName"
                                                                                                name="boatName" readonly
                                                                                                class="mt-1 block w-full px-3 py-2 border-gray-300 rounded-md shadow-sm bg-gray-100 sm:text-sm"><input
                                                                                                type="hidden"
                                                                                                id="quickAddBoatId"
                                                                                                name="boatId"></div>
                                                                                        <div><label
                                                                                                for="quickAddCheckInDate"
                                                                                                class="block text-sm font-medium text-gray-700">Check-in</label><input
                                                                                                type="date"
                                                                                                id="quickAddCheckInDate"
                                                                                                name="checkInDate"
                                                                                                required
                                                                                                class="wizard-input mt-1 price-recalc-trigger">
                                                                                        </div>
                                                                                        <div><label
                                                                                                for="quickAddCheckInTime"
                                                                                                class="block text-sm font-medium text-gray-700">Time</label><input
                                                                                                type="time"
                                                                                                id="quickAddCheckInTime"
                                                                                                name="checkInTime"
                                                                                                required
                                                                                                class="wizard-input mt-1 price-recalc-trigger">
                                                                                        </div>
                                                                                        <div><label
                                                                                                for="quickAddCheckOutDate"
                                                                                                class="block text-sm font-medium text-gray-700">Check-out</label><input
                                                                                                type="date"
                                                                                                id="quickAddCheckOutDate"
                                                                                                name="checkOutDate"
                                                                                                required
                                                                                                class="wizard-input mt-1 price-recalc-trigger">
                                                                                        </div>
                                                                                        <div><label
                                                                                                for="quickAddCheckOutTime"
                                                                                                class="block text-sm font-medium text-gray-700">Time</label><input
                                                                                                type="time"
                                                                                                id="quickAddCheckOutTime"
                                                                                                name="checkOutTime"
                                                                                                required
                                                                                                class="wizard-input mt-1 price-recalc-trigger">
                                                                                        </div>
                                                                                    </div>
                                                                                </fieldset>
                                                                                < !-- This is the new, detailed price
                                                                                    summary section -->
                                                                                    <div id="quickAddPriceSummary"
                                                                                        class="mt-4 p-3 bg-gray-50 rounded-md border border-gray-200 space-y-1 text-sm">
                                                                                        <p class="text-gray-500">Select
                                                                                            dates to see price...</p>
                                                                                    </div>
                                                                                    <fieldset
                                                                                        class="border border-gray-200 p-3 rounded-md">
                                                                                        <legend
                                                                                            class="text-md font-medium text-gray-700 px-2">
                                                                                            Client & Details</legend>
                                                                                        <div class="space-y-3 mt-2">
                                                                                            <div><label
                                                                                                    for="quickAddClientName"
                                                                                                    class="block text-sm font-medium text-gray-700">Full
                                                                                                    Name</label><input
                                                                                                    type="text"
                                                                                                    id="quickAddClientName"
                                                                                                    name="clientName"
                                                                                                    required
                                                                                                    class="wizard-input mt-1">
                                                                                            </div>
                                                                                            <div
                                                                                                class="grid grid-cols-2 gap-4">
                                                                                                <div><label
                                                                                                        for="quickAddStatus"
                                                                                                        class="block text-sm font-medium text-gray-700">Status</label><select
                                                                                                        id="quickAddStatus"
                                                                                                        name="status"
                                                                                                        required
                                                                                                        class="wizard-input mt-1">
                                                                                                        <option
                                                                                                            value="Confirmed">
                                                                                                            Confirmed
                                                                                                        </option>
                                                                                                        <option
                                                                                                            value="Pending">
                                                                                                            Pending
                                                                                                        </option>
                                                                                                    </select></div>
                                                                                                <div><label
                                                                                                        for="quickAddReservationSource"
                                                                                                        class="block text-sm font-medium text-gray-700">Source</label><select
                                                                                                        id="quickAddReservationSource"
                                                                                                        name="reservationSource"
                                                                                                        required
                                                                                                        class="wizard-input mt-1">
                                                                                                        <option
                                                                                                            value="AMIEIRA">
                                                                                                            AMIEIRA
                                                                                                        </option>
                                                                                                        <option
                                                                                                            value="NICOLS">
                                                                                                            NICOLS
                                                                                                        </option>
                                                                                                        <option
                                                                                                            value="Ancorado">
                                                                                                            Ancorado
                                                                                                        </option>
                                                                                                        <option
                                                                                                            value="Diaria">
                                                                                                            Diaria
                                                                                                        </option>
                                                                                                        <option
                                                                                                            value="OTHER">
                                                                                                            OTHER
                                                                                                        </option>
                                                                                                    </select></div>
                                                                                            </div>
                                                                                            < !-- NEW DISCOUNT FIELD -->
                                                                                                <div><label
                                                                                                        for="quickAddDiscountPercentage"
                                                                                                        class="block text-sm font-medium text-gray-700">Discount
                                                                                                        (%)</label><input
                                                                                                        type="number"
                                                                                                        id="quickAddDiscountPercentage"
                                                                                                        name="discountPercentage"
                                                                                                        value="0"
                                                                                                        min="0"
                                                                                                        max="100"
                                                                                                        step="0.01"
                                                                                                        class="wizard-input mt-1 price-recalc-trigger">
                                                                                                </div>
                                                                                        </div>
                                                                                    </fieldset>
                                                                                    <div class="pt-4"><button
                                                                                            type="submit"
                                                                                            class="w-full btn-primary py-3 px-4 text-base justify-center"><i
                                                                                                data-lucide="check-circle"
                                                                                                class="mr-2 h-5 w-5"></i>Create
                                                                                            Reservation </button></div>
                                                                            </form>
                                                                        </div>
                                                                    </div>
                                                            </div>
                                                        </div>
                                                        < !-- THIS IS THE COMPLETE, CORRECTED BLOCK TO COPY AND PASTE
                                                            -->
                                                            <div id="reports-view" class="view-content hidden">
                                                                < !-- Section 1: Reservation Report -->
                                                                    <h2 class="text-2xl font-semibold text-gray-800 mb-6"
                                                                        data-translate-key="reports.title">Generate
                                                                        Reservation Report</h2>
                                                                    <div
                                                                        class="bg-white p-8 rounded-lg shadow-lg space-y-6 mb-8">
                                                                        <p class="text-sm text-gray-600"
                                                                            data-translate-key="reports.description">
                                                                            Select a date range to generate a PDF report
                                                                            of check-ins and check-outs.</p>
                                                                        <div
                                                                            class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                                            <div><label for="reportStartDate"
                                                                                    class="block text-sm font-medium text-gray-700"
                                                                                    data-translate-key="reports.startDateLabel">Start
                                                                                    Date</label><input type="date"
                                                                                    id="reportStartDate"
                                                                                    name="reportStartDate" required
                                                                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                                            </div>
                                                                            <div><label for="reportEndDate"
                                                                                    class="block text-sm font-medium text-gray-700"
                                                                                    data-translate-key="reports.endDateLabel">End
                                                                                    Date</label><input type="date"
                                                                                    id="reportEndDate"
                                                                                    name="reportEndDate" required
                                                                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                                            </div>
                                                                        </div>
                                                                        <div class="flex justify-end pt-4"><button
                                                                                id="generateReportPdfButton"
                                                                                class="px-6 py-3 btn-gradient-green text-white font-medium text-xs leading-tight uppercase rounded-md shadow-md hover:shadow-lg focus:shadow-lg focus:outline-none focus:ring-0 active:shadow-lg transition-all duration-150 ease-in-out flex items-center hover:scale-105"><i
                                                                                    data-lucide="download-cloud"
                                                                                    class="mr-2 h-5 w-5"></i><span
                                                                                    data-translate-key="reports.generateBtn">Generate
                                                                                    & Download Report</span></button>
                                                                        </div>
                                                                    </div>
                                                                    < !-- Section 2: Client Information Downloads -->
                                                                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 mt-10"
                                                                            data-translate-key="reports.clientDownloadsTitle">
                                                                            Client Information Downloads</h2>
                                                                        <div
                                                                            class="bg-white p-8 rounded-lg shadow-lg space-y-4">
                                                                            <p class="text-sm text-gray-600"
                                                                                data-translate-key="reports.clientDownloadsDescription">
                                                                                Download PDF lists of available boats,
                                                                                current tariffs,
                                                                                and optional extras for clients.</p>
                                                                            <div
                                                                                class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4">
                                                                                <button id="generateBoatsListPdfButton"
                                                                                    class="px-6 py-3 btn-gradient-blue text-white font-medium text-xs leading-tight uppercase rounded-md shadow-md hover:shadow-lg focus:shadow-lg focus:outline-none focus:ring-0 active:shadow-lg transition-all duration-150 ease-in-out flex items-center justify-center hover:scale-105"><i
                                                                                        data-lucide="ship"
                                                                                        class="mr-2 h-5 w-5"></i><span
                                                                                        data-translate-key="reports.boatsListBtn">Download
                                                                                        Boats
                                                                                        List</span></button><button
                                                                                    id="generateTariffsBrochurePdfButton"
                                                                                    class="px-6 py-3 btn-gradient-purple text-white font-medium text-xs leading-tight uppercase rounded-md shadow-md hover:shadow-lg focus:shadow-lg focus:outline-none focus:ring-0 active:shadow-lg transition-all duration-150 ease-in-out flex items-center justify-center hover:scale-105"><i
                                                                                        data-lucide="dollar-sign"
                                                                                        class="mr-2 h-5 w-5"></i><span
                                                                                        data-translate-key="reports.tariffsBrochureBtn">Download
                                                                                        Tariffs
                                                                                        Brochure</span></button><button
                                                                                    id="generateExtrasListPdfButton"
                                                                                    class="px-6 py-3 btn-gradient-teal text-white font-medium text-xs leading-tight uppercase rounded-md shadow-md hover:shadow-lg focus:shadow-lg focus:outline-none focus:ring-0 active:shadow-lg transition-all duration-150 ease-in-out flex items-center justify-center hover:scale-105"><i
                                                                                        data-lucide="puzzle"
                                                                                        class="mr-2 h-5 w-5"></i><span
                                                                                        data-translate-key="reports.extrasListBtn">Download
                                                                                        Extras List</span></button>
                                                                            </div>
                                                                        </div>
                                                                        < !-- NEW SECTION: Daily Activity Report -->
                                                                            <h2
                                                                                class="text-2xl font-semibold text-gray-800 mb-6 mt-10">
                                                                                Daily Activity Report</h2>
                                                                            <div
                                                                                class="bg-white p-8 rounded-lg shadow-lg space-y-6">
                                                                                <p class="text-sm text-gray-600">
                                                                                    Generate a landscape PDF summarizing
                                                                                    daily check-ins,
                                                                                    check-outs,
                                                                                    and travels for a selected period.
                                                                                    Includes space for notes.</p>
                                                                                <div
                                                                                    class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                                                    <div><label
                                                                                            for="dailyActivityReportStartDate"
                                                                                            class="block text-sm font-medium text-gray-700">Start
                                                                                            Date</label><input
                                                                                            type="date"
                                                                                            id="dailyActivityReportStartDate"
                                                                                            name="dailyActivityReportStartDate"
                                                                                            required
                                                                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                                                    </div>
                                                                                    <div><label
                                                                                            for="dailyActivityReportEndDate"
                                                                                            class="block text-sm font-medium text-gray-700">End
                                                                                            Date</label><input
                                                                                            type="date"
                                                                                            id="dailyActivityReportEndDate"
                                                                                            name="dailyActivityReportEndDate"
                                                                                            required
                                                                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                                                    </div>
                                                                                </div>
                                                                                <div class="flex justify-end pt-4">
                                                                                    <button
                                                                                        id="generateDailyActivityReportBtn"
                                                                                        class="px-6 py-3 btn-gradient-purple text-white font-medium text-xs leading-tight uppercase rounded-md shadow-md hover:shadow-lg focus:shadow-lg focus:outline-none focus:ring-0 active:shadow-lg transition-all duration-150 ease-in-out flex items-center hover:scale-105"><i
                                                                                            data-lucide="layout-grid"
                                                                                            class="mr-2 h-5 w-5"></i><span>Generate
                                                                                            Activity
                                                                                            Report</span></button>
                                                                                </div>
                                                                            </div>
                                                                            < !-- Section 4: Generate Stay Sheets -->
                                                                                <h2
                                                                                    class="text-2xl font-semibold text-gray-800 mb-6 mt-10">
                                                                                    Generate Stay Sheets</h2>
                                                                                <div
                                                                                    class="bg-white p-8 rounded-lg shadow-lg space-y-6">
                                                                                    <p class="text-sm text-gray-600">
                                                                                        Select a check-in date range to
                                                                                        generate a printable "Ficha de
                                                                                        Estadia" for each reservation.
                                                                                    </p>
                                                                                    <div
                                                                                        class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                                                        <div><label
                                                                                                for="staySheetStartDate"
                                                                                                class="block text-sm font-medium text-gray-700">Check-in
                                                                                                Start Date</label><input
                                                                                                type="date"
                                                                                                id="staySheetStartDate"
                                                                                                name="staySheetStartDate"
                                                                                                required
                                                                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                                                        </div>
                                                                                        <div><label
                                                                                                for="staySheetEndDate"
                                                                                                class="block text-sm font-medium text-gray-700">Check-in
                                                                                                End Date</label><input
                                                                                                type="date"
                                                                                                id="staySheetEndDate"
                                                                                                name="staySheetEndDate"
                                                                                                required
                                                                                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="flex justify-end pt-4">
                                                                                        <button
                                                                                            id="generateStaySheetsPdfButton"
                                                                                            class="px-6 py-3 btn-gradient-teal text-white font-medium text-xs leading-tight uppercase rounded-md shadow-md hover:shadow-lg focus:shadow-lg focus:outline-none focus:ring-0 active:shadow-lg transition-all duration-150 ease-in-out flex items-center hover:scale-105"><i
                                                                                                data-lucide="printer"
                                                                                                class="mr-2 h-5 w-5"></i><span>Generate
                                                                                                Stay
                                                                                                Sheets</span></button>
                                                                                    </div>
                                                                                </div>
                                                                                < !-- Section 3: Global Financial Report
                                                                                    -->
                                                                                    <h2 class="text-2xl font-semibold text-gray-800 mb-6 mt-10"
                                                                                        data-translate-key="reports.financialReportTitle">
                                                                                        Global Financial Report</h2>
                                                                                    <div
                                                                                        class="bg-white p-8 rounded-lg shadow-lg space-y-6">
                                                                                        <p class="text-sm text-gray-600"
                                                                                            data-translate-key="reports.financialReportDescription">
                                                                                            Select a date range to
                                                                                            generate a PDF report of all
                                                                                            transactions (new
                                                                                            reservations and daily
                                                                                            travels) created within that
                                                                                            period.</p>
                                                                                        <div
                                                                                            class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                                                            <div><label
                                                                                                    for="financialReportStartDate"
                                                                                                    class="block text-sm font-medium text-gray-700"
                                                                                                    data-translate-key="reports.startDateLabel">Start
                                                                                                    Date</label><input
                                                                                                    type="date"
                                                                                                    id="financialReportStartDate"
                                                                                                    name="financialReportStartDate"
                                                                                                    required
                                                                                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                                                            </div>
                                                                                            <div><label
                                                                                                    for="financialReportEndDate"
                                                                                                    class="block text-sm font-medium text-gray-700"
                                                                                                    data-translate-key="reports.endDateLabel">End
                                                                                                    Date</label><input
                                                                                                    type="date"
                                                                                                    id="financialReportEndDate"
                                                                                                    name="financialReportEndDate"
                                                                                                    required
                                                                                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                                                                            </div>
                                                                                        </div>
                                                                                        <div
                                                                                            class="flex justify-end pt-4">
                                                                                            <button
                                                                                                id="generateFinancialReportPdfButton"
                                                                                                class="px-6 py-3 btn-gradient-indigo text-white font-medium text-xs leading-tight uppercase rounded-md shadow-md hover:shadow-lg focus:shadow-lg focus:outline-none focus:ring-0 active:shadow-lg transition-all duration-150 ease-in-out flex items-center hover:scale-105"><i
                                                                                                    data-lucide="bar-chart-2"
                                                                                                    class="mr-2 h-5 w-5"></i><span
                                                                                                    data-translate-key="reports.financialGenerateBtn">Generate
                                                                                                    Financial
                                                                                                    Report</span></button>
                                                                                        </div>
                                                                                    </div>
                                                            </div>
                                                            < !-- Daily Travels View - UPDATED LAYOUT -->
                                                                <div id="daily-travels-view"
                                                                    class="view-content hidden">
                                                                    <div class="max-w-7xl mx-auto">
                                                                        < !-- Header -->
                                                                            <div
                                                                                class="bg-white rounded-lg shadow-sm p-6 mb-6">
                                                                                <div
                                                                                    class="flex items-center justify-between">
                                                                                    <div>
                                                                                        <h2
                                                                                            class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                                                                                            <div
                                                                                                class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center shadow-lg">
                                                                                                <i data-lucide="sailboat"
                                                                                                    class="h-6 w-6 text-white"></i>
                                                                                            </div><span
                                                                                                data-translate-key="dailyTravels.list.title">Travel
                                                                                                Bookings</span>
                                                                                        </h2>
                                                                                        <p class="text-gray-600 mt-2">
                                                                                            Manage daily boat trips and
                                                                                            excursions</p>
                                                                                    </div>
                                                                                    <div><button
                                                                                            id="toggleTravelFormBtn"
                                                                                            onclick="toggleTravelForm()"
                                                                                            class="px-6 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-semibold rounded-lg shadow-md transition-all flex items-center gap-2 text-sm"><i
                                                                                                data-lucide="plus-circle"
                                                                                                class="h-4 w-4"></i><span
                                                                                                data-translate-key="dailyTravels.form.addNewBtn">Add
                                                                                                New
                                                                                                Travel</span></button>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div
                                                                                class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                                                                <div class="lg:col-span-2">
                                                                                    <div id="dailyTravelFormContainer"
                                                                                        class="bg-white rounded-lg shadow-sm p-6">
                                                                                        <h3 id="dailyTravelFormTitle"
                                                                                            class="text-xl font-semibold text-gray-900 mb-6 pb-3 border-b-2 border-blue-500 flex items-center gap-2">
                                                                                            <i data-lucide="map"
                                                                                                class="h-5 w-5 text-blue-600"></i><span
                                                                                                data-translate-key="dailyTravels.form.titleNew">New
                                                                                                Travel Booking</span>
                                                                                        </h3>
                                                                                        <form id="dailyTravelForm"
                                                                                            class="space-y-6"><input
                                                                                                type="hidden"
                                                                                                id="travelFormMode"
                                                                                                name="travelFormMode"
                                                                                                value="add"><input
                                                                                                type="hidden"
                                                                                                id="originalTravelId"
                                                                                                name="originalTravelId">
                                                                                            < !-- Client Information -->
                                                                                                <div>
                                                                                                    <h4
                                                                                                        class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide flex items-center gap-2">
                                                                                                        <i data-lucide="user-circle"
                                                                                                            class="h-4 w-4 text-blue-600"></i>Client
                                                                                                        Information
                                                                                                    </h4>
                                                                                                    <div
                                                                                                        class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                                                                        <div><label
                                                                                                                class="block text-sm font-medium text-gray-700 mb-1">Full
                                                                                                                Name
                                                                                                                <span
                                                                                                                    class="text-red-500">*</span></label><input
                                                                                                                type="text"
                                                                                                                id="travelClientName"
                                                                                                                name="clientName"
                                                                                                                required
                                                                                                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 text-sm"
                                                                                                                placeholder="John Doe">
                                                                                                        </div>
                                                                                                        <div><label
                                                                                                                class="block text-sm font-medium text-gray-700 mb-1">Phone</label><input
                                                                                                                type="tel"
                                                                                                                id="travelClientPhone"
                                                                                                                name="clientPhone"
                                                                                                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 text-sm"
                                                                                                                placeholder="+351 123 456 789">
                                                                                                        </div>
                                                                                                        <div><label
                                                                                                                class="block text-sm font-medium text-gray-700 mb-1">Email</label><input
                                                                                                                type="email"
                                                                                                                id="travelClientEmail"
                                                                                                                name="clientEmail"
                                                                                                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 text-sm"
                                                                                                                placeholder="john@example.com">
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </div>
                                                                                                < !-- Trip Details -->
                                                                                                    <div>
                                                                                                        <h4
                                                                                                            class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide flex items-center gap-2">
                                                                                                            <i data-lucide="map-pin"
                                                                                                                class="h-4 w-4 text-blue-600"></i>Trip
                                                                                                            Details
                                                                                                        </h4>
                                                                                                        <div
                                                                                                            class="grid grid-cols-3 gap-4">
                                                                                                            <div><label
                                                                                                                    class="block text-sm font-medium text-gray-700 mb-1">Trip
                                                                                                                    <span
                                                                                                                        class="text-red-500">*</span></label><select
                                                                                                                    id="travelTripName"
                                                                                                                    name="tripName"
                                                                                                                    required
                                                                                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 text-sm travel-calc-trigger">
                                                                                                                    <option
                                                                                                                        value="">
                                                                                                                        Select
                                                                                                                        trip...
                                                                                                                    </option>
                                                                                                                </select>
                                                                                                            </div>
                                                                                                            <div><label
                                                                                                                    class="block text-sm font-medium text-gray-700 mb-1">Date
                                                                                                                    <span
                                                                                                                        class="text-red-500">*</span></label><input
                                                                                                                    type="date"
                                                                                                                    id="travelDate"
                                                                                                                    name="travelDate"
                                                                                                                    required
                                                                                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 text-sm">
                                                                                                            </div>
                                                                                                            <div><label
                                                                                                                    class="block text-sm font-medium text-gray-700 mb-1">Time
                                                                                                                    <span
                                                                                                                        class="text-red-500">*</span></label><input
                                                                                                                    type="time"
                                                                                                                    id="travelTime"
                                                                                                                    name="travelTime"
                                                                                                                    required
                                                                                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 text-sm">
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    < !-- Passengers -->
                                                                                                        <div>
                                                                                                            <h4
                                                                                                                class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide flex items-center gap-2">
                                                                                                                <i data-lucide="users"
                                                                                                                    class="h-4 w-4 text-blue-600"></i>Passengers
                                                                                                            </h4>
                                                                                                            <div
                                                                                                                class="grid grid-cols-3 gap-4">
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        class="block text-sm font-medium text-gray-700 mb-1">Adults</label><input
                                                                                                                        type="number"
                                                                                                                        id="travelAdults"
                                                                                                                        name="adults"
                                                                                                                        value="1"
                                                                                                                        min="0"
                                                                                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-center font-semibold focus:ring-2 focus:ring-blue-500 text-sm travel-calc-trigger">
                                                                                                                </div>
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        class="block text-sm font-medium text-gray-700 mb-1">Children</label><input
                                                                                                                        type="number"
                                                                                                                        id="travelKids"
                                                                                                                        name="kids"
                                                                                                                        value="0"
                                                                                                                        min="0"
                                                                                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-center font-semibold focus:ring-2 focus:ring-blue-500 text-sm travel-calc-trigger">
                                                                                                                </div>
                                                                                                                <div>
                                                                                                                    <label
                                                                                                                        class="block text-sm font-medium text-gray-700 mb-1">Seniors</label><input
                                                                                                                        type="number"
                                                                                                                        id="travelSeniors"
                                                                                                                        name="seniors"
                                                                                                                        value="0"
                                                                                                                        min="0"
                                                                                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-center font-semibold focus:ring-2 focus:ring-blue-500 text-sm travel-calc-trigger">
                                                                                                                </div>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                        < !-- Food
                                                                                                            Options -->
                                                                                                            <div>
                                                                                                                <h4
                                                                                                                    class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide flex items-center gap-2">
                                                                                                                    <i data-lucide="utensils"
                                                                                                                        class="h-4 w-4 text-blue-600"></i>Food
                                                                                                                    &
                                                                                                                    Beverages
                                                                                                                </h4>
                                                                                                                <div id="travelFoodOptionsContainer"
                                                                                                                    class="grid grid-cols-2 gap-3 max-h-40 overflow-y-auto p-2 bg-gray-50 rounded-md border border-gray-200">
                                                                                                                    < !--
                                                                                                                        Populated
                                                                                                                        by
                                                                                                                        JavaScript
                                                                                                                        -->
                                                                                                                </div>
                                                                                                            </div>
                                                                                                            < !--
                                                                                                                Pricing
                                                                                                                -->
                                                                                                                <div>
                                                                                                                    <h4
                                                                                                                        class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide flex items-center gap-2">
                                                                                                                        <i data-lucide="percent"
                                                                                                                            class="h-4 w-4 text-blue-600"></i>Adjustments
                                                                                                                    </h4>
                                                                                                                    <div
                                                                                                                        class="grid grid-cols-2 gap-4">
                                                                                                                        <div>
                                                                                                                            <label
                                                                                                                                class="block text-sm font-medium text-gray-700 mb-1">Discount
                                                                                                                                (%)</label><input
                                                                                                                                type="number"
                                                                                                                                id="travelDiscountPercentage"
                                                                                                                                name="discountPercentage"
                                                                                                                                value="0"
                                                                                                                                min="0"
                                                                                                                                max="100"
                                                                                                                                step="0.01"
                                                                                                                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 text-sm travel-calc-trigger">
                                                                                                                        </div>
                                                                                                                        <div>
                                                                                                                            <label
                                                                                                                                class="block text-sm font-medium text-gray-700 mb-1">Tax
                                                                                                                                (%)</label><input
                                                                                                                                type="number"
                                                                                                                                id="travelTaxPercentage"
                                                                                                                                name="taxPercentage"
                                                                                                                                value="0"
                                                                                                                                min="0"
                                                                                                                                max="100"
                                                                                                                                step="0.01"
                                                                                                                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 text-sm travel-calc-trigger">
                                                                                                                        </div>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                                < !--
                                                                                                                    Notes
                                                                                                                    -->
                                                                                                                    <div>
                                                                                                                        <label
                                                                                                                            class="block text-sm font-medium text-gray-700 mb-1">Notes</label><textarea
                                                                                                                            id="travelNotes"
                                                                                                                            name="notes"
                                                                                                                            rows="2"
                                                                                                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 text-sm"
                                                                                                                            placeholder="Special requirements..."></textarea>
                                                                                                                    </div>
                                                                                                                    < !--
                                                                                                                        Action
                                                                                                                        Buttons
                                                                                                                        -->
                                                                                                                        <div
                                                                                                                            class="flex justify-end gap-3 pt-4 border-t">
                                                                                                                            <button
                                                                                                                                type="button"
                                                                                                                                onclick="resetTravelForm()"
                                                                                                                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-md transition-colors text-sm">Clear
                                                                                                                                Form
                                                                                                                            </button><button
                                                                                                                                type="submit"
                                                                                                                                id="dailyTravelFormSubmitBtn"
                                                                                                                                class="px-6 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-semibold rounded-md shadow-md transition-all flex items-center gap-2 text-sm"><i
                                                                                                                                    data-lucide="check-circle"
                                                                                                                                    class="h-4 w-4"></i><span
                                                                                                                                    data-translate-key="dailyTravels.form.saveBtn">Save
                                                                                                                                    Booking</span></button>
                                                                                                                        </div>
                                                                                        </form>
                                                                                    </div>
                                                                                </div>
                                                                                < !-- RIGHT COLUMN: Price Summary (1/3
                                                                                    width) -->
                                                                                    <div class="lg:col-span-1">
                                                                                        <div class="sticky top-6">
                                                                                            <div
                                                                                                class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg shadow-sm p-6 border-2 border-green-200">
                                                                                                <h4
                                                                                                    class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                                                                                    <i data-lucide="receipt"
                                                                                                        class="h-5 w-5 text-green-600"></i>Price
                                                                                                    Summary
                                                                                                </h4>
                                                                                                <div id="travelPriceSummary"
                                                                                                    class="space-y-2 text-sm">
                                                                                                    <div
                                                                                                        class="flex justify-between py-2 border-b border-green-200">
                                                                                                        <span
                                                                                                            class="text-gray-700">Trip
                                                                                                            Cost:</span><span
                                                                                                            class="font-bold">€<span
                                                                                                                id="summaryTravelTripBaseCost">0.00</span></span>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="flex justify-between py-2 border-b border-green-200">
                                                                                                        <span
                                                                                                            class="text-gray-700">Food:</span><span
                                                                                                            class="font-bold">€<span
                                                                                                                id="summaryTravelFoodCost">0.00</span></span>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="flex justify-between py-2 border-b border-green-200">
                                                                                                        <span
                                                                                                            class="text-gray-700">Subtotal:</span><span
                                                                                                            class="font-bold">€<span
                                                                                                                id="summaryTravelSubtotal">0.00</span></span>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="flex justify-between py-2 border-b border-green-200">
                                                                                                        <span
                                                                                                            class="text-gray-700">Discount:</span><span
                                                                                                            class="font-bold text-red-600">-€<span
                                                                                                                id="summaryTravelDiscountAmount">0.00</span></span>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="flex justify-between py-2 border-b border-green-200">
                                                                                                        <span
                                                                                                            class="text-gray-700">Tax:</span><span
                                                                                                            class="font-bold">€<span
                                                                                                                id="summaryTravelTaxAmount">0.00</span></span>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="flex justify-between py-3 bg-green-600 text-white rounded-lg px-4 mt-3">
                                                                                                        <span
                                                                                                            class="font-bold">Total:</span><span
                                                                                                            class="text-xl font-black">€<span
                                                                                                                id="summaryTravelTotalCost">0.00</span></span>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                            < !-- Quick Tips -->
                                                                                                <div
                                                                                                    class="bg-blue-50 rounded-lg p-4 border border-blue-200 mt-4">
                                                                                                    <h5
                                                                                                        class="font-semibold text-blue-900 mb-2 flex items-center gap-2 text-sm">
                                                                                                        <i data-lucide="lightbulb"
                                                                                                            class="h-4 w-4"></i>Quick
                                                                                                        Tips
                                                                                                    </h5>
                                                                                                    <ul
                                                                                                        class="space-y-1 text-xs text-blue-800">
                                                                                                        <li>• Check
                                                                                                            weather
                                                                                                            before
                                                                                                            confirming
                                                                                                        </li>
                                                                                                        <li>• Confirm
                                                                                                            passenger
                                                                                                            count</li>
                                                                                                        <li>• Update
                                                                                                            food options
                                                                                                            if needed
                                                                                                        </li>
                                                                                                    </ul>
                                                                                                </div>
                                                                                        </div>
                                                                                    </div>
                                                                            </div>
                                                                            < !-- Search Bar -->
                                                                                <div
                                                                                    class="bg-white rounded-lg shadow-sm p-4 mb-6 mt-6">
                                                                                    <div class="relative"><i
                                                                                            data-lucide="search"
                                                                                            class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"></i><input
                                                                                            type="text"
                                                                                            id="travelSearch"
                                                                                            placeholder="Search by client or trip name..."
                                                                                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-sm">
                                                                                    </div>
                                                                                </div>
                                                                                < !-- Table -->
                                                                                    <div
                                                                                        class="bg-white rounded-lg shadow-lg overflow-hidden">
                                                                                        <table
                                                                                            class="min-w-full divide-y divide-gray-200">
                                                                                            <thead class="bg-gray-50">
                                                                                                <tr>
                                                                                                    <th
                                                                                                        class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">
                                                                                                        Client</th>
                                                                                                    <th
                                                                                                        class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">
                                                                                                        Date</th>
                                                                                                    <th
                                                                                                        class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">
                                                                                                        Trip</th>
                                                                                                    <th
                                                                                                        class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">
                                                                                                        People</th>
                                                                                                    <th
                                                                                                        class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">
                                                                                                        Total</th>
                                                                                                    <th
                                                                                                        class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">
                                                                                                        Due</th>
                                                                                                    <th
                                                                                                        class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">
                                                                                                        Status</th>
                                                                                                    <th
                                                                                                        class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase">
                                                                                                        Actions</th>
                                                                                                </tr>
                                                                                            </thead>
                                                                                            <tbody
                                                                                                id="dailyTravelsTableBody"
                                                                                                class="bg-white divide-y divide-gray-200">
                                                                                                <tr>
                                                                                                    <td colspan="8"
                                                                                                        class="text-center py-4 text-gray-500 text-sm">
                                                                                                        Loading
                                                                                                        travels...</td>
                                                                                                </tr>
                                                                                            </tbody>
                                                                                        </table>
                                                                                    </div>
                                                                                    < !-- Pagination -->
                                                                                        <div id="travelsPaginationControls"
                                                                                            class="mt-6 flex justify-center">
                                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                < !-- Travel Calendar View -->
                                                                    <div id="travel-calendar-view"
                                                                        class="view-content hidden">
                                                                        < !-- Header -->
                                                                            <div class="mb-6">
                                                                                <h2
                                                                                    class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                                                                                    <div
                                                                                        class="w-12 h-12 bg-gradient-to-br from-teal-500 to-cyan-600 rounded-xl flex items-center justify-center shadow-lg">
                                                                                        <i data-lucide="calendar-days"
                                                                                            class="h-6 w-6 text-white"></i>
                                                                                    </div><span
                                                                                        data-translate-key="nav.dailyTravels.calendar">Travel
                                                                                        Calendar</span>
                                                                                </h2>
                                                                                <p class="text-gray-600 mt-2 ml-15">View
                                                                                    all scheduled travel bookings on the
                                                                                    calendar</p>
                                                                            </div>
                                                                            < !-- Calendar Container -->
                                                                                <div
                                                                                    class="bg-white rounded-2xl shadow-xl p-6 border-2 border-gray-200">
                                                                                    <div id="travelCalendar"></div>
                                                                                </div>
                                                                                < !-- Legend -->
                                                                                    <div
                                                                                        class="mt-6 bg-gradient-to-r from-teal-50 to-cyan-50 rounded-xl p-6 border-2 border-teal-200">
                                                                                        <h4
                                                                                            class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                                                                                            <i data-lucide="info"
                                                                                                class="h-5 w-5 text-teal-600"></i>Calendar
                                                                                            Legend
                                                                                        </h4>
                                                                                        <div
                                                                                            class="flex flex-wrap gap-4 text-sm">
                                                                                            <div
                                                                                                class="flex items-center gap-2">
                                                                                                <div
                                                                                                    class="w-4 h-4 rounded bg-blue-500">
                                                                                                </div><span
                                                                                                    class="text-gray-700 font-medium">Standard
                                                                                                    Trip</span>
                                                                                            </div>
                                                                                            <div
                                                                                                class="flex items-center gap-2">
                                                                                                <div
                                                                                                    class="w-4 h-4 rounded bg-green-500">
                                                                                                </div><span
                                                                                                    class="text-gray-700 font-medium">Trip
                                                                                                    with Food</span>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                    </div>
                                                                    < !-- DELETE all the separate "manage-..." divs and
                                                                        REPLACE with this single settings view -->
                                                                        <div id="settings-view"
                                                                            class="view-content hidden">
                                                                            <h2 class="text-2xl font-semibold text-gray-800 mb-6"
                                                                                data-translate-key="settings.title">
                                                                                Settings </h2>
                                                                            <div
                                                                                class="bg-white p-2 rounded-lg shadow-lg">
                                                                                < !-- Tab Navigation -->
                                                                                    <div
                                                                                        class="border-b border-gray-200">
                                                                                        <nav id="settings-tabs"
                                                                                            class="-mb-px flex space-x-6"
                                                                                            aria-label="Tabs"><a
                                                                                                href="#"
                                                                                                data-tab="boats"
                                                                                                class="settings-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600"><i
                                                                                                    data-lucide="ship"
                                                                                                    class="inline-block h-5 w-5 mr-2 align-middle"></i><span
                                                                                                    data-translate-key="nav.boats"
                                                                                                    class="align-middle">Boats</span></a><a
                                                                                                href="#"
                                                                                                data-tab="tariffs"
                                                                                                class="settings-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"><i
                                                                                                    data-lucide="dollar-sign"
                                                                                                    class="inline-block h-5 w-5 mr-2 align-middle"></i><span
                                                                                                    data-translate-key="nav.tariffs"
                                                                                                    class="align-middle">Tariffs
                                                                                                    &
                                                                                                    Prices</span></a><a
                                                                                                href="#"
                                                                                                data-tab="extras"
                                                                                                class="settings-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"><i
                                                                                                    data-lucide="puzzle"
                                                                                                    class="inline-block h-5 w-5 mr-2 align-middle"></i><span
                                                                                                    data-translate-key="nav.extras"
                                                                                                    class="align-middle">Extras</span></a><a
                                                                                                href="#"
                                                                                                data-tab="trips"
                                                                                                class="settings-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"><i
                                                                                                    data-lucide="route"
                                                                                                    class="inline-block h-5 w-5 mr-2 align-middle"></i><span
                                                                                                    data-translate-key="nav.trips"
                                                                                                    class="align-middle">Trips</span></a><a
                                                                                                href="#" data-tab="food"
                                                                                                class="settings-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"><i
                                                                                                    data-lucide="utensils-crossed"
                                                                                                    class="inline-block h-5 w-5 mr-2 align-middle"></i><span
                                                                                                    data-translate-key="nav.food"
                                                                                                    class="align-middle">Food</span></a>
                                                                                        </nav>
                                                                                    </div>
                                                                                    < !-- Tab Panels -->
                                                                                        <div class="py-6">
                                                                                            <div id="settings-boats-panel"
                                                                                                class="settings-tab-panel">
                                                                                                < !-- Content from old
                                                                                                    manage-boats-view
                                                                                                    -->
                                                                                                    <div
                                                                                                        class="flex justify-end mb-4">
                                                                                                        <button
                                                                                                            onclick="openBoatModal('add')"
                                                                                                            class="btn-primary flex items-center"><i
                                                                                                                data-lucide="plus"
                                                                                                                class="mr-2 h-5 w-5"></i><span
                                                                                                                data-translate-key="manageBoats.addNewBtn">Add
                                                                                                                New
                                                                                                                Boat</span></button>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="overflow-x-auto">
                                                                                                        <table
                                                                                                            class="min-w-full divide-y divide-gray-200">
                                                                                                            <thead
                                                                                                                class="bg-gray-50">
                                                                                                                <tr>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageBoats.table.id">
                                                                                                                        Unique
                                                                                                                        ID
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageBoats.table.name">
                                                                                                                        Boat
                                                                                                                        Name
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageBoats.table.model">
                                                                                                                        Boat
                                                                                                                        Model
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageBoats.table.actions">
                                                                                                                        Actions
                                                                                                                    </th>
                                                                                                                </tr>
                                                                                                            </thead>
                                                                                                            <tbody
                                                                                                                id="boatsTableBody"
                                                                                                                class="bg-white divide-y divide-gray-200">
                                                                                                            </tbody>
                                                                                                        </table>
                                                                                                    </div>
                                                                                            </div>
                                                                                            <div id="settings-tariffs-panel"
                                                                                                class="settings-tab-panel hidden">
                                                                                                < !-- Content from old
                                                                                                    manage-tariffs-view
                                                                                                    -->
                                                                                                    <div
                                                                                                        class="flex justify-end mb-4">
                                                                                                        <button
                                                                                                            onclick="openTariffPriceModal('add')"
                                                                                                            class="btn-primary flex items-center"><i
                                                                                                                data-lucide="plus"
                                                                                                                class="mr-2 h-5 w-5"></i><span
                                                                                                                data-translate-key="manageTariffs.addNewBtn">Add
                                                                                                                New
                                                                                                                Tariff/Price</span></button>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="overflow-x-auto">
                                                                                                        <table
                                                                                                            class="min-w-full divide-y divide-gray-200">
                                                                                                            <thead
                                                                                                                class="bg-gray-50">
                                                                                                                <tr>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTariffs.table.tariffName">
                                                                                                                        Tariff
                                                                                                                        Name
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTariffs.table.startDate">
                                                                                                                        Start
                                                                                                                        Date
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTariffs.table.endDate">
                                                                                                                        End
                                                                                                                        Date
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTariffs.table.boatModel">
                                                                                                                        Boat
                                                                                                                        Model
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTariffs.table.priceNormal">
                                                                                                                        Price
                                                                                                                        Normal
                                                                                                                        Night
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTariffs.table.priceWeekend">
                                                                                                                        Price
                                                                                                                        Weekend
                                                                                                                        Night
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTariffs.table.actions">
                                                                                                                        Actions
                                                                                                                    </th>
                                                                                                                </tr>
                                                                                                            </thead>
                                                                                                            <tbody
                                                                                                                id="tariffsPricesTableBody"
                                                                                                                class="bg-white divide-y divide-gray-200">
                                                                                                            </tbody>
                                                                                                        </table>
                                                                                                    </div>
                                                                                            </div>
                                                                                            <div id="settings-extras-panel"
                                                                                                class="settings-tab-panel hidden">
                                                                                                < !-- Content from old
                                                                                                    manage-extras-view
                                                                                                    -->
                                                                                                    <div
                                                                                                        class="flex justify-end mb-4">
                                                                                                        <button
                                                                                                            onclick="openExtraModal('add')"
                                                                                                            class="btn-primary flex items-center"><i
                                                                                                                data-lucide="plus"
                                                                                                                class="mr-2 h-5 w-5"></i><span
                                                                                                                data-translate-key="manageExtras.addNewBtn">Add
                                                                                                                New
                                                                                                                Extra</span></button>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="overflow-x-auto">
                                                                                                        <table
                                                                                                            class="min-w-full divide-y divide-gray-200">
                                                                                                            <thead
                                                                                                                class="bg-gray-50">
                                                                                                                <tr>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageExtras.table.name">
                                                                                                                        Extra
                                                                                                                        Name
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageExtras.table.price">
                                                                                                                        Price
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageExtras.table.unit">
                                                                                                                        Unit
                                                                                                                    </th>
                                                                                                                    <th scope="col"
                                                                                                                        class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageExtras.table.actions">
                                                                                                                        Actions
                                                                                                                    </th>
                                                                                                                </tr>
                                                                                                            </thead>
                                                                                                            <tbody
                                                                                                                id="extrasTableBody"
                                                                                                                class="bg-white divide-y divide-gray-200">
                                                                                                            </tbody>
                                                                                                        </table>
                                                                                                    </div>
                                                                                            </div>
                                                                                            <div id="settings-trips-panel"
                                                                                                class="settings-tab-panel hidden">
                                                                                                < !-- Content from old
                                                                                                    manage-trips-view
                                                                                                    -->
                                                                                                    <div
                                                                                                        class="flex justify-end mb-4">
                                                                                                        <button
                                                                                                            onclick="openTripModal('add')"
                                                                                                            class="btn-primary flex items-center"><i
                                                                                                                data-lucide="plus"
                                                                                                                class="mr-2 h-5 w-5"></i><span
                                                                                                                data-translate-key="manageTrips.addNewBtn">Add
                                                                                                                New
                                                                                                                Trip</span></button>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="overflow-x-auto">
                                                                                                        <table
                                                                                                            class="min-w-full divide-y divide-gray-200">
                                                                                                            <thead
                                                                                                                class="bg-gray-50">
                                                                                                                <tr>
                                                                                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTrips.table.name">
                                                                                                                        Trip
                                                                                                                        Name
                                                                                                                    </th>
                                                                                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTrips.table.priceAdult">
                                                                                                                        Price/Adult
                                                                                                                    </th>
                                                                                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTrips.table.priceKid">
                                                                                                                        Price/Kid
                                                                                                                    </th>
                                                                                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTrips.table.priceSenior">
                                                                                                                        Price/Senior
                                                                                                                    </th>
                                                                                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTrips.table.duration">
                                                                                                                        Duration
                                                                                                                        (h)
                                                                                                                    </th>
                                                                                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageTrips.table.actions">
                                                                                                                        Actions
                                                                                                                    </th>
                                                                                                                </tr>
                                                                                                            </thead>
                                                                                                            <tbody
                                                                                                                id="tripsTableBody"
                                                                                                                class="bg-white divide-y divide-gray-200">
                                                                                                            </tbody>
                                                                                                        </table>
                                                                                                    </div>
                                                                                            </div>
                                                                                            <div id="settings-food-panel"
                                                                                                class="settings-tab-panel hidden">
                                                                                                < !-- Content from old
                                                                                                    manage-food-view -->
                                                                                                    <div
                                                                                                        class="flex justify-end mb-4">
                                                                                                        <button
                                                                                                            onclick="openFoodModal('add')"
                                                                                                            class="btn-primary flex items-center"><i
                                                                                                                data-lucide="plus"
                                                                                                                class="mr-2 h-5 w-5"></i><span
                                                                                                                data-translate-key="manageFood.addNewBtn">Add
                                                                                                                New Food
                                                                                                                Option</span></button>
                                                                                                    </div>
                                                                                                    <div
                                                                                                        class="overflow-x-auto">
                                                                                                        <table
                                                                                                            class="min-w-full divide-y divide-gray-200">
                                                                                                            <thead
                                                                                                                class="bg-gray-50">
                                                                                                                <tr>
                                                                                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageFood.table.name">
                                                                                                                        Option
                                                                                                                        Name
                                                                                                                    </th>
                                                                                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageFood.table.price">
                                                                                                                        Price
                                                                                                                    </th>
                                                                                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageFood.table.description">
                                                                                                                        Description
                                                                                                                    </th>
                                                                                                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                                                                                                        data-translate-key="manageFood.table.actions">
                                                                                                                        Actions
                                                                                                                    </th>
                                                                                                                </tr>
                                                                                                            </thead>
                                                                                                            <tbody
                                                                                                                id="foodTableBody"
                                                                                                                class="bg-white divide-y divide-gray-200">
                                                                                                            </tbody>
                                                                                                        </table>
                                                                                                    </div>
                                                                                            </div>
                                                                                        </div>
                                                                            </div>
                                                                        </div>
                                                                        <div id="restaurant-view"
                                                                            class="view-content hidden">
                                                                            <div class="max-w-7xl mx-auto">
                                                                                < !-- Header -->
                                                                                    <div
                                                                                        class="bg-white rounded-lg shadow-sm p-6 mb-6">
                                                                                        <div
                                                                                            class="flex items-center justify-between">
                                                                                            <div>
                                                                                                <h2
                                                                                                    class="text-3xl font-bold text-gray-900 flex items-center gap-3">
                                                                                                    <div
                                                                                                        class="w-12 h-12 bg-gradient-to-br from-pink-500 to-rose-600 rounded-xl flex items-center justify-center shadow-lg">
                                                                                                        <i data-lucide="utensils-crossed"
                                                                                                            class="h-6 w-6 text-white"></i>
                                                                                                    </div><span
                                                                                                        data-translate-key="restaurant.title">Restaurant
                                                                                                        Reservations</span>
                                                                                                </h2>
                                                                                                <p
                                                                                                    class="text-gray-600 mt-2">
                                                                                                    Manage restaurant
                                                                                                    bookings and table
                                                                                                    reservations</p>
                                                                                            </div>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div
                                                                                        class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                                                                        < !-- LEFT COLUMN: Form (2/3
                                                                                            width) -->
                                                                                            <div class="lg:col-span-2">
                                                                                                <div
                                                                                                    class="bg-white rounded-lg shadow-sm p-6">
                                                                                                    <h3 id="restaurantFormTitle"
                                                                                                        class="text-xl font-semibold text-gray-900 mb-6 pb-3 border-b-2 border-pink-500 flex items-center gap-2">
                                                                                                        <i data-lucide="calendar-plus"
                                                                                                            class="h-5 w-5 text-pink-600"></i><span
                                                                                                            data-translate-key="restaurant.form.titleNew">New
                                                                                                            Restaurant
                                                                                                            Reservation</span>
                                                                                                    </h3>
                                                                                                    <form
                                                                                                        id="restaurantReservationForm"
                                                                                                        class="space-y-6">
                                                                                                        <input
                                                                                                            type="hidden"
                                                                                                            id="restaurantFormMode"
                                                                                                            name="restaurantFormMode"
                                                                                                            value="add"><input
                                                                                                            type="hidden"
                                                                                                            id="originalRestaurantReservationId"
                                                                                                            name="originalRestaurantReservationId">
                                                                                                        < !-- Client
                                                                                                            Information
                                                                                                            -->
                                                                                                            <div>
                                                                                                                <h4
                                                                                                                    class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide flex items-center gap-2">
                                                                                                                    <i data-lucide="user"
                                                                                                                        class="h-4 w-4 text-pink-600"></i>Client
                                                                                                                    Information
                                                                                                                </h4>
                                                                                                                <div
                                                                                                                    class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                                                                                    <div>
                                                                                                                        <label
                                                                                                                            class="block text-sm font-medium text-gray-700 mb-1">Full
                                                                                                                            Name
                                                                                                                            <span
                                                                                                                                class="text-red-500">*</span></label><input
                                                                                                                            type="text"
                                                                                                                            id="restaurantClientName"
                                                                                                                            name="clientName"
                                                                                                                            required
                                                                                                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-sm"
                                                                                                                            placeholder="John Doe">
                                                                                                                    </div>
                                                                                                                    <div>
                                                                                                                        <label
                                                                                                                            class="block text-sm font-medium text-gray-700 mb-1">Phone
                                                                                                                            <span
                                                                                                                                class="text-red-500">*</span></label><input
                                                                                                                            type="tel"
                                                                                                                            id="restaurantClientPhone"
                                                                                                                            name="clientPhone"
                                                                                                                            required
                                                                                                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-sm"
                                                                                                                            placeholder="+351 123 456 789">
                                                                                                                    </div>
                                                                                                                    <div>
                                                                                                                        <label
                                                                                                                            class="block text-sm font-medium text-gray-700 mb-1">Email
                                                                                                                        </label><input
                                                                                                                            type="email"
                                                                                                                            id="restaurantClientEmail"
                                                                                                                            name="clientEmail"
                                                                                                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-sm"
                                                                                                                            placeholder="john@example.com">
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                            </div>
                                                                                                            < !--
                                                                                                                Reservation
                                                                                                                Details
                                                                                                                -->
                                                                                                                <div>
                                                                                                                    <h4
                                                                                                                        class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide flex items-center gap-2">
                                                                                                                        <i data-lucide="calendar-clock"
                                                                                                                            class="h-4 w-4 text-pink-600"></i>Reservation
                                                                                                                        Details
                                                                                                                    </h4>
                                                                                                                    <div
                                                                                                                        class="grid grid-cols-3 gap-4">
                                                                                                                        <div>
                                                                                                                            <label
                                                                                                                                class="block text-sm font-medium text-gray-700 mb-1">People
                                                                                                                                <span
                                                                                                                                    class="text-red-500">*</span></label><input
                                                                                                                                type="number"
                                                                                                                                id="restaurantNumPeople"
                                                                                                                                name="numPeople"
                                                                                                                                min="1"
                                                                                                                                required
                                                                                                                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-sm"
                                                                                                                                placeholder="4">
                                                                                                                        </div>
                                                                                                                        <div>
                                                                                                                            <label
                                                                                                                                class="block text-sm font-medium text-gray-700 mb-1">Date
                                                                                                                                <span
                                                                                                                                    class="text-red-500">*</span></label><input
                                                                                                                                type="date"
                                                                                                                                id="restaurantDate"
                                                                                                                                name="reservationDate"
                                                                                                                                required
                                                                                                                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-sm">
                                                                                                                        </div>
                                                                                                                        <div>
                                                                                                                            <label
                                                                                                                                class="block text-sm font-medium text-gray-700 mb-1">Time
                                                                                                                                <span
                                                                                                                                    class="text-red-500">*</span></label><input
                                                                                                                                type="time"
                                                                                                                                id="restaurantHour"
                                                                                                                                name="reservationHour"
                                                                                                                                required
                                                                                                                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-sm">
                                                                                                                        </div>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                                < !--
                                                                                                                    Notes
                                                                                                                    -->
                                                                                                                    <div>
                                                                                                                        <label
                                                                                                                            class="block text-sm font-medium text-gray-700 mb-1">Special
                                                                                                                            Requests
                                                                                                                            /
                                                                                                                            Notes</label><textarea
                                                                                                                            id="restaurantNotes"
                                                                                                                            name="notes"
                                                                                                                            rows="2"
                                                                                                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-sm"
                                                                                                                            placeholder="Dietary restrictions, special occasions..."></textarea>
                                                                                                                    </div>
                                                                                                                    < !--
                                                                                                                        Action
                                                                                                                        Buttons
                                                                                                                        -->
                                                                                                                        <div
                                                                                                                            class="flex justify-end gap-3 pt-4 border-t">
                                                                                                                            <button
                                                                                                                                type="button"
                                                                                                                                onclick="resetRestaurantForm()"
                                                                                                                                class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-md transition-colors text-sm">Clear
                                                                                                                                Form
                                                                                                                            </button><button
                                                                                                                                type="submit"
                                                                                                                                id="restaurantFormSubmitBtn"
                                                                                                                                class="px-6 py-2 bg-gradient-to-r from-pink-600 to-rose-600 hover:from-pink-700 hover:to-rose-700 text-white font-semibold rounded-md shadow-md transition-all flex items-center gap-2 text-sm"><i
                                                                                                                                    data-lucide="check-circle"
                                                                                                                                    class="h-4 w-4"></i>Save
                                                                                                                                Reservation
                                                                                                                            </button>
                                                                                                                        </div>
                                                                                                    </form>
                                                                                                </div>
                                                                                            </div>
                                                                                            < !-- RIGHT COLUMN: Quick
                                                                                                Info (1/3 width) -->
                                                                                                <div
                                                                                                    class="lg:col-span-1">
                                                                                                    <div
                                                                                                        class="sticky top-6">
                                                                                                        < !-- Quick
                                                                                                            Stats -->
                                                                                                            <div
                                                                                                                class="bg-gradient-to-br from-pink-50 to-rose-50 rounded-lg shadow-sm p-6 border-2 border-pink-200 mb-6">
                                                                                                                <h4
                                                                                                                    class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
                                                                                                                    <i data-lucide="info"
                                                                                                                        class="h-5 w-5 text-pink-600"></i>Quick
                                                                                                                    Info
                                                                                                                </h4>
                                                                                                                <div
                                                                                                                    class="space-y-3 text-sm">
                                                                                                                    <div
                                                                                                                        class="flex justify-between items-center">
                                                                                                                        <span
                                                                                                                            class="text-gray-600">Total
                                                                                                                            Today:</span><span
                                                                                                                            class="font-bold text-gray-900"
                                                                                                                            id="restaurantTodayCount">0</span>
                                                                                                                    </div>
                                                                                                                    <div
                                                                                                                        class="flex justify-between items-center">
                                                                                                                        <span
                                                                                                                            class="text-gray-600">This
                                                                                                                            Week:</span><span
                                                                                                                            class="font-bold text-gray-900"
                                                                                                                            id="restaurantWeekCount">0</span>
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                            </div>
                                                                                                            < !-- Tips
                                                                                                                -->
                                                                                                                <div
                                                                                                                    class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                                                                                                    <h5
                                                                                                                        class="font-semibold text-blue-900 mb-2 flex items-center gap-2 text-sm">
                                                                                                                        <i data-lucide="lightbulb"
                                                                                                                            class="h-4 w-4"></i>Quick
                                                                                                                        Tips
                                                                                                                    </h5>
                                                                                                                    <ul
                                                                                                                        class="space-y-1 text-xs text-blue-800">
                                                                                                                        <li>•
                                                                                                                            Confirm
                                                                                                                            large
                                                                                                                            groups
                                                                                                                            by
                                                                                                                            phone
                                                                                                                        </li>
                                                                                                                        <li>•
                                                                                                                            Update
                                                                                                                            status
                                                                                                                            after
                                                                                                                            confirmation
                                                                                                                        </li>
                                                                                                                        <li>•
                                                                                                                            Note
                                                                                                                            dietary
                                                                                                                            restrictions
                                                                                                                            clearly
                                                                                                                        </li>
                                                                                                                    </ul>
                                                                                                                </div>
                                                                                                    </div>
                                                                                                </div>
                                                                                    </div>
                                                                                    < !-- View Switcher -->
                                                                                        <div
                                                                                            class="bg-white rounded-lg shadow-sm p-2 mb-6 inline-flex gap-2 mt-6">
                                                                                            <button
                                                                                                id="showRestaurantTableViewBtn"
                                                                                                class="px-4 py-2 bg-gradient-to-r from-pink-600 to-rose-600 text-white font-medium rounded-md transition-all flex items-center gap-2 shadow-md text-sm"><i
                                                                                                    data-lucide="list"
                                                                                                    class="h-4 w-4"></i>Table
                                                                                                View </button><button
                                                                                                id="showRestaurantCalendarViewBtn"
                                                                                                class="px-4 py-2 bg-white text-gray-700 font-medium rounded-md hover:bg-gray-50 transition-all flex items-center gap-2 text-sm"><i
                                                                                                    data-lucide="calendar-days"
                                                                                                    class="h-4 w-4"></i>Calendar
                                                                                                View </button>
                                                                                        </div>
                                                                                        < !-- Table View -->
                                                                                            <div
                                                                                                id="restaurantTableView">
                                                                                                < !-- Search Bar -->
                                                                                                    <div
                                                                                                        class="bg-white rounded-lg shadow-sm p-4 mb-6">
                                                                                                        <div
                                                                                                            class="relative">
                                                                                                            <i data-lucide="search"
                                                                                                                class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400"></i><input
                                                                                                                type="text"
                                                                                                                id="restaurantSearch"
                                                                                                                placeholder="Search by name or phone..."
                                                                                                                class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-pink-500 focus:border-pink-500 text-sm">
                                                                                                        </div>
                                                                                                    </div>
                                                                                                    < !-- Table -->
                                                                                                        <div
                                                                                                            class="bg-white rounded-lg shadow-lg overflow-hidden">
                                                                                                            <table
                                                                                                                class="min-w-full divide-y divide-gray-200">
                                                                                                                <thead
                                                                                                                    class="bg-gray-50">
                                                                                                                    <tr>
                                                                                                                        <th
                                                                                                                            class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                                                                                            Client
                                                                                                                        </th>
                                                                                                                        <th
                                                                                                                            class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                                                                                            Date
                                                                                                                            &
                                                                                                                            Time
                                                                                                                        </th>
                                                                                                                        <th
                                                                                                                            class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                                                                                            People
                                                                                                                        </th>
                                                                                                                        <th
                                                                                                                            class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                                                                                            Status
                                                                                                                        </th>
                                                                                                                        <th
                                                                                                                            class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                                                                                                                            Actions
                                                                                                                        </th>
                                                                                                                    </tr>
                                                                                                                </thead>
                                                                                                                <tbody
                                                                                                                    id="restaurantTableBody"
                                                                                                                    class="bg-white divide-y divide-gray-200">
                                                                                                                    < !--
                                                                                                                        Populated
                                                                                                                        by
                                                                                                                        JavaScript
                                                                                                                        -->
                                                                                                                </tbody>
                                                                                                            </table>
                                                                                                        </div>
                                                                                                        < !-- Pagination
                                                                                                            -->
                                                                                                            <div id="restaurantPaginationControls"
                                                                                                                class="mt-6 flex justify-center">
                                                                                                            </div>
                                                                                            </div>
                                                                                            < !-- Calendar View -->
                                                                                                <div id="restaurantCalendarView"
                                                                                                    class="hidden">
                                                                                                    <div
                                                                                                        class="bg-white rounded-lg shadow-lg p-6">
                                                                                                        <div
                                                                                                            id="restaurantCalendar">
                                                                                                        </div>
                                                                                                    </div>
                                                                                                </div>
                                                                                                < !-- Report Generation
                                                                                                    -->
                                                                                                    <div
                                                                                                        class="mt-10 bg-white rounded-lg shadow-sm p-6">
                                                                                                        <h3
                                                                                                            class="text-xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                                                                                            <i data-lucide="file-spreadsheet"
                                                                                                                class="h-5 w-5 text-purple-600"></i>Generate
                                                                                                            Worker
                                                                                                            Report
                                                                                                        </h3>
                                                                                                        <div
                                                                                                            class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                                                                            <div><label
                                                                                                                    class="block text-sm font-medium text-gray-700 mb-1">Start
                                                                                                                    Date</label><input
                                                                                                                    type="date"
                                                                                                                    id="restaurantReportStartDate"
                                                                                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-sm">
                                                                                                            </div>
                                                                                                            <div><label
                                                                                                                    class="block text-sm font-medium text-gray-700 mb-1">End
                                                                                                                    Date</label><input
                                                                                                                    type="date"
                                                                                                                    id="restaurantReportEndDate"
                                                                                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500 text-sm">
                                                                                                            </div>
                                                                                                            <div
                                                                                                                class="flex items-end">
                                                                                                                <button
                                                                                                                    id="generateRestaurantReportBtn"
                                                                                                                    class="w-full px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-semibold rounded-md shadow-md transition-all flex items-center justify-center gap-2 text-sm"><i
                                                                                                                        data-lucide="download"
                                                                                                                        class="h-4 w-4"></i>Export
                                                                                                                    Report
                                                                                                                </button>
                                                                                                            </div>
                                                                                                        </div>
                                                                                                    </div>
                                                                            </div>
                                                                        </div>
                                                </main>
                                            </div>
                                            <?!= include('js-translations'); ?>
                                            <?!= include('js-utils'); ?>
                                            <?!= include('js-ui'); ?>
                                            <?!= include('js-calendar'); ?>

                                                    ;

                                                // Simplified wizard object for single-page mode
                                                const wizard = {
                                                    currentState: {
                                                        isEditMode: false,
                                                        reservationId: null
                                                    }

                                                    ,

                                                    initialize(isEdit = false, reservationId = null) {
                                                        this.currentState.isEditMode = isEdit;
                                                        this.currentState.reservationId = reservationId;

                                                        const submitBtnText = document.getElementById('mainSubmitBtnText');

                                                        if (submitBtnText) {
                                                            submitBtnText.textContent = _t(isEdit ? 'buttons.updateReservation' : 'buttons.saveReservation');
                                                        }

                                                        if (!isEdit) {
                                                            const form = document.getElementById('newReservationForm');
                                                            form.reset();
                                                            document.getElementById('checkInTime').value = '09:00';
                                                            document.getElementById('checkOutTime').value = '09:00';
                                                            document.getElementById('taxValue').value = '76';
                                                            form.dataset.currentExtras = '{}';
                                                            populateExtras();
                                                        }

                                                        // Hide initial payment section if editing
                                                        const initialPaymentSection = document.getElementById('initialPaymentSection');

                                                        if (initialPaymentSection) {
                                                            initialPaymentSection.style.display = isEdit ? 'none' : 'block';
                                                        }
                                                    }

                                                    ,

                                                    collectWizardData() {
                                                        const form = document.getElementById('newReservationForm');
                                                        const formData = new FormData(form);

                                                        const reservationDetails = {}

                                                            ;

                                                        for (let [key, value] of formData.entries()) {
                                                            reservationDetails[key] = value;
                                                        }

                                                        reservationDetails.boatUniqueId = formData.get('boatId');
                                                        reservationDetails.extrasBooked = JSON.stringify(getSelectedExtras());
                                                        reservationDetails.discountPercentage = parseFloat(formData.get('discountPercentage')) || 0;
                                                        reservationDetails.taxValue = 76; // Always 76
                                                        reservationDetails.totalCost = parseFloat(formData.get('manualTotalCost'));

                                                        return reservationDetails;
                                                    }
                                                }

                                                    ;

                                                /**
                                             * Gathers data from the QUICK ADD panel, calls the server-side calculation, and populates the summary.
                                             */
                                                function calculateQuickAddPrice() {
                                                    const summaryContainer = document.getElementById('quickAddPriceSummary');
                                                    if (!summaryContainer) return;

                                                    const boatId = document.getElementById('quickAddBoatId').value;
                                                    const boat = ALL_BOATS.find(b => b.uniqueId === boatId);

                                                    if (!boat) {
                                                        summaryContainer.innerHTML = '<p class="text-red-500">Error: Boat not found.</p>';
                                                        return;
                                                    }

                                                    const checkInDate = document.getElementById('quickAddCheckInDate').value;
                                                    const checkOutDate = document.getElementById('quickAddCheckOutDate').value;

                                                    // Don't calculate if dates are invalid or missing
                                                    if (!checkInDate || !checkOutDate || new Date(checkOutDate) < new Date(checkInDate)) {
                                                        summaryContainer.innerHTML = '<p class="text-gray-500">Select valid dates to see price...</p>';
                                                        return;
                                                    }

                                                    summaryContainer.innerHTML = '<p class="text-gray-500">Calculating price...</p>';

                                                    const params = {
                                                        boatModel: boat.boatModel,
                                                        checkInDate: checkInDate,
                                                        checkInTime: document.getElementById('quickAddCheckInTime').value,
                                                        checkOutDate: checkOutDate,
                                                        checkOutTime: document.getElementById('quickAddCheckOutTime').value,
                                                        selectedExtras: '{}',
                                                        // No extras are used in the quick add panel
                                                        discountPercentage: document.getElementById('quickAddDiscountPercentage').value || 0,
                                                        taxValue: 76 // Tax is a fixed value on the backend
                                                    }

                                                        ;

                                                    google.script.run.withSuccessHandler(response => {
                                                        if (response.error) {
                                                            summaryContainer.innerHTML = `<p class="text-red-600 font-semibold" >Error: $ {
                                response.error
                            }

                            </p>`;
                                                        }

                                                        else {
                                                            populateQuickAddSummary(response);
                                                        }

                                                    }).withFailureHandler(err => {
                                                        summaryContainer.innerHTML = `<p class="text-red-600 font-semibold" >Error calculating price.</p>`;
                                                        console.error("Quick add price calculation failed:", err);
                                                    }).calculateReservationPrice(params);
                                                }

                                                /**
                                             * Populates the Quick Add panel's summary with the detailed price breakdown, including the tariff name.
                                             * @param {object} data - The price breakdown object from `calculateReservationPrice`.
                                             */
                                                function populateQuickAddSummary(data = {}) {
                                                    const summaryContainer = document.getElementById('quickAddPriceSummary');
                                                    if (!summaryContainer) return;

                                                    // Build the detailed HTML for the summary panel, now including the tariff name and per-night costs.
                                                    summaryContainer.innerHTML = ` <h4 class="font-semibold text-gray-700 mb-1">Price Summary</h4><p class="flex justify-between"><span>Tariff Applied:</span><span class="font-mono font-semibold text-cyan-600">$ {
                    data.tariffName || 'N/A'
                }

                </span></p><p class="flex justify-between"><span>Normal Nights ($ {
                        data.normalNights || 0
                    }

                    x €$ {
                        (data.unitPriceNormalNight || 0).toFixed(2)

                    }):</span><span class="font-mono">€$ {
                    (data.totalNormalNightCost || 0).toFixed(2)
                }

                </span></p><p class="flex justify-between"><span>Weekend Nights ($ {
                        data.weekendNights || 0
                    }

                    x €$ {
                        (data.unitPriceWeekendNight || 0).toFixed(2)

                    }):</span><span class="font-mono">€$ {
                    (data.totalWeekendNightCost || 0).toFixed(2)
                }

                </span></p><p class="flex justify-between"><span>Boat Cost:</span><span class="font-mono">€$ {
                    (data.baseBoatCost || 0).toFixed(2)
                }

                </span></p><p class="flex justify-between"><span>Taxes:</span><span class="font-mono">€$ {
                    (data.taxAmountApplied || 0).toFixed(2)
                }

                </span></p><p class="flex justify-between"><span>Discount:</span><span class="font-mono text-red-500">-€$ {
                    (data.discountAmount || 0).toFixed(2)
                }

                </span></p><hr class="my-1"><p class="flex justify-between font-bold text-base"><span>Total:</span><span class="font-mono text-indigo-600">€$ {
                    (data.totalCost || 0).toFixed(2)
                }

                </span></p>`;
                                                }

                                                // Replace the addPriceCalculationTriggers function
                                                function addPriceCalculationTriggers() {
                                                    const triggers = document.querySelectorAll('.price-trigger');

                                                    triggers.forEach(trigger => {
                                                        trigger.addEventListener('change', () => {
                                                            // Auto-calculate after a short delay
                                                            setTimeout(calculatePriceNow, 300);
                                                        });
                                                    });

                                                    // Also trigger on extras changes
                                                    const extrasContainer = document.getElementById('extrasContainer');

                                                    if (extrasContainer) {
                                                        extrasContainer.addEventListener('change', () => {
                                                            setTimeout(calculatePriceNow, 300);
                                                        });
                                                    }
                                                }

                                                /**
                                             * Attaches real-time update listeners to the inputs in the Quick Add panel.
                                             * This version uses event delegation for increased reliability.
                                             * Call this function once when your application loads (e.g., inside DOMContentLoaded).
                                             */
                                                function addQuickAddPriceTriggers() {
                                                    const quickAddPanel = document.getElementById('quickAddPanel');

                                                    if (!quickAddPanel) {
                                                        console.error("Quick Add Panel not found. Price triggers cannot be attached.");
                                                        return;
                                                    }

                                                    // A single handler for all price-related input changes within the panel.
                                                    const handlePriceInputChange = (event) => {

                                                        // Check if the element that was changed has the 'price-recalc-trigger' class.
                                                        if (event.target.classList.contains('price-recalc-trigger')) {
                                                            // Use a small timeout to batch rapid changes (like typing in a number field).
                                                            setTimeout(calculateQuickAddPrice, 200);
                                                        }
                                                    }

                                                        ;

                                                    // We attach two listeners to the panel itself. They will catch events from
                                                    // any input inside the panel that has the 'price-recalc-trigger' class.

                                                    // 'input' event for real-time updates as you type in the discount field.
                                                    quickAddPanel.addEventListener('input', handlePriceInputChange);

                                                    // 'change' event for when you select a new date or time.
                                                    quickAddPanel.addEventListener('change', handlePriceInputChange);

                                                    console.log("Price trigger listeners attached to Quick Add Panel using event delegation.");
                                                }

                                                function applyTranslationsToDynamicContent() {
                                                    const currentViewId = document.querySelector('.view-content:not(.hidden)')?.id?.replace('-view', '');

                                                    if (currentViewId && viewTitles[currentViewId]) {
                                                        document.getElementById('view-title').textContent = _t(viewTitles[currentViewId].key);
                                                    }

                                                    else if (currentViewId) {
                                                        document.getElementById('view-title').textContent = _t(`nav.$ {
                            currentViewId.replace(/-/g, '')
                        }

                        `, {}

                                                            , currentViewId.charAt(0).toUpperCase() + currentViewId.slice(1).replace('-', ' '));
                                                    }

                                                    const newOrEditLinkTextEl = document.getElementById('newOrEditReservationLinkText');
                                                    const reservationFormTitleEl = document.getElementById('reservationFormTitle');
                                                    const saveReservationButton = document.getElementById('saveReservationButton');
                                                    const initialPaymentSection = document.getElementById('initialPaymentSection');


                                                    if (document.getElementById('new-reservation-view') && !document.getElementById('new-reservation-view').classList.contains('hidden')) {
                                                        const resIdToUpdate = document.getElementById('reservationIdToUpdate').value;

                                                        if (resIdToUpdate) {
                                                            // Editing mode
                                                            if (newOrEditLinkTextEl) newOrEditLinkTextEl.textContent = _t('nav.editReservation');

                                                            if (reservationFormTitleEl) reservationFormTitleEl.textContent = _t('newReservation.formTitleEdit', {
                                                                id: resIdToUpdate
                                                            });
                                                            if (saveReservationButton) saveReservationButton.textContent = _t('buttons.updateReservation');
                                                            if (initialPaymentSection) initialPaymentSection.classList.add('hidden');
                                                        }

                                                        else {
                                                            // New reservation mode
                                                            if (newOrEditLinkTextEl) newOrEditLinkTextEl.textContent = _t('nav.newReservation');
                                                            if (reservationFormTitleEl) reservationFormTitleEl.textContent = _t('newReservation.formTitleCreate');
                                                            if (saveReservationButton) saveReservationButton.textContent = _t('buttons.saveReservation');
                                                            if (initialPaymentSection) initialPaymentSection.classList.remove('hidden');
                                                        }
                                                    }

                                                    else {
                                                        if (newOrEditLinkTextEl) newOrEditLinkTextEl.textContent = _t('nav.newReservation');
                                                        if (initialPaymentSection) initialPaymentSection.classList.add('hidden');
                                                    }

                                                    // Re-render tables to apply translations in headers etc.
                                                    if (document.getElementById('view-reservations-view') && !document.getElementById('view-reservations-view').classList.contains('hidden')) renderReservationsPage();
                                                    if (document.getElementById('manage-boats-view') && !document.getElementById('manage-boats-view').classList.contains('hidden')) renderBoatsTable();
                                                    if (document.getElementById('manage-tariffs-view') && !document.getElementById('manage-tariffs-view').classList.contains('hidden')) renderTariffsPricesTable();
                                                    if (document.getElementById('manage-extras-view') && !document.getElementById('manage-extras-view').classList.contains('hidden')) renderExtrasTable();
                                                    if (document.getElementById('manage-trips-view') && !document.getElementById('manage-trips-view').classList.contains('hidden')) renderTripsTable();
                                                    if (document.getElementById('manage-food-view') && !document.getElementById('manage-food-view').classList.contains('hidden')) renderFoodTable();

                                                    if (document.getElementById('calendar-view') && !document.getElementById('calendar-view').classList.contains('hidden') && ALL_BOATS.length > 0 && ALL_RESERVATIONS.length > 0) renderYearCalendarGrid(calendarDisplayYear);
                                                    if (document.getElementById('daily-travels-view') && !document.getElementById('daily-travels-view').classList.contains('hidden')) renderDailyTravelsTable();
                                                    if (document.getElementById('travel-calendar-view') && !document.getElementById('travel-calendar-view').classList.contains('hidden')) initializeTravelCalendar();

                                                    populateBoatSelect();
                                                    populateExtras(JSON.parse(document.getElementById('newReservationForm')?.dataset.currentExtras || '{}'));
                                                    populateTripSelect();
                                                    populateFoodOptions();
                                                }

                                                function applyTranslations() {
                                                    document.querySelectorAll('[data-translate-key]').forEach(el => {
                                                        const key = el.dataset.translateKey;
                                                        const type = el.dataset.translateType || 'textContent';
                                                        const paramsAttr = el.dataset.translateParams;

                                                        let params = {}

                                                            ;

                                                        if (paramsAttr) {
                                                            try {
                                                                params = JSON.parse(paramsAttr);
                                                            }

                                                            catch (e) {
                                                                console.warn("Could not parse translate-params for key", key, e);
                                                            }
                                                        }

                                                        let translatedText = _t(key, params);
                                                        if (type === 'innerHTML') el.innerHTML = translatedText;
                                                        else if (type === 'placeholder') el.placeholder = translatedText;
                                                        else if (type === 'titleAttr') el.title = translatedText;
                                                        else el.textContent = translatedText;
                                                    });
                                                    applyTranslationsToDynamicContent();
                                                    updateLanguageButtonStates();
                                                    if (lucide) lucide.createIcons();
                                                }

                                                function setLanguage(lang) {
                                                    currentLanguage = lang;
                                                    localStorage.setItem('appLanguage', lang);
                                                    document.documentElement.lang = lang;
                                                    if (travelCalendar) travelCalendar.setOption('locale', lang);
                                                    applyTranslations();
                                                }

                                                function updateLanguageButtonStates() {
                                                    document.querySelectorAll('#language-switcher .lang-btn').forEach(btn => {
                                                        btn.classList.remove('active');

                                                        if (btn.dataset.lang === currentLanguage) {
                                                            btn.classList.add('active');
                                                        }
                                                    });
                                                }


                                                function openModal(modalId) {
                                                    const modal = document.getElementById(modalId);

                                                    if (modal) {
                                                        modal.classList.add('show');
                                                        const titleEl = modal.querySelector('[id$="ModalTitle"]');
                                                        const paymentTitleEl = modal.querySelector('#paymentModalTitle');

                                                        if (paymentTitleEl && modalId === 'paymentManagementModal') {
                                                            const bookingId = document.getElementById('paymentBookingId')?.value || '...';
                                                            const bookingType = document.getElementById('paymentBookingType')?.value;
                                                            let bookingRecord;
                                                            let typeStr = bookingType;

                                                            if (bookingType === 'reservation') {
                                                                bookingRecord = ALL_RESERVATIONS.find(r => r.reservationId === bookingId);
                                                            }

                                                            else if (bookingType === 'travel') {
                                                                bookingRecord = ALL_DAILY_TRAVELS.find(t => t.travelId === bookingId);
                                                                typeStr = "Travel";
                                                            }

                                                            const clientName = bookingRecord?.clientName || '';

                                                            paymentTitleEl.textContent = _t('payments_modal_title', {
                                                                type: typeStr, id: `$ {
                            bookingId
                        }

                        $ {
                            clientName ? ` ($ {
                                                                    clientName
                                                                })` : ''
                        }

                        `
                                                            });
                                                        }

                                                        else if (titleEl && titleEl.dataset.translateKey) {
                                                            let key = titleEl.dataset.translateKey;
                                                            if (modalId.includes('boat') && document.getElementById('boatFormMode')?.value === 'edit') key = 'boatModal.titleEdit';
                                                            else if (modalId.includes('tariffPrice') && document.getElementById('tariffPriceFormMode')?.value === 'edit') key = 'tariffModal.titleEdit';
                                                            else if (modalId.includes('extra') && document.getElementById('extraFormMode')?.value === 'edit') key = 'extraModal.titleEdit';
                                                            else if (modalId.includes('trip') && document.getElementById('tripFormMode')?.value === 'edit') key = 'manageTrips.modal.titleEdit';
                                                            else if (modalId.includes('food') && document.getElementById('foodFormMode')?.value === 'edit') key = 'manageFood.modal.titleEdit';
                                                            titleEl.textContent = _t(key);
                                                        }
                                                    }
                                                }

                                                function closeModal(modalId) {
                                                    const modal = document.getElementById(modalId);
                                                    if (modal) modal.classList.remove('show');
                                                    if (modalId === 'invoiceModal') currentInvoiceDetailsForPdf = null;
                                                    if (modalId === 'travelInvoiceModal') currentTravelInvoiceDetailsForPdf = null;

                                                    if (modalId === 'paymentManagementModal') {
                                                        document.getElementById('addPaymentForm')?.reset();

                                                        document.getElementById('paymentHistoryTableBody').innerHTML = `<tr><td colspan="5" class="text-center py-3 text-gray-500">$ {
                    _t('payments_no_payments_recorded')
                }

                </td></tr>`;
                                                        document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];
                                                    }
                                                }

                                                // Add 'manage-moorings' to your existing views array
                                                // REPLACE the 'views' and 'viewTitles' constants
                                                let CURRENT_VIEW_ORIGIN = 'view-reservations';
                                                const views = ['dashboard',
                                                    'new-reservation',
                                                    'view-reservations',
                                                    'calendar',
                                                    'reports',
                                                    'daily-travels',
                                                    'travel-calendar',
                                                    'manage-moorings',
                                                    'settings',
                                                    'restaurant'];

                                                const viewTitles = {
                                                    'dashboard': {
                                                        key: 'nav.dashboard'
                                                    }

                                                    ,
                                                    'new-reservation': {
                                                        key: 'nav.newReservation'
                                                    }

                                                    ,
                                                    'view-reservations': {
                                                        key: 'nav.viewReservations'
                                                    }

                                                    ,
                                                    'calendar': {
                                                        key: 'nav.calendarView'
                                                    }

                                                    ,
                                                    'reports': {
                                                        key: 'nav.reports'
                                                    }

                                                    ,
                                                    'daily-travels': {
                                                        key: 'nav.dailyTravels.bookings'
                                                    }

                                                    ,
                                                    'travel-calendar': {
                                                        key: 'nav.dailyTravels.calendar'
                                                    }

                                                    ,
                                                    'manage-moorings': {
                                                        key: 'nav.moorings'
                                                    }

                                                    ,
                                                    'settings': {
                                                        key: 'nav.settings'
                                                    }

                                                    ,
                                                    'restaurant': {
                                                        key: 'nav.restaurant'
                                                    }
                                                }

                                                    ;

                                                function setupSettingsTabs() {
                                                    const tabs = document.querySelectorAll('.settings-tab');
                                                    const panels = document.querySelectorAll('.settings-tab-panel');

                                                    tabs.forEach(tab => {
                                                        tab.addEventListener('click', e => {
                                                            e.preventDefault();
                                                            const tabId = tab.dataset.tab;

                                                            // Update tab styles
                                                            tabs.forEach(t => {
                                                                t.classList.remove('border-indigo-500', 'text-indigo-600');
                                                                t.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
                                                            });
                                                            tab.classList.add('border-indigo-500', 'text-indigo-600');
                                                            tab.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');

                                                            // Show/hide panels
                                                            panels.forEach(panel => {
                                                                if (panel.id === `settings-$ {
                                            tabId
                                        }

                                        -panel`) {
                                                                    panel.classList.remove('hidden');

                                                                    // Trigger data fetch/render if needed when tab is activated
                                                                    switch (tabId) {
                                                                        case 'boats': renderBoatsTable(); break;
                                                                        case 'tariffs': renderTariffsPricesTable(); break;
                                                                        case 'extras': renderExtrasTable(); break;
                                                                        case 'trips': renderTripsTable(); break;
                                                                        case 'food': renderFoodTable(); break;
                                                                    }
                                                                }

                                                                else {
                                                                    panel.classList.add('hidden');
                                                                }
                                                            });
                                                        });
                                                    });
                                                }



                                                /**
                                                 * Lazy load restaurant data only when needed
                                                 */
                                                function ensureRestaurantLoaded(callback) {
                                                    if (lazyLoadFlags.restaurant) {
                                                        if (typeof callback === 'function') callback();
                                                        return;
                                                    }

                                                    console.log("Lazy loading restaurant data...");

                                                    fetchRestaurantData(() => {
                                                        lazyLoadFlags.restaurant = true;
                                                        if (typeof callback === 'function') callback();
                                                    });
                                                }


                                                /**
                                                 * Ensure all searchable data is loaded for global search
                                                 * Loads data in parallel for faster results
                                                 */
                                                function ensureSearchDataLoaded(callback) {
                                                    let loadCount = 0;
                                                    const totalToLoad = 4; // reservations, moorings, travels, restaurant

                                                    function checkComplete() {
                                                        loadCount++;

                                                        if (loadCount >= totalToLoad) {
                                                            if (typeof callback === 'function') callback();
                                                        }
                                                    }

                                                    // Load all searchable data sources in parallel
                                                    if (!lazyLoadFlags.reservations) {
                                                        fetchReservations(() => {
                                                            lazyLoadFlags.reservations = true;
                                                            checkComplete();
                                                        }

                                                            , "Global Search");
                                                    }

                                                    else {
                                                        checkComplete();
                                                    }

                                                    if (!lazyLoadFlags.moorings) {
                                                        fetchMoorings(() => {
                                                            lazyLoadFlags.moorings = true;
                                                            checkComplete();
                                                        });
                                                    }

                                                    else {
                                                        checkComplete();
                                                    }

                                                    if (!lazyLoadFlags.travels) {
                                                        fetchDailyTravels(() => {
                                                            lazyLoadFlags.travels = true;
                                                            checkComplete();
                                                        }

                                                            , "Global Search");
                                                    }

                                                    else {
                                                        checkComplete();
                                                    }

                                                    if (!lazyLoadFlags.restaurant) {
                                                        fetchRestaurantData(() => {
                                                            lazyLoadFlags.restaurant = true;
                                                            checkComplete();
                                                        });
                                                    }

                                                    else {
                                                        checkComplete();
                                                    }
                                                }

                                                // ==========================================
                                                // GLOBAL SEARCH FUNCTIONALITY
                                                // ==========================================

                                                let globalSearchTimeout;

                                                function performGlobalSearch(searchTerm) {
                                                    const resultsContainer = document.getElementById('globalSearchResults');

                                                    if (!resultsContainer) return;

                                                    // Show loading state
                                                    resultsContainer.innerHTML = ` <div class="global-search-loading"><div class="pro-spinner"></div><span>Searching...</span></div>`;
                                                    resultsContainer.classList.add('show');

                                                    // Debounce search
                                                    clearTimeout(globalSearchTimeout);

                                                    globalSearchTimeout = setTimeout(() => {

                                                        // Ensure critical data is loaded
                                                        ensureSearchDataLoaded(() => {
                                                            try {
                                                                const results = searchAllData(searchTerm.toLowerCase());
                                                                displayGlobalSearchResults(results);
                                                            }

                                                            catch (error) {
                                                                console.error('Global search error:', error);
                                                                resultsContainer.innerHTML = ` <div class="global-search-empty" > <i data-lucide="alert-circle" ></i> <p>Search error. Please try again.</p> </div> `;
                                                                if (lucide) lucide.createIcons();
                                                            }
                                                        });
                                                    }

                                                        , 300);
                                                }

                                                /**
                                                 * Search through all data sources
                                                 * Helper function to safely convert to string and search
                                                 */
                                                function safeStringSearch(value, term) {
                                                    if (!value) return false;
                                                    return String(value).toLowerCase().includes(term);
                                                }

                                                function searchAllData(term) {
                                                    const results = {
                                                        reservations: [],
                                                        moorings: [],
                                                        travels: [],
                                                        restaurant: []
                                                    }

                                                        ;

                                                    // Search Reservations
                                                    if (ALL_RESERVATIONS && ALL_RESERVATIONS.length > 0) {
                                                        results.reservations = ALL_RESERVATIONS.filter(r => {
                                                            return (safeStringSearch(r.clientName, term) || safeStringSearch(r.clientEmail, term) || safeStringSearch(r.clientPhone, term) || safeStringSearch(r.boatNameAuto, term) || safeStringSearch(r.reservationId, term));
                                                        }).slice(0, 5); // Limit to 5 results per category
                                                    }

                                                    // Search Moorings
                                                    if (ALL_MOORINGS && ALL_MOORINGS.length > 0) {
                                                        results.moorings = ALL_MOORINGS.filter(m => {
                                                            return (safeStringSearch(m.clientName, term) || safeStringSearch(m.boatName, term) || safeStringSearch(m.place, term) || safeStringSearch(m.clientPhone, term) || safeStringSearch(m.clientEmail, term));
                                                        }).slice(0, 5);
                                                    }

                                                    // Search Daily Travels
                                                    if (ALL_DAILY_TRAVELS && ALL_DAILY_TRAVELS.length > 0) {
                                                        results.travels = ALL_DAILY_TRAVELS.filter(t => {
                                                            return (safeStringSearch(t.clientName, term) || safeStringSearch(t.tripName, term) || safeStringSearch(t.travelId, term) || safeStringSearch(t.clientPhone, term));
                                                        }).slice(0, 5);
                                                    }

                                                    // Search Restaurant Reservations
                                                    if (ALL_RESTAURANT_RESERVATIONS && ALL_RESTAURANT_RESERVATIONS.length > 0) {
                                                        results.restaurant = ALL_RESTAURANT_RESERVATIONS.filter(r => {
                                                            return (safeStringSearch(r.clientName, term) || safeStringSearch(r.clientPhone, term) || safeStringSearch(r.clientEmail, term));
                                                        }).slice(0, 5);
                                                    }

                                                    return results;
                                                }

                                                function displayGlobalSearchResults(results) {
                                                    const resultsContainer = document.getElementById('globalSearchResults');
                                                    let html = '';
                                                    let totalResults = 0;

                                                    // Reservations
                                                    if (results.reservations.length > 0) {
                                                        totalResults += results.reservations.length;
                                                        html += '<div class="global-search-category"><i data-lucide="calendar"></i>Reservations</div>';

                                                        results.reservations.forEach(r => {
                                                            const checkIn = r.checkInDate || 'N/A';
                                                            const boat = r.boatNameAuto || 'Unknown boat';
                                                            const status = r.status || 'Unknown';

                                                            html += ` <div class="global-search-item" onclick="navigateToReservation('${r.reservationId}')" > <div class="global-search-item-title" > $ {
                            r.clientName || 'No name'
                        }

                        <span class="text-xs font-normal text-gray-500 ml-2" >#$ {
                            r.reservationId.substring(0, 8)
                        }

                        </span> </div> <div class="global-search-item-meta" > <span class="global-search-item-badge badge-reservation" >Reservation</span> <span>$ {
                            boat
                        }

                        </span> <span>Check-in: $ {
                            checkIn
                        }

                        </span> <span>Status: $ {
                            status
                        }

                        </span> </div> </div> `;
                                                        });
                                                    }

                                                    // Moorings
                                                    if (results.moorings.length > 0) {
                                                        totalResults += results.moorings.length;
                                                        html += '<div class="global-search-category"><i data-lucide="anchor"></i>Moorings</div>';

                                                        results.moorings.forEach(m => {
                                                            const place = m.place || 'N/A';
                                                            const boat = m.boatName || 'Unknown boat';
                                                            const status = m.paymentStatus || 'Unknown';

                                                            html += ` <div class="global-search-item" onclick="navigateToMooring('${m.mooringId}')" > <div class="global-search-item-title" >$ {
                            m.clientName || 'No name'
                        }

                        </div> <div class="global-search-item-meta" > <span class="global-search-item-badge badge-mooring" >Mooring</span> <span>$ {
                            boat
                        }

                        </span> <span>Place: $ {
                            place
                        }

                        </span> <span>Status: $ {
                            status
                        }

                        </span> </div> </div> `;
                                                        });
                                                    }

                                                    // Daily Travels
                                                    if (results.travels.length > 0) {
                                                        totalResults += results.travels.length;
                                                        html += '<div class="global-search-category"><i data-lucide="sailboat"></i>Daily Travels</div>';

                                                        results.travels.forEach(t => {
                                                            const date = t.travelDate || 'N/A';
                                                            const trip = t.tripName || 'Unknown trip';

                                                            html += ` <div class="global-search-item" onclick="navigateToTravel('${t.travelId}')" > <div class="global-search-item-title" >$ {
                            t.clientName || 'No name'
                        }

                        </div> <div class="global-search-item-meta" > <span class="global-search-item-badge badge-travel" >Travel</span> <span>$ {
                            trip
                        }

                        </span> <span>Date: $ {
                            date
                        }

                        </span> </div> </div> `;
                                                        });
                                                    }

                                                    // Restaurant
                                                    if (results.restaurant.length > 0) {
                                                        totalResults += results.restaurant.length;
                                                        html += '<div class="global-search-category"><i data-lucide="utensils-crossed"></i>Restaurant</div>';

                                                        results.restaurant.forEach(r => {
                                                            const date = r.reservationDate || 'N/A';
                                                            const time = r.reservationHour || '';
                                                            const people = r.numPeople || '?';

                                                            html += ` <div class="global-search-item" onclick="navigateToRestaurant('${r.reservationId}')" > <div class="global-search-item-title" >$ {
                            r.clientName || 'No name'
                        }

                        </div> <div class="global-search-item-meta" > <span class="global-search-item-badge badge-restaurant" >Restaurant</span> <span>$ {
                            date
                        }

                        $ {
                            time
                        }

                        </span> <span>$ {
                            people
                        }

                        people</span> </div> </div> `;
                                                        });
                                                    }

                                                    if (totalResults === 0) {
                                                        html = ` <div class="global-search-empty"><i data-lucide="search-x"></i><p>No results found</p></div>`;
                                                    }

                                                    resultsContainer.innerHTML = html;
                                                    resultsContainer.classList.add('show');
                                                    if (lucide) lucide.createIcons();
                                                }

                                                // Global variable to store the selected reservation ID
                                                let selectedReservationIdForAction = null;

                                                /**
                                                 * Shows options modal for reservation navigation
                                                 * @param {string} reservationId - The reservation ID to navigate to
                                                 */
                                                function navigateToReservation(reservationId) {
                                                    // Store the reservation ID for later use
                                                    selectedReservationIdForAction = reservationId;

                                                    // Close the search results
                                                    closeGlobalSearch();

                                                    // Show the action modal
                                                    openModal('reservationActionModal');

                                                    // Set up the button click handlers
                                                    const viewInCalendarBtn = document.getElementById('viewInCalendarBtn');
                                                    const editReservationBtn = document.getElementById('editReservationBtn');

                                                    // Remove any existing event listeners by cloning and replacing
                                                    const newViewBtn = viewInCalendarBtn.cloneNode(true);
                                                    const newEditBtn = editReservationBtn.cloneNode(true);
                                                    viewInCalendarBtn.parentNode.replaceChild(newViewBtn, viewInCalendarBtn);
                                                    editReservationBtn.parentNode.replaceChild(newEditBtn, editReservationBtn);

                                                    // Add new event listeners
                                                    document.getElementById('viewInCalendarBtn').addEventListener('click', () => {
                                                        viewReservationInCalendar(selectedReservationIdForAction);
                                                    });

                                                    document.getElementById('editReservationBtn').addEventListener('click', () => {
                                                        editReservationDetails(selectedReservationIdForAction);
                                                    });

                                                    // Re-initialize Lucide icons
                                                    if (lucide) lucide.createIcons();
                                                }

                                                /**
                                                 * Navigate to calendar view and highlight the reservation
                                                 * @param {string} reservationId - The reservation ID to highlight
                                                 */
                                                function viewReservationInCalendar(reservationId) {
                                                    closeModal('reservationActionModal');

                                                    // Find the reservation
                                                    const reservation = ALL_RESERVATIONS.find(r => r.reservationId === reservationId);

                                                    if (!reservation) {
                                                        showNotification('Reservation not found', 'error');
                                                        return;
                                                    }

                                                    // Check if reservation has valid check-in date
                                                    if (!reservation.checkInDate) {
                                                        showNotification('Reservation has no check-in date', 'error');
                                                        return;
                                                    }

                                                    // Parse the check-in date to get the year
                                                    const targetDate = getDateUTC(reservation.checkInDate, reservation.checkInTime || "00:00");

                                                    if (!targetDate) {
                                                        showNotification(`Could not parse date for reservation $ {
                        reservationId
                    }

                    `, 'error');
                                                        return;
                                                    }

                                                    const targetYear = targetDate.getUTCFullYear();

                                                    // Navigate to calendar view
                                                    showView('calendar');

                                                    // If year is different, render the new calendar
                                                    if (targetYear !== calendarDisplayYear) {
                                                        calendarDisplayYear = targetYear;
                                                        renderYearCalendarGrid(calendarDisplayYear);
                                                    }

                                                    // Wait for calendar to render, then scroll and highlight
                                                    setTimeout(() => {
                                                        const reservationBlock = document.querySelector(`.reservation-block[title*="ID: ${reservationId}"]`);

                                                        if (reservationBlock) {

                                                            // Scroll to the reservation
                                                            reservationBlock.scrollIntoView({
                                                                behavior: 'smooth',
                                                                block: 'center',
                                                                inline: 'center'
                                                            });

                                                            // Add highlight animation
                                                            reservationBlock.classList.add('highlight-search');

                                                            // Remove highlight after animation
                                                            setTimeout(() => {
                                                                reservationBlock.classList.remove('highlight-search');
                                                            }

                                                                , 4500);

                                                            showNotification(`Found reservation for $ {
                            reservation.clientName
                        }

                        `, 'success', 3000);
                                                        }

                                                        else {

                                                            // If block not found, try scrolling to the date cell
                                                            showNotification(`Showing calendar for $ {
                            reservation.clientName
                        }

                        's reservation`, ' info', 3000);

                                                            const dateCell = document.querySelector(`td[data-date="${reservation.checkInDate}"][data-slot-type="AM"]`);

                                                            if (dateCell) {
                                                                dateCell.scrollIntoView({
                                                                    behavior: 'smooth',
                                                                    block: 'center',
                                                                    inline: 'center'
                                                                });
                                                            }
                                                        }
                                                    }

                                                        , 500);
                                                }

                                                /**
                                                 * Open reservation for editing
                                                 * @param {string} reservationId - The reservation ID to edit
                                                 */
                                                function editReservationDetails(reservationId) {
                                                    closeModal('reservationActionModal');

                                                    showView('new-reservation', {
                                                        mode: 'edit', reservationId: reservationId
                                                    });
                                                }

                                                function navigateToMooring(mooringId) {
                                                    closeGlobalSearch();
                                                    showView('manage-moorings');

                                                    setTimeout(() => {
                                                        showMooringDetails(mooringId);
                                                    }

                                                        , 300);
                                                }

                                                function navigateToTravel(travelId) {
                                                    closeGlobalSearch();
                                                    showView('daily-travels');

                                                    setTimeout(() => {
                                                        openTravelBookingForEdit(travelId);
                                                    }

                                                        , 300);
                                                }

                                                function navigateToRestaurant(reservationId) {
                                                    closeGlobalSearch();
                                                    showView('restaurant');

                                                    setTimeout(() => {
                                                        openRestaurantForm('edit', reservationId);
                                                    }

                                                        , 300);
                                                }

                                                /**
                                                 * Close global search dropdown
                                                 */
                                                function closeGlobalSearch() {
                                                    const resultsContainer = document.getElementById('globalSearchResults');
                                                    resultsContainer.classList.remove('show');
                                                }

                                                // --- Sidebar Collapse/Expand Functionality ---
                                                function toggleSidebar() {
                                                    const sidebar = document.getElementById('sidebar');
                                                    const mainContent = document.querySelector('.main-content');
                                                    const toggleBtn = document.getElementById('sidebarToggleBtn');
                                                    const collapseIcon = toggleBtn.querySelector('.icon-collapse');
                                                    const expandIcon = toggleBtn.querySelector('.icon-expand');

                                                    // Toggle the collapsed class
                                                    sidebar.classList.toggle('collapsed');
                                                    mainContent.classList.toggle('expanded');

                                                    // Switch icons
                                                    if (sidebar.classList.contains('collapsed')) {
                                                        collapseIcon.classList.add('hidden');
                                                        expandIcon.classList.remove('hidden');
                                                        toggleBtn.title = 'Expand Sidebar';
                                                        localStorage.setItem('sidebarCollapsed', 'true');
                                                    }

                                                    else {
                                                        collapseIcon.classList.remove('hidden');
                                                        expandIcon.classList.add('hidden');
                                                        toggleBtn.title = 'Collapse Sidebar';
                                                        localStorage.setItem('sidebarCollapsed', 'false');
                                                    }

                                                    // Re-render lucide icons
                                                    if (lucide) lucide.createIcons();
                                                }

                                                // Restore sidebar state on page load
                                                function restoreSidebarState() {
                                                    const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

                                                    if (isCollapsed) {
                                                        const sidebar = document.getElementById('sidebar');
                                                        const mainContent = document.querySelector('.main-content');
                                                        const toggleBtn = document.getElementById('sidebarToggleBtn');
                                                        const collapseIcon = toggleBtn?.querySelector('.icon-collapse');
                                                        const expandIcon = toggleBtn?.querySelector('.icon-expand');

                                                        sidebar?.classList.add('collapsed');
                                                        mainContent?.classList.add('expanded');

                                                        if (collapseIcon && expandIcon) {
                                                            collapseIcon.classList.add('hidden');
                                                            expandIcon.classList.remove('hidden');
                                                            toggleBtn.title = 'Expand Sidebar';
                                                        }
                                                    }
                                                }

                                                function showView(viewId, params = {}) {
                                                    console.log(`showView: Switching to '${viewId}' . Params:`, params);

                                                    // Origin Tracking: If we are going TO a form/detail view, remember WHERE we came from.
                                                    // If we are currently on a "list" view, mark it as the origin.
                                                    const currentActiveView = views.find(v => {
                                                        const el = document.getElementById(`$ {
                            v
                        }

                        -view`);
                                                        return el && !el.classList.contains('hidden');
                                                    });

                                                    if (currentActiveView === 'view-reservations' || currentActiveView === 'calendar') {
                                                        CURRENT_VIEW_ORIGIN = currentActiveView;
                                                    }

                                                    views.forEach(id_from_loop => {
                                                        let elementToHideId = `$ {
                        id_from_loop
                    }

                    -view`;
                                                        const elToHide = document.getElementById(elementToHideId);

                                                        if (elToHide) {
                                                            elToHide.classList.add('hidden');
                                                        }

                                                        else {
                                                            console.warn(`showView (hiding phase): Element with ID '${elementToHideId}' not found for viewId '${id_from_loop}' .`);
                                                        }
                                                    });

                                                    let currentViewElId = `$ {
                viewId
            }

            -view`;
                                                    const currentViewEl = document.getElementById(currentViewElId);

                                                    if (currentViewEl) {
                                                        currentViewEl.classList.remove('hidden');
                                                    }

                                                    else {
                                                        console.error(`showView (showing phase): Element with ID '${currentViewElId}' not found for viewId '${viewId}' .`);

                                                        showNotification(_t('notifications.error', {
                                                            message: `UI component for '${viewId}' is missing.`
                                                        }), 'error');
                                                        document.getElementById('dashboard-view')?.classList.remove('hidden');
                                                        return;
                                                    }

                                                    const viewTitleEl = document.getElementById('view-title');
                                                    const reservationFormTitleEl = document.getElementById('reservationFormTitle');
                                                    const newOrEditLinkTextEl = document.getElementById('newOrEditReservationLinkText');

                                                    if (viewTitleEl && viewTitles[viewId]) viewTitleEl.textContent = _t(viewTitles[viewId].key);
                                                    else if (viewTitleEl) viewTitleEl.textContent = _t('nav.dashboard');

                                                    if (viewId === 'new-reservation') {
                                                        const isEdit = params.mode === 'edit' && params.reservationId;
                                                        wizard.initialize(isEdit, params.reservationId);

                                                        if (isEdit) {
                                                            if (reservationFormTitleEl) reservationFormTitleEl.textContent = _t('newReservation.formTitleEdit', {
                                                                id: params.reservationId
                                                            });
                                                            if (viewTitleEl) viewTitleEl.textContent = _t('nav.editReservation');
                                                            if (newOrEditLinkTextEl) newOrEditLinkTextEl.textContent = _t('nav.editReservation');
                                                            document.getElementById('initialPaymentSection').classList.add('hidden');
                                                            loadReservationForEditing(params.reservationId);
                                                        }

                                                        else {
                                                            if (reservationFormTitleEl) reservationFormTitleEl.textContent = _t('newReservation.formTitleCreate');
                                                            if (viewTitleEl) viewTitleEl.textContent = _t('nav.newReservation');
                                                            if (newOrEditLinkTextEl) newOrEditLinkTextEl.textContent = _t('nav.newReservation');
                                                            document.getElementById('initialPaymentSection').classList.remove('hidden');
                                                        }
                                                    }

                                                    else {
                                                        if (newOrEditLinkTextEl) newOrEditLinkTextEl.textContent = _t('nav.newReservation');
                                                    }

                                                    document.querySelectorAll('.nav-link').forEach(link => {
                                                        link.classList.remove('active');

                                                        if (link.getAttribute('onclick')?.includes(`showView('${viewId}')`)) {
                                                            link.classList.add('active');
                                                        }
                                                    });
                                                    const sidebar = document.getElementById('sidebar');

                                                    if (window.innerWidth < 768 && sidebar && !sidebar.classList.contains('sidebar-hidden')) {
                                                        sidebar.classList.add('sidebar-hidden');
                                                    }

                                                    if (!isInitialLoadComplete && !['dashboard', 'new-reservation'].includes(viewId)) {
                                                        console.warn(`showView: Called for '${viewId}' before initial load fully complete. Data might be incomplete.`);
                                                    }

                                                    switch (viewId) {
                                                        case 'dashboard': fetchDashboardData();
                                                            const finStartDateEl = document.getElementById('financialReportStartDate');
                                                            const finEndDateEl = document.getElementById('financialReportEndDate');

                                                            if (finStartDateEl && finEndDateEl) {
                                                                const todayForReport = new Date();
                                                                const firstDayOfMonth = new Date(todayForReport.getFullYear(), todayForReport.getMonth(), 1);
                                                                finStartDateEl.value = firstDayOfMonth.toISOString().split('T')[0];
                                                                finEndDateEl.value = todayForReport.toISOString().split('T')[0];
                                                            }

                                                            break;

                                                        case 'manage-moorings': ensureMooringsLoaded(() => {
                                                            renderMooringMap(ALL_MOORINGS);
                                                            renderMooringNotifications(ALL_MOORINGS); // This is the new function call
                                                        });
                                                            break;

                                                        case 'view-reservations': ensureReservationsLoaded(() => {
                                                            renderReservationsPage();
                                                        });
                                                            break;

                                                        case 'calendar': const gridContainer = document.getElementById('calendarYearGridContainer');
                                                            const yearDisplay = document.getElementById('currentYearDisplay');

                                                            if (!gridContainer || !yearDisplay) {
                                                                console.error("Calendar view critical elements not found.");
                                                                const calViewDiv = document.getElementById('calendar-view');

                                                                if (calViewDiv) calViewDiv.innerHTML = `<div class="p-6 bg-white rounded-lg shadow-lg text-red-500 text-center" >$ {
                    _t('notifications.error', {
                        message: 'Calendar components could not be initialized.'
                    })
            }

            </div>`;
                                                            }

                                                            else {
                                                                ensureBoatsLoaded(() => {
                                                                    ensureReservationsLoaded(() => {
                                                                        initializeYearCalendar();
                                                                    });
                                                                });
                                                            }

                                                            break;

                                                        case 'reports': const reportStartDateEl = document.getElementById('reportStartDate');
                                                            const reportEndDateEl = document.getElementById('reportEndDate');

                                                            if (reportStartDateEl && reportEndDateEl) {
                                                                const todayForReport = new Date();
                                                                const firstDayOfMonth = new Date(todayForReport.getFullYear(), todayForReport.getMonth(), 1);
                                                                reportStartDateEl.value = firstDayOfMonth.toISOString().split('T')[0];
                                                                reportEndDateEl.value = todayForReport.toISOString().split('T')[0];
                                                            }

                                                            break;

                                                        case 'settings': ensureBoatsLoaded(() => renderBoatsTable());
                                                            ensureTariffsLoaded(() => renderTariffsPricesTable());
                                                            ensureExtrasLoaded(() => renderExtrasTable());
                                                            ensureTripsLoaded(() => renderTripsTable());
                                                            ensureFoodLoaded(() => renderFoodTable());
                                                            break;

                                                        case 'daily-travels': ensureTripsLoaded(() => {
                                                            ensureFoodLoaded(() => {
                                                                ensureTravelsLoaded(() => {
                                                                    renderDailyTravelsTable();
                                                                    populateTripSelect();
                                                                    populateFoodOptions();
                                                                    resetTravelForm();
                                                                });
                                                            });
                                                        });
                                                            break;

                                                        case 'travel-calendar': ensureTravelsLoaded(() => {
                                                            initializeTravelCalendar();
                                                        });
                                                            break;

                                                        case 'restaurant': ensureRestaurantLoaded(() => {
                                                            renderRestaurantTable();
                                                            initializeRestaurantCalendar();
                                                        });
                                                            break;

                                                        case 'new-reservation': ensureBoatsLoaded(() => {
                                                            ensureExtrasLoaded(() => {
                                                                populateBoatSelect();
                                                                populateExtras();
                                                            });
                                                        });
                                                            break;
                                                    }
                                                }

                                                document.getElementById('menu-button')?.addEventListener('click', () => document.getElementById('sidebar')?.classList.toggle('sidebar-hidden'));

                                                function fetchDashboardData() {
                                                    console.log("fetchDashboardData: Called.");

                                                    // Check cache first
                                                    if (isCacheValid('dashboard')) {
                                                        console.log("fetchDashboardData: Using cached data (skipping refresh).");
                                                        return;
                                                    }

                                                    showLoading(true, "notifications.loading", {
                                                        item: _t('nav.dashboard')
                                                    });

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);
                                                        console.log("fetchDashboardData: Success. Response:", response);

                                                        if (response && typeof response === 'object') {
                                                            if (response.error) {
                                                                showNotification(_t('notifications.error', {
                                                                    message: `Dashboard data error: $ {
                                    response.error
                                }

                                `
                                                                }), 'error');
                                                            }

                                                            else {
                                                                updateCacheTimestamp('dashboard');

                                                                document.getElementById('db-active-reservations').textContent = response.activeReservations ?? '--';
                                                                document.getElementById('db-upcoming-checkins').textContent = response.upcomingCheckins ?? '--';
                                                                document.getElementById('db-pending-payments').textContent = response.pendingPayments ?? '--';
                                                                document.getElementById('db-available-boats').textContent = response.availableBoats ?? '-- / --';

                                                                // Load data for filters
                                                                ensureReservationsLoaded(function () {
                                                                    ensureTravelsLoaded(function () {
                                                                        filterDashboardCheckins('today');
                                                                        filterDashboardCheckouts('today');
                                                                        filterDashboardTravels('today');
                                                                    });
                                                                });
                                                            }
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Received invalid dashboard data from server.'
                                                            }), 'error');
                                                            console.error("fetchDashboardData: Received null or non-object response:", response);
                                                        }

                                                    }).withFailureHandler(err => {
                                                        showLoading(false);
                                                        console.error("fetchDashboardData: Failure. Error:", err);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to load dashboard data: $ {
                            err.message || 'Unknown error'
                        }

                        `
                                                        }), 'error');
                                                    }).getDashboardData();
                                                }

                                                function filterDashboardCheckins(period) {
                                                    ['today', 'tomorrow', 'week'].forEach(function (p) {
                                                        const btn = document.getElementById('dash-checkin-' + p);

                                                        if (btn) {
                                                            if (p === period) {
                                                                btn.className = 'px-2 py-1 text-xs font-medium rounded bg-blue-600 text-white';
                                                            }

                                                            else {
                                                                btn.className = 'px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
                                                            }
                                                        }
                                                    });

                                                    const checkinsList = document.getElementById('db-today-checkins-list');
                                                    const filtered = getFilteredByDate(ALL_RESERVATIONS, 'checkInDate', period);

                                                    checkinsList.innerHTML = '';

                                                    if (filtered.length === 0) {
                                                        checkinsList.innerHTML = '<li class="text-gray-500">No check-ins scheduled</li>';
                                                        return;
                                                    }

                                                    filtered.forEach(function (item) {
                                                        const li = document.createElement('li');
                                                        li.innerHTML = '<span class="client-name">' + item.clientName + ' <span class="boat-name">(' + item.boatNameAuto + ')</span></span> <span class="time-info">' + (item.checkInTime || '09:00') + '</span>';
                                                        checkinsList.appendChild(li);
                                                    });
                                                }

                                                function filterDashboardCheckouts(period) {
                                                    ['today', 'tomorrow', 'week'].forEach(function (p) {
                                                        const btn = document.getElementById('dash-checkout-' + p);

                                                        if (btn) {
                                                            if (p === period) {
                                                                btn.className = 'px-2 py-1 text-xs font-medium rounded bg-purple-600 text-white';
                                                            }

                                                            else {
                                                                btn.className = 'px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
                                                            }
                                                        }
                                                    });

                                                    const checkoutsList = document.getElementById('db-today-checkouts-list');
                                                    const filtered = getFilteredByDate(ALL_RESERVATIONS, 'checkOutDate', period);

                                                    checkoutsList.innerHTML = '';

                                                    if (filtered.length === 0) {
                                                        checkoutsList.innerHTML = '<li class="text-gray-500">No check-outs scheduled</li>';
                                                        return;
                                                    }

                                                    filtered.forEach(function (item) {
                                                        const li = document.createElement('li');
                                                        li.innerHTML = '<span class="client-name">' + item.clientName + ' <span class="boat-name">(' + item.boatNameAuto + ')</span></span> <span class="time-info">' + (item.checkOutTime || '09:00') + '</span>';
                                                        checkoutsList.appendChild(li);
                                                    });
                                                }

                                                function filterDashboardTravels(period) {
                                                    ['today', 'tomorrow', 'week'].forEach(function (p) {
                                                        const btn = document.getElementById('dash-travel-' + p);

                                                        if (btn) {
                                                            if (p === period) {
                                                                btn.className = 'px-2 py-1 text-xs font-medium rounded bg-green-600 text-white';
                                                            }

                                                            else {
                                                                btn.className = 'px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded hover:bg-gray-300';
                                                            }
                                                        }
                                                    });

                                                    const travelsList = document.getElementById('db-travels-list');
                                                    const filtered = getFilteredByDate(ALL_DAILY_TRAVELS, 'travelDate', period);

                                                    travelsList.innerHTML = '';

                                                    if (filtered.length === 0) {
                                                        travelsList.innerHTML = '<li class="text-gray-500">No travels scheduled</li>';
                                                        return;
                                                    }

                                                    filtered.forEach(function (item) {
                                                        const people = (parseInt(item.adults) || 0) + (parseInt(item.kids) || 0) + (parseInt(item.seniors) || 0);
                                                        const li = document.createElement('li');
                                                        li.innerHTML = '<span class="client-name">' + item.clientName + ' <span class="boat-name">(' + item.tripName + ' - ' + people + ' people)</span></span> <span class="time-info">' + (item.travelTime || 'N/A') + '</span>';
                                                        travelsList.appendChild(li);
                                                    });
                                                }

                                                function getFilteredByDate(dataArray, dateField, period) {
                                                    // FIX: Use local timezone instead of UTC to avoid date offset issues
                                                    const today = new Date();
                                                    today.setHours(0, 0, 0, 0);

                                                    // Format as YYYY-MM-DD in local timezone
                                                    const todayStr = `$ {
                today.getFullYear()
            }

            -$ {
                String(today.getMonth() + 1).padStart(2, '0')
            }

            -$ {
                String(today.getDate()).padStart(2, '0')
            }

            `;

                                                    const tomorrow = new Date(today);
                                                    tomorrow.setDate(tomorrow.getDate() + 1);

                                                    const tomorrowStr = `$ {
                tomorrow.getFullYear()
            }

            -$ {
                String(tomorrow.getMonth() + 1).padStart(2, '0')
            }

            -$ {
                String(tomorrow.getDate()).padStart(2, '0')
            }

            `;

                                                    const weekFromNow = new Date(today);
                                                    weekFromNow.setDate(weekFromNow.getDate() + 7);

                                                    const weekStr = `$ {
                weekFromNow.getFullYear()
            }

            -$ {
                String(weekFromNow.getMonth() + 1).padStart(2, '0')
            }

            -$ {
                String(weekFromNow.getDate()).padStart(2, '0')
            }

            `;

                                                    return dataArray.filter(function (item) {
                                                        if (item.status === 'Cancelled') return false;
                                                        const itemDate = item[dateField];
                                                        if (!itemDate) return false;

                                                        if (period === 'today') {
                                                            return itemDate === todayStr;
                                                        }

                                                        else if (period === 'tomorrow') {
                                                            return itemDate === tomorrowStr;
                                                        }

                                                        else if (period === 'week') {
                                                            return itemDate >= todayStr && itemDate <= weekStr;
                                                        }

                                                        return false;

                                                    }).sort(function (a, b) {
                                                        return a[dateField].localeCompare(b[dateField]);
                                                    });
                                                }

                                                function generateRestaurantQuickReport() {
                                                    const today = new Date();
                                                    const weekFromNow = new Date(today);
                                                    weekFromNow.setDate(weekFromNow.getDate() + 7);

                                                    const startDate = today.toISOString().split('T')[0];
                                                    const endDate = weekFromNow.toISOString().split('T')[0];

                                                    showCustomConfirm({

                                                        title: 'Generate Restaurant Report',
                                                        message: 'Generate a PDF report of restaurant reservations for the next 7 days.',
                                                        details: [`<strong>From:</strong> $ {
                    startDate
                }

                `,
                                                            `<strong>To:</strong> $ {
                    endDate
                }

                `],
                                                        confirmText: 'Generate Report',
                                                        confirmColor: 'indigo',
                                                        icon: 'info',
                                                        onConfirm: function () {
                                                            generateAndDownloadPdf({
                                                                startDate: startDate, endDate: endDate
                                                            }

                                                                , 'restaurantReport');
                                                        }
                                                    });

                                                    if (lucide) lucide.createIcons();
                                                }

                                                function openQuickReportDialog() {
                                                    const today = new Date();
                                                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                                                    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);

                                                    const startDate = firstDayOfMonth.toISOString().split('T')[0];
                                                    const endDate = lastDayOfMonth.toISOString().split('T')[0];

                                                    showCustomConfirm({
                                                        title: 'Generate Reservation Report',
                                                        message: 'Generate a PDF report of check-ins and check-outs for the selected date range.',
                                                        details: ['<label class="text-sm font-medium text-gray-700">Start Date:</label><input type="date" id="quick-report-start" value="' + startDate + '" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">',
                                                        '<label class="text-sm font-medium text-gray-700 mt-3 block">End Date:</label><input type="date" id="quick-report-end" value="' + endDate + '" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">'

                                                        ],
                                                        confirmText: 'Generate Report',
                                                        confirmColor: 'indigo',
                                                        icon: 'info',
                                                        onConfirm: function () {
                                                            const start = document.getElementById('quick-report-start').value;
                                                            const end = document.getElementById('quick-report-end').value;

                                                            if (start && end) {
                                                                generateAndDownloadPdf({
                                                                    startDate: start, endDate: end
                                                                }

                                                                    , 'report');
                                                            }

                                                            else {
                                                                showNotification('Please select both start and end dates', 'error');
                                                            }
                                                        }
                                                    });

                                                    if (lucide) lucide.createIcons();
                                                }

                                                function openQuickStaySheetsDialog() {
                                                    const today = new Date();
                                                    const weekFromNow = new Date(today);
                                                    weekFromNow.setDate(weekFromNow.getDate() + 7);

                                                    const startDate = today.toISOString().split('T')[0];
                                                    const endDate = weekFromNow.toISOString().split('T')[0];

                                                    showCustomConfirm({
                                                        title: 'Generate Stay Sheets',
                                                        message: 'Generate printable "Ficha de Estadia" for all check-ins in the selected date range.',
                                                        details: ['<label class="text-sm font-medium text-gray-700">Check-in Start Date:</label><input type="date" id="quick-staysheet-start" value="' + startDate + '" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">',
                                                        '<label class="text-sm font-medium text-gray-700 mt-3 block">Check-in End Date:</label><input type="date" id="quick-staysheet-end" value="' + endDate + '" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">'

                                                        ],
                                                        confirmText: 'Generate Stay Sheets',
                                                        confirmColor: 'green',
                                                        icon: 'info',
                                                        onConfirm: function () {
                                                            const start = document.getElementById('quick-staysheet-start').value;
                                                            const end = document.getElementById('quick-staysheet-end').value;

                                                            if (start && end) {
                                                                generateAndDownloadPdf({
                                                                    startDate: start, endDate: end
                                                                }

                                                                    , 'staySheets');
                                                            }

                                                            else {
                                                                showNotification('Please select both start and end dates', 'error');
                                                            }
                                                        }
                                                    });

                                                    if (lucide) lucide.createIcons();
                                                }

                                                function populateBoatSelect() {
                                                    const select = document.getElementById('boatId');
                                                    if (!select) return;
                                                    const currentValue = select.value;

                                                    select.innerHTML = `<option value="" >$ {
                _t('newReservation.boatSelectLabel')
            }

            </option>`;

                                                    if (ALL_BOATS && ALL_BOATS.length > 0) {
                                                        ALL_BOATS.forEach(boat => {
                                                            if (boat && boat.uniqueId && boat.boatName && boat.boatModel) {
                                                                const option = document.createElement('option');
                                                                option.value = boat.uniqueId;

                                                                option.textContent = `$ {
                                boat.boatName
                            }

                            ($ {
                                    boat.boatModel
                                })`;
                                                                option.dataset.model = boat.boatModel;
                                                                select.appendChild(option);
                                                            }
                                                        });
                                                        if (currentValue) select.value = currentValue;
                                                    }

                                                    else {
                                                        select.innerHTML += `<option value="" disabled>$ {
                    _t('newReservation.boatSelectDefaultOption')
                }

                </option>`;
                                                    }
                                                }

                                                document.getElementById('boatId')?.addEventListener('change', function () {
                                                    const boatModelInput = document.getElementById('boatModelDisplay');
                                                    if (boatModelInput) boatModelInput.value = this.options[this.selectedIndex]?.dataset?.model || '';
                                                });

                                                function populateExtras(selectedExtrasData = {}) {
                                                    const container = document.getElementById('extrasContainer');
                                                    if (!container) return;
                                                    container.innerHTML = '';

                                                    if (ALL_EXTRAS && ALL_EXTRAS.length > 0) {
                                                        ALL_EXTRAS.forEach(extra => {
                                                            if (extra && extra.extraName && typeof extra.price === 'number' && extra.unit) {
                                                                const currentQuantity = selectedExtrasData[extra.extraName]?.quantity || 0;
                                                                const div = document.createElement('div');

                                                                let displayUnit = extra.unit;
                                                                if (extra.unit === 'per day') displayUnit = _t('extraModal.unitPerDay');
                                                                else if (extra.unit === 'per booking') displayUnit = _t('extraModal.unitPerBooking');

                                                                div.innerHTML = ` <label for="extra_${extra.extraName.replace(/\s+/g, '_')}" > $ {
                                extra.extraName
                            }

                            <div class="extra-unit" >€$ {
                                extra.price.toFixed(2)
                            }

                            / $ {
                                displayUnit
                            }

                            </div> </label> <input type="number"
                            id="extra_${extra.extraName.replace(/\s+/g, '_')}"
                            name="extra_${extra.extraName.replace(/\s+/g, '_')}"
                            data-price="${extra.price}"
                            data-unit="${extra.unit}"
                            data-name="${extra.extraName}"
                            min="0"
                            value="${currentQuantity}"
                            placeholder="Qty"
                            class="price-trigger" > `;
                                                                container.appendChild(div);
                                                            }
                                                        });
                                                    }

                                                    else {
                                                        container.innerHTML = `<p class="text-sm text-gray-500 col-span-full text-center py-4" >$ {
                    _t('newReservation.extrasLoading')
                }

                </p>`;
                                                    }
                                                }

                                                document.getElementById('newReservationForm')?.addEventListener('submit', function (event) {
                                                    event.preventDefault();
                                                    document.getElementById('newReservationForm').dataset.currentExtras = JSON.stringify(getSelectedExtras());
                                                    handleSaveOrUpdateReservation();
                                                });

                                                document.getElementById('reservationSource')?.addEventListener('change', function (event) {
                                                    const manualSources = ['NICOLS', 'Ancorado', 'Diaria'];
                                                    const isManual = manualSources.includes(event.target.value);

                                                    const priceSummaryDiv = document.getElementById('priceSummary').parentElement;
                                                    const manualTotalCostContainer = document.getElementById('manualTotalCostContainer');
                                                    const calculatePriceBtn = document.querySelector('button[onclick="calculatePrice()"]');

                                                    if (isManual) {
                                                        priceSummaryDiv.classList.add('hidden');
                                                        manualTotalCostContainer.classList.remove('hidden');
                                                        if (calculatePriceBtn) calculatePriceBtn.classList.add('hidden');
                                                    }

                                                    else {
                                                        priceSummaryDiv.classList.remove('hidden');
                                                        manualTotalCostContainer.classList.add('hidden');
                                                        if (calculatePriceBtn) calculatePriceBtn.classList.remove('hidden');
                                                    }
                                                });

                                                function getSelectedExtras() {
                                                    const extras = {}

                                                        ;

                                                    document.querySelectorAll('#extrasContainer input[type="number"]').forEach(input => {
                                                        const quantity = parseInt(input.value);

                                                        if (quantity > 0) {
                                                            extras[input.dataset.name] = {
                                                                quantity: quantity, price: parseFloat(input.dataset.price), unit: input.dataset.unit
                                                            }

                                                                ;
                                                        }
                                                    });
                                                    return extras;
                                                }

                                                function calculatePrice() {
                                                    const form = document.getElementById('newReservationForm');

                                                    if (!form) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Reservation form not found."
                                                        }), "error"); return;
                                                    }

                                                    showLoading(true, "notifications.processing");
                                                    const formData = new FormData(form);
                                                    const boatSelect = document.getElementById('boatId');
                                                    const selectedBoatOption = boatSelect ? boatSelect.options[boatSelect.selectedIndex] : null;

                                                    const params = {
                                                        boatModel: selectedBoatOption ? selectedBoatOption.dataset.model : '',
                                                        checkInDate: formData.get('checkInDate'), checkInTime: formData.get('checkInTime'),
                                                        checkOutDate: formData.get('checkOutDate'), checkOutTime: formData.get('checkOutTime'),
                                                        selectedExtras: JSON.stringify(getSelectedExtras()),
                                                        discountPercentage: parseFloat(formData.get('discountPercentage')) || 0,
                                                        taxValue: parseFloat(formData.get('taxValue')) || 0,
                                                    }

                                                        ;

                                                    if (!params.boatModel || !params.checkInDate || !params.checkOutDate || !params.checkInTime || !params.checkOutTime) {
                                                        showNotification(_t('notifications.error', {
                                                            message: 'Please select a boat and all check-in/out dates and times.'
                                                        }), 'error');

                                                        showLoading(false); populatePriceSummary({}); return;
                                                    }

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (!response || typeof response !== 'object') {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Price calculation error: Invalid response from server.'
                                                            }), 'error', 7000);

                                                            populatePriceSummary({}); console.error("calculatePrice: Invalid response", response); return;
                                                        }

                                                        if (response.error) {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Price calculation error: $ {
                        response.error
                    }

                    `
                                                            }), 'error', 7000);

                                                            populatePriceSummary({}); return;
                                                        }

                                                        populatePriceSummary(response);

                                                        showNotification(response.message ? _t(response.message) : _t('notifications.success', {
                                                            message: 'Price calculated.'
                                                        }), 'success');

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to calculate price: $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error', 7000);

                                                        populatePriceSummary({}); console.error("calculatePrice: Failure", error);
                                                    }).calculateReservationPrice(params);
                                                }

                                                function populatePriceSummary(data = {}) {
                                                    // Update tariff name
                                                    const tariffNameEl = document.getElementById('summaryTariffName');

                                                    if (tariffNameEl) {
                                                        tariffNameEl.textContent = data.tariffName || 'No tariff applied';
                                                    }

                                                    // Update all price fields
                                                    document.getElementById('summaryTotalNights').textContent = data.nights ?? '0';
                                                    document.getElementById('summaryNormalNights').textContent = data.normalNights ?? '0';
                                                    document.getElementById('summaryUnitPriceNormal').textContent = (data.unitPriceNormalNight ?? 0).toFixed(2);
                                                    document.getElementById('summaryTotalNormalNightCost').textContent = (data.totalNormalNightCost ?? 0).toFixed(2);
                                                    document.getElementById('summaryWeekendNights').textContent = data.weekendNights ?? '0';
                                                    document.getElementById('summaryUnitPriceWeekend').textContent = (data.unitPriceWeekendNight ?? 0).toFixed(2);
                                                    document.getElementById('summaryTotalWeekendNightCost').textContent = (data.totalWeekendNightCost ?? 0).toFixed(2);
                                                    document.getElementById('summaryBoatCost').textContent = (data.baseBoatCost ?? 0).toFixed(2);
                                                    document.getElementById('summaryExtrasCost').textContent = (data.extrasCost ?? 0).toFixed(2);
                                                    document.getElementById('summarySubtotal').textContent = (data.subtotal ?? 0).toFixed(2);
                                                    document.getElementById('summaryTaxAmountApplied').textContent = (data.taxAmountApplied ?? 0).toFixed(2);
                                                    document.getElementById('summaryDiscountAmount').textContent = (data.discountAmount ?? 0).toFixed(2);
                                                    document.getElementById('summaryTotalCost').textContent = (data.totalCost ?? 0).toFixed(2);
                                                }

                                                // Add this NEW function after populatePriceSummary
                                                function calculatePriceNow() {
                                                    const form = document.getElementById('newReservationForm');
                                                    if (!form) return;

                                                    const statusEl = document.getElementById('calculationStatus');

                                                    if (statusEl) {
                                                        statusEl.textContent = 'Calculating...';
                                                        statusEl.classList.add('loading');
                                                    }

                                                    const formData = new FormData(form);
                                                    const boatSelect = document.getElementById('boatId');
                                                    const selectedBoatOption = boatSelect ? boatSelect.options[boatSelect.selectedIndex] : null;

                                                    const params = {
                                                        boatModel: selectedBoatOption ? selectedBoatOption.dataset.model : '',
                                                        checkInDate: formData.get('checkInDate'),
                                                        checkInTime: formData.get('checkInTime'),
                                                        checkOutDate: formData.get('checkOutDate'),
                                                        checkOutTime: formData.get('checkOutTime'),
                                                        selectedExtras: JSON.stringify(getSelectedExtras()),
                                                        discountPercentage: parseFloat(formData.get('discountPercentage')) || 0,
                                                        taxValue: 76, // Always use 76
                                                    }

                                                        ;

                                                    const source = formData.get('reservationSource');
                                                    const manualSources = ['NICOLS', 'Ancorado', 'Diaria'];
                                                    const isManual = manualSources.includes(source);

                                                    document.getElementById('priceSummaryContainer').style.display = isManual ? 'none' : 'block';
                                                    document.getElementById('manualTotalCostContainer').style.display = isManual ? 'block' : 'none';

                                                    if (isManual) {
                                                        populatePriceSummary({});

                                                        if (statusEl) {
                                                            statusEl.textContent = 'Manual entry required for this source';
                                                            statusEl.classList.remove('loading');
                                                        }

                                                        return;
                                                    }

                                                    if (!params.boatModel || !params.checkInDate || !params.checkOutDate) {
                                                        showNotification('Please fill in boat and dates to calculate price', 'error', 3000);

                                                        if (statusEl) {
                                                            statusEl.textContent = 'Missing required fields';
                                                            statusEl.classList.remove('loading');
                                                        }

                                                        return;
                                                    }

                                                    google.script.run.withSuccessHandler(response => {
                                                        if (statusEl) {
                                                            statusEl.classList.remove('loading');
                                                        }

                                                        if (response.error) {
                                                            showNotification(response.error, 'error', 5000);

                                                            populatePriceSummary({});

                                                            if (statusEl) {
                                                                statusEl.textContent = 'Error calculating price';
                                                            }
                                                        }

                                                        else {
                                                            populatePriceSummary(response);

                                                            if (statusEl) {
                                                                statusEl.innerHTML = '<i data-lucide="check-circle" class="inline h-3 w-3 mr-1 text-green-600"></i>Price calculated successfully';
                                                                if (lucide) lucide.createIcons();
                                                            }
                                                        }

                                                    }).withFailureHandler(err => {
                                                        if (statusEl) {
                                                            statusEl.classList.remove('loading');
                                                            statusEl.textContent = 'Calculation failed';
                                                        }

                                                        showNotification(`Price calculation failed: $ {
                        err.message
                    }

                    `, 'error', 5000);

                                                        populatePriceSummary({});
                                                    }).calculateReservationPrice(params);
                                                }

                                                /**
                                                 * Handle form submission in compact mode (no wizard)
                                                 */
                                                function handleCompactFormSubmit() {
                                                    // Validate all required fields
                                                    const form = document.getElementById('newReservationForm');
                                                    const requiredFields = form.querySelectorAll('[required]');
                                                    let isValid = true;

                                                    requiredFields.forEach(field => {
                                                        field.classList.remove('is-invalid');

                                                        if (!field.value || field.value.trim() === '') {
                                                            field.classList.add('is-invalid');
                                                            isValid = false;
                                                        }
                                                    });

                                                    if (!isValid) {
                                                        showNotification('Please fill all required fields', 'error', 3000);
                                                        // Scroll to first invalid field
                                                        const firstInvalid = form.querySelector('.is-invalid');

                                                        if (firstInvalid) {
                                                            firstInvalid.scrollIntoView({
                                                                behavior: 'smooth', block: 'center'
                                                            });
                                                            firstInvalid.focus();
                                                        }

                                                        return;
                                                    }

                                                    // All valid, proceed with save
                                                    handleSaveOrUpdateReservation();
                                                }

                                                function handleSaveOrUpdateReservation() {

                                                    const reservationDetails = wizard.collectWizardData();
                                                    const isUpdate = wizard.currentState.isEditMode;
                                                    const reservationIdToUpdate = wizard.currentState.reservationId;

                                                    showLoading(true, "notifications.processing");

                                                    let initialPaymentDetails = null;

                                                    if (!isUpdate) {
                                                        const initialAmount = parseFloat(reservationDetails.initialPaymentAmount);
                                                        const initialMethod = reservationDetails.initialPaymentMethod;

                                                        if (!isNaN(initialAmount) && initialAmount > 0 && initialMethod) {
                                                            initialPaymentDetails = {
                                                                amount: initialAmount, method: initialMethod
                                                            }

                                                                ;
                                                        }

                                                        else if (!isNaN(initialAmount) && initialAmount > 0 && !initialMethod) {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Initial payment amount entered, but no payment method selected.'
                                                            }), 'error');
                                                            showLoading(false); return;
                                                        }
                                                    }

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Reservation $ {
                                response.reservationId || ''
                            }

                            $ {
                                isUpdate ? _t('status.Updated') : _t('status.Saved')
                            }

                            successfully !`
                                                            }), 'success');
                                                            invalidateCache('reservations'); // Invalidate cache to force fresh data
                                                            invalidateCache('dashboard'); // Dashboard stats may have changed

                                                            fetchReservations(() => {
                                                                showView(CURRENT_VIEW_ORIGIN);

                                                                // If we came from or are going to the calendar, make sure it's refreshed
                                                                if (CURRENT_VIEW_ORIGIN === 'calendar' || (document.getElementById('calendar-view') && !document.getElementById('calendar-view').classList.contains('hidden'))) {
                                                                    renderYearCalendarGrid(calendarDisplayYear);
                                                                }
                                                            }

                                                                , `Post-$ {
                        isUpdate ? 'Update' : 'Save'
                    }

                    Refresh`);
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error: $ {
                            response.message || 'Unknown server error.'
                        }

                        `
                                                            }), 'error', 10000);
                                                        }

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to save reservation: $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error', 7000);
                                                    }).saveReservation(reservationDetails, isUpdate ? reservationIdToUpdate : null, initialPaymentDetails);
                                                }


                                                function loadReservationForEditing(reservationId) {
                                                    const reservation = ALL_RESERVATIONS.find(r => r.reservationId === reservationId);

                                                    if (!reservation) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Reservation not found for editing."
                                                        }), "error");
                                                        showView('view-reservations');
                                                        return;
                                                    }

                                                    // Populate form fields
                                                    const form = document.getElementById('newReservationForm');
                                                    form.elements.checkInDate.value = reservation.checkInDate || '';
                                                    form.elements.checkInTime.value = reservation.checkInTime || '09:00';
                                                    form.elements.checkOutDate.value = reservation.checkOutDate || '';
                                                    form.elements.checkOutTime.value = reservation.checkOutTime || '09:00';
                                                    form.elements.boatId.value = reservation.boatUniqueId || '';
                                                    form.elements.clientName.value = reservation.clientName || '';
                                                    form.elements.clientPhone.value = reservation.clientPhone || '';
                                                    form.elements.clientEmail.value = reservation.clientEmail || '';
                                                    form.elements.taxValue.value = reservation.taxValue || 0;
                                                    form.elements.discountPercentage.value = reservation.discountPercentage || 0;
                                                    form.elements.status.value = reservation.status || 'Confirmed';
                                                    form.elements.reservationSource.value = reservation.reservationSource || 'OTHER';
                                                    form.elements.notes.value = reservation.notes || '';

                                                    // Populate extras
                                                    let selectedExtrasObj = {}

                                                        ;

                                                    if (reservation.extrasBooked) {
                                                        try {
                                                            selectedExtrasObj = JSON.parse(reservation.extrasBooked);
                                                        }

                                                        catch (e) { }
                                                    }

                                                    populateExtras(selectedExtrasObj);

                                                    const manualSources = ['NICOLS', 'Ancorado', 'Diaria'];

                                                    if (manualSources.includes(reservation.reservationSource)) {
                                                        form.elements.manualTotalCost.value = reservation.totalCost;
                                                    }
                                                }

                                                function fetchReservations(callback, context = "Generic Fetch") {
                                                    console.log(`fetchReservations: Called. Context: $ {
                    context
                }

                `);

                                                    // Check cache first
                                                    if (isCacheValid('reservations') && ALL_RESERVATIONS.length > 0) {
                                                        console.log(`fetchReservations: Using cached data. Context: $ {
                        context
                    }

                    `);
                                                        if (typeof callback === 'function') callback();
                                                        return;
                                                    }

                                                    showLoading(true, "notifications.loading", {
                                                        item: _t('nav.viewReservations')
                                                    });
                                                    const tableBody = document.getElementById('reservationsTableBody');

                                                    if (tableBody) tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500" >$ {
            _t('viewReservations.table.loading')
        }

        </td></tr>`;

                                                    google.script.run.withSuccessHandler(function (response) {
                                                        showLoading(false);

                                                        console.log(`fetchReservations ($ {
                            context
                        }): SUCCESS.`);

                                                        if (response && typeof response === 'object') {
                                                            if (response.error) {
                                                                showNotification(_t('notifications.error', {
                                                                    message: `Error fetching reservations: $ {
                                    response.error
                                }

                                `
                                                                }), 'error', 7000);
                                                                ALL_RESERVATIONS = [];
                                                            }

                                                            else if (Array.isArray(response.reservations)) {
                                                                ALL_RESERVATIONS = response.reservations;

                                                                ALL_RESERVATIONS.sort((a, b) => {
                                                                    const dateA = new Date(a.reservationDate || a.checkInDate || 0);
                                                                    const dateB = new Date(b.reservationDate || b.checkInDate || 0);
                                                                    return dateB - dateA;
                                                                });
                                                                updateCacheTimestamp('reservations'); // Update cache timestamp
                                                            }

                                                            else {
                                                                showNotification(_t('notifications.error', {
                                                                    message: 'Error: Invalid reservations data structure received.'
                                                                }), 'error', 7000);
                                                                ALL_RESERVATIONS = [];
                                                            }
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Error: Unexpected response from server for reservations (null or not an object).'
                                                            }), 'error', 7000);
                                                            ALL_RESERVATIONS = [];
                                                        }

                                                        CURRENT_RESERVATIONS_PAGE = 1;
                                                        renderReservationsPage();
                                                        if (typeof callback === 'function') callback();

                                                    }).withFailureHandler(function (error) {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to fetch reservations: $ {
                            error.message || 'Unknown client-side error.'
                        }

                        `
                                                        }), 'error', 7000);
                                                        ALL_RESERVATIONS = [];

                                                        if (tableBody) tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-red-500" >$ {
                _t('notifications.failed', {
                    message: `Failed to load reservations: $ {
                                                            error.message || 'See console for details.'
                                                        }

                                                        `
                })
        }

        </td></tr>`;
                                                        renderReservationsPage();
                                                        if (typeof callback === 'function') callback();
                                                    }).getReservations();
                                                }

                                                // REPLACE your existing renderReservationsPage function with this
                                                function renderReservationsPage() {
                                                    const tableBody = document.getElementById('reservationsTableBody');

                                                    if (!tableBody) {
                                                        console.error("renderReservationsPage: Table body not found."); return;
                                                    }

                                                    tableBody.innerHTML = '';

                                                    const reservationsToDisplay = Array.isArray(ALL_RESERVATIONS) ? ALL_RESERVATIONS : [];
                                                    const searchTerm = document.getElementById('reservationSearch')?.value?.toLowerCase() || '';
                                                    const filteredReservations = getFilteredReservations();

                                                    const startIndex = (CURRENT_RESERVATIONS_PAGE - 1) * RESERVATIONS_PER_PAGE;
                                                    const paginatedReservations = filteredReservations.slice(startIndex, startIndex + RESERVATIONS_PER_PAGE);

                                                    if (paginatedReservations.length === 0) {
                                                        const messageKey = reservationsToDisplay.length > 0 ? 'viewReservations.table.noMatch' : 'viewReservations.table.noReservations';

                                                        tableBody.innerHTML = `<tr><td colspan="10" class="text-center py-4 text-gray-500" >$ {
                    _t(messageKey)
                }

                </td></tr>`;
                                                    }

                                                    else {
                                                        paginatedReservations.forEach(res => {
                                                            const row = tableBody.insertRow();
                                                            row.className = "hover:bg-indigo-50 transition-all duration-200 border-b border-gray-100";

                                                            const formatDateDisplay = (dateStr) => {
                                                                if (!dateStr) return 'N/A';

                                                                try {
                                                                    const parts = dateStr.split('-');
                                                                    const dateObj = new Date(parts[0], parseInt(parts[1]) - 1, parts[2]);

                                                                    return dateObj.toLocaleDateString(currentLanguage === 'pt' ? 'pt-PT' : 'en-GB', {
                                                                        year: '2-digit', month: '2-digit', day: '2-digit'
                                                                    });
                                                                }

                                                                catch (e) {
                                                                    return dateStr;
                                                                }
                                                            }

                                                                ;

                                                            // Payment status styling
                                                            const totalPaid = res.totalPaid || 0;
                                                            const amountDue = res.amountDue || 0;
                                                            const totalCost = res.totalCost || 0;

                                                            let paymentBadge = '';

                                                            if (totalPaid === 0) {
                                                                paymentBadge = '<span class="px-2 py-1 text-xs font-bold rounded-full bg-red-100 text-red-800">Unpaid</span>';
                                                            }

                                                            else if (amountDue === 0 && totalCost > 0) {
                                                                paymentBadge = '<span class="px-2 py-1 text-xs font-bold rounded-full bg-green-100 text-green-800">Paid</span>';
                                                            }

                                                            else {
                                                                paymentBadge = '<span class="px-2 py-1 text-xs font-bold rounded-full bg-yellow-100 text-yellow-800">Partial</span>';
                                                            }

                                                            // Status styling
                                                            let statusClass = 'bg-gray-100 text-gray-800';
                                                            let statusIcon = 'help-circle';
                                                            const sLower = String(res.status || '').toLowerCase();

                                                            if (sLower === 'confirmed') {
                                                                statusClass = 'bg-green-100 text-green-800 border border-green-300';
                                                                statusIcon = 'check-circle';
                                                            }

                                                            else if (sLower === 'pending') {
                                                                statusClass = 'bg-yellow-100 text-yellow-800 border border-yellow-300';
                                                                statusIcon = 'clock';
                                                            }

                                                            else if (sLower === 'cancelled') {
                                                                statusClass = 'bg-red-100 text-red-800 border border-red-300 line-through';
                                                                statusIcon = 'x-circle';
                                                            }

                                                            // Source badge styling
                                                            let sourceBadge = res.reservationSource || 'N/A';
                                                            let sourceClass = 'bg-gray-100 text-gray-700';
                                                            if (res.reservationSource === 'AMIEIRA') sourceClass = 'bg-blue-100 text-blue-800 font-semibold';
                                                            else if (res.reservationSource === 'NICOLS') sourceClass = 'bg-purple-100 text-purple-800 font-semibold';
                                                            else if (res.reservationSource === 'Ancorado') sourceClass = 'bg-indigo-100 text-indigo-800 font-semibold';
                                                            else if (res.reservationSource === 'Diaria') sourceClass = 'bg-teal-100 text-teal-800 font-semibold';

                                                            row.innerHTML = ` <td class="px-4 py-3 whitespace-nowrap" > <div class="flex items-center" > <div class="flex-shrink-0 h-10 w-10 bg-indigo-100 rounded-full flex items-center justify-center" > <i data-lucide="user" class="h-5 w-5 text-indigo-600" ></i> </div> <div class="ml-3" > <div class="text-sm font-semibold text-gray-900" >$ {
                        res.clientName || 'N/A'
                    }

                    </div> <div class="text-xs text-gray-500" >$ {
                        res.clientEmail || res.clientPhone || ''
                    }

                    </div> </div> </div> </td> <td class="px-4 py-3 whitespace-nowrap" > <div class="text-sm font-medium text-gray-900" >$ {
                        res.boatNameAuto || 'N/A'
                    }

                    </div> <div class="text-xs text-gray-500" >$ {
                        res.boatModelAuto || ''
                    }

                    </div> </td> <td class="px-4 py-3 whitespace-nowrap" > <div class="flex items-center text-sm" > <i data-lucide="calendar" class="h-4 w-4 text-gray-400 mr-1" ></i> <span class="text-gray-700" >$ {
                        formatDateDisplay(res.checkInDate)
                    }

                    </span> </div> <div class="text-xs text-gray-500" >$ {
                        res.checkInTime || '09:00'
                    }

                    </div> </td> <td class="px-4 py-3 whitespace-nowrap" > <div class="flex items-center text-sm" > <i data-lucide="calendar" class="h-4 w-4 text-gray-400 mr-1" ></i> <span class="text-gray-700" >$ {
                        formatDateDisplay(res.checkOutDate)
                    }

                    </span> </div> <div class="text-xs text-gray-500" >$ {
                        res.checkOutTime || '09:00'
                    }

                    </div> </td> <td class="px-4 py-3 whitespace-nowrap" > <div class="text-sm font-bold text-gray-900" >€$ {
                        (totalCost).toFixed(2)
                    }

                    </div> <div class="text-xs text-gray-500" >$ {
                        res.numberOfNights || 0
                    }

                    night(s)</div> </td> <td class="px-4 py-3 whitespace-nowrap text-center" > $ {
                        paymentBadge
                    }

                    <div class="text-xs text-gray-500 mt-1" >€$ {
                        totalPaid.toFixed(2)
                    }

                    / €$ {
                        totalCost.toFixed(2)
                    }

                    </div> </td> <td class="px-4 py-3 whitespace-nowrap text-center" > <div class="text-sm font-bold ${amountDue > 0 ? 'text-red-600' : 'text-green-600'}" > €$ {
                        amountDue.toFixed(2)
                    }

                    </div> </td> <td class="px-4 py-3 whitespace-nowrap text-center" > <span class="px-3 py-1 inline-flex items-center gap-1 text-xs font-bold rounded-full ${statusClass}" > <i data-lucide="${statusIcon}" class="h-3 w-3" ></i> $ {
                        _t(`status.$ {
                                                                res.status
                                                            }

                                                            `, {}

                        , res.status)
                }

                </span> </td> <td class="px-4 py-3 whitespace-nowrap text-center" > <span class="px-2 py-1 text-xs font-semibold rounded ${sourceClass}" > $ {
                    sourceBadge
                }

                </span> </td> <td class="px-4 py-3 whitespace-nowrap text-center" > <div class="relative inline-block text-left" > <button class="kebab-menu-button p-2 rounded-full hover:bg-indigo-100 transition-all" > <i data-lucide="more-vertical" class="h-5 w-5 text-gray-600" ></i> </button> <div class="kebab-menu-dropdown origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10" > <div class="py-1" role="none" > <a href="#" onclick="viewReservationDetails('${res.reservationId}')" class="kebab-menu-item" ><i data-lucide="eye" ></i><span>$ {
                    _t('viewReservations.actions.viewTitle')
                }

                </span></a> <a href="#" onclick="showView('new-reservation', { mode: 'edit', reservationId: '${res.reservationId}' })" class="kebab-menu-item" ><i data-lucide="edit-2" ></i><span>$ {
                    _t('viewReservations.actions.editTitle')
                }

                </span></a> <a href="#" onclick="openPaymentModal('${res.reservationId}', 'reservation')" class="kebab-menu-item" ><i data-lucide="credit-card" ></i><span>$ {
                    _t('buttons.managePayments')
                }

                </span></a> <a href="#" onclick="displayInvoice('${res.reservationId}')" class="kebab-menu-item" ><i data-lucide="file-text" ></i><span>$ {
                    _t('viewReservations.actions.invoiceTitle')
                }

                </span></a> <a href="#" onclick="generateSingleStaySheet('${res.reservationId}')" class="kebab-menu-item" ><i data-lucide="printer" ></i><span>$ {
                    _t('viewReservations.actions.staySheetTitle')
                }

                </span></a> $ {
                    sLower !=='cancelled' ? `< a href = "#" onclick = "confirmCancelReservation('${res.reservationId}')" class="kebab-menu-item text-red-700 hover:bg-red-50" ><i data-lucide="trash-2" ></i><span>$ {
                        _t('viewReservations.actions.cancelTitle')
                    }

                    </span></a > ` : ''
                }

                </div> </div> </div> </td>`;
                                                        });
                                                    }

                                                    renderPaginationControls(filteredReservations.length);
                                                    if (lucide) lucide.createIcons();
                                                }

                                                // Keyboard navigation for reservation action modal
                                                document.addEventListener('keydown', (e) => {
                                                    const modal = document.getElementById('reservationActionModal');

                                                    if (modal && modal.classList.contains('show')) {
                                                        if (e.key === '1' || e.key === 'c') {
                                                            // Press '1' or 'C' for Calendar
                                                            e.preventDefault();
                                                            document.getElementById('viewInCalendarBtn')?.click();
                                                        }

                                                        else if (e.key === '2' || e.key === 'e') {
                                                            // Press '2' or 'E' for Edit
                                                            e.preventDefault();
                                                            document.getElementById('editReservationBtn')?.click();
                                                        }

                                                        else if (e.key === 'Escape') {
                                                            // Press Escape to close
                                                            closeModal('reservationActionModal');
                                                        }
                                                    }
                                                });

                                                // ADD this event listener setup to your main DOMContentLoaded listener
                                                document.addEventListener('click', function (event) {
                                                    // Kebab menu logic
                                                    const isKebabButton = event.target.closest('.kebab-menu-button');

                                                    // Close all open menus first
                                                    document.querySelectorAll('.kebab-menu-dropdown:not(.hidden)').forEach(openMenu => {
                                                        if (!isKebabButton || !openMenu.previousElementSibling.isSameNode(isKebabButton)) {
                                                            openMenu.classList.add('hidden');
                                                        }
                                                    });

                                                    if (isKebabButton) {
                                                        const dropdown = isKebabButton.nextElementSibling;
                                                        dropdown.classList.toggle('hidden');
                                                    }
                                                });

                                                document.getElementById('reservationSearch')?.addEventListener('input', filterReservations);

                                                function filterReservations() {
                                                    CURRENT_RESERVATIONS_PAGE = 1; renderReservationsPage();
                                                }

                                                // ==========================================
                                                // ADVANCED RESERVATION FILTERS
                                                // ==========================================

                                                let ACTIVE_FILTERS = {
                                                    search: '',
                                                    status: '',
                                                    source: '',
                                                    dateFrom: '',
                                                    dateTo: '',
                                                    paymentStatus: ''
                                                }

                                                    ;

                                                /**
                                                 * Apply all active filters and re-render the table
                                                 */
                                                function applyReservationFilters() {
                                                    ACTIVE_FILTERS.search = document.getElementById('reservationSearch').value.toLowerCase().trim();
                                                    ACTIVE_FILTERS.status = document.getElementById('filterStatus').value;
                                                    ACTIVE_FILTERS.source = document.getElementById('filterSource').value;
                                                    ACTIVE_FILTERS.dateFrom = document.getElementById('filterDateFrom').value;
                                                    ACTIVE_FILTERS.dateTo = document.getElementById('filterDateTo').value;
                                                    ACTIVE_FILTERS.paymentStatus = document.getElementById('filterPaymentStatus').value;

                                                    CURRENT_RESERVATIONS_PAGE = 1;
                                                    renderReservationsPage();
                                                    updateActiveFiltersDisplay();

                                                    // Show notification
                                                    const filterCount = Object.values(ACTIVE_FILTERS).filter(v => v !== '').length;

                                                    if (filterCount > 0) {
                                                        showNotification(`$ {
                        filterCount
                    }

                    filter(s) applied`, 'success', 2000);
                                                    }
                                                }

                                                /**
                                                 * Clear all filters and reset the table
                                                 */
                                                function clearReservationFilters() {
                                                    ACTIVE_FILTERS = {
                                                        search: '',
                                                        status: '',
                                                        source: '',
                                                        dateFrom: '',
                                                        dateTo: '',
                                                        paymentStatus: ''
                                                    }

                                                        ;

                                                    document.getElementById('reservationSearch').value = '';
                                                    document.getElementById('filterStatus').value = '';
                                                    document.getElementById('filterSource').value = '';
                                                    document.getElementById('filterDateFrom').value = '';
                                                    document.getElementById('filterDateTo').value = '';
                                                    document.getElementById('filterPaymentStatus').value = '';

                                                    CURRENT_RESERVATIONS_PAGE = 1;
                                                    renderReservationsPage();
                                                    updateActiveFiltersDisplay();
                                                    showNotification('All filters cleared', 'info', 2000);
                                                }

                                                /**
                                                 * Update the visual display of active filters
                                                 */
                                                function updateActiveFiltersDisplay() {
                                                    const displayContainer = document.getElementById('activeFiltersDisplay');
                                                    const tagsContainer = document.getElementById('activeFilterTags');

                                                    if (!displayContainer || !tagsContainer) return;

                                                    tagsContainer.innerHTML = '';
                                                    let hasActiveFilters = false;

                                                    // Search tag
                                                    if (ACTIVE_FILTERS.search) {
                                                        hasActiveFilters = true;
                                                        tagsContainer.innerHTML += ` <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full" > Search: "${ACTIVE_FILTERS.search}"
                <i data-lucide="x" class="h-3 w-3 cursor-pointer" onclick="ACTIVE_FILTERS.search=''; document.getElementById('reservationSearch').value=''; applyReservationFilters();" ></i> </span>`;
                                                    }

                                                    // Status tag
                                                    if (ACTIVE_FILTERS.status) {
                                                        hasActiveFilters = true;

                                                        tagsContainer.innerHTML += ` <span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full" > Status: $ {
                    ACTIVE_FILTERS.status
                }

                <i data-lucide="x" class="h-3 w-3 cursor-pointer" onclick="ACTIVE_FILTERS.status=''; document.getElementById('filterStatus').value=''; applyReservationFilters();" ></i> </span>`;
                                                    }

                                                    // Source tag
                                                    if (ACTIVE_FILTERS.source) {
                                                        hasActiveFilters = true;

                                                        tagsContainer.innerHTML += ` <span class="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-800 text-xs font-medium rounded-full" > Source: $ {
                    ACTIVE_FILTERS.source
                }

                <i data-lucide="x" class="h-3 w-3 cursor-pointer" onclick="ACTIVE_FILTERS.source=''; document.getElementById('filterSource').value=''; applyReservationFilters();" ></i> </span>`;
                                                    }

                                                    // Date range tag
                                                    if (ACTIVE_FILTERS.dateFrom || ACTIVE_FILTERS.dateTo) {
                                                        hasActiveFilters = true;

                                                        const dateText = ACTIVE_FILTERS.dateFrom && ACTIVE_FILTERS.dateTo ? `$ {
                    ACTIVE_FILTERS.dateFrom
                }

                to $ {
                    ACTIVE_FILTERS.dateTo
                }

                ` : ACTIVE_FILTERS.dateFrom ? `From $ {
                    ACTIVE_FILTERS.dateFrom
                }

                ` : `Until $ {
                    ACTIVE_FILTERS.dateTo
                }

                `;

                                                        tagsContainer.innerHTML += ` <span class="inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full" > $ {
                    dateText
                }

                <i data-lucide="x" class="h-3 w-3 cursor-pointer" onclick="ACTIVE_FILTERS.dateFrom=''; ACTIVE_FILTERS.dateTo=''; document.getElementById('filterDateFrom').value=''; document.getElementById('filterDateTo').value=''; applyReservationFilters();" ></i> </span>`;
                                                    }

                                                    // Payment status tag
                                                    if (ACTIVE_FILTERS.paymentStatus) {
                                                        hasActiveFilters = true;

                                                        const paymentLabels = {
                                                            paid: 'Fully Paid', partial: 'Partially Paid', unpaid: 'Unpaid'
                                                        }

                                                            ;

                                                        tagsContainer.innerHTML += ` <span class="inline-flex items-center gap-1 px-2 py-1 bg-indigo-100 text-indigo-800 text-xs font-medium rounded-full" > $ {
                    paymentLabels[ACTIVE_FILTERS.paymentStatus] || ACTIVE_FILTERS.paymentStatus
                }

                <i data-lucide="x" class="h-3 w-3 cursor-pointer" onclick="ACTIVE_FILTERS.paymentStatus=''; document.getElementById('filterPaymentStatus').value=''; applyReservationFilters();" ></i> </span>`;
                                                    }

                                                    if (hasActiveFilters) {
                                                        displayContainer.classList.remove('hidden');
                                                        if (lucide) lucide.createIcons();
                                                    }

                                                    else {
                                                        displayContainer.classList.add('hidden');
                                                    }
                                                }

                                                /**
                                                 * Get filtered reservations based on active filters
                                                 */
                                                function getFilteredReservations() {
                                                    return ALL_RESERVATIONS.filter(res => {
                                                        if (!res) return false;

                                                        // Search filter
                                                        if (ACTIVE_FILTERS.search) {
                                                            const searchString = `$ {
                            res.reservationId || ''
                        }

                        $ {
                            res.clientName || ''
                        }

                        $ {
                            res.boatNameAuto || ''
                        }

                        $ {
                            res.boatModelAuto || ''
                        }

                        $ {
                            res.status || ''
                        }

                        $ {
                            res.reservationSource || ''
                        }

                        `.toLowerCase();
                                                            if (!searchString.includes(ACTIVE_FILTERS.search)) return false;
                                                        }

                                                        // Status filter
                                                        if (ACTIVE_FILTERS.status && res.status !== ACTIVE_FILTERS.status) {
                                                            return false;
                                                        }

                                                        // Source filter
                                                        if (ACTIVE_FILTERS.source && res.reservationSource !== ACTIVE_FILTERS.source) {
                                                            return false;
                                                        }

                                                        // Date from filter
                                                        if (ACTIVE_FILTERS.dateFrom && res.checkInDate < ACTIVE_FILTERS.dateFrom) {
                                                            return false;
                                                        }

                                                        // Date to filter
                                                        if (ACTIVE_FILTERS.dateTo && res.checkInDate > ACTIVE_FILTERS.dateTo) {
                                                            return false;
                                                        }

                                                        // Payment status filter
                                                        if (ACTIVE_FILTERS.paymentStatus) {
                                                            const amountDue = res.amountDue || 0;
                                                            const totalCost = res.totalCost || 0;
                                                            const totalPaid = res.totalPaid || 0;

                                                            if (ACTIVE_FILTERS.paymentStatus === 'paid' && amountDue > 0) return false;
                                                            if (ACTIVE_FILTERS.paymentStatus === 'unpaid' && totalPaid > 0) return false;
                                                            if (ACTIVE_FILTERS.paymentStatus === 'partial' && (totalPaid === 0 || amountDue === 0)) return false;
                                                        }

                                                        return true;
                                                    });
                                                }

                                                /**
                                                 * Export filtered reservations to CSV
                                                 */
                                                function exportReservationsToCSV() {
                                                    const filteredReservations = getFilteredReservations();

                                                    if (filteredReservations.length === 0) {
                                                        showNotification('No reservations to export', 'error', 3000);
                                                        return;
                                                    }

                                                    // CSV Headers
                                                    let csv = 'Reservation ID,Client Name,Client Email,Client Phone,Boat,Model,Check-in Date,Check-in Time,Check-out Date,Check-out Time,Total Cost,Total Paid,Amount Due,Status,Source,Notes\n';

                                                    // CSV Rows
                                                    filteredReservations.forEach(res => {
                                                        const row = [res.reservationId || '',
                                                        res.clientName || '',
                                                        res.clientEmail || '',
                                                        res.clientPhone || '',
                                                        res.boatNameAuto || '',
                                                        res.boatModelAuto || '',
                                                        res.checkInDate || '',
                                                        res.checkInTime || '',
                                                        res.checkOutDate || '',
                                                        res.checkOutTime || '',
                                                        (res.totalCost || 0).toFixed(2),
                                                        (res.totalPaid || 0).toFixed(2),
                                                        (res.amountDue || 0).toFixed(2),
                                                        res.status || '',
                                                        res.reservationSource || '',
                                                        (res.notes || '').replace(/"/g, '" "') // Escape quotes
                                                        ];
                                                        csv += row.map(field => `"${field}" `).join(',') + '\n';
                                                    });

                                                    // Download
                                                    const blob = new Blob([csv], {
                                                        type: 'text/csv;charset=utf-8;'
                                                    });
                                                    const link = document.createElement('a');
                                                    const url = URL.createObjectURL(blob);
                                                    link.setAttribute('href', url);

                                                    link.setAttribute('download', `reservations_export_$ {
                    new Date().toISOString().split('T')[0]
                }

                .csv`);
                                                    link.style.visibility = 'hidden';
                                                    document.body.appendChild(link);
                                                    link.click();
                                                    document.body.removeChild(link);

                                                    showNotification(`Exported $ {
                    filteredReservations.length
                }

                reservation(s) to CSV`, 'success', 3000);
                                                }

                                                /**
                                                 * Export filtered reservations to PDF
                                                 */
                                                function exportReservationsToPDF() {
                                                    const filteredReservations = getFilteredReservations();

                                                    if (filteredReservations.length === 0) {
                                                        showNotification('No reservations to export', 'error', 3000);
                                                        return;
                                                    }

                                                    showLoading(true, 'notifications.processing');

                                                    const exportData = {
                                                        reservations: filteredReservations,
                                                        filters: ACTIVE_FILTERS,
                                                        exportDate: new Date().toISOString(),
                                                        lang: currentLanguage
                                                    }

                                                        ;

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success && response.pdfBase64 && response.fileName) {
                                                            const link = document.createElement('a');
                                                            link.href = 'data:application/pdf;base64,' + response.pdfBase64;
                                                            link.download = response.fileName;
                                                            document.body.appendChild(link);
                                                            link.click();
                                                            document.body.removeChild(link);

                                                            showNotification(`Exported $ {
                                filteredReservations.length
                            }

                            reservation(s) to PDF`, 'success', 3000);
                                                        }

                                                        else {
                                                            showNotification(`Error generating PDF: $ {
                                response.error || 'Unknown error'
                            }

                            `, 'error', 5000);
                                                        }

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(`Failed to generate PDF: $ {
                            error.message
                        }

                        `, 'error', 5000);
                                                    }).generateFilteredReservationsPdf(exportData);
                                                }

                                                function renderPaginationControls(totalItems) {
                                                    const paginationContainer = document.getElementById('paginationControls');
                                                    if (!paginationContainer) return;
                                                    paginationContainer.innerHTML = '';
                                                    const totalPages = Math.ceil(totalItems / RESERVATIONS_PER_PAGE);
                                                    if (totalPages <= 1) return;

                                                    const createBtn = (html, clickFn, dis) => {
                                                        const b = document.createElement('button'); b.innerHTML = html; b.onclick = clickFn; b.disabled = dis; b.className = "p-2 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"; return b;
                                                    }

                                                        ;

                                                    paginationContainer.appendChild(createBtn('<i data-lucide="chevron-left" class="h-5 w-5"></i>', () => {
                                                        if (CURRENT_RESERVATIONS_PAGE > 1) {
                                                            CURRENT_RESERVATIONS_PAGE--; renderReservationsPage();
                                                        }
                                                    }

                                                        , CURRENT_RESERVATIONS_PAGE === 1));
                                                    const pageInfo = document.createElement('span'); pageInfo.className = "text-sm text-gray-700 px-2";

                                                    pageInfo.textContent = _t('pagination.pageOf', {
                                                        currentPage: CURRENT_RESERVATIONS_PAGE, totalPages: totalPages
                                                    });
                                                    paginationContainer.appendChild(pageInfo);

                                                    paginationContainer.appendChild(createBtn('<i data-lucide="chevron-right" class="h-5 w-5"></i>', () => {
                                                        if (CURRENT_RESERVATIONS_PAGE < totalPages) {
                                                            CURRENT_RESERVATIONS_PAGE++; renderReservationsPage();
                                                        }
                                                    }

                                                        , CURRENT_RESERVATIONS_PAGE === totalPages));
                                                    if (lucide) lucide.createIcons();
                                                }

                                                /**
                                                 * Displays reservation details in a redesigned, professional-looking modal.
                                                 * This function replaces the previous version.
                                                 * @param {string} id - The ID of the reservation to display.
                                                 */
                                                function viewReservationDetails(id) {
                                                    const reservation = ALL_RESERVATIONS.find(r => r.reservationId === id);

                                                    if (!reservation) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Reservation not found."
                                                        }), "error");
                                                        return;
                                                    }

                                                    const modalBody = document.getElementById('modalBody');
                                                    const modalTitle = document.getElementById('modalTitle');

                                                    if (modalTitle) modalTitle.textContent = _t('reservationDetailsModal.title') + `: $ {
            id
        }

        `;

                                                    const formatDateForDisplay = (dateStr, timeStr = '') => {
                                                        if (!dateStr) return 'N/A';

                                                        try {
                                                            // This handles both 'YYYY-MM-DD' and 'M/D/YYYY' formats
                                                            const dateObj = new Date(dateStr.replace(/-/g, '/'));

                                                            if (isNaN(dateObj.getTime())) return `$ {
                    dateStr
                }

                $ {
                    timeStr
                }

                `;

                                                            let display = dateObj.toLocaleDateString(currentLanguage === 'pt' ? 'pt-PT' : 'en-GB', {
                                                                year: 'numeric',
                                                                month: 'long',
                                                                day: 'numeric'
                                                            });

                                                            if (timeStr) display += ` $ {
                timeStr
            }

            `;
                                                            return display;
                                                        }

                                                        catch (e) {
                                                            return `$ {
                dateStr
            }

            $ {
                timeStr
            }

            `;
                                                        }
                                                    }

                                                        ;

                                                    // Helper to create a styled section in the modal
                                                    const createDetailSection = (title, details) => {
                                                        let content = `<div class="mt-4" > <h4 class="text-md font-semibold text-gray-600 border-b pb-2 mb-3" >$ {
                title
            }

            </h4> <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3 text-sm" >`;

                                                        for (const [label, value] of Object.entries(details)) {
                                                            if (value !== undefined && value !== null && value !== '') {
                                                                content += `<div class="flex flex-col" ><dt class="font-medium text-gray-500" >$ {
                        label
                    }

                    </dt><dd class="text-gray-900 mt-1" >$ {
                        value
                    }

                    </dd></div>`;
                                                            }
                                                        }

                                                        content += `</dl></div>`;
                                                        return content;
                                                    }

                                                        ;

                                                    // --- 1. Client & Booking Info ---
                                                    const clientInfo = {
                                                        [_t('viewReservations.table.client')]: reservation.clientName,
                                                        [_t('newReservation.clientPhoneLabel')]: reservation.clientPhone || 'N/A',
                                                        [_t('newReservation.clientEmailLabel')]: reservation.clientEmail || 'N/A'
                                                    }

                                                        ;

                                                    const bookingInfo = {
                                                        [_t('viewReservations.table.status')]: `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800" >$ {
                _t(`status.$ {
                                                            reservation.status
                                                        }

                                                    `, {}

                , reservation.status)
        }

        </span>`,
                                                        [_t('viewReservations.table.source')]: reservation.reservationSource || 'N/A',
                                                            [_t('newReservation.boatSelectLabel')]: `$ {
            reservation.boatNameAuto
        }

        ($ {
                reservation.boatModelAuto
            })`,
                                                                'Check-in': formatDateForDisplay(reservation.checkInDate, reservation.checkInTime),
                                                                    'Check-out': formatDateForDisplay(reservation.checkOutDate, reservation.checkOutTime),
                                                                        'Total Nights': reservation.numberOfNights
                                                }

                                                ;

                                                // --- 2. Pricing Breakdown ---
                                                const pricingInfo = {
                                                    'Normal Nights Cost': `$ {
                reservation.normalNights || 0
            }

            x €$ {
                (reservation.unitPriceNormalNight || 0).toFixed(2)
            }

            =€$ {
                (reservation.totalNormalNightCost || 0).toFixed(2)
            }

            `,
                                                    'Weekend Nights Cost': `$ {
                reservation.weekendNights || 0
            }

            x €$ {
                (reservation.unitPriceWeekendNight || 0).toFixed(2)
            }

            =€$ {
                (reservation.totalWeekendNightCost || 0).toFixed(2)
            }

            `,
                                                    'Base Boat Cost': `€$ {
                (reservation.baseBoatCost || 0).toFixed(2)
            }

            `,
                                                    'Extras Cost': `€$ {
                (reservation.extrasCost || 0).toFixed(2)
            }

            `,
                                                    'Subtotal': `€$ {
                (reservation.subtotal || 0).toFixed(2)
            }

            `,
                                                    'Tax Applied': `€$ {
                (reservation.taxAmountApplied || 0).toFixed(2)
            }

            `,
                                                    'Discount': `$ {
                reservation.discountPercentage || 0
            }

            % (-€$ {
                    (reservation.discountAmount || 0).toFixed(2)
                })`,
                                                }

                                                    ;

                                                // --- 3. Financial Summary ---
                                                const financialSummary = {
                                                    'Total Cost': `<strong class="text-lg" >€$ {
                (reservation.totalCost || 0).toFixed(2)
            }

            </strong>`,
                                                    'Total Paid': `<span class="text-green-600 font-semibold" >€$ {
                (reservation.totalPaid || 0).toFixed(2)
            }

            </span>`,
                                                    'Amount Due': `<strong class="text-lg ${(reservation.amountDue || 0) > 0 ? 'text-red-600' : 'text-green-700'}" >€$ {
                (reservation.amountDue || 0).toFixed(2)
            }

            </strong>`
                                                }

                                                    ;

                                                // --- 4. Extras & Notes ---
                                                let extrasStr = _t('reports.none', {}

                                                    , 'None');

                                                if (reservation.extrasBooked && reservation.extrasBooked !== '{}') {
                                                    try {
                                                        const extrasObj = JSON.parse(reservation.extrasBooked);

                                                        extrasStr = Object.entries(extrasObj).map(([name, detail]) => `<li>$ {
                        name
                    }

                    (Qty: $ {
                            detail.quantity
                        })</li>`).join('');

                                                        extrasStr = `<ul class="list-disc list-inside" >$ {
                    extrasStr
                }

                </ul>`;
                                                    }

                                                    catch (e) {
                                                        extrasStr = _t('reports.error_parsing_extras', {}

                                                            , 'Error parsing extras');
                                                    }
                                                }

                                                const otherInfo = {
                                                    'Extras Booked': extrasStr,
                                                    'Notes': reservation.notes || 'N/A'
                                                }

                                                    ;

                                                // --- Assemble the final HTML ---
                                                let finalHtml = createDetailSection('Client & Booking', {
                                                    ...clientInfo, ...bookingInfo
                                                });
                                                finalHtml += createDetailSection('Pricing Breakdown', pricingInfo);
                                                finalHtml += createDetailSection('Financial Summary', financialSummary);
                                                finalHtml += createDetailSection('Other Information', otherInfo);

                                                if (modalBody) modalBody.innerHTML = finalHtml;
                                                openModal('reservationDetailsModal');
        }


                                                function confirmCancelReservation(id) {
                                                    console.log('confirmCancelReservation called with ID:', id);

                                                    if (!id) {
                                                        showNotification('Error: No reservation ID provided', 'error');
                                                        return;
                                                    }

                                                    const reservation = ALL_RESERVATIONS.find(r => r.reservationId === id);

                                                    if (!reservation) {
                                                        showNotification('Reservation not found', 'error');
                                                        return;
                                                    }

                                                    // Calculate nights
                                                    const checkIn = new Date(reservation.checkInDate);
                                                    const checkOut = new Date(reservation.checkOutDate);
                                                    const nights = Math.ceil((checkOut - checkIn) / (1000 * 60 * 60 * 24));

                                                    const details = [];

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="user" class="h-4 w-4 text-gray-500" ></i><strong>Client:</strong> <span class="ml-auto" >$ {
                    reservation.clientName
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="ship" class="h-4 w-4 text-gray-500" ></i><strong>Boat:</strong> <span class="ml-auto" >$ {
                    reservation.boatNameAuto
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="calendar" class="h-4 w-4 text-gray-500" ></i><strong>Duration:</strong> <span class="ml-auto" >$ {
                    nights
                }

                night(s)</span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="log-in" class="h-4 w-4 text-gray-500" ></i><strong>Check-in:</strong> <span class="ml-auto" >$ {
                    reservation.checkInDate
                }

                $ {
                    reservation.checkInTime || ''
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="log-out" class="h-4 w-4 text-gray-500" ></i><strong>Check-out:</strong> <span class="ml-auto" >$ {
                    reservation.checkOutDate
                }

                $ {
                    reservation.checkOutTime || ''
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="euro" class="h-4 w-4 text-gray-500" ></i><strong>Total Cost:</strong> <span class="ml-auto font-bold" >€$ {
                    (reservation.totalCost || 0).toFixed(2)
                }

                </span></div>`);

                                                    if (reservation.totalPaid > 0) {
                                                        details.push(`<div class="flex items-center gap-2" ><i data-lucide="credit-card" class="h-4 w-4 text-green-500" ></i><strong>Already Paid:</strong> <span class="ml-auto font-bold text-green-600" >€$ {
                        (reservation.totalPaid || 0).toFixed(2)
                    }

                    </span></div>`);

                                                        details.push(`<div class="flex items-center gap-2" ><i data-lucide="alert-circle" class="h-4 w-4 text-orange-500" ></i><strong>Amount Due:</strong> <span class="ml-auto font-bold text-orange-600" >€$ {
                        (reservation.amountDue || 0).toFixed(2)
                    }

                    </span></div>`);
                                                    }

                                                    let warningMessage = 'This action will mark the reservation as cancelled.';

                                                    if (reservation.totalPaid > 0) {
                                                        warningMessage = '⚠️ This reservation has payments totaling €' + (reservation.totalPaid || 0).toFixed(2) + '. Cancelling will NOT automatically process refunds. You must handle refunds separately.';
                                                    }

                                                    showCustomConfirm({

                                                        title: '🚫 Cancel Reservation?',
                                                        message: `Are you sure you want to cancel the reservation for <strong>$ {
                    reservation.clientName
                }

                </strong>?`,
                                                        details: details,
                                                        warning: warningMessage,
                                                        confirmText: 'Yes, Cancel This Reservation',
                                                        confirmColor: 'red',
                                                        icon: 'danger',
                                                        onConfirm: () => {
                                                            cancelReservationAction(id);
                                                        }
                                                    });

                                                    // Reinitialize icons in the modal
                                                    setTimeout(() => {
                                                        if (lucide) lucide.createIcons();
                                                    }

                                                        , 100);
                                                }


                                                function cancelReservationAction(id) {
                                                    console.log('cancelReservationAction called with ID:', id);

                                                    if (!id) {
                                                        showNotification('Error: No reservation ID provided to cancel', 'error');
                                                        showLoading(false);
                                                        return;
                                                    }

                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        // ... code ...
                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Reservation $ {
                                    id
                                }

                                status updated to Cancelled.`
                                                            }), 'success');
                                                            invalidateCache('reservations'); // ✅ ADD THIS LINE
                                                            invalidateCache('dashboard'); // ✅ ADD THIS LINE

                                                            fetchReservations(() => {

                                                                // If we are on the calendar or it's our origin, refresh it
                                                                if (CURRENT_VIEW_ORIGIN === 'calendar' || (document.getElementById('calendar-view') && !document.getElementById('calendar-view').classList.contains('hidden'))) {
                                                                    renderYearCalendarGrid(calendarDisplayYear);
                                                                }
                                                            }

                                                                , "Post-Cancel Refresh");
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error cancelling $ {
                                id
                            }

                            : $ {
                                response.message || 'Unknown error'
                            }

                            `
                                                            }), 'error', 7000);
                                                        }

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to send cancel request for $ {
                            id
                        }

                        : $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error', 7000);
                                                    }).cancelReservation(id);
                                                }

                                                async function displayInvoice(reservationIdOrDetails, isPreview = false) {
                                                    let reservationDetails;

                                                    if (typeof reservationIdOrDetails === 'string') {
                                                        reservationDetails = ALL_RESERVATIONS.find(r => r.reservationId === reservationIdOrDetails);

                                                        if (!reservationDetails) {
                                                            showNotification(_t('notifications.error', {
                                                                message: "Reservation not found for invoice."
                                                            }), "error");
                                                            return;
                                                        }
                                                    }

                                                    else {
                                                        reservationDetails = reservationIdOrDetails;
                                                    }

                                                    console.log("Displaying invoice for:", reservationDetails);
                                                    currentInvoiceDetailsForPdf = JSON.parse(JSON.stringify(reservationDetails));

                                                    const invoiceTitleEl = document.querySelector('#invoiceModal .modal-header-gradient h3');
                                                    if (invoiceTitleEl) invoiceTitleEl.textContent = _t('invoice.header');


                                                    const dateOptionsDisplay = {
                                                        year: 'numeric', month: '2-digit', day: '2-digit'
                                                    }

                                                        ;

                                                    const formatDate = (dateStr, timeStr) => {
                                                        if (!dateStr) return 'N/A';

                                                        try {
                                                            let normalizedDateStr = dateStr;

                                                            if (dateStr.includes('/')) {
                                                                const parts = dateStr.split('/');

                                                                if (parts.length === 3 && parts[2].length === 4) {
                                                                    normalizedDateStr = `$ {
                            parts[2]
                        }

                        -$ {
                            parts[1].padStart(2, '0')
                        }

                        -$ {
                            parts[0].padStart(2, '0')
                        }

                        `;
                                                                }
                                                            }

                                                            const dateObj = new Date(normalizedDateStr.replace(/-/g, '/') + (timeStr ? ' ' + timeStr : ''));
                                                            if (isNaN(dateObj.getTime())) return dateStr + (timeStr ? ' ' + timeStr : '');

                                                            let formatted = dateObj.toLocaleDateString(currentLanguage === 'pt' ? 'pt-PT' : 'en-GB', {
                                                                day: '2-digit', month: '2-digit', year: 'numeric'
                                                            });

                                                            if (timeStr) {
                                                                formatted += ' ' + dateObj.toLocaleTimeString(currentLanguage === 'pt' ? 'pt-PT' : 'en-GB', {
                                                                    hour: '2-digit', minute: '2-digit'
                                                                });
                                                            }

                                                            return formatted;
                                                        }

                                                        catch (e) {
                                                            return dateStr + (timeStr ? ' ' + timeStr : '');
                                                        }
                                                    }

                                                        ;


                                                    document.getElementById('invoiceDateIssuedDisplay').textContent = new Date().toLocaleDateString(currentLanguage === 'pt' ? 'pt-PT' : 'en-GB', dateOptionsDisplay);

                                                    document.getElementById('invoiceClientNameDisplay').textContent = reservationDetails.clientName || 'N/A';
                                                    const clientEmailEl = document.getElementById('invoiceClientEmailDisplay');

                                                    if (reservationDetails.clientEmail) {
                                                        clientEmailEl.textContent = reservationDetails.clientEmail;
                                                        clientEmailEl.style.display = 'block';
                                                    }

                                                    else {
                                                        clientEmailEl.style.display = 'none';
                                                    }


                                                    document.getElementById('invoiceCheckInDisplay').textContent = formatDate(reservationDetails.checkInDate, reservationDetails.checkInTime);
                                                    document.getElementById('invoiceCheckOutDisplay').textContent = formatDate(reservationDetails.checkOutDate, reservationDetails.checkOutTime);


                                                    const itemsBody = document.getElementById('invoiceItemsBodyDisplay');
                                                    itemsBody.innerHTML = '';

                                                    const boatName = reservationDetails.boatNameAuto || _t('status.Unknown', {}

                                                        , 'Unknown Boat');

                                                    let boatRentalItemsAdded = false;

                                                    if (reservationDetails.normalNights > 0 && typeof reservationDetails.totalNormalNightCost === 'number' && typeof reservationDetails.unitPriceNormalNight === 'number') {
                                                        const description = _t('invoice_item_boat_normal_nights', {
                                                            boatName: boatName
                                                        });
                                                        const normalNightRow = itemsBody.insertRow();

                                                        normalNightRow.innerHTML = `<td>$ {
            description
        }

        </td><td class="text-center" >$ {
            reservationDetails.normalNights
        }

        </td><td class="text-right" >€$ {
            (reservationDetails.unitPriceNormalNight).toFixed(2)
        }

        </td><td class="text-right" >€$ {
            (reservationDetails.totalNormalNightCost).toFixed(2)
        }

        </td>`;
                                                        boatRentalItemsAdded = true;
                                                    }

                                                    if (reservationDetails.weekendNights > 0 && typeof reservationDetails.totalWeekendNightCost === 'number' && typeof reservationDetails.unitPriceWeekendNight === 'number') {
                                                        const description = _t('invoice_item_boat_weekend_nights', {
                                                            boatName: boatName
                                                        });
                                                        const weekendNightRow = itemsBody.insertRow();

                                                        weekendNightRow.innerHTML = `<td>$ {
            description
        }

        </td><td class="text-center" >$ {
            reservationDetails.weekendNights
        }

        </td><td class="text-right" >€$ {
            (reservationDetails.unitPriceWeekendNight).toFixed(2)
        }

        </td><td class="text-right" >€$ {
            (reservationDetails.totalWeekendNightCost).toFixed(2)
        }

        </td>`;
                                                        boatRentalItemsAdded = true;
                                                    }

                                                    if (!boatRentalItemsAdded && typeof reservationDetails.baseBoatCost === 'number' && reservationDetails.baseBoatCost > 0) {
                                                        const nightsForDisplay = reservationDetails.numberOfNights || reservationDetails.nights || 0;

                                                        const description = _t('invoice_item_boat_rental_generic', {
                                                            boatName: boatName, numNights: nightsForDisplay
                                                        });
                                                        const boatRow = itemsBody.insertRow();

                                                        boatRow.innerHTML = `<td>$ {
            description
        }

        </td><td class="text-center" >$ {
            nightsForDisplay
        }

        </td><td class="text-right" >$ {
            _t('invoice.calculated')
        }

        </td><td class="text-right" >€$ {
            (reservationDetails.baseBoatCost).toFixed(2)
        }

        </td>`;
                                                    }

                                                    if (reservationDetails.extrasBooked) {
                                                        try {
                                                            const extras = JSON.parse(reservationDetails.extrasBooked);
                                                            const numNightsForExtras = reservationDetails.numberOfNights || reservationDetails.nights || 0;

                                                            for (const extraName in extras) {
                                                                if (extras.hasOwnProperty(extraName)) {
                                                                    const extraDetail = extras[extraName];
                                                                    const effectiveNightsForExtra = (numNightsForExtras > 0 ? numNightsForExtras : 1);
                                                                    const extraTotalCost = extraDetail.quantity * extraDetail.price * (extraDetail.unit === 'per day' ? effectiveNightsForExtra : 1);
                                                                    const unitDisplay = extraDetail.unit === 'per day' ? _t('extraModal.unitPerDay') : _t('extraModal.unitPerBooking');
                                                                    const extraRow = itemsBody.insertRow();

                                                                    extraRow.innerHTML = `<td>$ {
                            _t('invoice.extraPrefix')
                        }

                        : $ {
                            extraName
                        }

                        </td><td class="text-center" >$ {
                            extraDetail.quantity
                        }

                        ($ {
                                unitDisplay

                            })</td><td class="text-right" >€$ {
                            (extraDetail.price || 0).toFixed(2)
                        }

                        </td><td class="text-right" >€$ {
                            extraTotalCost.toFixed(2)
                        }

                        </td>`;
                                                                }
                                                            }
                                                        }

                                                        catch (e) {
                                                            console.error("Error parsing extras for invoice display:", e);
                                                        }
                                                    }

                                                    const paymentsBody = document.getElementById('invoicePaymentsBodyDisplay');
                                                    paymentsBody.innerHTML = '';
                                                    const paymentsSectionDiv = document.getElementById('invoicePaymentsMadeSection');
                                                    paymentsSectionDiv.style.display = 'none';

                                                    if (isPreview && reservationDetails.initialPaymentAmount > 0 && reservationDetails.initialPaymentMethod) {
                                                        paymentsSectionDiv.style.display = 'block';
                                                        const paymentRow = paymentsBody.insertRow();

                                                        paymentRow.innerHTML = ` <td>$ {
                new Date().toLocaleDateString(currentLanguage==='pt' ? 'pt-PT' : 'en-GB', dateOptionsDisplay)
            }

            ($ {
                    _t('status.Preview')

                })</td> <td>$ {
                reservationDetails.initialPaymentMethod
            }

            </td> <td class="text-right" >€$ {
                (reservationDetails.initialPaymentAmount || 0).toFixed(2)
            }

            </td>`;
                                                    }

                                                    else if (!isPreview && reservationDetails.reservationId) {
                                                        showLoading(true, _t("notifications.loading", {
                                                            item: _t('payments_history')
                                                        }));

                                                        try {
                                                            const paymentResponse = await new Promise((resolve, reject) => {
                                                                google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getPaymentsForReservation(reservationDetails.reservationId);
                                                            });
                                                            showLoading(false);

                                                            if (paymentResponse.success && paymentResponse.payments && paymentResponse.payments.length > 0) {
                                                                paymentsSectionDiv.style.display = 'block';

                                                                paymentResponse.payments.forEach(p => {
                                                                    const paymentRow = paymentsBody.insertRow();
                                                                    const paymentDateDisplay = p.paymentDate ? formatDate(p.paymentDate) : 'N/A';

                                                                    paymentRow.innerHTML = ` <td>$ {
                            paymentDateDisplay
                        }

                        </td> <td>$ {
                            p.paymentMethod || 'N/A'
                        }

                        </td> <td class="text-right" >€$ {
                            (p.paymentAmount || 0).toFixed(2)
                        }

                        </td>`;
                                                                });
                                                            }

                                                            else if (!paymentResponse.success) {
                                                                showNotification(_t('notifications.error', {
                                                                    message: `Could not load payments for invoice: $ {
                            paymentResponse.error
                        }

                        `
                                                                }), 'error');
                                                            }
                                                        }

                                                        catch (err) {
                                                            showLoading(false);

                                                            showNotification(_t('notifications.failed', {
                                                                message: `Failed to load payments: $ {
                        err.message
                    }

                    `
                                                            }), 'error');
                                                        }
                                                    }


                                                    document.getElementById('invoiceSubtotalDisplay').textContent = `€$ {
            (reservationDetails.subtotal || 0).toFixed(2)
        }

        `;

                                                    document.getElementById('invoiceTaxAmountDisplay').textContent = `€$ {
            (reservationDetails.taxAmountApplied || 0).toFixed(2)
        }

        `;

                                                    document.getElementById('invoiceTotalBeforeDiscountDisplay').textContent = `€$ {
            (reservationDetails.amountWithTaxBeforeDiscount || 0).toFixed(2)
        }

        `;

                                                    const discountLine = document.getElementById('invoiceDiscountLine');

                                                    if (reservationDetails.discountAmount && reservationDetails.discountAmount > 0) {
                                                        document.getElementById('invoiceDiscountAmountDisplay').textContent = `-€$ {
                (reservationDetails.discountAmount || 0).toFixed(2)
            }

            `;
                                                        discountLine.style.display = 'flex';
                                                    }

                                                    else {
                                                        discountLine.style.display = 'none';
                                                    }

                                                    document.getElementById('invoiceTotalCostDisplay').textContent = `€$ {
            (reservationDetails.totalCost || 0).toFixed(2)
        }

        `;

                                                    document.getElementById('invoiceTotalPaidDisplay').textContent = `€$ {
            (reservationDetails.totalPaid || 0).toFixed(2)
        }

        `;

                                                    document.getElementById('invoiceGrandTotalDisplay').textContent = `€$ {
            (reservationDetails.amountDue || 0).toFixed(2)
        }

        `;
                                                    document.getElementById('invoiceGrandTotalDisplay').className = (reservationDetails.amountDue > 0) ? 'amount-due' : 'grand-total text-green-600';


                                                    openModal('invoiceModal');
                                                }

                                                function previewInvoice() {
                                                    const form = document.getElementById('newReservationForm');

                                                    if (!form) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Reservation form not found for invoice preview."
                                                        }), "error"); return;
                                                    }

                                                    showLoading(true, "notifications.processing");
                                                    const formData = new FormData(form);
                                                    const boatSelect = document.getElementById('boatId');
                                                    const selectedBoatOption = boatSelect ? boatSelect.options[boatSelect.selectedIndex] : null;

                                                    const boatName = selectedBoatOption ? selectedBoatOption.textContent.split(' (')[0] : _t('status.Unknown', {}

                                                        , 'Unknown Boat');

                                                    const boatModel = selectedBoatOption ? selectedBoatOption.dataset.model : _t('status.Unknown', {}

                                                        , 'Unknown Model');

                                                    const params = {
                                                        boatModel: boatModel,
                                                        checkInDate: formData.get('checkInDate'), checkInTime: formData.get('checkInTime'),
                                                        checkOutDate: formData.get('checkOutDate'), checkOutTime: formData.get('checkOutTime'),
                                                        selectedExtras: JSON.stringify(getSelectedExtras()),
                                                        discountPercentage: parseFloat(formData.get('discountPercentage')) || 0,
                                                        taxValue: parseFloat(formData.get('taxValue')) || 0,
                                                    }

                                                        ;

                                                    if (!params.boatModel || !params.checkInDate || !params.checkOutDate || !params.checkInTime || !params.checkOutTime) {
                                                        showNotification(_t('notifications.error', {
                                                            message: 'Please fill all booking details for invoice preview.'
                                                        }), 'error');
                                                        showLoading(false); return;
                                                    }

                                                    google.script.run.withSuccessHandler(priceResponse => {
                                                        showLoading(false);

                                                        if (priceResponse.error) {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error calculating price for preview: $ {
                                priceResponse.error
                            }

                            `
                                                            }), 'error'); return;
                                                        }

                                                        const initialPaymentAmount = parseFloat(formData.get('initialPaymentAmount')) || 0;
                                                        const initialPaymentMethod = formData.get('initialPaymentMethod') || '';

                                                        const previewDetails = {

                                                            isPreview: true,
                                                            reservationId: _t('status.Preview', {}

                                                                , 'PREVIEW') + '-' + Date.now(),
                                                            clientName: formData.get('clientName') || 'N/A',
                                                            clientPhone: formData.get('clientPhone') || '',
                                                            clientEmail: formData.get('clientEmail') || '',
                                                            boatUniqueId: formData.get('boatId'),
                                                            boatNameAuto: boatName,
                                                            boatModelAuto: boatModel,
                                                            checkInDate: params.checkInDate, checkInTime: params.checkInTime,
                                                            checkOutDate: params.checkOutDate, checkOutTime: params.checkOutTime,
                                                            ...priceResponse,
                                                            extrasBooked: params.selectedExtras,
                                                            discountPercentage: params.discountPercentage,
                                                            taxValue: params.taxValue,
                                                            status: formData.get('status') || _t('status.Preview', {}

                                                                , 'Preview'),
                                                            reservationSource: formData.get('reservationSource') || 'OTHER',
                                                            notes: formData.get('notes') || '',
                                                            totalPaid: initialPaymentAmount,
                                                            amountDue: (priceResponse.totalCost || 0) - initialPaymentAmount,
                                                            initialPaymentAmount: initialPaymentAmount,
                                                            initialPaymentMethod: initialPaymentMethod
                                                        }

                                                            ;
                                                        if (previewDetails.amountDue < 0) previewDetails.amountDue = 0;

                                                        displayInvoice(previewDetails, true);

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to calculate price for invoice preview: $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error');
                                                    }).calculateReservationPrice(params);
                                                }

                                                document.getElementById('downloadPdfButton')?.addEventListener('click', () => {
                                                    if (currentInvoiceDetailsForPdf) {
                                                        generateAndDownloadPdf(currentInvoiceDetailsForPdf, 'invoice');
                                                    }

                                                    else {
                                                        showNotification(_t('notifications.error', {
                                                            message: "No invoice details available to generate PDF."
                                                        }), "error");
                                                    }
                                                });

                                                document.getElementById('downloadTravelPdfButton')?.addEventListener('click', () => {
                                                    if (currentTravelInvoiceDetailsForPdf) {
                                                        generateAndDownloadPdf(currentTravelInvoiceDetailsForPdf, 'travelInvoice');
                                                    }

                                                    else {
                                                        showNotification(_t('notifications.error', {
                                                            message: "No travel invoice details available to generate PDF."
                                                        }), "error");
                                                    }
                                                });

                                                document.getElementById('generateStaySheetsPdfButton')?.addEventListener('click', () => {
                                                    const startDate = document.getElementById('staySheetStartDate').value;
                                                    const endDate = document.getElementById('staySheetEndDate').value;

                                                    if (!startDate || !endDate) {
                                                        showNotification("Please select both a start and end date for the stay sheets.", "error");
                                                        return;
                                                    }

                                                    if (new Date(startDate) > new Date(endDate)) {
                                                        showNotification("Start date cannot be after end date.", "error");
                                                        return;
                                                    }

                                                    const reportParams = {
                                                        startDate, endDate
                                                    }

                                                        ;
                                                    generateAndDownloadPdf(reportParams, 'staySheets');
                                                });

                                                document.getElementById('generateReportPdfButton')?.addEventListener('click', () => {
                                                    const startDate = document.getElementById('reportStartDate').value;
                                                    const endDate = document.getElementById('reportEndDate').value;

                                                    if (!startDate || !endDate) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Please select both a start and end date for the report."
                                                        }), "error");
                                                        return;
                                                    }

                                                    if (new Date(startDate) > new Date(endDate)) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Start date cannot be after end date."
                                                        }), "error");
                                                        return;
                                                    }

                                                    const reportParams = {
                                                        startDate, endDate
                                                    }

                                                        ;
                                                    generateAndDownloadPdf(reportParams, 'report');
                                                });

                                                document.getElementById('generateBoatsListPdfButton')?.addEventListener('click', () => {
                                                    generateAndDownloadPdf({}

                                                        , 'boatsList');
                                                });

                                                document.getElementById('generateTariffsBrochurePdfButton')?.addEventListener('click', () => {
                                                    generateAndDownloadPdf({}

                                                        , 'tariffsBrochure');
                                                });

                                                document.getElementById('generateExtrasListPdfButton')?.addEventListener('click', () => {
                                                    generateAndDownloadPdf({}

                                                        , 'extrasList');
                                                });

                                                document.getElementById('generateFinancialReportPdfButton')?.addEventListener('click', () => {
                                                    const startDate = document.getElementById('financialReportStartDate').value;
                                                    const endDate = document.getElementById('financialReportEndDate').value;

                                                    if (!startDate || !endDate) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Please select both a start and end date for the report."
                                                        }), "error");
                                                        return;
                                                    }

                                                    if (new Date(startDate) > new Date(endDate)) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Start date cannot be after end date."
                                                        }), "error");
                                                        return;
                                                    }

                                                    const reportParams = {
                                                        startDate, endDate
                                                    }

                                                        ;
                                                    generateAndDownloadPdf(reportParams, 'financialReport');
                                                });

                                                // NEW: Event listener for the Daily Activity Report button
                                                document.getElementById('generateDailyActivityReportBtn')?.addEventListener('click', () => {
                                                    const startDate = document.getElementById('dailyActivityReportStartDate').value;
                                                    const endDate = document.getElementById('dailyActivityReportEndDate').value;

                                                    if (!startDate || !endDate) {
                                                        showNotification("Please select both a start and end date for the activity report.", "error");
                                                        return;
                                                    }

                                                    if (new Date(startDate) > new Date(endDate)) {
                                                        showNotification("Start date cannot be after end date.", "error");
                                                        return;
                                                    }

                                                    const reportParams = {
                                                        startDate, endDate
                                                    }

                                                        ;
                                                    generateAndDownloadPdf(reportParams, 'dailyActivityReport');
                                                });

                                                function fetchBoats(callback) {
                                                    console.log("fetchBoats (Manage): Called.");
                                                    const tableBody = document.getElementById('boatsTableBody');

                                                    if (tableBody) tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500" >$ {
                _t('manageBoats.table.loading')
            }

            </td></tr>`;

                                                    showLoading(true, "notifications.loading", {
                                                        item: _t('nav.boats')
                                                    });

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response && typeof response === 'object') {
                                                            if (response.error) {
                                                                showNotification(_t('notifications.error', {
                                                                    message: `Error fetching boats: $ {
                                    response.error
                                }

                                `
                                                                }), 'error', 7000);
                                                                ALL_BOATS = [];
                                                            }

                                                            else {
                                                                ALL_BOATS = response.boats || [];
                                                            }
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Error fetching boats: Invalid server response.'
                                                            }), 'error', 7000);
                                                            ALL_BOATS = [];
                                                        }

                                                        renderBoatsTable();
                                                        populateBoatSelect();
                                                        if (typeof callback === 'function') callback();

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to fetch boats: $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error', 7000);
                                                        ALL_BOATS = [];
                                                        renderBoatsTable();
                                                        populateBoatSelect();
                                                        if (typeof callback === 'function') callback();
                                                    }).getBoatsData();
                                                }

                                                function renderBoatsTable() {
                                                    const tableBody = document.getElementById('boatsTableBody');
                                                    if (!tableBody) return;

                                                    const headers = tableBody.closest('table').querySelector('thead tr');

                                                    if (headers) {
                                                        headers.querySelector('th:nth-child(1)').textContent = _t('manageBoats.table.id');
                                                        headers.querySelector('th:nth-child(2)').textContent = _t('manageBoats.table.name');
                                                        headers.querySelector('th:nth-child(3)').textContent = _t('manageBoats.table.model');
                                                        headers.querySelector('th:nth-child(4)').textContent = _t('manageBoats.table.actions');
                                                    }

                                                    tableBody.innerHTML = '';

                                                    if (!ALL_BOATS || ALL_BOATS.length === 0) {
                                                        tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500" >$ {
                    _t('manageBoats.table.noBoats')
                }

                </td></tr>`;
                                                        return;
                                                    }

                                                    ALL_BOATS.forEach(boat => {
                                                        const row = tableBody.insertRow();
                                                        row.className = "hover:bg-gray-50 transition-colors duration-150";

                                                        row.innerHTML = ` <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        boat.uniqueId || 'N/A'
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        boat.boatName || 'N/A'
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        boat.boatModel || 'N/A'
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-1" > <button onclick="openBoatModal('edit', '${boat.uniqueId}')" class="text-yellow-600 hover:text-yellow-900 p-1" title="${_t('viewReservations.actions.editTitle')}" ><i data-lucide="edit-2" class="h-4 w-4" ></i></button> <button onclick="confirmDeleteBoat('${boat.uniqueId}')" class="text-red-600 hover:text-red-900 p-1" title="${_t('viewReservations.actions.deleteTitle')}" ><i data-lucide="trash-2" class="h-4 w-4" ></i></button> </td> `;
                                                    });
                                                    if (lucide) lucide.createIcons();
                                                }

                                                function openBoatModal(mode, uniqueId = null) {
                                                    const form = document.getElementById('boatForm');
                                                    const titleEl = document.getElementById('boatModalTitle');
                                                    const submitBtn = document.getElementById('boatFormSubmitBtn');
                                                    const modeInput = document.getElementById('boatFormMode');
                                                    const originalIdInput = document.getElementById('originalBoatUniqueId');
                                                    const idInput = document.getElementById('boatUniqueId');
                                                    const nameInput = document.getElementById('boatName');
                                                    const modelInput = document.getElementById('boatModel');

                                                    form.reset();
                                                    originalIdInput.value = '';
                                                    idInput.readOnly = false; idInput.disabled = false;

                                                    if (mode === 'add') {
                                                        titleEl.textContent = _t('boatModal.titleAdd');
                                                        submitBtn.textContent = _t('buttons.addBoat');
                                                        modeInput.value = 'add';
                                                    }

                                                    else if (mode === 'edit' && uniqueId) {
                                                        titleEl.textContent = _t('boatModal.titleEdit');
                                                        submitBtn.textContent = _t('buttons.saveChanges');
                                                        modeInput.value = 'edit';
                                                        originalIdInput.value = uniqueId;
                                                        const boatToEdit = ALL_BOATS.find(b => b.uniqueId === uniqueId);

                                                        if (boatToEdit) {
                                                            idInput.value = boatToEdit.uniqueId;
                                                            nameInput.value = boatToEdit.boatName;
                                                            modelInput.value = boatToEdit.boatModel;
                                                            idInput.readOnly = true; idInput.disabled = true;
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Boat with ID $ {
                                uniqueId
                            }

                            not found for editing.`
                                                            }), 'error'); return;
                                                        }
                                                    }

                                                    else {
                                                        console.error("Invalid mode or missing ID for openBoatModal"); return;
                                                    }

                                                    openModal('boatModal');
                                                }

                                                document.getElementById('boatForm')?.addEventListener('submit', function (event) {
                                                    event.preventDefault();
                                                    const form = event.target;
                                                    const formData = new FormData(form);
                                                    const mode = formData.get('boatFormMode');

                                                    const boatData = {
                                                        uniqueId: formData.get('uniqueId'), name: formData.get('name'), model: formData.get('model')
                                                    }

                                                        ;
                                                    showLoading(true, "notifications.processing");

                                                    const successHandler = response => {
                                                        showLoading(false);

                                                        if (!response || typeof response !== 'object') {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Boat operation error: Invalid server response.'
                                                            }), 'error'); return;
                                                        }

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Boat $ {
                                mode==='add' ? _t('status.Added') : _t('status.Updated')
                            }

                            successfully !`
                                                            }), 'success');
                                                            closeModal('boatModal'); form.reset();

                                                            fetchBoats(() => {
                                                                const calViewDiv = document.getElementById('calendar-view');

                                                                if (calViewDiv && !calViewDiv.classList.contains('hidden') && ALL_BOATS.length > 0 && ALL_RESERVATIONS.length > 0) {
                                                                    renderYearCalendarGrid(calendarDisplayYear);
                                                                }
                                                            });
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error: $ {
                            response.message || 'Unknown boat operation error.'
                        }

                        `
                                                            }), 'error', 7000);
                                                        }
                                                    }

                                                        ;

                                                    const failureHandler = error => {
                                                        showLoading(false); showNotification(_t('notifications.failed', {
                                                            message: `Boat operation failed: $ {
                        error.message || 'Unknown error'
                    }

                    `
                                                        }), 'error', 7000);
                                                    }

                                                        ;

                                                    if (mode === 'add') {
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).addBoat(boatData);
                                                    }

                                                    else if (mode === 'edit') {
                                                        const originalUniqueId = formData.get('originalUniqueId');

                                                        if (!originalUniqueId) {
                                                            showNotification(_t('notifications.error', {
                                                                message: "Original ID missing for edit."
                                                            }), 'error'); showLoading(false); return;
                                                        }

                                                        const updatedData = {
                                                            name: boatData.name, model: boatData.model
                                                        }

                                                            ;
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).editBoat(originalUniqueId, updatedData);
                                                    }

                                                    else {
                                                        showNotification(_t('notifications.error', {
                                                            message: 'Invalid boat form mode.'
                                                        }), 'error'); showLoading(false);
                                                    }
                                                });

                                                function confirmDeleteBoat(uniqueId) {
                                                    const boat = ALL_BOATS.find(b => b.uniqueId === uniqueId);

                                                    if (!boat) {
                                                        showNotification('Boat not found', 'error');
                                                        return;
                                                    }

                                                    // Check if boat has active reservations
                                                    const activeReservations = ALL_RESERVATIONS.filter(r => r.boatUniqueId === uniqueId && r.status !== 'Cancelled' && new Date(r.checkOutDate) >= new Date());

                                                    const details = [];

                                                    details.push(`<strong>Boat ID:</strong> $ {
                    boat.uniqueId
                }

                `);

                                                    details.push(`<strong>Boat Name:</strong> $ {
                    boat.boatName
                }

                `);

                                                    details.push(`<strong>Model:</strong> $ {
                    boat.boatModel
                }

                `);

                                                    let warningMessage = null;

                                                    if (activeReservations.length > 0) {
                                                        warningMessage = `⚠️ WARNING: This boat has $ {
                    activeReservations.length
                }

                active reservation(s). Deleting it may cause data issues. Please cancel all reservations first.`;

                                                        details.push(`<strong class="text-red-600" >Active Reservations:</strong> <span class="text-red-600 font-bold" >$ {
                        activeReservations.length
                    }

                    </span>`);
                                                    }

                                                    showCustomConfirm({

                                                        title: 'Delete Boat?',
                                                        message: `Are you sure you want to permanently delete <strong>$ {
                    boat.boatName
                }

                </strong>?`,
                                                        details: details,
                                                        warning: warningMessage,
                                                        confirmText: activeReservations.length > 0 ? 'Delete Anyway (Risky!)' : 'Yes, Delete Boat',
                                                        confirmColor: 'red',
                                                        icon: 'danger',
                                                        onConfirm: () => {
                                                            deleteBoatAction(uniqueId);
                                                        }
                                                    });
                                                }

                                                function deleteBoatAction(uniqueId) {
                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (!response || typeof response !== 'object') {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Delete boat error: Invalid server response.'
                                                            }), 'error'); return;
                                                        }

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Boat "${uniqueId}" deleted successfully.`
                                                            }), 'success');

                                                            fetchBoats(() => {
                                                                const calViewDiv = document.getElementById('calendar-view');

                                                                if (calViewDiv && !calViewDiv.classList.contains('hidden') && ALL_BOATS.length > 0 && ALL_RESERVATIONS.length > 0) {
                                                                    renderYearCalendarGrid(calendarDisplayYear);
                                                                }
                                                            });
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error deleting boat: $ {
                            response.message || 'Unknown error.'
                        }

                        `
                                                            }), 'error', 7000);
                                                        }

                                                    }).withFailureHandler(error => {
                                                        showLoading(false); showNotification(_t('notifications.failed', {
                                                            message: `Failed to delete boat: $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error', 7000);
                                                    }).deleteBoat(uniqueId);
                                                }

                                                function fetchTariffsPrices(callback) {
                                                    console.log("fetchTariffsPrices (Manage): Called.");
                                                    const tableBody = document.getElementById('tariffsPricesTableBody');

                                                    if (tableBody) tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500" >$ {
                _t('manageTariffs.table.loading')
            }

            </td></tr>`;

                                                    showLoading(true, "notifications.loading", {
                                                        item: _t('nav.tariffs')
                                                    });

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response && typeof response === 'object') {
                                                            if (response.error) {
                                                                showNotification(_t('notifications.error', {
                                                                    message: `Error fetching tariffs/prices: $ {
                                    response.error
                                }

                                `
                                                                }), 'error', 7000);
                                                                ALL_TARIFFS_PRICES = [];
                                                            }

                                                            else {
                                                                ALL_TARIFFS_PRICES = response.tariffsPrices || [];
                                                            }
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Error fetching tariffs/prices: Invalid server response.'
                                                            }), 'error', 7000);
                                                            ALL_TARIFFS_PRICES = [];
                                                        }

                                                        renderTariffsPricesTable();
                                                        if (typeof callback === 'function') callback();

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to fetch tariffs/prices: $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error', 7000);
                                                        ALL_TARIFFS_PRICES = [];
                                                        renderTariffsPricesTable();
                                                        if (typeof callback === 'function') callback();
                                                    }).getTariffsPricesData();
                                                }

                                                function renderTariffsPricesTable() {
                                                    const tableBody = document.getElementById('tariffsPricesTableBody');
                                                    if (!tableBody) return;
                                                    const headers = tableBody.closest('table').querySelector('thead tr');

                                                    if (headers) {
                                                        headers.querySelector('th:nth-child(1)').textContent = _t('manageTariffs.table.tariffName');
                                                        headers.querySelector('th:nth-child(2)').textContent = _t('manageTariffs.table.startDate');
                                                        headers.querySelector('th:nth-child(3)').textContent = _t('manageTariffs.table.endDate');
                                                        headers.querySelector('th:nth-child(4)').textContent = _t('manageTariffs.table.boatModel');
                                                        headers.querySelector('th:nth-child(5)').textContent = _t('manageTariffs.table.priceNormal');
                                                        headers.querySelector('th:nth-child(6)').textContent = _t('manageTariffs.table.priceWeekend');
                                                        headers.querySelector('th:nth-child(7)').textContent = _t('manageTariffs.table.actions');
                                                    }

                                                    tableBody.innerHTML = '';

                                                    if (!ALL_TARIFFS_PRICES || ALL_TARIFFS_PRICES.length === 0) {
                                                        tableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500" >$ {
                    _t('manageTariffs.table.noTariffs')
                }

                </td></tr>`;
                                                        return;
                                                    }

                                                    ALL_TARIFFS_PRICES.sort((a, b) => (a.tariffName + a.boatModel).localeCompare(b.tariffName + b.boatModel));

                                                    ALL_TARIFFS_PRICES.forEach(item => {
                                                        const row = tableBody.insertRow();
                                                        row.className = "hover:bg-gray-50 transition-colors duration-150";

                                                        const dateOptions = {
                                                            year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC'
                                                        }

                                                            ;

                                                        // Corrected date handling: Create Date object directly from the timestamp number
                                                        const startDateDisplay = item.startDate ? new Date(item.startDate).toLocaleDateString(currentLanguage === 'pt' ? 'pt-PT' : 'en-GB', dateOptions) : 'N/A';
                                                        const endDateDisplay = item.endDate ? new Date(item.endDate).toLocaleDateString(currentLanguage === 'pt' ? 'pt-PT' : 'en-GB', dateOptions) : 'N/A';

                                                        row.innerHTML = ` <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        item.tariffName || 'N/A'
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        startDateDisplay
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        endDateDisplay
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        item.boatModel || 'N/A'
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >€$ {
                        (item.rateNormalNight ?? 0).toFixed(2)
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >€$ {
                        (item.rateWeekendNight ?? 0).toFixed(2)
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-1" > <button onclick="openTariffPriceModal('edit', '${item.boatModel}', '${item.tariffName}')" class="text-yellow-600 hover:text-yellow-900 p-1" title="${_t('viewReservations.actions.editTitle')}" ><i data-lucide="edit-2" class="h-4 w-4" ></i></button> <button onclick="confirmDeleteTariffPrice('${item.boatModel}', '${item.tariffName}')" class="text-red-600 hover:text-red-900 p-1" title="${_t('viewReservations.actions.deleteTitle')}" ><i data-lucide="trash-2" class="h-4 w-4" ></i></button> </td> `;
                                                    });
                                                    if (lucide) lucide.createIcons();
                                                }

                                                function openTariffPriceModal(mode, boatModel = null, tariffName = null) {
                                                    const form = document.getElementById('tariffPriceForm');
                                                    const titleEl = document.getElementById('tariffPriceModalTitle');
                                                    const submitBtn = document.getElementById('tariffPriceFormSubmitBtn');
                                                    const modeInput = document.getElementById('tariffPriceFormMode');
                                                    const originalBoatModelInput = document.getElementById('originalTariffBoatModel');
                                                    const originalTariffNameInput = document.getElementById('originalTariffName');

                                                    const tariffNameInput = document.getElementById('tariffName');
                                                    const startDateInput = document.getElementById('tariffStartDate');
                                                    const endDateInput = document.getElementById('tariffEndDate');
                                                    const boatModelInput = document.getElementById('tariffBoatModel');
                                                    const rateNormalInput = document.getElementById('tariffRateNormal');
                                                    const rateWeekendInput = document.getElementById('tariffRateWeekend');

                                                    form.reset();
                                                    originalBoatModelInput.value = ''; originalTariffNameInput.value = '';

                                                    const isEditMode = mode === 'edit';

                                                    [tariffNameInput, startDateInput, endDateInput, boatModelInput].forEach(el => {
                                                        el.readOnly = isEditMode;
                                                        el.disabled = isEditMode;
                                                        if (isEditMode) el.classList.add('bg-gray-100'); else el.classList.remove('bg-gray-100');
                                                    });
                                                    rateNormalInput.readOnly = false; rateNormalInput.disabled = false; rateNormalInput.classList.remove('bg-gray-100');
                                                    rateWeekendInput.readOnly = false; rateWeekendInput.disabled = false; rateWeekendInput.classList.remove('bg-gray-100');


                                                    if (mode === 'add') {
                                                        titleEl.textContent = _t('tariffModal.titleAdd');
                                                        submitBtn.textContent = _t('buttons.addTariff');
                                                        modeInput.value = 'add';
                                                    }

                                                    else if (mode === 'edit' && boatModel && tariffName) {
                                                        titleEl.textContent = _t('tariffModal.titleEdit');
                                                        submitBtn.textContent = _t('buttons.saveChanges');
                                                        modeInput.value = 'edit';
                                                        originalBoatModelInput.value = boatModel; originalTariffNameInput.value = tariffName;

                                                        const itemToEdit = ALL_TARIFFS_PRICES.find(item => item.boatModel === boatModel && item.tariffName === tariffName);

                                                        if (itemToEdit) {
                                                            tariffNameInput.value = itemToEdit.tariffName;

                                                            const toISODate = (timestamp) => {
                                                                if (!timestamp) return '';
                                                                const d = new Date(timestamp);
                                                                return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                                                            }

                                                                ;

                                                            startDateInput.value = toISODate(itemToEdit.startDate);
                                                            endDateInput.value = toISODate(itemToEdit.endDate);

                                                            boatModelInput.value = itemToEdit.boatModel;
                                                            rateNormalInput.value = itemToEdit.rateNormalNight;
                                                            rateWeekendInput.value = itemToEdit.rateWeekendNight;
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Tariff/Price for $ {
                                boatModel
                            }

                            ($ {
                                    tariffName
                                }) not found.`
                                                            }), 'error'); return;
                                                        }
                                                    }

                                                    else {
                                                        console.error("Invalid mode or missing ID for openTariffPriceModal"); return;
                                                    }

                                                    openModal('tariffPriceModal');
                                                }

                                                document.getElementById('tariffPriceForm')?.addEventListener('submit', function (event) {
                                                    event.preventDefault();
                                                    const form = event.target;
                                                    const formData = new FormData(form);
                                                    const mode = formData.get('tariffPriceFormMode');

                                                    const data = {
                                                        tariffName: formData.get('tariffName'),
                                                        startDate: formData.get('startDate'), endDate: formData.get('endDate'),
                                                        boatModel: formData.get('boatModel'),
                                                        rateNormalNight: parseFloat(formData.get('rateNormalNight')) || 0,
                                                        rateWeekendNight: parseFloat(formData.get('rateWeekendNight')) || 0
                                                    }

                                                        ;
                                                    showLoading(true, "notifications.processing");

                                                    const successHandler = response => {
                                                        showLoading(false);

                                                        if (!response || typeof response !== 'object') {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Tariff operation error: Invalid server response.'
                                                            }), 'error'); return;
                                                        }

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Tariff/Price $ {
                                mode==='add' ? _t('status.Added') : _t('status.Updated')
                            }

                            successfully !`
                                                            }), 'success');
                                                            closeModal('tariffPriceModal'); form.reset(); fetchTariffsPrices();
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error: $ {
                            response.message || 'Unknown tariff operation error.'
                        }

                        `
                                                            }), 'error', 7000);
                                                        }
                                                    }

                                                        ;

                                                    const failureHandler = error => {
                                                        showLoading(false); showNotification(_t('notifications.failed', {
                                                            message: `Tariff operation failed: $ {
                        error.message || 'Unknown error'
                    }

                    `
                                                        }), 'error', 7000);
                                                    }

                                                        ;

                                                    if (mode === 'add') {
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).addTariffPrice(data);
                                                    }

                                                    else if (mode === 'edit') {
                                                        const originalBoatModel = formData.get('originalBoatModel');
                                                        const originalTariffName = formData.get('originalTariffName');

                                                        if (!originalBoatModel || !originalTariffName) {
                                                            showNotification(_t('notifications.error', {
                                                                message: "Original identifiers missing for rate edit."
                                                            }), 'error'); showLoading(false); return;
                                                        }

                                                        const updatedRateData = {
                                                            boatModel: originalBoatModel,
                                                            tariffName: originalTariffName,
                                                            rateNormalNight: data.rateNormalNight,
                                                            rateWeekendNight: data.rateWeekendNight
                                                        }

                                                            ;
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).editTariffPrice(updatedRateData);
                                                    }

                                                    else {
                                                        showNotification(_t('notifications.error', {
                                                            message: 'Invalid tariff form mode.'
                                                        }), 'error'); showLoading(false);
                                                    }
                                                });

                                                function confirmDeleteTariffPrice(boatModel, tariffName) {
                                                    if (confirm(_t('notifications.confirmDelete', {
                                                        item: `price entry for boat model "${boatModel}" under tariff "${tariffName}" `

                                                    }))) {
                                                        deleteTariffPriceAction(boatModel, tariffName);
                                                    }
                                                }

                                                function deleteTariffPriceAction(boatModel, tariffName) {
                                                    showLoading(true, "notifications.processing");

                                                    const identifiers = {
                                                        boatModel: boatModel, tariffName: tariffName
                                                    }

                                                        ;

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (!response || typeof response !== 'object') {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Delete tariff/price error: Invalid server response.'
                                                            }), 'error'); return;
                                                        }

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Tariff/Price for $ {
                                boatModel
                            }

                            ($ {
                                    tariffName
                                }) deleted successfully.`
                                                            }), 'success'); fetchTariffsPrices();
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error deleting tariff/price: $ {
                            response.message || 'Unknown error.'
                        }

                        `
                                                            }), 'error', 7000);
                                                        }

                                                    }).withFailureHandler(error => {
                                                        showLoading(false); showNotification(_t('notifications.failed', {
                                                            message: `Failed to delete tariff/price: $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error', 7000);
                                                    }).deleteTariffPrice(identifiers);
                                                }

                                                function fetchExtras(callback) {
                                                    console.log("fetchExtras (Manage): Called.");
                                                    const tableBody = document.getElementById('extrasTableBody');

                                                    if (tableBody) tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500" >$ {
                _t('manageExtras.table.loading')
            }

            </td></tr>`;

                                                    showLoading(true, "notifications.loading", {
                                                        item: _t('nav.extras')
                                                    });

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response && typeof response === 'object') {
                                                            if (response.error) {
                                                                showNotification(_t('notifications.error', {
                                                                    message: `Error fetching extras: $ {
                                    response.error
                                }

                                `
                                                                }), 'error', 7000);
                                                                ALL_EXTRAS = [];
                                                            }

                                                            else {
                                                                ALL_EXTRAS = response.extras || [];
                                                            }
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Error fetching extras: Invalid server response.'
                                                            }), 'error', 7000);
                                                            ALL_EXTRAS = [];
                                                        }

                                                        renderExtrasTable();
                                                        populateExtras();
                                                        if (typeof callback === 'function') callback();

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to fetch extras: $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error', 7000);
                                                        ALL_EXTRAS = [];
                                                        renderExtrasTable();
                                                        populateExtras();
                                                        if (typeof callback === 'function') callback();
                                                    }).getExtrasData();
                                                }

                                                function renderExtrasTable() {
                                                    const tableBody = document.getElementById('extrasTableBody');
                                                    if (!tableBody) return;

                                                    const headers = tableBody.closest('table').querySelector('thead tr');

                                                    if (headers) {
                                                        headers.querySelector('th:nth-child(1)').textContent = _t('manageExtras.table.name');
                                                        headers.querySelector('th:nth-child(2)').textContent = _t('manageExtras.table.price');
                                                        headers.querySelector('th:nth-child(3)').textContent = _t('manageExtras.table.unit');
                                                        headers.querySelector('th:nth-child(4)').textContent = _t('manageExtras.table.actions');
                                                    }

                                                    tableBody.innerHTML = '';

                                                    if (!ALL_EXTRAS || ALL_EXTRAS.length === 0) {
                                                        tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500" >$ {
                    _t('manageExtras.table.noExtras')
                }

                </td></tr>`;
                                                        return;
                                                    }

                                                    ALL_EXTRAS.forEach(extra => {
                                                        const row = tableBody.insertRow();
                                                        row.className = "hover:bg-gray-50 transition-colors duration-150";
                                                        let displayUnit = extra.unit;
                                                        if (extra.unit === 'per day') displayUnit = _t('extraModal.unitPerDay');
                                                        else if (extra.unit === 'per booking') displayUnit = _t('extraModal.unitPerBooking');

                                                        row.innerHTML = ` <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        extra.extraName || 'N/A'
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >€$ {
                        (extra.price ?? 0).toFixed(2)
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        displayUnit
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-1" > <button onclick="openExtraModal('edit', '${extra.extraName}')" class="text-yellow-600 hover:text-yellow-900 p-1" title="${_t('viewReservations.actions.editTitle')}" ><i data-lucide="edit-2" class="h-4 w-4" ></i></button> <button onclick="confirmDeleteExtra('${extra.extraName}')" class="text-red-600 hover:text-red-900 p-1" title="${_t('viewReservations.actions.deleteTitle')}" ><i data-lucide="trash-2" class="h-4 w-4" ></i></button> </td> `;
                                                    });
                                                    if (lucide) lucide.createIcons();
                                                }

                                                function openExtraModal(mode, extraName = null) {
                                                    const form = document.getElementById('extraForm');
                                                    const titleEl = document.getElementById('extraModalTitle');
                                                    const submitBtn = document.getElementById('extraFormSubmitBtn');
                                                    const modeInput = document.getElementById('extraFormMode');
                                                    const originalNameInput = document.getElementById('originalExtraName');
                                                    const nameInput = document.getElementById('extraName');
                                                    const priceInput = document.getElementById('extraPrice');
                                                    const unitInput = document.getElementById('extraUnit');

                                                    form.reset();
                                                    originalNameInput.value = '';
                                                    nameInput.readOnly = false; nameInput.disabled = false;

                                                    if (mode === 'add') {
                                                        titleEl.textContent = _t('extraModal.titleAdd');
                                                        submitBtn.textContent = _t('buttons.addExtra');
                                                        modeInput.value = 'add';
                                                    }

                                                    else if (mode === 'edit' && extraName) {
                                                        titleEl.textContent = _t('extraModal.titleEdit');
                                                        submitBtn.textContent = _t('buttons.saveChanges');
                                                        modeInput.value = 'edit';
                                                        originalNameInput.value = extraName;
                                                        const extraToEdit = ALL_EXTRAS.find(e => e.extraName === extraName);

                                                        if (extraToEdit) {
                                                            nameInput.value = extraToEdit.extraName;
                                                            priceInput.value = extraToEdit.price;
                                                            unitInput.value = extraToEdit.unit;
                                                            nameInput.readOnly = true; nameInput.disabled = true;
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Extra "${extraName}" not found for editing.`
                                                            }), 'error'); return;
                                                        }
                                                    }

                                                    else {
                                                        console.error("Invalid mode or missing name for openExtraModal"); return;
                                                    }

                                                    openModal('extraModal');
                                                }

                                                document.getElementById('extraForm')?.addEventListener('submit', function (event) {
                                                    event.preventDefault();
                                                    const form = event.target;
                                                    const formData = new FormData(form);
                                                    const mode = formData.get('extraFormMode');

                                                    const extraData = {
                                                        name: formData.get('name'), price: parseFloat(formData.get('price')) || 0, unit: formData.get('unit')
                                                    }

                                                        ;
                                                    showLoading(true, "notifications.processing");

                                                    const successHandler = response => {
                                                        showLoading(false);

                                                        if (!response || typeof response !== 'object') {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Extra operation error: Invalid server response.'
                                                            }), 'error'); return;
                                                        }

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Extra $ {
                                mode==='add' ? _t('status.Added') : _t('status.Updated')
                            }

                            successfully !`
                                                            }), 'success');
                                                            closeModal('extraModal'); form.reset();
                                                            fetchExtras();
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error: $ {
                            response.message || 'Unknown extra operation error.'
                        }

                        `
                                                            }), 'error', 7000);
                                                        }
                                                    }

                                                        ;

                                                    const failureHandler = error => {
                                                        showLoading(false); showNotification(_t('notifications.failed', {
                                                            message: `Extra operation failed: $ {
                        error.message || 'Unknown error'
                    }

                    `
                                                        }), 'error', 7000);
                                                    }

                                                        ;

                                                    if (mode === 'add') {
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).addExtra(extraData);
                                                    }

                                                    else if (mode === 'edit') {
                                                        const originalName = formData.get('originalName');

                                                        if (!originalName) {
                                                            showNotification(_t('notifications.error', {
                                                                message: "Original name missing for edit."
                                                            }), 'error'); showLoading(false); return;
                                                        }

                                                        const updatedData = {
                                                            price: extraData.price, unit: extraData.unit
                                                        }

                                                            ;
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).editExtra(originalName, updatedData);
                                                    }

                                                    else {
                                                        showNotification(_t('notifications.error', {
                                                            message: 'Invalid extra form mode.'
                                                        }), 'error'); showLoading(false);
                                                    }
                                                });

                                                function confirmDeleteExtra(name) {
                                                    if (confirm(_t('notifications.confirmDelete', {
                                                        item: `extra "${name}" `

                                                    }))) {
                                                        deleteExtraAction(name);
                                                    }
                                                }

                                                function deleteExtraAction(name) {
                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (!response || typeof response !== 'object') {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Delete extra error: Invalid server response.'
                                                            }), 'error'); return;
                                                        }

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Extra "${name}" deleted successfully.`
                                                            }), 'success');
                                                            fetchExtras();
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error deleting extra: $ {
                            response.message || 'Unknown error.'
                        }

                        `
                                                            }), 'error', 7000);
                                                        }

                                                    }).withFailureHandler(error => {
                                                        showLoading(false); showNotification(_t('notifications.failed', {
                                                            message: `Failed to delete extra: $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error', 7000);
                                                    }).deleteExtra(name);
                                                }

                                                // --- Daily Trip Management ---
                                                function fetchDailyTripOptions(callback) {
                                                    console.log("fetchDailyTripOptions (Manage): Called.");
                                                    const tableBody = document.getElementById('tripsTableBody');

                                                    if (tableBody) tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500" >$ {
                _t('manageTrips.table.loading')
            }

            </td></tr>`;

                                                    showLoading(true, "notifications.loading", {
                                                        item: _t('nav.trips')
                                                    });

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response && response.success) {
                                                            ALL_DAILY_TRIP_OPTIONS = response.options || [];
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error fetching trip options: $ {
                                response.error || 'Invalid server response.'
                            }

                            `
                                                            }), 'error');
                                                            ALL_DAILY_TRIP_OPTIONS = [];
                                                        }

                                                        renderTripsTable();
                                                        populateTripSelect();
                                                        if (typeof callback === 'function') callback();

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to fetch trip options: $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error');
                                                        ALL_DAILY_TRIP_OPTIONS = [];
                                                        renderTripsTable();
                                                        if (typeof callback === 'function') callback();
                                                    }).getDailyTripOptions();
                                                }

                                                function renderTripsTable() {
                                                    const tableBody = document.getElementById('tripsTableBody');
                                                    if (!tableBody) return;
                                                    tableBody.innerHTML = '';

                                                    if (!ALL_DAILY_TRIP_OPTIONS || ALL_DAILY_TRIP_OPTIONS.length === 0) {
                                                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500" >$ {
                    _t('manageTrips.table.noTrips')
                }

                </td></tr>`;
                                                        return;
                                                    }

                                                    ALL_DAILY_TRIP_OPTIONS.forEach(trip => {
                                                        const row = tableBody.insertRow();
                                                        row.className = "hover:bg-gray-50 transition-colors duration-150";

                                                        row.innerHTML = ` <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        trip.tripName || 'N/A'
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >€$ {
                        (trip.pricePerAdult || 0).toFixed(2)
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >€$ {
                        (trip.pricePerKid || 0).toFixed(2)
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >€$ {
                        (trip.pricePerSenior || 0).toFixed(2)
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        trip.duration || 'N/A'
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-1" > <button onclick="openTripModal('edit', '${trip.tripName}')" class="text-yellow-600 hover:text-yellow-900 p-1" title="${_t('viewReservations.actions.editTitle')}" ><i data-lucide="edit-2" class="h-4 w-4" ></i></button> <button onclick="confirmDeleteTrip('${trip.tripName}')" class="text-red-600 hover:text-red-900 p-1" title="${_t('viewReservations.actions.deleteTitle')}" ><i data-lucide="trash-2" class="h-4 w-4" ></i></button> </td> `;
                                                    });
                                                    if (lucide) lucide.createIcons();
                                                }

                                                function openTripModal(mode, tripName = null) {
                                                    const form = document.getElementById('tripForm');
                                                    const titleEl = document.getElementById('tripModalTitle');
                                                    const submitBtn = document.getElementById('tripFormSubmitBtn');
                                                    form.reset();
                                                    document.getElementById('tripFormMode').value = mode;
                                                    document.getElementById('originalTripName').value = '';
                                                    document.getElementById('tripName').readOnly = false;

                                                    if (mode === 'add') {
                                                        titleEl.textContent = _t('manageTrips.modal.titleAdd');
                                                        submitBtn.textContent = _t('buttons.addTrip');
                                                    }

                                                    else if (mode === 'edit' && tripName) {
                                                        titleEl.textContent = _t('manageTrips.modal.titleEdit');
                                                        submitBtn.textContent = _t('buttons.saveChanges');
                                                        const tripToEdit = ALL_DAILY_TRIP_OPTIONS.find(t => t.tripName === tripName);

                                                        if (tripToEdit) {
                                                            document.getElementById('originalTripName').value = tripToEdit.tripName;
                                                            document.getElementById('tripName').value = tripToEdit.tripName;
                                                            document.getElementById('tripName').readOnly = true;
                                                            document.getElementById('tripPriceAdult').value = tripToEdit.pricePerAdult;
                                                            document.getElementById('tripPriceKid').value = tripToEdit.pricePerKid;
                                                            document.getElementById('tripPriceSenior').value = tripToEdit.pricePerSenior;
                                                            document.getElementById('tripDuration').value = tripToEdit.duration;
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Trip "${tripName}" not found for editing.`
                                                            }), 'error');
                                                            return;
                                                        }
                                                    }

                                                    openModal('tripModal');
                                                }

                                                document.getElementById('tripForm')?.addEventListener('submit', function (event) {
                                                    event.preventDefault();
                                                    const form = event.target;
                                                    const formData = new FormData(form);
                                                    const mode = formData.get('tripFormMode');
                                                    const originalTripName = formData.get('originalTripName');

                                                    const tripData = {
                                                        tripName: formData.get('tripName'),
                                                        pricePerAdult: parseFloat(formData.get('pricePerAdult')),
                                                        pricePerKid: parseFloat(formData.get('pricePerKid')),
                                                        pricePerSenior: parseFloat(formData.get('pricePerSenior')),
                                                        duration: parseFloat(formData.get('duration'))
                                                    }

                                                        ;

                                                    showLoading(true, "notifications.processing");

                                                    const successHandler = response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Trip $ {
                                    mode==='add' ? _t('status.Added') : _t('status.Updated')
                                }

                                successfully !`
                                                            }), 'success');
                                                            closeModal('tripModal');
                                                            fetchDailyTripOptions();
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error: $ {
                                response.message
                            }

                            `
                                                            }), 'error');
                                                        }
                                                    }

                                                        ;

                                                    const failureHandler = error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Trip operation failed: $ {
                        error.message
                    }

                    `
                                                        }), 'error');
                                                    }

                                                        ;

                                                    if (mode === 'add') {
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).addDailyTrip(tripData);
                                                    }

                                                    else if (mode === 'edit') {
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).editDailyTrip(originalTripName, tripData);
                                                    }
                                                });

                                                function confirmDeleteTrip(tripName) {
                                                    if (confirm(_t('notifications.confirmDelete', {
                                                        item: `trip "${tripName}" `

                                                    }))) {
                                                        deleteTripAction(tripName);
                                                    }
                                                }

                                                function deleteTripAction(tripName) {
                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Trip "${tripName}" deleted.`
                                                            }), 'success');
                                                            fetchDailyTripOptions();
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error deleting trip: $ {
                                response.message
                            }

                            `
                                                            }), 'error');
                                                        }

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to delete trip: $ {
                            error.message
                        }

                        `
                                                        }), 'error');
                                                    }).deleteDailyTrip(tripName);
                                                }

                                                // --- Food Option Management ---
                                                function fetchFoodOptions(callback) {
                                                    console.log("fetchFoodOptions (Manage): Called.");
                                                    const tableBody = document.getElementById('foodTableBody');

                                                    if (tableBody) tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500" >$ {
                _t('manageFood.table.loading')
            }

            </td></tr>`;

                                                    showLoading(true, "notifications.loading", {
                                                        item: _t('nav.food')
                                                    });

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response && response.success) {
                                                            ALL_FOOD_OPTIONS = response.options || [];
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error fetching food options: $ {
                                response.error || 'Invalid server response.'
                            }

                            `
                                                            }), 'error');
                                                            ALL_FOOD_OPTIONS = [];
                                                        }

                                                        renderFoodTable();
                                                        populateFoodOptions();
                                                        if (typeof callback === 'function') callback();

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to fetch food options: $ {
                            error.message || 'Unknown error'
                        }

                        `
                                                        }), 'error');
                                                        ALL_FOOD_OPTIONS = [];
                                                        renderFoodTable();
                                                        if (typeof callback === 'function') callback();
                                                    }).getFoodOptions();
                                                }

                                                function renderFoodTable() {
                                                    const tableBody = document.getElementById('foodTableBody');
                                                    if (!tableBody) return;
                                                    tableBody.innerHTML = '';

                                                    if (!ALL_FOOD_OPTIONS || ALL_FOOD_OPTIONS.length === 0) {
                                                        tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500" >$ {
                    _t('manageFood.table.noFood')
                }

                </td></tr>`;
                                                        return;
                                                    }

                                                    ALL_FOOD_OPTIONS.forEach(food => {
                                                        const row = tableBody.insertRow();
                                                        row.className = "hover:bg-gray-50 transition-colors duration-150";

                                                        row.innerHTML = ` <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >$ {
                        food.optionName || 'N/A'
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-700" >€$ {
                        (food.price || 0).toFixed(2)
                    }

                    </td> <td class="px-4 py-3 text-sm text-gray-700" >$ {
                        food.description || ''
                    }

                    </td> <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-1" > <button onclick="openFoodModal('edit', '${food.optionName}')" class="text-yellow-600 hover:text-yellow-900 p-1" title="${_t('viewReservations.actions.editTitle')}" ><i data-lucide="edit-2" class="h-4 w-4" ></i></button> <button onclick="confirmDeleteFood('${food.optionName}')" class="text-red-600 hover:text-red-900 p-1" title="${_t('viewReservations.actions.deleteTitle')}" ><i data-lucide="trash-2" class="h-4 w-4" ></i></button> </td> `;
                                                    });
                                                    if (lucide) lucide.createIcons();
                                                }

                                                function openFoodModal(mode, foodName = null) {
                                                    const form = document.getElementById('foodForm');
                                                    const titleEl = document.getElementById('foodModalTitle');
                                                    const submitBtn = document.getElementById('foodFormSubmitBtn');
                                                    form.reset();
                                                    document.getElementById('foodFormMode').value = mode;
                                                    document.getElementById('originalFoodName').value = '';
                                                    document.getElementById('foodOptionName').readOnly = false;

                                                    if (mode === 'add') {
                                                        titleEl.textContent = _t('manageFood.modal.titleAdd');
                                                        submitBtn.textContent = _t('buttons.addFood');
                                                    }

                                                    else if (mode === 'edit' && foodName) {
                                                        titleEl.textContent = _t('manageFood.modal.titleEdit');
                                                        submitBtn.textContent = _t('buttons.saveChanges');
                                                        const foodToEdit = ALL_FOOD_OPTIONS.find(f => f.optionName === foodName);

                                                        if (foodToEdit) {
                                                            document.getElementById('originalFoodName').value = foodToEdit.optionName;
                                                            document.getElementById('foodOptionName').value = foodToEdit.optionName;
                                                            document.getElementById('foodOptionName').readOnly = true;
                                                            document.getElementById('foodPrice').value = foodToEdit.price;
                                                            document.getElementById('foodDescription').value = foodToEdit.description;
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Food option "${foodName}" not found for editing.`
                                                            }), 'error');
                                                            return;
                                                        }
                                                    }

                                                    openModal('foodModal');
                                                }

                                                document.getElementById('foodForm')?.addEventListener('submit', function (event) {
                                                    event.preventDefault();
                                                    const form = event.target;
                                                    const formData = new FormData(form);
                                                    const mode = formData.get('foodFormMode');
                                                    const originalFoodName = formData.get('originalFoodName');

                                                    const foodData = {
                                                        optionName: formData.get('optionName'),
                                                        price: parseFloat(formData.get('price')),
                                                        description: formData.get('description')
                                                    }

                                                        ;

                                                    showLoading(true, "notifications.processing");

                                                    const successHandler = response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Food option $ {
                                    mode==='add' ? _t('status.Added') : _t('status.Updated')
                                }

                                successfully !`
                                                            }), 'success');
                                                            closeModal('foodModal');
                                                            fetchFoodOptions();
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error: $ {
                                response.message
                            }

                            `
                                                            }), 'error');
                                                        }
                                                    }

                                                        ;

                                                    const failureHandler = error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Food option operation failed: $ {
                        error.message
                    }

                    `
                                                        }), 'error');
                                                    }

                                                        ;

                                                    if (mode === 'add') {
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).addFoodOption(foodData);
                                                    }

                                                    else if (mode === 'edit') {
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).editFoodOption(originalFoodName, foodData);
                                                    }
                                                });

                                                function confirmDeleteFood(foodName) {
                                                    if (confirm(_t('notifications.confirmDelete', {
                                                        item: `food option "${foodName}" `

                                                    }))) {
                                                        deleteFoodAction(foodName);
                                                    }
                                                }

                                                function deleteFoodAction(foodName) {
                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Food option "${foodName}" deleted.`
                                                            }), 'success');
                                                            fetchFoodOptions();
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error deleting food option: $ {
                                response.message
                            }

                            `
                                                            }), 'error');
                                                        }

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to delete food option: $ {
                            error.message
                        }

                        `
                                                        }), 'error');
                                                    }).deleteFoodOption(foodName);
                                                }

                                                // --- ADD THIS ENTIRE NEW FUNCTION TO YOUR SCRIPT ---

                                                let lastHighlightedDate = null;

                                                /**
                                                 * Toggles a yellow highlight effect for a specific day's column in the calendar.
                                                 * @param {string} dateStr - The date string (YYYY-MM-DD) of the column to highlight.
                                                 */
                                                function toggleDayHighlight(dateStr) {
                                                    const gridContainer = document.getElementById('calendarYearGridContainer');
                                                    if (!gridContainer) return;

                                                    // Remove the highlight class from any previously highlighted columns
                                                    gridContainer.querySelectorAll('.highlighted-day').forEach(el => {
                                                        el.classList.remove('highlighted-day');
                                                    });

                                                    // If the user clicks the same date again, we just clear the highlight and exit.
                                                    if (lastHighlightedDate === dateStr) {
                                                        lastHighlightedDate = null;
                                                        return;
                                                    }

                                                    // Find all headers and cells for the selected date and apply the new highlight class
                                                    const headers = gridContainer.querySelectorAll(`.calendar-dayname-header[data-date="${dateStr}"], .calendar-day-header-number[data-date="${dateStr}"]`);
                                                    const slots = gridContainer.querySelectorAll(`.calendar-slot-cell[data-date="${dateStr}"]`);

                                                    headers.forEach(header => header.classList.add('highlighted-day'));
                                                    slots.forEach(slot => slot.classList.add('highlighted-day'));

                                                    // Remember the last highlighted date
                                                    lastHighlightedDate = dateStr;
                                                }



                                                // --- Calendar Fullscreen ---
                                                function toggleCalendarFullscreen() {
                                                    const calendarView = document.getElementById('calendar-view');
                                                    const button = document.getElementById('calendarFullscreenBtn');
                                                    const maximizeIcon = button.querySelector('.icon-maximize');
                                                    const minimizeIcon = button.querySelector('.icon-minimize');
                                                    const buttonText = button.querySelector('span');

                                                    calendarView.classList.toggle('fullscreen');

                                                    if (calendarView.classList.contains('fullscreen')) {
                                                        // Swapping to minimize icon
                                                        maximizeIcon.classList.add('hidden');
                                                        minimizeIcon.classList.remove('hidden');
                                                        buttonText.textContent = _t('calendar.exitFullscreen');
                                                        document.addEventListener('keydown', handleEscKeyForCalendar);
                                                    }

                                                    else {
                                                        // Swapping to maximize icon
                                                        maximizeIcon.classList.remove('hidden');
                                                        minimizeIcon.classList.add('hidden');
                                                        buttonText.textContent = _t('calendar.fullscreen');
                                                        document.removeEventListener('keydown', handleEscKeyForCalendar);
                                                    }

                                                    // No need to call lucide.createIcons() here anymore
                                                }

                                                function handleEscKeyForCalendar(event) {
                                                    if (event.key === 'Escape') {
                                                        const calendarView = document.getElementById('calendar-view');

                                                        if (calendarView.classList.contains('fullscreen')) {
                                                            toggleCalendarFullscreen();
                                                        }
                                                    }
                                                }

                                                /**
                                                 * Initializes the yearly calendar view, setting up navigation and search event listeners.
                                                 * UPDATED: The quick-add sidebar will now close on calendar navigation, UNLESS it was
                                                 * opened by a drag-and-drop action, in which case it will persist.
                                                 */
                                                function initializeYearCalendar() {
                                                    const gridContainer = document.getElementById('calendarYearGridContainer');
                                                    const yearDisplayElement = document.getElementById('currentYearDisplay');

                                                    if (!yearDisplayElement || !gridContainer) {
                                                        console.error("Yearly calendar critical elements not found.");

                                                        if (gridContainer) gridContainer.innerHTML = `<p class="text-red-500 p-4 text-center" >$ {
                    _t('notifications.error', {
                        message: 'Calendar display elements missing.'
                    })
            }

            </p>`;
                                                        return;
                                                    }

                                                    /**
                                                     * Scrolls the calendar to today's date automatically
                                                     */
                                                    function scrollCalendarToToday() {
                                                        const today = new Date();

                                                        const todayStr = `$ {
                today.getFullYear()
            }

            -$ {
                String(today.getMonth() + 1).padStart(2, '0')
            }

            -$ {
                String(today.getDate()).padStart(2, '0')
            }

            `;

                                                        setTimeout(() => {
                                                            const todayHeader = document.querySelector(`th.calendar-slot-header[data-date-for-scroll="${todayStr}"]`);

                                                            if (todayHeader) {
                                                                todayHeader.scrollIntoView({
                                                                    behavior: 'smooth',
                                                                    inline: 'center',
                                                                    block: 'nearest'
                                                                });

                                                                console.log(`Calendar auto-scrolled to today: $ {
                            todayStr
                        }

                        `);
                                                            }

                                                            else {
                                                                console.log(`Today's date (${todayStr}) not found in current calendar year.`);

                                                            }
                                                        }

                                                            , 500); // Wait for calendar to render
                                                    }

                                                    // The panel will close on scroll, unless it's in a persistent state.
                                                    gridContainer.addEventListener('scroll', () => {
                                                        if (!isQuickAddPanelPersistent) {
                                                            closeQuickAddPanel();
                                                        }
                                                    });

                                                    document.getElementById('prevYearBtn')?.addEventListener('click', () => {
                                                        if (!isQuickAddPanelPersistent) {
                                                            closeQuickAddPanel();
                                                        }

                                                        calendarDisplayYear--;
                                                        renderYearCalendarGrid(calendarDisplayYear);
                                                    });

                                                    document.getElementById('nextYearBtn')?.addEventListener('click', () => {
                                                        if (!isQuickAddPanelPersistent) {
                                                            closeQuickAddPanel();
                                                        }

                                                        calendarDisplayYear++;
                                                        renderYearCalendarGrid(calendarDisplayYear);
                                                    });

                                                    document.getElementById('calendarSearchBtn')?.addEventListener('click', () => {
                                                        if (!isQuickAddPanelPersistent) {
                                                            closeQuickAddPanel();
                                                        }

                                                        searchCalendarByClient();
                                                    });

                                                    document.getElementById('findAvailabilityBtn')?.addEventListener('click', () => {
                                                        if (!isQuickAddPanelPersistent) {
                                                            closeQuickAddPanel();
                                                        }

                                                        highlightCalendarRange();
                                                    });

                                                    // Auto-scroll helper function
                                                    function scrollToToday() {
                                                        setTimeout(() => {
                                                            const today = new Date();

                                                            const todayStr = `$ {
                        today.getFullYear()
                    }

                    -$ {
                        String(today.getMonth() + 1).padStart(2, '0')
                    }

                    -$ {
                        String(today.getDate()).padStart(2, '0')
                    }

                    `;
                                                            const todayHeader = document.querySelector(`th.calendar-slot-header[data-date-for-scroll="${todayStr}"]`);

                                                            if (todayHeader) {
                                                                todayHeader.scrollIntoView({
                                                                    behavior: 'smooth',
                                                                    inline: 'center',
                                                                    block: 'nearest'
                                                                });

                                                                console.log(`Calendar scrolled to today: $ {
                            todayStr
                        }

                        `);
                                                            }
                                                        }

                                                            , 800); // Wait for calendar to fully render
                                                    }

                                                    if (isInitialLoadComplete && ALL_RESERVATIONS && ALL_BOATS) {
                                                        renderYearCalendarGrid(calendarDisplayYear);
                                                        // scrollToToday(); // Auto-scroll after rendering -> DISABLED
                                                    }

                                                    else {
                                                        showLoading(true, "notifications.loading", {
                                                            item: _t('nav.calendarView')
                                                        });

                                                        fetchBoats(() => {
                                                            fetchReservations(() => {
                                                                renderYearCalendarGrid(calendarDisplayYear);
                                                                showLoading(false);
                                                                // scrollToToday(); // Auto-scroll after rendering -> DISABLED
                                                            }

                                                                , "Initial Calendar Load - Reservations");
                                                        });
                                                    }
                                                }



                                                function searchCalendarByClient() {
                                                    const clientNameInput = document.getElementById('calendarClientSearch');
                                                    const searchTerm = clientNameInput?.value?.trim().toLowerCase();

                                                    if (!searchTerm) {
                                                        showNotification(_t('notifications.info', {
                                                            message: "Please enter a client name to search."
                                                        }), "info");
                                                        return;
                                                    }

                                                    const foundReservation = ALL_RESERVATIONS.find(res => res.clientName && res.clientName.toLowerCase().includes(searchTerm) && res.status !== 'Cancelled');

                                                    if (foundReservation && foundReservation.checkInDate) {
                                                        const targetDate = getDateUTC(foundReservation.checkInDate, foundReservation.checkInTime || "00:00");

                                                        if (!targetDate) {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Could not parse date for client $ {
                            foundReservation.clientName
                        }

                        .`
                                                            }), "error"); return;
                                                        }

                                                        const targetYear = targetDate.getUTCFullYear();

                                                        if (targetYear !== calendarDisplayYear) {
                                                            calendarDisplayYear = targetYear;
                                                            renderYearCalendarGrid(calendarDisplayYear);
                                                        }

                                                        setTimeout(() => {
                                                            const reservationBlock = document.querySelector(`.reservation-block[title*="ID: ${foundReservation.reservationId}"]`);

                                                            if (reservationBlock) {
                                                                reservationBlock.scrollIntoView({
                                                                    behavior: 'smooth', block: 'center', inline: 'center'
                                                                });
                                                                reservationBlock.classList.add('highlight-search');
                                                                setTimeout(() => reservationBlock.classList.remove('highlight-search'), 4500);

                                                                showNotification(_t('notifications.success', {
                                                                    message: `Found reservation for $ {
                            foundReservation.clientName
                        }

                        .`
                                                                }), "success");
                                                            }

                                                            else {
                                                                showNotification(_t('notifications.info', {
                                                                    message: `Found reservation for $ {
                        foundReservation.clientName
                    }

                    , but could not highlight it on the calendar. Try 'Go to Date' with $ {
                        foundReservation.checkInDate
                    }

                    .`
                                                                }), "info");
                                                                const dateCell = document.querySelector(`td[data-date="${foundReservation.checkInDate}"][data-slot-type="AM"]`);

                                                                if (dateCell) dateCell.scrollIntoView({
                                                                    behavior: 'smooth', block: 'center', inline: 'center'
                                                                });
                                                            }
                                                        }

                                                            , 300);
                                                    }

                                                    else {
                                                        showNotification(_t('notifications.info', {
                                                            message: `No active reservations found for client name containing "${clientNameInput.value}" .`
                                                        }), "info");
                                                    }
                                                }

                                                // MODIFIED FUNCTION - REPLACE the old version with this one
                                                function highlightCalendarRange() {
                                                    const checkInInput = document.getElementById('availabilityCheckIn');
                                                    const checkOutInput = document.getElementById('availabilityCheckOut');

                                                    if (!checkInInput.value || !checkOutInput.value) {
                                                        showNotification(_t('notifications.info', {
                                                            message: "Please select both a check-in and check-out date to find availability."
                                                        }), "info");
                                                        return;
                                                    }

                                                    const startDate = getDateUTC(checkInInput.value);
                                                    const endDate = getDateUTC(checkOutInput.value);

                                                    if (!startDate || !endDate || endDate < startDate) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Please ensure check-out date is on or after check-in date."
                                                        }), "error");
                                                        return;
                                                    }

                                                    const startYear = startDate.getUTCFullYear();
                                                    const checkInDateStr = checkInInput.value;
                                                    const checkOutDateStr = checkOutInput.value;

                                                    if (startYear !== calendarDisplayYear) {
                                                        // If year is different, render the new calendar first, and then highlight/scroll
                                                        // by passing a "callback" function to be executed upon completion.
                                                        calendarDisplayYear = startYear;

                                                        renderYearCalendarGrid(calendarDisplayYear, () => {
                                                            performHighlightAndScroll(checkInDateStr, checkOutDateStr);
                                                        });
                                                    }

                                                    else {
                                                        // If we are in the same year, we can highlight/scroll immediately.
                                                        performHighlightAndScroll(checkInDateStr, checkOutDateStr);
                                                    }
                                                }

                                                /**
                                                 * Renders the main yearly calendar grid.
                                                 * UPDATED: The onclick event for day headers now calls toggleDayHighlight.
                                                 * The left border for each day is now bolder to visually separate them.
                                                 * @param {number} year - The year to render.
                                                 * @param {function} [onCompleteCallback] - Optional callback to run after rendering is complete.
                                                 */
                                                function renderYearCalendarGrid(year, onCompleteCallback) {
                                                    const gridContainer = document.getElementById('calendarYearGridContainer');
                                                    const yearDisplayElement = document.getElementById('currentYearDisplay');

                                                    if (!yearDisplayElement || !gridContainer) return;

                                                    // PERFORMANCE OPTIMIZATION: Only rebuild the shell if the year changed
                                                    if (gridContainer.dataset.renderedYear === String(year) && gridContainer.innerHTML.includes('calendar-slot-cell')) {
                                                        console.log(`renderYearCalendarGrid: Shell already exists for $ {
                        year
                    }

                    . Only repopulating reservations.`);
                                                        populateYearCalendarWithReservations(year);
                                                        if (typeof onCompleteCallback === 'function') onCompleteCallback();
                                                        return;
                                                    }

                                                    gridContainer.innerHTML = `<div class="p-8 text-center text-gray-500 flex items-center justify-center" ><div class="pro-spinner !border-slate-500 !border-t-transparent mr-2 !w-6 !h-6" ></div>$ {
                _t('calendar.loadingGrid')
            }

            </div>`;
                                                    yearDisplayElement.textContent = year;
                                                    gridContainer.dataset.renderedYear = year;

                                                    const monthShortNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                                    const dayShortNames = _t('date.dayNamesShort');
                                                    const today = new Date();

                                                    const todayStr = `$ {
                today.getFullYear()
            }

            -$ {
                String(today.getMonth() + 1).padStart(2, '0')
            }

            -$ {
                String(today.getDate()).padStart(2, '0')
            }

            `;

                                                    let tableHtml = '<table class="min-w-full divide-y divide-gray-300 border-collapse table-fixed">';
                                                    // --- HEADER ROW 1: Month abbreviation ---
                                                    let headerRow1 = `<thead class="calendar-header-sticky" ><tr class="border-b border-gray-300" ><th class="px-2 py-1 text-left text-xs font-medium text-gray-500 calendar-boatname-sticky border-r w-32" > </th>`;

                                                    let headerRow2 = `<tr class="border-b border-gray-300" ><th class="px-2 py-2 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider calendar-boatname-sticky border-r" >$ {
                _t('nav.boats')
            }

            </th>`;
                                                    let headerRow3 = `<tr class="border-b border-gray-300" ><th class="px-2 py-1 text-left text-xs font-medium text-gray-500 calendar-boatname-sticky border-r" > </th>`;
                                                    let headerRow4 = `<tr class="border-b border-gray-300" ><th class="px-2 py-1 text-left text-xs font-medium text-gray-500 calendar-boatname-sticky border-r" > </th>`;

                                                    for (let m = 0; m < 12; m++) {
                                                        const daysInMonth = new Date(year, m + 1, 0).getDate();
                                                        const monthBgClass = m % 2 === 0 ? 'month-bg-even' : 'month-bg-odd';

                                                        for (let d = 1; d <= daysInMonth; d++) {
                                                            const currentDate = new Date(Date.UTC(year, m, d));

                                                            const currentDateStr = `$ {
                        year
                    }

                    -$ {
                        String(m + 1).padStart(2, '0')
                    }

                    -$ {
                        String(d).padStart(2, '0')
                    }

                    `;
                                                            const dayName = dayShortNames[currentDate.getUTCDay()];
                                                            const isWeekend = currentDate.getUTCDay() === 0 || currentDate.getUTCDay() === 6;
                                                            const isCurrentDay = currentDateStr === todayStr;

                                                            let dayHeaderBaseClass = isWeekend ? 'bg-gray-200' : '';
                                                            let slotHeaderBaseClass = isWeekend ? 'bg-gray-100' : '';

                                                            if (isCurrentDay) {
                                                                dayHeaderBaseClass = 'current-day-header';
                                                                slotHeaderBaseClass = 'current-day-slot';
                                                            }

                                                            // Month separator styling - stronger border on first day of month
                                                            const isFirstDayOfMonth = d === 1;
                                                            const dayStartBorder = isFirstDayOfMonth ? 'border-l-4 border-indigo-400'
                                                                : 'border-l border-gray-200';
                                                            const monthBgShade = isFirstDayOfMonth ? 'bg-indigo-50' : '';

                                                            headerRow1 += `<th colspan="2" class="px-0.5 py-1 text-center text-xs font-semibold text-gray-700 ${dayStartBorder} ${monthBgShade} ${dayHeaderBaseClass} ${monthBgClass}" >$ {
                        monthShortNames[m]
                    }

                    </th>`;

                                                            // --- MODIFICATION: Changed onclick handler ---
                                                            headerRow2 += `<th colspan="2" class="calendar-dayname-header px-0.5 py-1 text-center ${dayStartBorder} ${dayHeaderBaseClass} ${monthBgClass}" data-date="${currentDateStr}" onclick="toggleDayHighlight(this.dataset.date)" >$ {
                        dayName
                    }

                    </th>`;

                                                            headerRow3 += `<th colspan="2" class="calendar-day-header-number px-0.5 py-1 text-center text-xs font-medium text-gray-600 ${dayStartBorder} ${dayHeaderBaseClass} ${monthBgClass}" data-date="${currentDateStr}" onclick="toggleDayHighlight(this.dataset.date)" >$ {
                        d
                    }

                    </th>`;
                                                            // --- END OF MODIFICATION ---

                                                            headerRow4 += `<th class="calendar-slot-header px-0.5 py-1 text-center font-medium ${dayStartBorder} ${slotHeaderBaseClass} ${monthBgClass}" data-date-for-scroll="${currentDateStr}" data-slot-type-for-scroll="AM" onclick="highlightCalendarRange(this.dataset.dateForScroll, this.dataset.dateForScroll)" >AM</th>`;
                                                            headerRow4 += `<th class="calendar-slot-header px-0.5 py-1 text-center font-medium border-l ${slotHeaderBaseClass} ${monthBgClass}" data-date-for-scroll="${currentDateStr}" data-slot-type-for-scroll="PM" onclick="highlightCalendarRange(this.dataset.dateForScroll, this.dataset.dateForScroll)" >PM</th>`;
                                                        }
                                                    }

                                                    headerRow1 += `</tr>`; headerRow2 += `</tr>`; headerRow3 += `</tr>`; headerRow4 += `</tr></thead>`;
                                                    tableHtml += headerRow1 + headerRow2 + headerRow3 + headerRow4;
                                                    tableHtml += '<tbody class="bg-white divide-y divide-gray-200">';

                                                    if (!ALL_BOATS || ALL_BOATS.length === 0) {
                                                        const leapYear = (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0;
                                                        const totalCols = 1 + ((leapYear ? 366 : 365) * 2);

                                                        tableHtml += `<tr><td colspan="${totalCols}" class="text-center py-4" >$ {
                    _t('manageBoats.table.noBoats')
                }

                </td></tr>`;
                                                    }

                                                    else {
                                                        ALL_BOATS.forEach(boat => {
                                                            tableHtml += `<tr class="hover:bg-gray-50" ><td class="px-2 py-1 whitespace-nowrap text-xs font-medium text-gray-800 calendar-boatname-sticky border-r truncate w-32" title="${boat.boatName} (${boat.boatModel})" >$ {
                            boat.boatName
                        }

                        </td>`;

                                                            for (let m = 0; m < 12; m++) {
                                                                const daysInMonth = new Date(year, m + 1, 0).getDate();
                                                                const monthBgClass = m % 2 === 0 ? 'month-bg-even' : 'month-bg-odd';

                                                                for (let d = 1; d <= daysInMonth; d++) {
                                                                    const dateStr = `$ {
                                    year
                                }

                                -$ {
                                    String(m + 1).padStart(2, '0')
                                }

                                -$ {
                                    String(d).padStart(2, '0')
                                }

                                `;
                                                                    const currentDate = new Date(Date.UTC(year, m, d));
                                                                    const isWeekend = currentDate.getUTCDay() === 0 || currentDate.getUTCDay() === 6;
                                                                    const weekendCellClass = isWeekend ? 'weekend-slot' : '';

                                                                    const dayStartBorder = 'border-l-2 border-gray-300';

                                                                    const cellIdAM = `cell-$ {
                                    boat.uniqueId
                                }

                                -$ {
                                    dateStr
                                }

                                -AM`;

                                                                    const cellIdPM = `cell-$ {
                                    boat.uniqueId
                                }

                                -$ {
                                    dateStr
                                }

                                -PM`;

                                                                    tableHtml += `<td id="${cellIdAM}" class="calendar-slot-cell ${dayStartBorder} ${monthBgClass} ${weekendCellClass}" data-boat-id="${boat.uniqueId}" data-date="${dateStr}" data-slot-type="AM" ></td>`;
                                                                    tableHtml += `<td id="${cellIdPM}" class="calendar-slot-cell border-l ${monthBgClass} ${weekendCellClass}" data-boat-id="${boat.uniqueId}" data-date="${dateStr}" data-slot-type="PM" ></td>`;
                                                                }
                                                            }

                                                            tableHtml += `</tr>`;
                                                        });
                                                    }

                                                    tableHtml += '</tbody></table>';
                                                    gridContainer.innerHTML = tableHtml;
                                                    populateYearCalendarWithReservations(year);
                                                    if (lucide) lucide.createIcons();
                                                    addDragToCreateListeners();

                                                    if (typeof onCompleteCallback === 'function') {
                                                        onCompleteCallback();
                                                    }
                                                }


                                                // NEW HELPER FUNCTION to reliably highlight and scroll
                                                function performHighlightAndScroll(checkInDateStr, checkOutDateStr) {
                                                    const gridContainer = document.getElementById('calendarYearGridContainer');
                                                    if (!gridContainer) return;

                                                    // Clear previous highlights
                                                    gridContainer.querySelectorAll('.availability-highlight').forEach(el => el.classList.remove('availability-highlight'));
                                                    const styleEl = document.getElementById('availability-highlight-style');
                                                    if (styleEl) styleEl.remove();

                                                    const startDate = getDateUTC(checkInDateStr);
                                                    const endDate = getDateUTC(checkOutDateStr);
                                                    if (!startDate || !endDate) return;

                                                    // Define the highlight style dynamically
                                                    const newStyleEl = document.createElement('style');
                                                    newStyleEl.id = 'availability-highlight-style';

                                                    newStyleEl.innerHTML = `.availability-highlight {
                background-color: rgba(74, 222, 128, 0.2) !important; box-shadow: inset 0 0 0 1px rgba(22, 163, 74, 0.4);
            }

            `;
                                                    document.head.appendChild(newStyleEl);

                                                    let currentDateIter = new Date(startDate.getTime());
                                                    const checkoutDateOnly = new Date(Date.UTC(endDate.getUTCFullYear(), endDate.getUTCMonth(), endDate.getUTCDate()));

                                                    while (currentDateIter <= checkoutDateOnly) {
                                                        const dateStr = `$ {
                    currentDateIter.getUTCFullYear()
                }

                -$ {
                    String(currentDateIter.getUTCMonth() + 1).padStart(2, '0')
                }

                -$ {
                    String(currentDateIter.getUTCDate()).padStart(2, '0')
                }

                `;

                                                        gridContainer.querySelectorAll(`td.calendar-slot-cell[data-date="${dateStr}"]`).forEach(cell => {
                                                            cell.classList.add('availability-highlight');
                                                        });
                                                        currentDateIter.setUTCDate(currentDateIter.getUTCDate() + 1);
                                                    }

                                                    // --- THIS IS THE FIX ---
                                                    // Instead of scrolling the table cell (td), we scroll to the HEADER CELL (th) for that date.
                                                    // This correctly scrolls the view horizontally.
                                                    const firstHeaderCell = gridContainer.querySelector(`th.calendar-slot-header[data-date-for-scroll="${checkInDateStr}"]`);

                                                    if (firstHeaderCell) {
                                                        firstHeaderCell.scrollIntoView({
                                                            behavior: 'smooth', inline: 'center', block: 'nearest'
                                                        });
                                                    }
                                                }

                                                function getDateUTC(dateStr, timeStr = "00:00") {
                                                    if (!dateStr) return null;
                                                    const [year, month, day] = dateStr.split('-').map(Number);
                                                    let hours = 0, minutes = 0;

                                                    if (timeStr && timeStr.includes(':')) {
                                                        [hours, minutes] = timeStr.split(':').map(Number);
                                                    }

                                                    if (isNaN(year) || isNaN(month) || isNaN(day) || isNaN(hours) || isNaN(minutes)) {
                                                        console.warn("Invalid date/time string for getDateUTC:", dateStr, timeStr);
                                                        return null;
                                                    }

                                                    return new Date(Date.UTC(year, month - 1, day, hours, minutes));
                                                }

                                                function populateYearCalendarWithReservations(targetYear) {
                                                    const gridContainer = document.getElementById('calendarYearGridContainer');

                                                    if (!gridContainer) {
                                                        console.error("populateYearCalendarWithReservations: Grid container not found."); return;
                                                    }

                                                    const currentReservations = Array.isArray(ALL_RESERVATIONS) ? ALL_RESERVATIONS : [];

                                                    console.log(`Populating year calendar for $ {
                    targetYear
                }

                with $ {
                    currentReservations.length
                }

                reservations.`);

                                                    // Efficiently clear the grid
                                                    const allCells = gridContainer.getElementsByClassName('calendar-slot-cell');

                                                    for (let i = 0; i < allCells.length; i++) {
                                                        const cell = allCells[i];
                                                        if (cell.innerHTML === '' && cell.style.display === '' && !cell.colSpan) continue; // Skip if already clear
                                                        cell.innerHTML = '';
                                                        cell.colSpan = 1;
                                                        cell.style.display = '';
                                                        cell.classList.remove('covered-by-colspan');

                                                        cell.title = cell.dataset.date && cell.dataset.slotType ? `$ {
                    cell.dataset.date
                }

                $ {
                    cell.dataset.slotType
                }

                ` : '';
                                                    }

                                                    currentReservations.forEach(res => {
                                                        if (!res.checkInDate || !res.checkOutDate || !res.boatUniqueId || res.status === 'Cancelled') {
                                                            return;
                                                        }

                                                        const ciDateTime = getDateUTC(res.checkInDate, res.checkInTime || "00:00");
                                                        const coDateTime = getDateUTC(res.checkOutDate, res.checkOutTime || "00:00");

                                                        if (!ciDateTime || !coDateTime || ciDateTime >= coDateTime) {
                                                            console.warn(`Skipping reservation $ {
                                res.reservationId
                            }

                            due to invalid/illogical dates. CI: $ {
                                res.checkInDate
                            }

                            $ {
                                res.checkInTime
                            }

                            , CO: $ {
                                res.checkOutDate
                            }

                            $ {
                                res.checkOutTime
                            }

                            `);
                                                            return;
                                                        }

                                                        let startCell = null;
                                                        let colspanCount = 0;
                                                        let currentIterDateTime = new Date(ciDateTime.getTime());

                                                        while (currentIterDateTime < coDateTime) {
                                                            const currentDateStr = `$ {
                            currentIterDateTime.getUTCFullYear()
                        }

                        -$ {
                            String(currentIterDateTime.getUTCMonth() + 1).padStart(2, '0')
                        }

                        -$ {
                            String(currentIterDateTime.getUTCDate()).padStart(2, '0')
                        }

                        `;
                                                            const currentHour = currentIterDateTime.getUTCHours();
                                                            const currentSlotType = currentHour < 12 ? "AM" : "PM";

                                                            if (currentIterDateTime.getUTCFullYear() === targetYear) {
                                                                const cellId = `cell-$ {
                                res.boatUniqueId
                            }

                            -$ {
                                currentDateStr
                            }

                            -$ {
                                currentSlotType
                            }

                            `;
                                                                const cell = document.getElementById(cellId);

                                                                if (cell) {
                                                                    if (!startCell) {
                                                                        startCell = cell;
                                                                    }

                                                                    if (cell !== startCell) {
                                                                        cell.classList.add('covered-by-colspan');
                                                                        cell.innerHTML = '';
                                                                        cell.style.display = 'none';
                                                                    }

                                                                    colspanCount++;
                                                                }
                                                            }

                                                            if (currentSlotType === "AM") {
                                                                currentIterDateTime.setUTCHours(12, 0, 0, 0);
                                                            }

                                                            else {
                                                                currentIterDateTime.setUTCDate(currentIterDateTime.getUTCDate() + 1);
                                                                currentIterDateTime.setUTCHours(0, 0, 0, 0);
                                                            }

                                                            if (colspanCount > (366 * 2 + 20)) {
                                                                console.warn("Excessive colspan for reservation ID:", res.reservationId, "Dates:", res.checkInDate, res.checkOutDate, "Count:", colspanCount);
                                                                break;
                                                            }
                                                        }

                                                        if (startCell && colspanCount > 0) {
                                                            startCell.colSpan = colspanCount;
                                                            startCell.innerHTML = '';

                                                            const clientNameToDisplay = res.clientName || `Booking: $ {
                            res.reservationId.slice(0, 8)
                        }

                        ...`;
                                                            const reservationBlock = document.createElement('div');
                                                            reservationBlock.textContent = clientNameToDisplay;

                                                            let titleText = `$ {
                            _t('viewReservations.table.client')
                        }

                        : $ {
                            res.clientName || 'N/A'
                        }

                        \n`;

                                                            titleText += `$ {
                            _t('viewReservations.table.boat')
                        }

                        : $ {
                            res.boatNameAuto || 'N/A'
                        }

                        \n`;

                                                            titleText += `CI: $ {
                            res.checkInDate
                        }

                        $ {
                            res.checkInTime || ''
                        }

                        \nCO: $ {
                            res.checkOutDate
                        }

                        $ {
                            res.checkOutTime || ''
                        }

                        \n`;

                                                            titleText += `ID: $ {
                            res.reservationId
                        }

                        \n$ {
                            _t('viewReservations.table.source')
                        }

                        : $ {
                            res.reservationSource || 'N/A'
                        }

                        `;
                                                            reservationBlock.title = titleText;

                                                            // UPDATED: onclick now handles fullscreen exit
                                                            reservationBlock.title = titleText;

                                                            // Make draggable
                                                            reservationBlock.classList.add('draggable');
                                                            reservationBlock.draggable = false; // We use custom drag, not HTML5 drag

                                                            // Single click - show action modal
                                                            // Click to edit (only if not dragging)
                                                            let clickTimer = null;

                                                            reservationBlock.onmousedown = (e) => {
                                                                // Don't interfere with right-click or drag operations
                                                                if (e.button !== 0) return;

                                                                clickTimer = setTimeout(() => {
                                                                    clickTimer = null;
                                                                }

                                                                    , 200);
                                                            }

                                                                ;

                                                            reservationBlock.onclick = (e) => {
                                                                // If we're dragging, don't trigger click
                                                                if (!clickTimer) return;

                                                                clearTimeout(clickTimer);

                                                                if (document.getElementById('calendar-view').classList.contains('fullscreen')) {
                                                                    toggleCalendarFullscreen();
                                                                }

                                                                showView('new-reservation', {
                                                                    mode: 'edit', reservationId: res.reservationId
                                                                });
                                                            }

                                                                ;

                                                            // Right click - context menu
                                                            reservationBlock.oncontextmenu = (e) => {
                                                                e.preventDefault();
                                                                e.stopPropagation();
                                                                showReservationContextMenu(e, res.reservationId);
                                                            }

                                                                ;

                                                            let blockClass = 'reservation-block';
                                                            const statusClean = res.status ? String(res.status).replace(/\s+/g, '') : 'Unknown';
                                                            const sourceClean = res.reservationSource ? String(res.reservationSource).replace(/\s+/g, '') : 'OTHER';

                                                            if (sourceClean === 'NICOLS') blockClass += ` source-NICOLS status-$ {
                        statusClean
                    }

                    `;

                                                            else if (sourceClean === 'AMIEIRA') {
                                                                if (statusClean === 'Confirmed') blockClass += ' source-AMIEIRA status-Confirmed';
                                                                else if (statusClean === 'Pending') blockClass += ' source-AMIEIRA status-Pending';

                                                                else blockClass += ` status-$ {
                            statusClean
                        }

                        `;
                                                            }

                                                            else blockClass += ` status-$ {
                        statusClean
                    }

                    `;
                                                            reservationBlock.className = blockClass;

                                                            startCell.appendChild(reservationBlock); // ← ADD THIS LINE!
                                                        }
                                                    });
                                                    console.log("Year calendar population complete for year:", targetYear);
                                                }

                                                function addDragToCreateListeners() {
                                                    const gridContainer = document.getElementById('calendarYearGridContainer');
                                                    if (!gridContainer) return;

                                                    gridContainer.addEventListener('mousedown', handleDragStart);
                                                    // These listeners are on the document to catch mouse-up even if it happens outside the grid
                                                    document.addEventListener('mouseup', handleDragEnd);
                                                    document.addEventListener('mousemove', handleDragMove);
                                                }

                                                function handleDragStart(e) {

                                                    // Only start dragging on an empty TD cell with a left-click
                                                    if (e.target.tagName === 'TD' && e.target.classList.contains('calendar-slot-cell') && e.target.innerHTML.trim() === '' && e.button === 0) {
                                                        e.preventDefault();
                                                        isDragging = true;
                                                        dragStartCell = e.target;
                                                        const gridContainer = document.getElementById('calendarYearGridContainer');
                                                        gridContainer.classList.add('is-dragging');

                                                        // Clear any previous selection
                                                        gridContainer.querySelectorAll('.is-selecting').forEach(cell => cell.classList.remove('is-selecting'));
                                                        dragStartCell.classList.add('is-selecting');
                                                    }
                                                }


                                                /**
                                                 * Handles the end of a drag-selection on the calendar grid.
                                                 * This function is responsible for gathering the selected date/time range
                                                 * and opening the quick-add side panel with the information.
                                                 * UPDATED: The checkout date is now calculated based on the last selected slot (AM/PM)
                                                 * to more accurately reflect the user's selection.
                                                 * @param {Event} e - The mouseup event.
                                                 */
                                                function handleDragEnd(e) {
                                                    if (!isDragging || !dragStartCell) {
                                                        isDragging = false;
                                                        return;
                                                    }

                                                    e.preventDefault();

                                                    const gridContainer = document.getElementById('calendarYearGridContainer');
                                                    gridContainer.classList.remove('is-dragging');

                                                    const selectedCells = gridContainer.querySelectorAll('.is-selecting');

                                                    if (selectedCells.length > 0) {
                                                        const firstCell = selectedCells[0];
                                                        const lastCell = selectedCells[selectedCells.length - 1];

                                                        const boatId = firstCell.dataset.boatId;
                                                        const checkInDate = firstCell.dataset.date;
                                                        const checkInTime = firstCell.dataset.slotType === "AM" ? "09:00" : "12:00";

                                                        // --- UPDATED LOGIC for more accurate checkout date ---
                                                        const lastSlotDate = lastCell.dataset.date;
                                                        const lastSlotType = lastCell.dataset.slotType;

                                                        let finalCheckOutDate;
                                                        let finalCheckOutTime;

                                                        if (lastSlotType === 'PM') {
                                                            finalCheckOutDate = new Date(getDateUTC(lastSlotDate));
                                                            finalCheckOutTime = "17:00";
                                                        }

                                                        else {
                                                            // lastSlotType is 'AM'
                                                            // If the last selection is an AM slot, checkout is the same day in the afternoon.
                                                            finalCheckOutDate = new Date(getDateUTC(lastSlotDate));
                                                            finalCheckOutTime = "12:00";
                                                        }

                                                        const finalCheckOutDateStr = `$ {
                    finalCheckOutDate.getUTCFullYear()
                }

                -$ {
                    String(finalCheckOutDate.getUTCMonth() + 1).padStart(2, '0')
                }

                -$ {
                    String(finalCheckOutDate.getUTCDate()).padStart(2, '0')
                }

                `;
                                                        // --- END OF UPDATED LOGIC ---

                                                        const panelDetails = {
                                                            boatId: boatId,
                                                            checkInDate: checkInDate,
                                                            checkInTime: checkInTime,
                                                            checkOutDate: finalCheckOutDateStr,
                                                            checkOutTime: finalCheckOutTime
                                                        }

                                                            ;

                                                        openQuickAddPanel(panelDetails);
                                                    }

                                                    // Clean up selection styling
                                                    isDragging = false;
                                                    dragStartCell = null;

                                                    setTimeout(() => {
                                                        gridContainer.querySelectorAll('.is-selecting').forEach(cell => cell.classList.remove('is-selecting'));
                                                    }

                                                        , 300);
                                                }


                                                /**
                                                 * Opens and populates the quick-add reservation panel.
                                                 * It makes the panel visible, triggers the slide-in animation, and sets
                                                 * the panel to be persistent against calendar navigation events.
                                                 * @param {object} details - The pre-filled details from the calendar selection.
                                                 */
                                                function openQuickAddPanel(details) {
                                                    const panel = document.getElementById('quickAddPanel');
                                                    const form = document.getElementById('quickAddReservationForm');
                                                    const boat = ALL_BOATS.find(b => b.uniqueId === details.boatId);

                                                    if (!panel || !form || !boat) {
                                                        console.error("Quick add panel, form, or boat not found.", {
                                                            panel, form, boat
                                                        });
                                                        showNotification("Could not open the reservation panel.", "error");
                                                        return;
                                                    }

                                                    // Set a flag to make the panel persistent during calendar navigation
                                                    isQuickAddPanelPersistent = true;

                                                    form.reset();
                                                    form.elements.boatId.value = details.boatId;

                                                    form.elements.boatName.value = `$ {
            boat.boatName
        }

        ($ {
                boat.boatModel
            })`;
                                                    form.elements.checkInDate.value = details.checkInDate;
                                                    form.elements.checkInTime.value = details.checkInTime;
                                                    form.elements.checkOutDate.value = details.checkOutDate;
                                                    form.elements.checkOutTime.value = details.checkOutTime;
                                                    form.elements.status.value = 'Confirmed';
                                                    form.elements.reservationSource.value = 'AMIEIRA';

                                                    // Make the panel visible before starting the transition for a smooth animation.
                                                    panel.style.display = 'flex';

                                                    setTimeout(() => {
                                                        panel.classList.remove('translate-x-full');
                                                    }

                                                        , 10);

                                                    if (lucide) lucide.createIcons();

                                                    // Trigger price calculation after populating the panel.
                                                    calculateQuickAddPrice();
                                                }

                                                /**
                                                 * Closes the quick-add reservation panel.
                                                 * This function should only be called by the 'X' button or after a successful save.
                                                 * It also resets the persistence flag, so the panel will close on the next navigation.
                                                 */
                                                function closeQuickAddPanel() {
                                                    const panel = document.getElementById('quickAddPanel');

                                                    if (panel) {
                                                        panel.classList.add('translate-x-full');

                                                        // Add a delay to allow the slide-out transition to finish before hiding completely
                                                        setTimeout(() => {
                                                            if (panel.classList.contains('translate-x-full')) {
                                                                panel.style.display = 'none';
                                                            }
                                                        }

                                                            , 300); // This duration should match your CSS transition duration (e.g., duration-300)
                                                    }

                                                    // Always reset the persistence flag when the panel is closed.
                                                    isQuickAddPanelPersistent = false;
                                                }

                                                /**
                                                 * Handles the submission of the quick-add reservation form.
                                                 * CORRECTED: Now correctly reads the discount percentage from the form.
                                                 * @param {Event} event - The form submission event.
                                                 */
                                                function handleQuickAddSubmit(event) {
                                                    event.preventDefault();
                                                    const form = event.target;
                                                    const formData = new FormData(form);

                                                    const reservationDetails = {
                                                        clientName: formData.get('clientName'),
                                                        boatUniqueId: formData.get('boatId'),
                                                        checkInDate: formData.get('checkInDate'),
                                                        checkInTime: formData.get('checkInTime'),
                                                        checkOutDate: formData.get('checkOutDate'),
                                                        checkOutTime: formData.get('checkOutTime'),
                                                        status: formData.get('status'),
                                                        reservationSource: formData.get('reservationSource'),
                                                        extrasBooked: '{}',
                                                        discountPercentage: parseFloat(formData.get('discountPercentage')) || 0, // <-- FIX IS HERE
                                                        taxValue: 0,
                                                        notes: 'Added via calendar quick-add',
                                                        totalCost: NaN
                                                    }

                                                        ;

                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(`Reservation $ {
                                response.reservationId
                            }

                            created successfully !`, 'success');
                                                            invalidateCache('reservations');
                                                            closeQuickAddPanel();

                                                            fetchReservations(() => {
                                                                renderYearCalendarGrid(calendarDisplayYear);
                                                            }

                                                                , "Post-Quick-Add Refresh");
                                                        }

                                                        else {
                                                            showNotification(`Error creating reservation: $ {
                                response.message || 'Unknown error.'
                            }

                            `, 'error', 8000);
                                                        }

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(`Failed to create reservation: $ {
                            error.message
                        }

                        `, 'error', 8000);
                                                    }).saveReservation(reservationDetails, null, null);
                                                }

                                                // Add the event listener ONCE
                                                document.getElementById('quickAddReservationForm')?.addEventListener('submit', handleQuickAddSubmit);

                                                function handleDragMove(e) {
                                                    if (!isDragging || !dragStartCell) return;
                                                    e.preventDefault();

                                                    const currentCell = e.target;
                                                    if (currentCell.tagName !== 'TD' || !currentCell.classList.contains('calendar-slot-cell')) return;

                                                    const gridContainer = document.getElementById('calendarYearGridContainer');

                                                    // **FIX:** Get all cells for the specific boat, across all rows.
                                                    const boatId = dragStartCell.dataset.boatId;
                                                    const allCellsForBoat = Array.from(gridContainer.querySelectorAll(`td.calendar-slot-cell[data-boat-id="${boatId}"]`));

                                                    const startIndex = allCellsForBoat.indexOf(dragStartCell);
                                                    const currentIndex = allCellsForBoat.indexOf(currentCell);

                                                    // If the hovered cell is not for the same boat, do nothing
                                                    if (currentIndex === -1) return;

                                                    const start = Math.min(startIndex, currentIndex);
                                                    const end = Math.max(startIndex, currentIndex);

                                                    // Clear previous hover selection
                                                    gridContainer.querySelectorAll('.is-selecting').forEach(cell => cell.classList.remove('is-selecting'));

                                                    // Highlight the new range
                                                    for (let i = start; i <= end; i++) {
                                                        if (allCellsForBoat[i]) {

                                                            // **CRITICAL FIX:** Ensure we don't select over an existing reservation
                                                            if (allCellsForBoat[i].innerHTML.trim() !== '') {
                                                                // Stop selection if we hit a booked slot
                                                                showNotification("Cannot select a range over an existing booking.", "error", 2000);
                                                                // Clear selection up to this point
                                                                gridContainer.querySelectorAll('.is-selecting').forEach(cell => cell.classList.remove('is-selecting'));
                                                                // Re-select only the starting cell
                                                                dragStartCell.classList.add('is-selecting');
                                                                return; // Exit the function
                                                            }

                                                            allCellsForBoat[i].classList.add('is-selecting');
                                                        }
                                                    }
                                                }

                                                // ==========================================
                                                // ADVANCED DRAG-AND-DROP FOR RESERVATIONS
                                                // ==========================================

                                                /**
                                                 * Initialize drag-and-drop for reservation blocks
                                                 */
                                                function initializeReservationDragDrop() {
                                                    const gridContainer = document.getElementById('calendarYearGridContainer');
                                                    if (!gridContainer) return;

                                                    // Add drag listeners to all reservation blocks
                                                    gridContainer.addEventListener('mousedown', handleReservationMouseDown);
                                                    document.addEventListener('mousemove', handleReservationDrag);
                                                    document.addEventListener('mouseup', handleReservationDrop);
                                                }

                                                function handleReservationMouseDown(e) {
                                                    // Check if clicking on a reservation block
                                                    const resBlock = e.target.closest('.reservation-block');
                                                    if (!resBlock) return;

                                                    // Right-click is handled separately (context menu)
                                                    if (e.button === 2) return;

                                                    // Don't drag if clicking the "x" or in fullscreen mode
                                                    if (e.target.closest('.close-btn') || document.getElementById('calendar-view').classList.contains('fullscreen')) {
                                                        return;
                                                    }

                                                    // Get reservation ID from title attribute
                                                    const titleText = resBlock.title || '';
                                                    const idMatch = titleText.match(/ID:\s*([^\n]+)/);
                                                    if (!idMatch) return;

                                                    const reservationId = idMatch[1].trim();
                                                    draggedReservation = ALL_RESERVATIONS.find(r => r.reservationId === reservationId);

                                                    if (!draggedReservation) return;

                                                    draggedElement = resBlock;

                                                    // Determine drag mode based on where clicked
                                                    const rect = resBlock.getBoundingClientRect();
                                                    const clickX = e.clientX - rect.left;
                                                    const edgeThreshold = 8;

                                                    // Store initial mouse position to detect actual dragging
                                                    const startX = e.clientX;
                                                    const startY = e.clientY;
                                                    resBlock.dataset.startX = startX;
                                                    resBlock.dataset.startY = startY;
                                                    resBlock.dataset.isDragging = 'false';

                                                    if (clickX < edgeThreshold) {
                                                        // Clicking on left edge = resize start
                                                        dragMode = 'resize-start';
                                                        resizeStartCell = resBlock.parentElement;
                                                        e.preventDefault(); // Prevent text selection
                                                        e.stopPropagation();
                                                    }

                                                    else if (clickX > rect.width - edgeThreshold) {
                                                        // Clicking on right edge = resize end
                                                        dragMode = 'resize-end';
                                                        resizeEndCell = resBlock.parentElement;
                                                        e.preventDefault();
                                                        e.stopPropagation();
                                                    }

                                                    else {
                                                        // Clicking in middle = move (but only if they actually drag)
                                                        dragMode = 'move';
                                                    }

                                                    // Only add dragging class if actually dragging (not just clicking)
                                                    // This will be set in handleReservationDrag
                                                }

                                                /**
                                                 * Create visual ghost element during drag
                                                 */
                                                function createDragGhost(e, reservation) {
                                                    dragGhost = document.createElement('div');
                                                    dragGhost.className = 'drag-ghost';

                                                    dragGhost.textContent = `$ {
                reservation.clientName
            }

            ($ {
                    reservation.boatNameAuto
                })`;
                                                    dragGhost.style.left = e.clientX + 10 + 'px';
                                                    dragGhost.style.top = e.clientY + 10 + 'px';
                                                    document.body.appendChild(dragGhost);
                                                }

                                                function handleReservationDrag(e) {
                                                    if (!draggedReservation || !dragMode || !draggedElement) return;

                                                    e.preventDefault();

                                                    // Calculate distance from initial click
                                                    const startX = parseFloat(draggedElement.dataset.startX || e.clientX);
                                                    const startY = parseFloat(draggedElement.dataset.startY || e.clientY);
                                                    const distance = Math.sqrt(Math.pow(e.clientX - startX, 2) + Math.pow(e.clientY - startY, 2));

                                                    // Only consider it "dragging" if moved more than 5 pixels
                                                    if (distance > 5) {
                                                        draggedElement.dataset.isDragging = 'true';

                                                        // Add visual feedback only when actually dragging
                                                        if (!draggedElement.classList.contains('dragging')) {
                                                            draggedElement.classList.add('dragging');
                                                            createDragGhost(e, draggedReservation);
                                                        }
                                                    }

                                                    else {
                                                        // Not dragging yet, just a click
                                                        return;
                                                    }

                                                    // Update ghost position
                                                    if (dragGhost) {
                                                        dragGhost.style.left = e.clientX + 10 + 'px';
                                                        dragGhost.style.top = e.clientY + 10 + 'px';
                                                    }

                                                    // Get cell under cursor
                                                    const targetCell = document.elementFromPoint(e.clientX, e.clientY);
                                                    if (!targetCell) return;

                                                    const calendarCell = targetCell.closest('.calendar-slot-cell');

                                                    // Clear previous highlights
                                                    document.querySelectorAll('.drop-zone-highlight, .drop-zone-valid, .drop-zone-invalid').forEach(el => {
                                                        el.classList.remove('drop-zone-highlight', 'drop-zone-valid', 'drop-zone-invalid');
                                                    });

                                                    if (calendarCell && calendarCell.classList.contains('calendar-slot-cell')) {
                                                        const targetBoatId = calendarCell.dataset.boatId;
                                                        const targetDate = calendarCell.dataset.date;

                                                        if (dragMode === 'move') {
                                                            // Highlight the target cell
                                                            calendarCell.classList.add('drop-zone-valid');
                                                        }

                                                        else {
                                                            // Resize mode
                                                            calendarCell.classList.add('drop-zone-highlight');
                                                        }
                                                    }
                                                }

                                                function handleReservationDrop(e) {
                                                    if (!draggedReservation || !dragMode) {
                                                        console.log('Drop ignored - no draggedReservation or dragMode', {
                                                            draggedReservation, dragMode
                                                        });
                                                        resetDragState();
                                                        return;
                                                    }

                                                    e.preventDefault();

                                                    // Get drop target
                                                    const targetCell = document.elementFromPoint(e.clientX, e.clientY);

                                                    if (!targetCell) {
                                                        resetDragState();
                                                        return;
                                                    }

                                                    const calendarCell = targetCell.closest('.calendar-slot-cell');

                                                    if (!calendarCell || !calendarCell.classList.contains('calendar-slot-cell')) {
                                                        resetDragState();
                                                        return;
                                                    }

                                                    const targetBoatId = calendarCell.dataset.boatId;
                                                    const targetDate = calendarCell.dataset.date;
                                                    const targetSlot = calendarCell.dataset.slotType;

                                                    if (dragMode === 'move') {
                                                        // Check if user actually dragged or just clicked
                                                        const wasDragged = draggedElement?.dataset?.isDragging === 'true';

                                                        if (!wasDragged) {
                                                            // Was just a click, not a drag - open edit form directly
                                                            resetDragState();

                                                            showView('new-reservation', {
                                                                mode: 'edit', reservationId: capturedReservation.reservationId
                                                            });
                                                            return;
                                                        }

                                                        // Actually dragged - proceed with move
                                                        handleReservationMove(targetDate, targetSlot, targetBoatId);

                                                    }

                                                    else if (dragMode === 'resize-start' || dragMode === 'resize-end') {
                                                        // Check if user actually dragged
                                                        const wasDragged = draggedElement?.dataset?.isDragging === 'true';

                                                        if (!wasDragged) {
                                                            // Was just a click - ignore
                                                            resetDragState();
                                                            return;
                                                        }

                                                        // Ensure we have valid target data
                                                        if (!targetDate || !targetSlot) {
                                                            showNotification('Invalid drop location for resize', 'error', 2000);
                                                            resetDragState();
                                                            return;
                                                        }

                                                        // Resizing reservation
                                                        handleReservationResize(targetDate, targetSlot, dragMode);
                                                    }

                                                    // Clean up visual feedback (MOVED TO END)
                                                    if (dragGhost) {
                                                        dragGhost.remove();
                                                        dragGhost = null;
                                                    }

                                                    if (draggedElement) {
                                                        draggedElement.classList.remove('dragging');
                                                    }

                                                    document.querySelectorAll('.drop-zone-highlight, .drop-zone-valid, .drop-zone-invalid').forEach(el => {
                                                        el.classList.remove('drop-zone-highlight', 'drop-zone-valid', 'drop-zone-invalid');
                                                    });
                                                }

                                                /**
                                                 * Move reservation to new dates
                                                 */
                                                function handleReservationMove(newStartDate, newStartSlot, targetBoatId) {

                                                    // Safety check - ensure draggedReservation exists
                                                    if (!draggedReservation) {
                                                        console.error('handleReservationMove called but draggedReservation is null');
                                                        resetDragState();
                                                        return;
                                                    }

                                                    // Capture the reservation data BEFORE any dialogs or state resets
                                                    const capturedReservation = JSON.parse(JSON.stringify(draggedReservation));

                                                    // Validate inputs
                                                    if (!newStartDate || !newStartSlot || !targetBoatId) {
                                                        showNotification('Invalid move parameters', 'error', 2000);
                                                        resetDragState();
                                                        return;
                                                    }

                                                    const originalCheckIn = getDateUTC(capturedReservation.checkInDate, capturedReservation.checkInTime);
                                                    const originalCheckOut = getDateUTC(capturedReservation.checkOutDate, capturedReservation.checkOutTime);

                                                    if (!originalCheckIn || !originalCheckOut) {
                                                        showNotification('Error parsing original dates.', 'error');
                                                        resetDragState();
                                                        return;
                                                    }

                                                    // Calculate duration
                                                    const duration = originalCheckOut - originalCheckIn;

                                                    // Calculate new dates
                                                    const newCheckInTime = newStartSlot === 'AM' ? '09:00' : '12:00';
                                                    const newCheckIn = getDateUTC(newStartDate, newCheckInTime);
                                                    const newCheckOut = new Date(newCheckIn.getTime() + duration);

                                                    // Format new checkout date
                                                    const newCheckOutDate = `$ {
                newCheckOut.getUTCFullYear()
            }

            -$ {
                String(newCheckOut.getUTCMonth() + 1).padStart(2, '0')
            }

            -$ {
                String(newCheckOut.getUTCDate()).padStart(2, '0')
            }

            `;

                                                    const newCheckOutTime = `$ {
                String(newCheckOut.getUTCHours()).padStart(2, '0')
            }

            :$ {
                String(newCheckOut.getUTCMinutes()).padStart(2, '0')
            }

            `;

                                                    // Check if boat changed
                                                    const targetBoat = ALL_BOATS.find(b => b.uniqueId === targetBoatId);
                                                    const dateChanged = newStartDate !== capturedReservation.checkInDate;
                                                    const boatChangedBool = targetBoatId !== capturedReservation.boatUniqueId;

                                                    if (boatChangedBool || dateChanged) {
                                                        // Calculate duration change
                                                        const oldDuration = new Date(capturedReservation.checkOutDate) - new Date(capturedReservation.checkInDate);
                                                        const newDuration = new Date(newCheckOut) - new Date(newCheckIn);
                                                        const daysDiff = Math.round((newDuration - oldDuration) / (1000 * 60 * 60 * 24));

                                                        const details = [];

                                                        details.push(`<strong>Client:</strong> $ {
                        capturedReservation.clientName
                    }

                    `);

                                                        details.push(`<strong>Old Dates:</strong> $ {
                        capturedReservation.checkInDate
                    }

                    → $ {
                        capturedReservation.checkOutDate
                    }

                    `);

                                                        details.push(`<strong>New Dates:</strong> $ {
                        newStartDate
                    }

                    → $ {
                        newCheckOutDate
                    }

                    `);

                                                        if (boatChangedBool && targetBoat) {
                                                            details.push(`<strong>Old Boat:</strong> $ {
                            capturedReservation.boatNameAuto || 'Unknown'
                        }

                        `);

                                                            details.push(`<strong>New Boat:</strong> $ {
                            targetBoat.boatName
                        }

                        `);
                                                        }

                                                        if (daysDiff !== 0) {
                                                            details.push(`<strong>Duration Change:</strong> $ {
                            daysDiff > 0 ? '+' : ''
                        }

                        $ {
                            daysDiff
                        }

                        day(s)`);
                                                        }

                                                        showCustomConfirm({

                                                            title: boatChangedBool ? 'Move to Different Boat?' : 'Reschedule Reservation?',
                                                            message: `Are you sure you want to $ {
                        boatChangedBool ? 'move this reservation to a different boat' : 'change the dates for this reservation'
                    }

                    ?`,
                                                            details: details,
                                                            warning: boatChangedBool ? 'Moving to a different boat may affect pricing.' : (daysDiff !== 0 ? `This will $ {
                            daysDiff > 0 ? 'add ' + daysDiff : 'remove ' + Math.abs(daysDiff)
                        }

                        night(s) and may change the price.` : null),
                                                            confirmText: 'Yes, Move Reservation',
                                                            confirmColor: 'indigo',
                                                            icon: 'warning',
                                                            onConfirm: () => {
                                                                closeCustomConfirm();
                                                                showLoading(true, 'notifications.processing');

                                                                google.script.run.withSuccessHandler(response => {
                                                                    showLoading(false);

                                                                    if (response.success) {
                                                                        showNotification(`Reservation for $ {
                                            capturedReservation.clientName
                                        }

                                        moved successfully !`, 'success');
                                                                        invalidateCache('reservations');
                                                                        invalidateCache('dashboard');

                                                                        fetchReservations(() => {
                                                                            renderYearCalendarGrid(calendarDisplayYear);
                                                                        }

                                                                            , 'After Drag Move');
                                                                    }

                                                                    else {
                                                                        showNotification(`Error: $ {
                                            response.message
                                        }

                                        `, 'error');
                                                                    }

                                                                    resetDragState();

                                                                }).withFailureHandler(error => {
                                                                    showLoading(false);

                                                                    showNotification(`Failed to reschedule: $ {
                                        error.message
                                    }

                                    `, 'error');
                                                                    resetDragState();
                                                                }).rescheduleReservation(capturedReservation.reservationId, newStartDate, newCheckInTime, newCheckOutDate, newCheckOutTime, targetBoatId);
                                                            }
                                                        });
                                                        return;
                                                    }

                                                    // If no significant change, proceed without confirmation
                                                    showLoading(true, 'notifications.processing');

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification('Reservation updated successfully!', 'success');
                                                            invalidateCache('reservations');
                                                            invalidateCache('dashboard');

                                                            fetchReservations(() => {
                                                                renderYearCalendarGrid(calendarDisplayYear);
                                                            }

                                                                , 'After Drag Move');
                                                        }

                                                        else {
                                                            showNotification(`Error: $ {
                            response.message
                        }

                        `, 'error');
                                                        }

                                                        resetDragState();

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(`Failed to update: $ {
                        error.message
                    }

                    `, 'error');
                                                        resetDragState();
                                                    }).rescheduleReservation(capturedReservation.reservationId, newStartDate, newCheckInTime, newCheckOutDate, newCheckOutTime, targetBoatId);
                                                }

                                                function handleReservationResize(targetDate, targetSlot, mode) {

                                                    // Safety check
                                                    if (!draggedReservation) {
                                                        console.error('handleReservationResize called but draggedReservation is null');
                                                        resetDragState();
                                                        return;
                                                    }

                                                    // Capture the reservation data BEFORE any dialogs
                                                    const capturedReservation = JSON.parse(JSON.stringify(draggedReservation));

                                                    const newTime = targetSlot === 'AM' ? '09:00' : '17:00';

                                                    let newCheckInDate, newCheckInTime, newCheckOutDate, newCheckOutTime;

                                                    if (mode === 'resize-start') {
                                                        // Changing check-in date
                                                        newCheckInDate = targetDate;
                                                        newCheckInTime = newTime;
                                                        newCheckOutDate = capturedReservation.checkOutDate;
                                                        newCheckOutTime = capturedReservation.checkOutTime;

                                                        // Validate: new check-in must be before check-out
                                                        if (getDateUTC(newCheckInDate, newCheckInTime) >= getDateUTC(newCheckOutDate, newCheckOutTime)) {
                                                            showNotification('Check-in must be before check-out!', 'error', 3000);
                                                            resetDragState();
                                                            return;
                                                        }

                                                    }

                                                    else if (mode === 'resize-end') {
                                                        // Changing check-out date
                                                        newCheckInDate = capturedReservation.checkInDate;
                                                        newCheckInTime = capturedReservation.checkInTime;
                                                        newCheckOutDate = targetDate;
                                                        newCheckOutTime = newTime;

                                                        // Validate: new check-out must be after check-in
                                                        if (getDateUTC(newCheckOutDate, newCheckOutTime) <= getDateUTC(newCheckInDate, newCheckInTime)) {
                                                            showNotification('Check-out must be after check-in!', 'error', 3000);
                                                            resetDragState();
                                                            return;
                                                        }
                                                    }

                                                    else {
                                                        resetDragState();
                                                        return;
                                                    }

                                                    // Calculate change in days
                                                    const oldStart = new Date(capturedReservation.checkInDate);
                                                    const oldEnd = new Date(capturedReservation.checkOutDate);
                                                    const newStart = new Date(newCheckInDate);
                                                    const newEnd = new Date(newCheckOutDate);
                                                    const oldDays = Math.round((oldEnd - oldStart) / (1000 * 60 * 60 * 24));
                                                    const newDays = Math.round((newEnd - newStart) / (1000 * 60 * 60 * 24));
                                                    const dayChange = newDays - oldDays;

                                                    const details = [];

                                                    details.push(`<strong>Client:</strong> $ {
                    capturedReservation.clientName
                }

                `);

                                                    details.push(`<strong>Boat:</strong> $ {
                    capturedReservation.boatNameAuto
                }

                `);

                                                    details.push(`<strong>Old Duration:</strong> $ {
                    oldDays
                }

                night(s)`);

                                                    details.push(`<strong>New Duration:</strong> $ {
                    newDays
                }

                night(s)`);

                                                    details.push(`<strong>Old Dates:</strong> $ {
                    capturedReservation.checkInDate
                }

                → $ {
                    capturedReservation.checkOutDate
                }

                `);

                                                    details.push(`<strong>New Dates:</strong> $ {
                    newCheckInDate
                }

                → $ {
                    newCheckOutDate
                }

                `);

                                                    showCustomConfirm({

                                                        title: 'Resize Reservation?',
                                                        message: `You are $ {
                    mode==='resize-start' ? 'changing the check-in date' : 'changing the check-out date'
                }

                for this reservation.`,
                                                        details: details,
                                                        warning: dayChange !== 0 ? `This will $ {
                    dayChange > 0 ? 'add ' + dayChange : 'remove ' + Math.abs(dayChange)
                }

                night(s) and may change the price.` : null,
                                                        confirmText: 'Yes, Resize',
                                                        confirmColor: 'indigo',
                                                        icon: 'warning',
                                                        onConfirm: () => {
                                                            closeCustomConfirm();
                                                            showLoading(true, 'notifications.processing');

                                                            google.script.run.withSuccessHandler(response => {
                                                                showLoading(false);

                                                                if (response.success) {
                                                                    showNotification(`Reservation for $ {
                                        capturedReservation.clientName
                                    }

                                    resized successfully !`, 'success');
                                                                    invalidateCache('reservations');
                                                                    invalidateCache('dashboard');

                                                                    fetchReservations(() => {
                                                                        renderYearCalendarGrid(calendarDisplayYear);
                                                                    }

                                                                        , 'After Drag Resize');
                                                                }

                                                                else {
                                                                    showNotification(`Error: $ {
                                        response.message
                                    }

                                    `, 'error');
                                                                }

                                                                resetDragState();

                                                            }).withFailureHandler(error => {
                                                                showLoading(false);

                                                                showNotification(`Failed to resize: $ {
                                    error.message
                                }

                                `, 'error');
                                                                resetDragState();
                                                            }).rescheduleReservation(capturedReservation.reservationId, newCheckInDate, newCheckInTime, newCheckOutDate, newCheckOutTime);
                                                        }
                                                    });
                                                }

                                                /**
                                                 * Reset drag state
                                                 */
                                                function resetDragState() {
                                                    console.log('resetDragState called');
                                                    draggedReservation = null;
                                                    draggedElement = null;
                                                    dragMode = null;
                                                    resizeStartCell = null;
                                                    resizeEndCell = null;

                                                    if (dragGhost) {
                                                        dragGhost.remove();
                                                        dragGhost = null;
                                                    }
                                                }

                                                // ==========================================
                                                // RIGHT-CLICK CONTEXT MENU
                                                // ==========================================

                                                let currentContextReservationId = null;

                                                function showReservationContextMenu(event, reservationId) {
                                                    const menu = document.getElementById('reservationContextMenu');
                                                    if (!menu) return;

                                                    console.log('showReservationContextMenu called with ID:', reservationId);

                                                    currentContextReservationId = reservationId;
                                                    menu.dataset.reservationId = reservationId;

                                                    // Position menu at cursor
                                                    menu.style.left = event.clientX + 'px';
                                                    menu.style.top = event.clientY + 'px';
                                                    menu.classList.add('show');

                                                    // Adjust if menu goes off-screen
                                                    setTimeout(() => {
                                                        const rect = menu.getBoundingClientRect();

                                                        if (rect.right > window.innerWidth) {
                                                            menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
                                                        }

                                                        if (rect.bottom > window.innerHeight) {
                                                            menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
                                                        }
                                                    }

                                                        , 10);

                                                    // Re-initialize Lucide icons
                                                    if (lucide) lucide.createIcons();
                                                }

                                                // ==========================================
                                                // CUSTOM CONFIRMATION DIALOG SYSTEM
                                                // ==========================================

                                                let confirmCallback = null;

                                                /**
                                                 * Show custom confirmation dialog
                                                 * @param {Object} options - Configuration object
                                                 * @param {string} options.title - Dialog title
                                                 * @param {string} options.message - Main message
                                                 * @param {Array} options.details - Array of detail lines (optional)
                                                 * @param {string} options.warning - Warning message (optional)
                                                 * @param {string} options.confirmText - Confirm button text (default: "Confirm")
                                                 * @param {string} options.confirmColor - Confirm button color (default: indigo)
                                                 * @param {string} options.icon - Icon type: info, warning, danger, success
                                                 * @param {Function} options.onConfirm - Callback when confirmed
                                                 */
                                                function showCustomConfirm(options) {
                                                    const modal = document.getElementById('customConfirmModal');
                                                    const title = document.getElementById('confirmModalTitle');
                                                    const message = document.getElementById('confirmModalMessage');
                                                    const details = document.getElementById('confirmModalDetails');
                                                    const detailsContent = document.getElementById('confirmModalDetailsContent');
                                                    const warning = document.getElementById('confirmModalWarning');
                                                    const warningText = document.getElementById('confirmModalWarningText');
                                                    const confirmBtn = document.getElementById('confirmModalConfirmBtn');
                                                    const iconContainer = document.getElementById('confirmModalIcon');

                                                    // Set title and message
                                                    title.textContent = options.title || 'Confirm Action';
                                                    message.innerHTML = options.message || 'Are you sure?';

                                                    // Set icon
                                                    const iconMap = {
                                                        info: {
                                                            icon: 'info', bg: 'bg-blue-100', color: 'text-blue-600'
                                                        }

                                                        ,
                                                        warning: {
                                                            icon: 'alert-circle', bg: 'bg-amber-100', color: 'text-amber-600'
                                                        }

                                                        ,
                                                        danger: {
                                                            icon: 'alert-triangle', bg: 'bg-red-100', color: 'text-red-600'
                                                        }

                                                        ,
                                                        success: {
                                                            icon: 'check-circle', bg: 'bg-green-100', color: 'text-green-600'
                                                        }
                                                    }

                                                        ;
                                                    const iconConfig = iconMap[options.icon] || iconMap.warning;

                                                    iconContainer.className = `flex-shrink-0 w-12 h-12 rounded-full $ {
                iconConfig.bg
            }

            flex items-center justify-center`;
                                                    iconContainer.innerHTML = `<i data-lucide="${iconConfig.icon}" class="h-6 w-6 ${iconConfig.color}" ></i>`;

                                                    // Set details
                                                    if (options.details && options.details.length > 0) {
                                                        detailsContent.innerHTML = options.details.map(d => `<p>$ {
                        d
                    }

                    </p>`).join('');
                                                        details.classList.remove('hidden');
                                                    }

                                                    else {
                                                        details.classList.add('hidden');
                                                    }

                                                    // Set warning
                                                    if (options.warning) {
                                                        warningText.textContent = options.warning;
                                                        warning.classList.remove('hidden');
                                                    }

                                                    else {
                                                        warning.classList.add('hidden');
                                                    }

                                                    // Set confirm button
                                                    confirmBtn.textContent = options.confirmText || 'Confirm';

                                                    const colorMap = {
                                                        indigo: 'bg-indigo-600 hover:bg-indigo-700',
                                                        red: 'bg-red-600 hover:bg-red-700',
                                                        green: 'bg-green-600 hover:bg-green-700',
                                                        amber: 'bg-amber-600 hover:bg-amber-700'
                                                    }

                                                        ;
                                                    const btnColor = colorMap[options.confirmColor] || colorMap.indigo;

                                                    confirmBtn.className = `px-5 py-2.5 $ {
                btnColor
            }

            text-white font-medium rounded-lg transition-colors shadow-md`;

                                                    // Store callback
                                                    confirmCallback = options.onConfirm;

                                                    // Show modal
                                                    openModal('customConfirmModal');

                                                    // Reinitialize icons
                                                    if (lucide) lucide.createIcons();
                                                }

                                                function closeCustomConfirm() {
                                                    const modal = document.getElementById('customConfirmModal');

                                                    if (modal) {
                                                        modal.classList.remove('show');
                                                    }

                                                    confirmCallback = null;
                                                }

                                                // Handle confirm button click
                                                document.getElementById('confirmModalConfirmBtn')?.addEventListener('click', () => {
                                                    if (typeof confirmCallback === 'function') {
                                                        confirmCallback();
                                                    }

                                                    closeCustomConfirm();
                                                });

                                                function hideReservationContextMenu() {
                                                    const menu = document.getElementById('reservationContextMenu');

                                                    if (menu) {
                                                        menu.classList.remove('show');
                                                        // Don't clear the ID immediately - let it persist in DOM
                                                        // It will be cleared when a new context menu is opened
                                                    }

                                                    // Don't clear currentContextReservationId here
                                                }

                                                document.getElementById('contextMenuEdit')?.addEventListener('click', () => {
                                                    const menu = document.getElementById('reservationContextMenu');
                                                    const reservationId = menu?.dataset?.reservationId || currentContextReservationId;
                                                    console.log('Context menu edit clicked. ID:', reservationId);

                                                    if (reservationId) {
                                                        hideReservationContextMenu();

                                                        if (document.getElementById('calendar-view').classList.contains('fullscreen')) {
                                                            toggleCalendarFullscreen();
                                                        }

                                                        showView('new-reservation', {
                                                            mode: 'edit', reservationId: reservationId
                                                        });
                                                    }

                                                    else {
                                                        showNotification('Error: No reservation selected', 'error');
                                                    }
                                                });

                                                document.getElementById('contextMenuInvoice')?.addEventListener('click', () => {
                                                    const menu = document.getElementById('reservationContextMenu');
                                                    const reservationId = menu?.dataset?.reservationId || currentContextReservationId;
                                                    console.log('Context menu invoice clicked. ID:', reservationId);

                                                    if (reservationId) {
                                                        hideReservationContextMenu();
                                                        displayInvoice(reservationId);
                                                    }

                                                    else {
                                                        showNotification('Error: No reservation selected', 'error');
                                                    }
                                                });

                                                document.getElementById('contextMenuPayments')?.addEventListener('click', () => {
                                                    const menu = document.getElementById('reservationContextMenu');
                                                    const reservationId = menu?.dataset?.reservationId || currentContextReservationId;
                                                    console.log('Context menu payments clicked. ID:', reservationId);

                                                    if (reservationId) {
                                                        hideReservationContextMenu();
                                                        openPaymentModal(reservationId, 'reservation');
                                                    }

                                                    else {
                                                        showNotification('Error: No reservation selected', 'error');
                                                    }
                                                });

                                                document.getElementById('contextMenuCancel')?.addEventListener('click', () => {
                                                    const menu = document.getElementById('reservationContextMenu');
                                                    const reservationId = menu?.dataset?.reservationId || currentContextReservationId;
                                                    console.log('Context menu cancel clicked. ID:', reservationId);

                                                    if (reservationId) {
                                                        hideReservationContextMenu();
                                                        confirmCancelReservation(reservationId);
                                                    }

                                                    else {
                                                        showNotification('Error: No reservation selected', 'error');
                                                    }
                                                });

                                                document.getElementById('contextMenuStaySheet')?.addEventListener('click', () => {
                                                    const menu = document.getElementById('reservationContextMenu');
                                                    const reservationId = menu?.dataset?.reservationId || currentContextReservationId;
                                                    console.log('Context menu stay sheet clicked. ID:', reservationId);

                                                    if (reservationId) {
                                                        hideReservationContextMenu();
                                                        generateSingleStaySheet(reservationId);
                                                    }

                                                    else {
                                                        showNotification('Error: No reservation selected', 'error');
                                                    }
                                                });

                                                // Hide menu when clicking anywhere else
                                                document.addEventListener('click', (e) => {
                                                    const menu = document.getElementById('reservationContextMenu');

                                                    if (menu && !menu.contains(e.target)) {
                                                        hideReservationContextMenu();
                                                    }
                                                });

                                                // Hide menu on scroll
                                                document.getElementById('calendarYearGridContainer')?.addEventListener('scroll', hideReservationContextMenu);

                                                // --- Payment Management Functions (Client-Side) ---
                                                function openPaymentModal(bookingId, bookingType) {
                                                    let bookingRecord;

                                                    if (bookingType === 'reservation') {
                                                        bookingRecord = ALL_RESERVATIONS.find(r => r.reservationId === bookingId);
                                                    }

                                                    else if (bookingType === 'travel') {
                                                        bookingRecord = ALL_DAILY_TRAVELS.find(t => t.travelId === bookingId);
                                                    }

                                                    if (!bookingRecord) {
                                                        showNotification(_t('notifications.error', {
                                                            message: `$ {
                            bookingType.charAt(0).toUpperCase() + bookingType.slice(1)
                        }

                        not found for payment management.`
                                                        }), "error");
                                                        return;
                                                    }

                                                    const typeStr = bookingType === 'reservation' ? 'Reservation' : 'Travel';

                                                    document.getElementById('paymentBookingId').value = bookingId;
                                                    document.getElementById('paymentBookingType').value = bookingType;
                                                    const modalTitleEl = document.getElementById('paymentModalTitle');

                                                    if (modalTitleEl) modalTitleEl.textContent = _t('payments_modal_title', {
                                                        type: typeStr, id: `$ {
                bookingId
            }

            ($ {
                    bookingRecord.clientName || 'N/A'
                })`
                                                    });

                                                    document.getElementById('paymentModalTotalCost').textContent = `€$ {
            (bookingRecord.totalCost || 0).toFixed(2)
        }

        `;

                                                    document.getElementById('paymentModalTotalPaid').textContent = `€$ {
            (bookingRecord.totalPaid || 0).toFixed(2)
        }

        `;

                                                    document.getElementById('paymentModalAmountDue').textContent = `€$ {
            (bookingRecord.amountDue || 0).toFixed(2)
        }

        `;
                                                    document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];

                                                    showLoading(true, "notifications.loading", {
                                                        item: _t('payments_history')
                                                    });

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            renderPaymentHistory(response.payments, bookingType);
                                                            openModal('paymentManagementModal');
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error fetching payments: $ {
                                response.error || 'Unknown error'
                            }

                            `
                                                            }), 'error');
                                                            renderPaymentHistory([], bookingType);
                                                            openModal('paymentManagementModal');
                                                        }

                                                    }).withFailureHandler(err => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to load payment history: $ {
                            err.message
                        }

                        `
                                                        }), 'error');
                                                        renderPaymentHistory([], bookingType);
                                                        openModal('paymentManagementModal');
                                                    }).getPaymentsForReservation(bookingId);
                                                }

                                                function renderPaymentHistory(payments, bookingType) {
                                                    const tableBody = document.getElementById('paymentHistoryTableBody');
                                                    tableBody.innerHTML = '';

                                                    if (!payments || payments.length === 0) {
                                                        tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-3 text-gray-500" >$ {
                    _t('payments_no_payments_recorded')
                }

                </td></tr>`;
                                                        return;
                                                    }

                                                    const dateOptions = {
                                                        year: 'numeric', month: '2-digit', day: '2-digit'
                                                    }

                                                        ;

                                                    payments.forEach(p => {
                                                        const row = tableBody.insertRow();
                                                        const paymentDateDisplay = p.paymentDate ? new Date(p.paymentDate.replace(/-/g, '/')).toLocaleDateString(currentLanguage === 'pt' ? 'pt-PT' : 'en-GB', dateOptions) : 'N/A';

                                                        row.innerHTML = ` <td class="px-3 py-2 whitespace-nowrap" >$ {
                        paymentDateDisplay
                    }

                    </td> <td class="px-3 py-2 whitespace-nowrap text-right" >€$ {
                        (p.paymentAmount || 0).toFixed(2)
                    }

                    </td> <td class="px-3 py-2 whitespace-nowrap" >$ {
                        p.paymentMethod || 'N/A'
                    }

                    </td> <td class="px-3 py-2 whitespace-pre-wrap max-w-xs truncate" title="${p.notes || ''}" >$ {
                        p.notes || ''
                    }

                    </td> <td class="px-3 py-2 whitespace-nowrap" > <button onclick="confirmDeletePayment('${p.paymentId}', '${p.reservationId}', '${bookingType}', '€${(p.paymentAmount || 0).toFixed(2)}', '${paymentDateDisplay}')"
                    class="text-red-500 hover:text-red-700 p-1" title="${_t('payments_action_delete')}" > <i data-lucide="trash-2" class="h-4 w-4" ></i> </button> </td> `;
                                                    });
                                                    if (lucide) lucide.createIcons();
                                                }

                                                document.getElementById('addPaymentForm')?.addEventListener('submit', function (event) {
                                                    event.preventDefault();
                                                    handleAddPayment();
                                                });

                                                function handleAddPayment() {
                                                    const form = document.getElementById('addPaymentForm');
                                                    const reservationId = document.getElementById('paymentBookingId').value;
                                                    const bookingType = document.getElementById('paymentBookingType').value;

                                                    const paymentData = {
                                                        reservationId: reservationId,
                                                        paymentAmount: parseFloat(form.elements.paymentAmount.value),
                                                        paymentDate: form.elements.paymentDate.value,
                                                        paymentMethod: form.elements.paymentMethod.value,
                                                        notes: form.elements.paymentNotes.value
                                                    }

                                                        ;

                                                    if (!paymentData.paymentDate || isNaN(paymentData.paymentAmount) || paymentData.paymentAmount <= 0 || !paymentData.paymentMethod) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Please fill all required payment fields (Date, Amount, Method)."
                                                        }), 'error');
                                                        return;
                                                    }

                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: response.message || "Payment added."
                                                            }), 'success');
                                                            form.reset();
                                                            document.getElementById('paymentDate').value = new Date().toISOString().split('T')[0];

                                                            if (bookingType === 'reservation') {
                                                                fetchReservations(() => {
                                                                    openPaymentModal(reservationId, bookingType);
                                                                }

                                                                    , "Post-Payment Add Refresh");
                                                            }

                                                            else if (bookingType === 'travel') {
                                                                fetchDailyTravels(() => {
                                                                    openPaymentModal(reservationId, bookingType);
                                                                });
                                                            }

                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error adding payment: $ {
                            response.message || 'Unknown error'
                        }

                        `
                                                            }), 'error');
                                                        }

                                                    }).withFailureHandler(err => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to add payment: $ {
                            err.message
                        }

                        `
                                                        }), 'error');
                                                    }).addPayment(paymentData, bookingType);
                                                }

                                                function confirmDeletePayment(paymentId, reservationId, bookingType, amountStr, dateStr) {
                                                    if (confirm(_t('payments_confirm_delete', {
                                                        amount: amountStr, date: dateStr

                                                    }))) {
                                                        deletePaymentAction(paymentId, reservationId, bookingType);
                                                    }
                                                }

                                                function deletePaymentAction(paymentId, reservationId, bookingType) {
                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: response.message || "Payment deleted."
                                                            }), 'success');

                                                            if (bookingType === 'reservation') {
                                                                fetchReservations(() => {
                                                                    openPaymentModal(reservationId, bookingType);
                                                                }

                                                                    , "Post-Payment Delete Refresh");
                                                            }

                                                            else if (bookingType === 'travel') {
                                                                fetchDailyTravels(() => {
                                                                    openPaymentModal(reservationId, bookingType);
                                                                });
                                                            }
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error deleting payment: $ {
                                response.message || 'Unknown error'
                            }

                            `
                                                            }), 'error');
                                                        }

                                                    }).withFailureHandler(err => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to delete payment: $ {
                            err.message
                        }

                        `
                                                        }), 'error');
                                                    }).deletePayment(paymentId, reservationId, bookingType);
                                                }

                                                // --- Daily Travel Functions ---
                                                function fetchDailyTravels(callback, context = "Generic Fetch") {
                                                    console.log(`fetchDailyTravels: Called. Context: $ {
                    context
                }

                `);

                                                    // Check cache first
                                                    if (isCacheValid('travels') && ALL_DAILY_TRAVELS.length > 0) {
                                                        console.log(`fetchDailyTravels: Using cached data. Context: $ {
                        context
                    }

                    `);

                                                        if (document.getElementById('daily-travels-view') && !document.getElementById('daily-travels-view').classList.contains('hidden')) {
                                                            renderDailyTravelsTable();
                                                        }

                                                        if (typeof callback === 'function') callback();
                                                        return;
                                                    }

                                                    showLoading(true, "notifications.loading", {
                                                        item: _t('nav.dailyTravels.bookings')
                                                    });

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        console.log(`fetchDailyTravels ($ {
                            context
                        }): SUCCESS.`);

                                                        if (response && response.success) {
                                                            ALL_DAILY_TRAVELS = response.travels || [];
                                                            ALL_DAILY_TRAVELS.sort((a, b) => new Date(b.travelDate) - new Date(a.travelDate));
                                                            updateCacheTimestamp('travels'); // Update cache timestamp
                                                        }

                                                        else {
                                                            const errorMessage = response ? response.error : 'Invalid data structure or null response from server.';

                                                            showNotification(_t('notifications.error', {
                                                                message: `Error fetching daily travels: $ {
                                errorMessage
                            }

                            `
                                                            }), 'error');
                                                            ALL_DAILY_TRAVELS = [];
                                                        }

                                                        if (document.getElementById('daily-travels-view') && !document.getElementById('daily-travels-view').classList.contains('hidden')) {
                                                            renderDailyTravelsTable();
                                                        }

                                                        if (typeof callback === 'function') callback();

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to fetch daily travels: $ {
                            error.message
                        }

                        `
                                                        }), 'error');
                                                        ALL_DAILY_TRAVELS = [];

                                                        if (document.getElementById('daily-travels-view') && !document.getElementById('daily-travels-view').classList.contains('hidden')) {
                                                            renderDailyTravelsTable();
                                                        }

                                                        if (typeof callback === 'function') callback();
                                                    }).getDailyTravels();
                                                }

                                                function renderDailyTravelsTable() {
                                                    const tableBody = document.getElementById('dailyTravelsTableBody');
                                                    if (!tableBody) return;
                                                    tableBody.innerHTML = '';

                                                    const searchTerm = document.getElementById('travelSearch')?.value?.toLowerCase() || '';

                                                    const filteredTravels = ALL_DAILY_TRAVELS.filter(t => {
                                                        const searchString = `$ {
                        t.clientName || ''
                    }

                    $ {
                        t.tripName || ''
                    }

                    `.toLowerCase();
                                                        return searchString.includes(searchTerm);
                                                    });

                                                    const startIndex = (CURRENT_TRAVELS_PAGE - 1) * TRAVELS_PER_PAGE;
                                                    const paginatedTravels = filteredTravels.slice(startIndex, startIndex + TRAVELS_PER_PAGE);

                                                    if (paginatedTravels.length === 0) {
                                                        const messageKey = ALL_DAILY_TRAVELS.length > 0 ? 'dailyTravels.list.noMatch' : 'dailyTravels.list.noTravels';

                                                        tableBody.innerHTML = `<tr><td colspan="8" class="text-center py-4 text-gray-500" >$ {
                    _t(messageKey)
                }

                </td></tr>`;
                                                    }

                                                    else {
                                                        paginatedTravels.forEach(t => {
                                                            const row = tableBody.insertRow();
                                                            row.className = "hover:bg-gray-50 transition-colors";
                                                            const travelDateDisplay = t.travelDate ? new Date(t.travelDate.replace(/-/g, '/')).toLocaleDateString(currentLanguage === 'pt' ? 'pt-PT' : 'en-GB') : 'N/A';
                                                            const peopleCount = (parseInt(t.adults) || 0) + (parseInt(t.kids) || 0) + (parseInt(t.seniors) || 0);

                                                            let statusClass = 'bg-gray-100 text-gray-800';
                                                            const sLower = String(t.status || '').toLowerCase();
                                                            if (sLower === 'confirmed') statusClass = 'bg-green-100 text-green-800';
                                                            else if (sLower === 'cancelled') statusClass = 'bg-red-100 text-red-800 line-through';

                                                            row.innerHTML = ` <td class="px-4 py-3 text-sm" >$ {
                            t.clientName || 'N/A'
                        }

                        </td> <td class="px-4 py-3 text-sm" >$ {
                            travelDateDisplay
                        }

                        $ {
                            t.travelTime || ''
                        }

                        </td> <td class="px-4 py-3 text-sm" >$ {
                            t.tripName || 'N/A'
                        }

                        </td> <td class="px-4 py-3 text-sm text-center" >$ {
                            peopleCount
                        }

                        </td> <td class="px-4 py-3 text-sm" >€$ {
                            (t.totalCost || 0).toFixed(2)
                        }

                        </td> <td class="px-4 py-3 text-sm ${t.amountDue > 0 ? 'text-red-600 font-semibold' : ''}" >€$ {
                            (t.amountDue || 0).toFixed(2)
                        }

                        </td> <td class="px-4 py-3 text-sm" ><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}" >$ {
                            t.status || 'N/A'
                        }

                        </span></td> <td class="px-4 py-3 text-sm space-x-1" > <button onclick="showTravelDetailsModal('${t.travelId}')" class="text-indigo-600 hover:text-indigo-900 p-1" title="${_t('viewReservations.actions.viewTitle')}" ><i data-lucide="eye" class="h-4 w-4" ></i></button> <button onclick="openTravelBookingForEdit('${t.travelId}')" class="text-yellow-600 hover:text-yellow-900 p-1" title="${_t('viewReservations.actions.editTitle')}" ><i data-lucide="edit-2" class="h-4 w-4" ></i></button> <button onclick="openPaymentModal('${t.travelId}', 'travel')" class="text-green-600 hover:text-green-900 p-1" title="${_t('buttons.managePayments')}" ><i data-lucide="credit-card" class="h-4 w-4" ></i></button> <button onclick="displayTravelInvoice('${t.travelId}')" class="text-blue-600 hover:text-blue-900 p-1" title="${_t('viewReservations.actions.invoiceTitle')}" ><i data-lucide="file-text" class="h-4 w-4" ></i></button> <button onclick="confirmDeleteTravel('${t.travelId}')" class="text-red-600 hover:text-red-900 p-1" title="${_t('viewReservations.actions.deleteTitle')}" ><i data-lucide="trash-2" class="h-4 w-4" ></i></button> </td>`;
                                                        });
                                                    }

                                                    renderTravelsPaginationControls(filteredTravels.length);
                                                    if (lucide) lucide.createIcons();
                                                }

                                                document.getElementById('travelSearch')?.addEventListener('input', () => {
                                                    CURRENT_TRAVELS_PAGE = 1;
                                                    renderDailyTravelsTable();
                                                });

                                                function renderTravelsPaginationControls(totalItems) {
                                                    const paginationContainer = document.getElementById('travelsPaginationControls');
                                                    if (!paginationContainer) return;
                                                    paginationContainer.innerHTML = '';
                                                    const totalPages = Math.ceil(totalItems / TRAVELS_PER_PAGE);
                                                    if (totalPages <= 1) return;

                                                    const createBtn = (html, clickFn, dis) => {
                                                        const b = document.createElement('button'); b.innerHTML = html; b.onclick = clickFn; b.disabled = dis; b.className = "p-2 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"; return b;
                                                    }

                                                        ;

                                                    paginationContainer.appendChild(createBtn('<i data-lucide="chevron-left" class="h-5 w-5"></i>', () => {
                                                        if (CURRENT_TRAVELS_PAGE > 1) {
                                                            CURRENT_TRAVELS_PAGE--; renderDailyTravelsTable();
                                                        }
                                                    }

                                                        , CURRENT_TRAVELS_PAGE === 1));
                                                    const pageInfo = document.createElement('span'); pageInfo.className = "text-sm text-gray-700 px-2";

                                                    pageInfo.textContent = _t('pagination.pageOf', {
                                                        currentPage: CURRENT_TRAVELS_PAGE, totalPages: totalPages
                                                    });
                                                    paginationContainer.appendChild(pageInfo);

                                                    paginationContainer.appendChild(createBtn('<i data-lucide="chevron-right" class="h-5 w-5"></i>', () => {
                                                        if (CURRENT_TRAVELS_PAGE < totalPages) {
                                                            CURRENT_TRAVELS_PAGE++; renderDailyTravelsTable();
                                                        }
                                                    }

                                                        , CURRENT_TRAVELS_PAGE === totalPages));
                                                    if (lucide) lucide.createIcons();
                                                }

                                                function getSelectedFoodOptions() {
                                                    const options = {}

                                                        ;

                                                    document.querySelectorAll('#travelFoodOptionsContainer input[type="number"]').forEach(input => {
                                                        const quantity = parseInt(input.value);

                                                        if (quantity > 0) {
                                                            options[input.dataset.name] = {
                                                                quantity: quantity
                                                            }

                                                                ;
                                                        }
                                                    });
                                                    return options;
                                                }

                                                function calculateTravelPriceClient() {
                                                    const params = {
                                                        tripName: document.getElementById('travelTripName').value,
                                                        adults: document.getElementById('travelAdults').value,
                                                        kids: document.getElementById('travelKids').value,
                                                        seniors: document.getElementById('travelSeniors').value,
                                                        selectedFoodOptions: JSON.stringify(getSelectedFoodOptions()),
                                                        discountPercentage: document.getElementById('travelDiscountPercentage').value,
                                                        taxPercentage: document.getElementById('travelTaxPercentage').value
                                                    }

                                                        ;

                                                    if (!params.tripName) {
                                                        populateTravelPriceSummary({}); // Clear summary if no trip is selected
                                                        return;
                                                    }

                                                    google.script.run.withSuccessHandler(response => {
                                                        if (response.success) {
                                                            populateTravelPriceSummary(response);
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: response.error
                                                            }), 'error');

                                                            populateTravelPriceSummary({});
                                                        }

                                                    }).withFailureHandler(err => {
                                                        showNotification(_t('notifications.failed', {
                                                            message: `Price calculation failed: $ {
                            err.message
                        }

                        `
                                                        }), 'error');

                                                        populateTravelPriceSummary({});
                                                    }).calculateTravelPrice(params);
                                                }

                                                function populateTravelPriceSummary(data = {}) {
                                                    document.getElementById('summaryTravelTripBaseCost').textContent = (data.tripBaseCost || 0).toFixed(2);
                                                    document.getElementById('summaryTravelFoodCost').textContent = (data.foodCost || 0).toFixed(2);
                                                    document.getElementById('summaryTravelSubtotal').textContent = (data.subtotal || 0).toFixed(2);
                                                    document.getElementById('summaryTravelDiscountAmount').textContent = (data.discountAmount || 0).toFixed(2);
                                                    document.getElementById('summaryTravelTaxAmount').textContent = (data.taxAmount || 0).toFixed(2);
                                                    document.getElementById('summaryTravelTotalCost').textContent = (data.totalCost || 0).toFixed(2);
                                                }

                                                document.querySelectorAll('.travel-calc-trigger').forEach(input => {
                                                    input.addEventListener('change', calculateTravelPriceClient);
                                                    input.addEventListener('keyup', calculateTravelPriceClient);
                                                });
                                                document.getElementById('travelFoodOptionsContainer')?.addEventListener('change', calculateTravelPriceClient);


                                                document.getElementById('dailyTravelForm')?.addEventListener('submit', function (event) {
                                                    event.preventDefault();
                                                    handleSaveOrUpdateTravel();
                                                });

                                                function confirmDeleteTravel(travelId) {
                                                    const travel = ALL_DAILY_TRAVELS.find(t => t.travelId === travelId);

                                                    if (!travel) {
                                                        showNotification('Travel booking not found', 'error');
                                                        return;
                                                    }

                                                    const peopleCount = (parseInt(travel.adults) || 0) + (parseInt(travel.kids) || 0) + (parseInt(travel.seniors) || 0);

                                                    const details = [];

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="user" class="h-4 w-4" ></i><strong>Client:</strong> <span class="ml-auto" >$ {
                    travel.clientName
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="sailboat" class="h-4 w-4" ></i><strong>Trip:</strong> <span class="ml-auto" >$ {
                    travel.tripName
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="calendar" class="h-4 w-4" ></i><strong>Date:</strong> <span class="ml-auto" >$ {
                    travel.travelDate
                }

                at $ {
                    travel.travelTime
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="users" class="h-4 w-4" ></i><strong>Passengers:</strong> <span class="ml-auto" >$ {
                    peopleCount
                }

                ($ {
                        travel.adults || 0
                    }

                    A, $ {
                        travel.kids || 0
                    }

                    K, $ {
                        travel.seniors || 0
                    }

                    S)</span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="euro" class="h-4 w-4" ></i><strong>Total Cost:</strong> <span class="ml-auto font-bold" >€$ {
                    (parseFloat(travel.totalCost) || 0).toFixed(2)
                }

                </span></div>`);

                                                    if (travel.totalPaid > 0) {
                                                        details.push(`<div class="flex items-center gap-2" ><i data-lucide="credit-card" class="h-4 w-4 text-green-500" ></i><strong>Paid:</strong> <span class="ml-auto text-green-600 font-bold" >€$ {
                        (parseFloat(travel.totalPaid) || 0).toFixed(2)
                    }

                    </span></div>`);
                                                    }

                                                    const warningMessage = travel.totalPaid > 0 ? `⚠️ This travel booking has a payment of €$ {
                (travel.totalPaid || 0).toFixed(2)
            }

            . Deletion will not process refunds.` : 'This action cannot be undone.';

                                                    showCustomConfirm({

                                                        title: 'Delete Travel Booking?',
                                                        message: `Are you sure you want to delete this travel booking for <strong>$ {
                    travel.clientName
                }

                </strong>?`,
                                                        details: details,
                                                        warning: warningMessage,
                                                        confirmText: 'Yes, Delete Booking',
                                                        confirmColor: 'red',
                                                        icon: 'danger',
                                                        onConfirm: () => {
                                                            deleteTravelAction(travelId);
                                                        }
                                                    });

                                                    setTimeout(() => {
                                                        if (lucide) lucide.createIcons();
                                                    }

                                                        , 100);
                                                }

                                                function deleteTravelAction(travelId) {
                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: 'Travel booking deleted successfully.'
                                                            }), 'success');
                                                            invalidateCache('travels'); // ✅ ADD THIS LINE
                                                            invalidateCache('dashboard'); // ✅ ADD THIS LINE
                                                            fetchDailyTravels();
                                                            if (travelCalendar) travelCalendar.refetchEvents();
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error deleting travel booking: $ {
                                response.message
                            }

                            `
                                                            }), 'error');
                                                        }

                                                    }).withFailureHandler(err => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to delete travel booking: $ {
                            err.message
                        }

                        `
                                                        }), 'error');
                                                    }).deleteTravel(travelId);
                                                }

                                                function initializeTravelCalendar() {
                                                    const calendarEl = document.getElementById('travelCalendar');
                                                    if (!calendarEl) return;

                                                    if (travelCalendar) {
                                                        travelCalendar.refetchEvents();
                                                        return;
                                                    }

                                                    travelCalendar = new FullCalendar.Calendar(calendarEl, {

                                                        initialView: 'dayGridMonth',
                                                        locale: currentLanguage,
                                                        headerToolbar: {
                                                            left: 'prev,next today',
                                                            center: 'title',
                                                            right: 'dayGridMonth,timeGridWeek,listWeek'
                                                        }

                                                        ,
                                                        events: function (fetchInfo, successCallback, failureCallback) {
                                                            google.script.run.withSuccessHandler(response => {
                                                                if (response.success) {
                                                                    const events = response.travels.map(t => {
                                                                        let foodCost = parseFloat(t.foodCost) || 0;

                                                                        return {

                                                                            id: t.travelId,
                                                                            title: `$ {
                                                t.clientName
                                            }

                                            ($ {
                                                    t.tripName

                                                })`,
                                                                            start: `$ {
                                                t.travelDate
                                            }

                                            T$ {
                                                t.travelTime
                                            }

                                            `,
                                                                            color: foodCost > 0 ? '#10b981' : '#3b82f6',
                                                                            extendedProps: t
                                                                        }

                                                                            ;
                                                                    });
                                                                    successCallback(events);
                                                                }

                                                                else {
                                                                    failureCallback(new Error(response.error));
                                                                }
                                                            }).withFailureHandler(failureCallback).getDailyTravels();
                                                        }

                                                        ,
                                                        eventClick: function (info) {
                                                            showTravelDetailsModal(info.event.id);
                                                        }
                                                    });
                                                    travelCalendar.render();
                                                }

                                                function populateTripSelect() {
                                                    const select = document.getElementById('travelTripName');
                                                    if (!select) return;
                                                    const currentValue = select.value;

                                                    select.innerHTML = `<option value="" >$ {
                _t('dailyTravels.form.loadingTrips')
            }

            </option>`;

                                                    if (ALL_DAILY_TRIP_OPTIONS && ALL_DAILY_TRIP_OPTIONS.length > 0) {
                                                        ALL_DAILY_TRIP_OPTIONS.forEach(trip => {
                                                            const option = document.createElement('option');
                                                            option.value = trip.tripName;

                                                            option.textContent = `$ {
                            trip.tripName
                        }

                        ($ {
                                trip.duration
                            }

                            h)`;
                                                            select.appendChild(option);
                                                        });
                                                        select.value = currentValue;
                                                    }
                                                }

                                                function populateFoodOptions(selectedFood = {}) {
                                                    const container = document.getElementById('travelFoodOptionsContainer');
                                                    if (!container) return;
                                                    container.innerHTML = '';

                                                    if (ALL_FOOD_OPTIONS && ALL_FOOD_OPTIONS.length > 0) {
                                                        ALL_FOOD_OPTIONS.forEach(food => {
                                                            const quantity = selectedFood[food.optionName]?.quantity || 0;
                                                            const div = document.createElement('div');
                                                            div.classList.add('flex', 'items-center', 'justify-between', 'py-1');

                                                            div.innerHTML = `<label for="food_${food.optionName.replace(/\s+/g, '_')}" class="text-sm text-gray-700" title="${food.description}" >$ {
                            food.optionName
                        }

                        (€$ {
                                food.price.toFixed(2)
                            })</label><input type="number" id="food_${food.optionName.replace(/\s+/g, '_')}" data-price="${food.price}" data-name="${food.optionName}" min="0" value="${quantity}" class="w-20 px-2 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-indigo-500 focus:border-indigo-500 travel-calc-trigger" >`;
                                                            container.appendChild(div);
                                                        });
                                                    }

                                                    else {
                                                        container.innerHTML = `<p class="text-sm text-gray-500" >$ {
                    _t('dailyTravels.form.loadingFood')
                }

                </p>`;
                                                    }
                                                }

                                                async function displayTravelInvoice(travelId) {
                                                    const travelDetails = ALL_DAILY_TRAVELS.find(t => t.travelId === travelId);

                                                    if (!travelDetails) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Travel booking not found for invoice."
                                                        }), "error");
                                                        return;
                                                    }

                                                    currentTravelInvoiceDetailsForPdf = {
                                                        ...travelDetails
                                                    }

                                                        ;

                                                    document.getElementById('travelInvoiceIdDisplay').textContent = travelDetails.travelId;
                                                    document.getElementById('travelInvoiceDateIssuedDisplay').textContent = new Date().toLocaleDateString(currentLanguage === 'pt' ? 'pt-PT' : 'en-GB');
                                                    document.getElementById('travelInvoiceClientNameDisplay').textContent = travelDetails.clientName;

                                                    document.getElementById('travelInvoiceDateTimeDisplay').textContent = `$ {
            travelDetails.travelDate
        }

        at $ {
            travelDetails.travelTime
        }

        `;

                                                    const itemsBody = document.getElementById('travelInvoiceItemsBodyDisplay');
                                                    itemsBody.innerHTML = '';

                                                    itemsBody.insertRow().innerHTML = `<td>Trip: $ {
            travelDetails.tripName
        }

        </td><td class="text-right" >€$ {
            (parseFloat(travelDetails.tripBaseCost) || 0).toFixed(2)
        }

        </td>`;

                                                    itemsBody.insertRow().innerHTML = `<td>Food Options</td><td class="text-right" >€$ {
            (parseFloat(travelDetails.foodCost) || 0).toFixed(2)
        }

        </td>`;

                                                    document.getElementById('travelInvoiceSubtotalDisplay').textContent = `€$ {
            (parseFloat(travelDetails.subtotal) || 0).toFixed(2)
        }

        `;

                                                    const discountLine = document.getElementById('travelInvoiceDiscountLine');

                                                    if (travelDetails.discountAmount > 0) {
                                                        discountLine.style.display = 'flex';

                                                        document.getElementById('travelInvoiceDiscountAmountDisplay').textContent = `-€$ {
                (parseFloat(travelDetails.discountAmount) || 0).toFixed(2)
            }

            ($ {
                    travelDetails.discountPercentage
                }

                %)`;
                                                    }

                                                    else {
                                                        discountLine.style.display = 'none';
                                                    }

                                                    const taxLine = document.getElementById('travelInvoiceTaxLine');

                                                    if (travelDetails.taxAmount > 0) {
                                                        taxLine.style.display = 'flex';

                                                        document.getElementById('travelInvoiceTaxAmountDisplay').textContent = `€$ {
                (parseFloat(travelDetails.taxAmount) || 0).toFixed(2)
            }

            ($ {
                    travelDetails.taxPercentage
                }

                %)`;
                                                    }

                                                    else {
                                                        taxLine.style.display = 'none';
                                                    }

                                                    document.getElementById('travelInvoiceTotalCostDisplay').textContent = `€$ {
            (parseFloat(travelDetails.totalCost) || 0).toFixed(2)
        }

        `;

                                                    document.getElementById('travelInvoiceTotalPaidDisplay').textContent = `€$ {
            (parseFloat(travelDetails.totalPaid) || 0).toFixed(2)
        }

        `;

                                                    document.getElementById('travelInvoiceGrandTotalDisplay').textContent = `€$ {
            (parseFloat(travelDetails.amountDue) || 0).toFixed(2)
        }

        `;
                                                    document.getElementById('travelInvoiceGrandTotalDisplay').className = (travelDetails.amountDue > 0) ? 'amount-due' : 'grand-total text-green-600';

                                                    openModal('travelInvoiceModal');
                                                }

                                                // --- NEW/UPDATED Travel Booking Functions ---
                                                function resetTravelForm() {
                                                    const form = document.getElementById('dailyTravelForm');
                                                    if (!form) return;
                                                    form.reset();
                                                    document.getElementById('travelFormMode').value = 'add';
                                                    document.getElementById('originalTravelId').value = '';

                                                    const titleEl = document.getElementById('dailyTravelFormTitle');

                                                    if (titleEl) {
                                                        titleEl.innerHTML = `<i data-lucide="map" class="h-5 w-5 text-blue-600" ></i> <span data-translate-key="dailyTravels.form.titleNew" >$ {
                    _t('dailyTravels.form.titleNew')
                }

                </span>`;
                                                        if (lucide) lucide.createIcons();
                                                    }

                                                    const submitBtnSpan = document.querySelector('#dailyTravelFormSubmitBtn span');
                                                    if (submitBtnSpan) submitBtnSpan.textContent = _t('dailyTravels.form.saveBtn');

                                                    document.getElementById('travelDate').value = new Date().toISOString().split('T')[0];
                                                    populateFoodOptions();
                                                    calculateTravelPriceClient();
                                                }


                                                /**
                                                 * Toggles the visibility of the new travel booking form.
                                                 */
                                                function toggleTravelForm() {
                                                    const container = document.getElementById('dailyTravelFormContainer');
                                                    const buttonSpan = document.querySelector('#toggleTravelFormBtn span');
                                                    const buttonIcon = document.querySelector('#toggleTravelFormBtn i');

                                                    if (!container || !buttonSpan || !buttonIcon) {
                                                        console.error("Could not find travel form container or button elements.");
                                                        return;
                                                    }

                                                    const isHidden = container.classList.contains('hidden');

                                                    if (isHidden) {
                                                        // Form is hidden, so we are opening it for a NEW booking.
                                                        resetTravelForm();
                                                        container.classList.remove('hidden');
                                                        buttonSpan.textContent = _t('dailyTravels.form.cancelBtn');
                                                        buttonIcon.setAttribute('data-lucide', 'x-circle');

                                                        container.scrollIntoView({
                                                            behavior: 'smooth'
                                                        });
                                                    }

                                                    else {
                                                        // Form is currently visible, so the user is closing/cancelling it.
                                                        container.classList.add('hidden');
                                                        buttonSpan.textContent = _t('dailyTravels.form.addNewBtn');
                                                        buttonIcon.setAttribute('data-lucide', 'plus-circle');
                                                    }

                                                    if (lucide) lucide.createIcons();
                                                }


                                                function openTravelBookingForEdit(travelId) {
                                                    const travel = ALL_DAILY_TRAVELS.find(t => t.travelId === travelId);

                                                    if (!travel) {
                                                        showNotification('Travel booking not found for editing.', 'error');
                                                        return;
                                                    }

                                                    // Make sure form is visible and button is in 'cancel' state
                                                    const container = document.getElementById('dailyTravelFormContainer');
                                                    if (container) container.classList.remove('hidden');
                                                    const buttonSpan = document.querySelector('#toggleTravelFormBtn span');
                                                    const buttonIcon = document.querySelector('#toggleTravelFormBtn i');
                                                    if (buttonSpan) buttonSpan.textContent = _t('dailyTravels.form.cancelBtn');
                                                    if (buttonIcon) buttonIcon.setAttribute('data-lucide', 'x-circle');

                                                    const form = document.getElementById('dailyTravelForm');

                                                    document.getElementById('travelFormMode').value = 'edit';
                                                    document.getElementById('originalTravelId').value = travel.travelId;
                                                    document.getElementById('dailyTravelFormTitle').innerHTML = '<i data-lucide="edit" class="h-5 w-5 text-blue-600"></i><span>Edit Travel Booking</span>';
                                                    document.querySelector('#dailyTravelFormSubmitBtn span').textContent = 'Update Booking';

                                                    form.elements.clientName.value = travel.clientName || '';
                                                    form.elements.clientPhone.value = travel.clientPhone || '';
                                                    form.elements.clientEmail.value = travel.clientEmail || '';
                                                    form.elements.travelDate.value = travel.travelDate || '';
                                                    form.elements.travelTime.value = travel.travelTime || '';
                                                    form.elements.tripName.value = travel.tripName || '';
                                                    form.elements.adults.value = travel.adults || 0;
                                                    form.elements.kids.value = travel.kids || 0;
                                                    form.elements.seniors.value = travel.seniors || 0;
                                                    form.elements.discountPercentage.value = travel.discountPercentage || 0;
                                                    form.elements.taxPercentage.value = travel.taxPercentage || 0;
                                                    form.elements.notes.value = travel.notes || '';

                                                    let foodOptions = {}

                                                        ;

                                                    try {
                                                        foodOptions = JSON.parse(travel.foodOptions || '{}');
                                                    }

                                                    catch (e) { }

                                                    populateFoodOptions(foodOptions);

                                                    calculateTravelPriceClient();

                                                    // Scroll to form
                                                    form.scrollIntoView({
                                                        behavior: 'smooth', block: 'start'
                                                    });

                                                    if (lucide) lucide.createIcons();
                                                }




                                                function handleSaveOrUpdateTravel() {
                                                    const form = document.getElementById('dailyTravelForm');
                                                    const mode = form.elements.travelFormMode.value;

                                                    const details = {
                                                        clientName: form.elements.clientName.value,
                                                        clientPhone: form.elements.clientPhone.value,
                                                        clientEmail: form.elements.clientEmail.value,
                                                        travelDate: form.elements.travelDate.value,
                                                        travelTime: form.elements.travelTime.value,
                                                        tripName: form.elements.tripName.value,
                                                        adults: form.elements.adults.value,
                                                        kids: form.elements.kids.value,
                                                        seniors: form.elements.seniors.value,
                                                        foodOptions: JSON.stringify(getSelectedFoodOptions()),
                                                        discountPercentage: form.elements.discountPercentage.value,
                                                        taxPercentage: form.elements.taxPercentage.value,
                                                        notes: form.elements.notes.value,
                                                        status: 'Confirmed'
                                                    }

                                                        ;

                                                    if (!details.clientName || !details.travelDate || !details.travelTime || !details.tripName) {
                                                        showNotification(_t('notifications.error', {
                                                            message: 'Client Name, Travel Date, Time, and Trip are required.'
                                                        }), 'error');
                                                        return;
                                                    }

                                                    showLoading(true, 'notifications.processing');

                                                    const successHandler = (response) => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(_t('notifications.success', {
                                                                message: `Travel booking $ {
                            mode==='add' ? _t('status.Saved') : _t('status.Updated')
                        }

                        successfully.`
                                                            }), 'success');
                                                            invalidateCache('travels'); // ✅ ADD THIS LINE
                                                            invalidateCache('dashboard'); // ✅ ADD THIS LINE
                                                            resetTravelForm();
                                                            fetchDailyTravels();
                                                            if (travelCalendar) travelCalendar.refetchEvents();
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: response.message
                                                            }), 'error');
                                                        }
                                                    }

                                                        ;

                                                    const failureHandler = (err) => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to $ {
                        mode
                    }

                    travel booking: $ {
                        err.message
                    }

                    `
                                                        }), 'error');
                                                    }

                                                        ;

                                                    if (mode === 'add') {
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).saveTravel(details);
                                                    }

                                                    else {
                                                        const travelId = form.elements.originalTravelId.value;
                                                        google.script.run.withSuccessHandler(successHandler).withFailureHandler(failureHandler).editTravel(travelId, details);
                                                    }
                                                }

                                                function showTravelDetailsModal(travelId) {
                                                    const travel = ALL_DAILY_TRAVELS.find(t => t.travelId === travelId);

                                                    if (!travel) {
                                                        showNotification(_t('notifications.error', {
                                                            message: "Travel booking not found."
                                                        }), "error");
                                                        return;
                                                    }

                                                    const modalBody = document.getElementById('travelModalBody');
                                                    const modalTitle = document.getElementById('travelModalTitle');

                                                    if (modalTitle) modalTitle.textContent = `$ {
            _t('dailyTravels.details.title')
        }

        : $ {
            travelId
        }

        `;

                                                    let detailsHtml = `<dl class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-3" >`;
                                                    const peopleCount = (parseInt(travel.adults) || 0) + (parseInt(travel.kids) || 0) + (parseInt(travel.seniors) || 0);

                                                    const fieldsToShow = {

                                                        [_t('viewReservations.table.client')]: travel.clientName,
                                                        [_t('dailyTravels.list.date')]: `$ {
                travel.travelDate
            }

            @ $ {
                travel.travelTime
            }

            `,
                                                        [_t('dailyTravels.list.tripName')]: travel.tripName,
                                                        [_t('dailyTravels.form.passengers')]: `$ {
                peopleCount
            }

            ($ {
                    travel.adults || 0
                }

                A, $ {
                    travel.kids || 0
                }

                K, $ {
                    travel.seniors || 0
                }

                S)`,
                                                        [_t('newReservation.summaryTotalCost')]: `<strong>€$ {
                (parseFloat(travel.totalCost) || 0).toFixed(2)
            }

            </strong>`,
                                                        [_t('payments_total_paid')]: `<span class="text-green-600" >€$ {
                (parseFloat(travel.totalPaid) || 0).toFixed(2)
            }

            </span>`,
                                                        [_t('payments_amount_due')]: `<strong class="${(travel.amountDue || 0) > 0 ? 'text-red-600' : 'text-gray-700'}" >€$ {
                (parseFloat(travel.amountDue) || 0).toFixed(2)
            }

            </strong>`,
                                                        [_t('newReservation.notesLabel')]: travel.notes || 'N/A'
                                                    }

                                                        ;

                                                    for (const [label, value] of Object.entries(fieldsToShow)) {
                                                        if (value !== undefined && value !== null) {
                                                            detailsHtml += `<div class="col-span-1 border-b pb-1" ><dt class="font-medium text-gray-500" >$ {
                    label
                }

                :</dt><dd class="text-gray-900 mt-1" >$ {
                    value
                }

                </dd></div>`;
                                                        }
                                                    }

                                                    detailsHtml += `</dl>`;

                                                    if (modalBody) modalBody.innerHTML = detailsHtml;
                                                    openModal('travelDetailsModal');
                                                }

                                                function fetchRestaurantData(callback) {
                                                    console.log("fetchRestaurantData: Called.");

                                                    showLoading(true, "notifications.loading", {
                                                        item: _t('nav.restaurant')
                                                    });

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response && response.success) {
                                                            ALL_RESTAURANT_RESERVATIONS = response.reservations || [];
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: `Error fetching restaurant data: $ {
                                response.error
                            }

                            `
                                                            }), 'error');
                                                            ALL_RESTAURANT_RESERVATIONS = [];
                                                        }

                                                        renderRestaurantTable();
                                                        initializeRestaurantCalendar();
                                                        if (typeof callback === 'function') callback();

                                                    }).withFailureHandler(err => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to fetch restaurant data: $ {
                            err.message
                        }

                        `
                                                        }), 'error');
                                                        ALL_RESTAURANT_RESERVATIONS = [];
                                                        renderRestaurantTable();
                                                    }).getRestaurantReservations();
                                                }

                                                function renderRestaurantTable() {
                                                    const tableBody = document.getElementById('restaurantTableBody');
                                                    if (!tableBody) return;
                                                    tableBody.innerHTML = '';

                                                    const searchTerm = document.getElementById('restaurantSearch').value.toLowerCase();
                                                    const filtered = ALL_RESTAURANT_RESERVATIONS.filter(r => String(r.clientName || '').toLowerCase().includes(searchTerm) || String(r.clientPhone || '').toLowerCase().includes(searchTerm));

                                                    filtered.sort((a, b) => new Date(b.reservationDate) - new Date(a.reservationDate));

                                                    const startIndex = (CURRENT_RESTAURANT_PAGE - 1) * RESTAURANT_PER_PAGE;
                                                    const paginated = filtered.slice(startIndex, startIndex + RESTAURANT_PER_PAGE);

                                                    if (paginated.length === 0) {
                                                        const msgKey = ALL_RESTAURANT_RESERVATIONS.length > 0 ? 'restaurant.table.noMatch' : 'restaurant.table.noReservations';

                                                        tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500" >$ {
                    _t(msgKey)
                }

                </td></tr>`;
                                                    }

                                                    else {
                                                        paginated.forEach(r => {
                                                            const row = tableBody.insertRow();
                                                            row.className = "hover:bg-gray-50 transition-colors";
                                                            const dateDisplay = r.reservationDate ? new Date(r.reservationDate.replace(/-/g, '/')).toLocaleDateString(currentLanguage === 'pt' ? 'pt-PT' : 'en-GB') : 'N/A';

                                                            let statusClass = 'bg-gray-100 text-gray-800';
                                                            if ((r.status || '').toLowerCase() === 'confirmed') statusClass = 'bg-green-100 text-green-800';
                                                            else if ((r.status || '').toLowerCase() === 'cancelled') statusClass = 'bg-red-100 text-red-800';

                                                            row.innerHTML = ` <td class="px-4 py-3 text-sm" >$ {
                            r.clientName
                        }

                        <div class="text-xs text-gray-500" >$ {
                            r.clientPhone
                        }

                        </div></td> <td class="px-4 py-3 text-sm" >$ {
                            dateDisplay
                        }

                        at $ {
                            r.reservationHour
                        }

                        </td> <td class="px-4 py-3 text-sm" >$ {
                            r.numPeople
                        }

                        </td> <td class="px-4 py-3 text-sm" ><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}" >$ {
                            r.status || 'N/A'
                        }

                        </span></td> <td class="px-4 py-3 text-sm space-x-1" > <button onclick="openRestaurantForm('edit', '${r.reservationId}')" class="text-yellow-600 hover:text-yellow-900 p-1" title="Edit" ><i data-lucide="edit-2" class="h-4 w-4" ></i></button> <button onclick="confirmDeleteRestaurantReservation('${r.reservationId}')" class="text-red-600 hover:text-red-900 p-1" title="Delete" ><i data-lucide="trash-2" class="h-4 w-4" ></i></button> </td> `;
                                                        });
                                                    }

                                                    renderRestaurantPagination(filtered.length);
                                                    if (lucide) lucide.createIcons();
                                                }

                                                function renderRestaurantPagination(totalItems) {
                                                    const container = document.getElementById('restaurantPaginationControls');
                                                    if (!container) return;
                                                    container.innerHTML = '';
                                                    const totalPages = Math.ceil(totalItems / RESTAURANT_PER_PAGE);
                                                    if (totalPages <= 1) return;

                                                    const createBtn = (html, clickFn, dis) => {
                                                        const b = document.createElement('button'); b.innerHTML = html; b.onclick = clickFn; b.disabled = dis; b.className = "p-2 rounded-md hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"; return b;
                                                    }

                                                        ;

                                                    container.appendChild(createBtn('<i data-lucide="chevron-left" class="h-5 w-5"></i>', () => {
                                                        if (CURRENT_RESTAURANT_PAGE > 1) {
                                                            CURRENT_RESTAURANT_PAGE--; renderRestaurantTable();
                                                        }
                                                    }

                                                        , CURRENT_RESTAURANT_PAGE === 1));
                                                    const pageInfo = document.createElement('span'); pageInfo.className = "text-sm text-gray-700 px-2";

                                                    pageInfo.textContent = _t('pagination.pageOf', {
                                                        currentPage: CURRENT_RESTAURANT_PAGE, totalPages: totalPages
                                                    });
                                                    container.appendChild(pageInfo);

                                                    container.appendChild(createBtn('<i data-lucide="chevron-right" class="h-5 w-5"></i>', () => {
                                                        if (CURRENT_RESTAURANT_PAGE < totalPages) {
                                                            CURRENT_RESTAURANT_PAGE++; renderRestaurantTable();
                                                        }
                                                    }

                                                        , CURRENT_RESTAURANT_PAGE === totalPages));
                                                    if (lucide) lucide.createIcons();
                                                }

                                                document.getElementById('restaurantSearch')?.addEventListener('input', () => {
                                                    CURRENT_RESTAURANT_PAGE = 1;
                                                    renderRestaurantTable();
                                                });

                                                function initializeRestaurantCalendar() {
                                                    const calendarEl = document.getElementById('restaurantCalendar');
                                                    if (!calendarEl) return;

                                                    if (restaurantCalendar) {
                                                        restaurantCalendar.refetchEvents();
                                                        return;
                                                    }

                                                    restaurantCalendar = new FullCalendar.Calendar(calendarEl, {

                                                        initialView: 'dayGridMonth',
                                                        locale: currentLanguage,
                                                        headerToolbar: {
                                                            left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek'
                                                        }

                                                        ,
                                                        events: (fetchInfo, successCallback, failureCallback) => {
                                                            const events = ALL_RESTAURANT_RESERVATIONS.map(r => ({

                                                                id: r.reservationId,
                                                                title: `$ {
                                r.clientName
                            }

                            (x$ {
                                    r.numPeople

                                })`,
                                                                start: `$ {
                                r.reservationDate
                            }

                            T$ {
                                r.reservationHour
                            }

                            `,
                                                                color: r.status === 'Cancelled' ? '#ef4444' : '#16a34a',
                                                                extendedProps: r
                                                            }));
                                                            successCallback(events);
                                                        }

                                                        ,
                                                        eventClick: (info) => {
                                                            openRestaurantForm('edit', info.event.id);
                                                        }
                                                    });
                                                    restaurantCalendar.render();
                                                }

                                                function toggleRestaurantForm(forceOpen = null) {
                                                    const container = document.getElementById('restaurantFormContainer');
                                                    const buttonSpan = document.querySelector('#toggleRestaurantFormBtn span');

                                                    // Find the immediate child div which acts as the content wrapper
                                                    const innerContent = container.querySelector('div');

                                                    // Safety check to ensure elements exist
                                                    if (!container || !innerContent) {
                                                        console.error("Restaurant form container or its inner content not found.");
                                                        return;
                                                    }

                                                    const isOpen = container.style.maxHeight !== '0px' && container.style.maxHeight !== '';
                                                    const shouldOpen = forceOpen !== null ? forceOpen : !isOpen;

                                                    if (shouldOpen) {
                                                        if (forceOpen === null) {
                                                            // if not a forced open (like for editing), it's a new entry, so reset
                                                            resetRestaurantForm();
                                                        }

                                                        // Set max-height to the scrollHeight of the inner content wrapper to account for padding/margins
                                                        container.style.maxHeight = innerContent.scrollHeight + "px";
                                                        if (buttonSpan) buttonSpan.textContent = _t('restaurant.form.cancelBtn');
                                                    }

                                                    else {
                                                        container.style.maxHeight = '0px';
                                                        if (buttonSpan) buttonSpan.textContent = _t('restaurant.form.addNewBtn');
                                                    }
                                                }

                                                function resetRestaurantForm() {
                                                    const form = document.getElementById('restaurantReservationForm');
                                                    form.reset();
                                                    document.getElementById('restaurantFormMode').value = 'add';
                                                    document.getElementById('originalRestaurantReservationId').value = '';
                                                    document.getElementById('restaurantFormTitle').textContent = _t('restaurant.form.titleNew');

                                                    document.getElementById('restaurantFormSubmitBtn').textContent = _t('buttons.saveReservation', {}

                                                        , 'Save Reservation');
                                                    document.getElementById('restaurantDate').value = new Date().toISOString().split('T')[0];
                                                }

                                                function openRestaurantForm(mode, reservationId = null) {
                                                    const form = document.getElementById('restaurantReservationForm');
                                                    resetRestaurantForm(); // Clear form first

                                                    if (mode === 'edit') {
                                                        const r = ALL_RESTAURANT_RESERVATIONS.find(res => res.reservationId === reservationId);

                                                        if (r) {
                                                            document.getElementById('restaurantFormMode').value = 'edit';
                                                            document.getElementById('originalRestaurantReservationId').value = r.reservationId;
                                                            document.getElementById('restaurantFormTitle').innerHTML = '<i data-lucide="edit" class="h-5 w-5 text-pink-600"></i><span>Edit Restaurant Reservation</span>';
                                                            document.getElementById('restaurantFormSubmitBtn').innerHTML = '<i data-lucide="save" class="h-4 w-4"></i>Update Reservation';

                                                            form.elements.clientName.value = r.clientName;
                                                            form.elements.clientPhone.value = r.clientPhone;
                                                            form.elements.clientEmail.value = r.clientEmail;
                                                            form.elements.numPeople.value = r.numPeople;
                                                            form.elements.reservationDate.value = r.reservationDate;
                                                            form.elements.reservationHour.value = r.reservationHour;
                                                            form.elements.notes.value = r.notes;

                                                            // Scroll to form
                                                            form.scrollIntoView({
                                                                behavior: 'smooth', block: 'start'
                                                            });
                                                        }
                                                    }

                                                    if (lucide) lucide.createIcons();
                                                }

                                                function confirmDeleteRestaurantReservation(id) {
                                                    const reservation = ALL_RESTAURANT_RESERVATIONS.find(r => r.reservationId === id);

                                                    if (!reservation) {
                                                        showNotification('Restaurant reservation not found', 'error');
                                                        return;
                                                    }

                                                    const details = [];

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="user" class="h-4 w-4" ></i><strong>Client:</strong> <span class="ml-auto" >$ {
                    reservation.clientName
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="phone" class="h-4 w-4" ></i><strong>Phone:</strong> <span class="ml-auto" >$ {
                    reservation.clientPhone || 'N/A'
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="calendar" class="h-4 w-4" ></i><strong>Date:</strong> <span class="ml-auto" >$ {
                    reservation.reservationDate
                }

                at $ {
                    reservation.reservationHour
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="users" class="h-4 w-4" ></i><strong>Party Size:</strong> <span class="ml-auto" >$ {
                    reservation.numPeople
                }

                people</span></div>`);

                                                    if (reservation.notes) {
                                                        details.push(`<div class="flex items-start gap-2" ><i data-lucide="sticky-note" class="h-4 w-4 mt-1" ></i><strong>Notes:</strong> <span class="ml-auto text-sm" >$ {
                        reservation.notes
                    }

                    </span></div>`);
                                                    }

                                                    showCustomConfirm({

                                                        title: 'Delete Restaurant Reservation?',
                                                        message: `Are you sure you want to delete the reservation for <strong>$ {
                    reservation.clientName
                }

                </strong>?`,
                                                        details: details,
                                                        warning: 'This action cannot be undone. Consider calling the client to confirm cancellation.',
                                                        confirmText: 'Yes, Delete Reservation',
                                                        confirmColor: 'red',
                                                        icon: 'danger',
                                                        onConfirm: () => {
                                                            showLoading(true);

                                                            google.script.run.withSuccessHandler(res => {
                                                                showLoading(false);

                                                                if (res.success) {
                                                                    showNotification('Reservation deleted.', 'success');
                                                                    invalidateCache('restaurant');
                                                                    fetchRestaurantData();
                                                                }

                                                                else {
                                                                    showNotification(`Error: $ {
                                        res.message
                                    }

                                    `, 'error');
                                                                }

                                                            }).withFailureHandler(err => {
                                                                showLoading(false);

                                                                showNotification(`Failed to delete: $ {
                                    err.message
                                }

                                `, 'error');
                                                            }).deleteRestaurantReservation(id);
                                                        }
                                                    });

                                                    setTimeout(() => {
                                                        if (lucide) lucide.createIcons();
                                                    }

                                                        , 100);
                                                }

                                                document.getElementById('generateRestaurantReportBtn')?.addEventListener('click', () => {
                                                    const startDate = document.getElementById('restaurantReportStartDate').value;
                                                    const endDate = document.getElementById('restaurantReportEndDate').value;

                                                    if (!startDate || !endDate) {
                                                        showNotification("Please select a start and end date for the report.", "error");
                                                        return;
                                                    }

                                                    generateAndDownloadPdf({
                                                        startDate, endDate
                                                    }

                                                        , 'restaurantReport');
                                                });

                                                // Event listeners for view switching
                                                document.getElementById('showRestaurantTableViewBtn')?.addEventListener('click', () => {
                                                    document.getElementById('restaurantTableView').classList.remove('hidden');
                                                    document.getElementById('restaurantCalendarView').classList.add('hidden');
                                                    document.getElementById('showRestaurantTableViewBtn').classList.add('bg-blue-600', 'text-white');
                                                    document.getElementById('showRestaurantTableViewBtn').classList.remove('bg-white', 'text-gray-900');
                                                    document.getElementById('showRestaurantCalendarViewBtn').classList.add('bg-white', 'text-gray-900');
                                                    document.getElementById('showRestaurantCalendarViewBtn').classList.remove('bg-blue-600', 'text-white');
                                                });

                                                document.getElementById('showRestaurantCalendarViewBtn')?.addEventListener('click', () => {
                                                    document.getElementById('restaurantTableView').classList.add('hidden');
                                                    document.getElementById('restaurantCalendarView').classList.remove('hidden');
                                                    document.getElementById('showRestaurantCalendarViewBtn').classList.add('bg-blue-600', 'text-white');
                                                    document.getElementById('showRestaurantCalendarViewBtn').classList.remove('bg-white', 'text-gray-900');
                                                    document.getElementById('showRestaurantTableViewBtn').classList.add('bg-white', 'text-gray-900');
                                                    document.getElementById('showRestaurantTableViewBtn').classList.remove('bg-blue-600', 'text-white');
                                                    if (restaurantCalendar) restaurantCalendar.render();
                                                });

                                                document.getElementById('restaurantReservationForm')?.addEventListener('submit', function (event) {
                                                    event.preventDefault();
                                                    const form = event.target;
                                                    const formData = new FormData(form);
                                                    const details = Object.fromEntries(formData.entries());
                                                    const mode = details.restaurantFormMode;
                                                    const idToUpdate = details.originalRestaurantReservationId;

                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(`Restaurant reservation $ {
                                    mode==='add' ? 'saved' : 'updated'
                                }

                                successfully !`, 'success');
                                                            invalidateCache('restaurant');
                                                            resetRestaurantForm();
                                                            fetchRestaurantData();
                                                        }

                                                        else {
                                                            showNotification(`Error: $ {
                                    response.message || 'Could not save reservation.'
                                }

                                `, 'error');
                                                        }

                                                    }).withFailureHandler(err => {
                                                        showLoading(false);

                                                        showNotification(`Failed to save reservation: $ {
                                err.message
                            }

                            `, 'error');
                                                    }).saveRestaurantReservation(details, mode === 'edit' ? idToUpdate : null);
                                                });


                                                // --- Initial Load ---
                                                document.addEventListener('DOMContentLoaded', () => {
                                                    setLanguage(currentLanguage);
                                                    if (lucide) lucide.createIcons();

                                                    // Toggle Extras Section
                                                    document.getElementById('toggleExtrasBtn')?.addEventListener('click', function () {
                                                        const extrasSection = document.getElementById('extrasSection');
                                                        const chevron = document.getElementById('extrasChevron');

                                                        if (extrasSection.classList.contains('expanded')) {
                                                            extrasSection.classList.remove('expanded');

                                                            setTimeout(() => {
                                                                extrasSection.classList.add('hidden');
                                                            }

                                                                , 400); // Wait for collapse animation
                                                            chevron.classList.remove('rotated');
                                                        }

                                                        else {
                                                            extrasSection.classList.remove('hidden');

                                                            setTimeout(() => {
                                                                extrasSection.classList.add('expanded');
                                                                chevron.classList.add('rotated');
                                                            }

                                                                , 10);
                                                        }

                                                        if (lucide) lucide.createIcons();
                                                    });


                                                    function setupContextMenuListeners() {
                                                        document.getElementById('contextMenuEdit')?.addEventListener('click', () => {
                                                            console.log('Context menu edit clicked. ID:', currentContextReservationId);

                                                            if (currentContextReservationId) {
                                                                hideReservationContextMenu();

                                                                showView('new-reservation', {
                                                                    mode: 'edit', reservationId: currentContextReservationId
                                                                });
                                                            }

                                                            else {
                                                                showNotification('Error: No reservation selected', 'error');
                                                            }
                                                        });

                                                        document.getElementById('contextMenuInvoice')?.addEventListener('click', () => {
                                                            console.log('Context menu invoice clicked. ID:', currentContextReservationId);

                                                            if (currentContextReservationId) {
                                                                hideReservationContextMenu();
                                                                displayInvoice(currentContextReservationId);
                                                            }

                                                            else {
                                                                showNotification('Error: No reservation selected', 'error');
                                                            }
                                                        });

                                                        document.getElementById('contextMenuPayments')?.addEventListener('click', () => {
                                                            console.log('Context menu payments clicked. ID:', currentContextReservationId);

                                                            if (currentContextReservationId) {
                                                                hideReservationContextMenu();
                                                                openPaymentModal(currentContextReservationId, 'reservation');
                                                            }

                                                            else {
                                                                showNotification('Error: No reservation selected', 'error');
                                                            }
                                                        });

                                                        document.getElementById('contextMenuCancel')?.addEventListener('click', () => {
                                                            console.log('Context menu cancel clicked. ID:', currentContextReservationId);

                                                            if (currentContextReservationId) {
                                                                hideReservationContextMenu();
                                                                confirmCancelReservation(currentContextReservationId);
                                                            }

                                                            else {
                                                                showNotification('Error: No reservation selected', 'error');
                                                            }
                                                        });

                                                        document.getElementById('contextMenuStaySheet')?.addEventListener('click', () => {
                                                            console.log('Context menu stay sheet clicked. ID:', currentContextReservationId);

                                                            if (currentContextReservationId) {
                                                                hideReservationContextMenu();
                                                                generateSingleStaySheet(currentContextReservationId);
                                                            }

                                                            else {
                                                                showNotification('Error: No reservation selected', 'error');
                                                            }
                                                        });
                                                    }

                                                    // Initialize sidebar collapse/expand
                                                    restoreSidebarState();
                                                    document.getElementById('sidebarToggleBtn')?.addEventListener('click', toggleSidebar);

                                                    // Initialize Global Search
                                                    const globalSearchInput = document.getElementById('globalSearchInput');
                                                    const globalSearchClear = document.getElementById('globalSearchClear');
                                                    const globalSearchResults = document.getElementById('globalSearchResults');

                                                    if (globalSearchInput) {

                                                        // Input event for real-time search
                                                        globalSearchInput.addEventListener('input', (e) => {
                                                            const searchTerm = e.target.value.trim();

                                                            // Show/hide clear button
                                                            if (searchTerm.length > 0) {
                                                                globalSearchClear.classList.add('visible');
                                                            }

                                                            else {
                                                                globalSearchClear.classList.remove('visible');
                                                                closeGlobalSearch();
                                                                return;
                                                            }

                                                            // Perform search
                                                            if (searchTerm.length >= 2) {
                                                                performGlobalSearch(searchTerm);
                                                            }

                                                            else {
                                                                globalSearchResults.innerHTML = '<div class="global-search-empty"><p>Type at least 2 characters to search...</p></div>';
                                                                globalSearchResults.classList.add('show');
                                                            }
                                                        });

                                                        // Focus event
                                                        globalSearchInput.addEventListener('focus', (e) => {
                                                            const searchTerm = e.target.value.trim();

                                                            if (searchTerm.length >= 2) {
                                                                performGlobalSearch(searchTerm);
                                                            }
                                                        });
                                                    }

                                                    if (globalSearchClear) {
                                                        globalSearchClear.addEventListener('click', () => {
                                                            globalSearchInput.value = '';
                                                            globalSearchClear.classList.remove('visible');
                                                            closeGlobalSearch();
                                                            globalSearchInput.focus();
                                                        });
                                                    }

                                                    // Close search results when clicking outside
                                                    document.addEventListener('click', (e) => {
                                                        if (!e.target.closest('.global-search-container')) {
                                                            closeGlobalSearch();
                                                        }
                                                    });

                                                    // Keyboard shortcuts for search
                                                    document.addEventListener('keydown', (e) => {

                                                        // Ctrl/Cmd + K to focus search
                                                        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                                                            e.preventDefault();
                                                            globalSearchInput?.focus();
                                                        }

                                                        // Escape to close search
                                                        if (e.key === 'Escape' && globalSearchResults?.classList.contains('show')) {
                                                            closeGlobalSearch();
                                                            globalSearchInput?.blur();
                                                        }
                                                    });

                                                    // Date initialization
                                                    const today = new Date().toISOString().split('T')[0];
                                                    const checkInDateEl = document.getElementById('checkInDate');
                                                    const checkOutDateEl = document.getElementById('checkOutDate');
                                                    if (checkInDateEl) checkInDateEl.setAttribute('min', today);
                                                    if (checkOutDateEl) checkOutDateEl.setAttribute('min', today);

                                                    checkInDateEl?.addEventListener('change', function () {
                                                        if (checkOutDateEl) {
                                                            checkOutDateEl.min = this.value;
                                                            if (checkOutDateEl.value < this.value) checkOutDateEl.value = this.value;
                                                        }
                                                    });
                                                    document.getElementById('paymentDate').value = today;
                                                    document.getElementById('travelDate').value = today;

                                                    views.forEach(id => {
                                                        let elId = `$ {
                        id
                    }

                    -view`;
                                                        const el = document.getElementById(elId);
                                                        if (el) el.classList.add('hidden');

                                                    });
                                                    document.getElementById('dashboard-view')?.classList.remove('hidden');
                                                    document.querySelector('.nav-link[onclick*="showView(\'dashboard\')"]')?.classList.add('active');

                                                    // ==========================================
                                                    // OPTIMIZED INITIAL LOAD - Single Round Trip
                                                    // ==========================================
                                                    showLoading(true, "notifications.processing");
                                                    console.log("DOMContentLoaded: Starting unified initial load...");

                                                    google.script.run.withSuccessHandler(response => {
                                                        console.log("DOMContentLoaded: getStartupData SUCCESS", response);
                                                        showLoading(false);

                                                        if (response && response.success) {
                                                            const {
                                                                appData, dashboardData, cacheVersion
                                                            }

                                                                = response;

                                                            // Check for global version mismatch (cross-user sync)
                                                            const localVersion = localStorage.getItem('AM_GLOBAL_CACHE_VERSION');

                                                            if (cacheVersion && localVersion && cacheVersion !== localVersion) {
                                                                console.log("Global cache version mismatch. Clearing local storage.");
                                                                invalidateAllCaches();
                                                            }

                                                            if (cacheVersion) {
                                                                localStorage.setItem('AM_GLOBAL_CACHE_VERSION', cacheVersion);
                                                            }

                                                            // 1. Process App Data (Boats, Extras, etc.)
                                                            if (appData) {
                                                                ALL_BOATS = appData.boats || [];
                                                                ALL_EXTRAS = appData.extras || [];
                                                                ALL_DAILY_TRIP_OPTIONS = appData.dailyTripOptions || [];
                                                                ALL_FOOD_OPTIONS = appData.foodOptions || [];
                                                                ALL_TARIFFS_PRICES = appData.tariffsPrices || [];

                                                                // Update local persistent cache
                                                                saveToLocalCache('boats', ALL_BOATS);
                                                                saveToLocalCache('extras', ALL_EXTRAS);
                                                                saveToLocalCache('trips', ALL_DAILY_TRIP_OPTIONS);
                                                                saveToLocalCache('food', ALL_FOOD_OPTIONS);
                                                                saveToLocalCache('tariffs', ALL_TARIFFS_PRICES);

                                                                lazyLoadFlags.boats = true;
                                                                lazyLoadFlags.extras = true;
                                                                lazyLoadFlags.trips = true;
                                                                lazyLoadFlags.food = true;
                                                                lazyLoadFlags.tariffs = true;

                                                                updateCacheTimestamp('tariffs');

                                                                populateBoatSelect();
                                                                populateExtras();
                                                                populateTripSelect();
                                                                populateFoodOptions();
                                                            }

                                                            // 2. Process Dashboard Data
                                                            if (dashboardData && !dashboardData.error) {
                                                                document.getElementById('db-active-reservations').textContent = dashboardData.activeReservations ?? '--';
                                                                document.getElementById('db-upcoming-checkins').textContent = dashboardData.upcomingCheckins ?? '--';
                                                                document.getElementById('db-pending-payments').textContent = dashboardData.pendingPayments ?? '--';
                                                                document.getElementById('db-available-boats').textContent = dashboardData.availableBoats ?? '-- / --';

                                                                const checkinsList = document.getElementById('db-today-checkins-list');
                                                                const checkoutsList = document.getElementById('db-today-checkouts-list');
                                                                if (checkinsList) checkinsList.innerHTML = '';
                                                                if (checkoutsList) checkoutsList.innerHTML = '';

                                                                if (dashboardData.todayCheckIns && dashboardData.todayCheckIns.length > 0) {
                                                                    dashboardData.todayCheckIns.forEach(item => {
                                                                        const li = document.createElement('li');

                                                                        li.innerHTML = `<span class="client-name" >$ {
                                            item.clientName
                                        }

                                        <span class="boat-name" >($ {
                                                item.boatNameAuto

                                            })</span></span> <span class="time-info" >$ {
                                            item.checkInTime
                                        }

                                        </span>`;
                                                                        checkinsList.appendChild(li);
                                                                    });
                                                                }

                                                                else if (checkinsList) {
                                                                    checkinsList.innerHTML = `<li class="text-gray-500" >$ {
                                    _t('dashboard.noCheckInsToday')
                                }

                                </li>`;
                                                                }

                                                                if (dashboardData.todayCheckOuts && dashboardData.todayCheckOuts.length > 0) {
                                                                    dashboardData.todayCheckOuts.forEach(item => {
                                                                        const li = document.createElement('li');

                                                                        li.innerHTML = `<span class="client-name" >$ {
                                            item.clientName
                                        }

                                        <span class="boat-name" >($ {
                                                item.boatNameAuto

                                            })</span></span> <span class="time-info" >$ {
                                            item.checkOutTime
                                        }

                                        </span>`;
                                                                        checkoutsList.appendChild(li);
                                                                    });
                                                                }

                                                                else if (checkoutsList) {
                                                                    checkoutsList.innerHTML = `<li class="text-gray-500" >$ {
                                    _t('dashboard.noCheckOutsToday')
                                }

                                </li>`;
                                                                }

                                                                // Mark dashboard as cached to prevent redundant fetch from showView
                                                                updateCacheTimestamp('dashboard');
                                                            }

                                                            isInitialLoadComplete = true;
                                                            showView('dashboard');
                                                            applyTranslations();
                                                        }

                                                        else {
                                                            showNotification(_t('notifications.error', {
                                                                message: 'Failed to load app data: ' + (response.error || 'Unknown error')
                                                            }), 'error');
                                                        }

                                                    }).withFailureHandler(error => {
                                                        showLoading(false);
                                                        console.error("DOMContentLoaded: getStartupData FAILURE", error);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `CRITICAL: Failed to load app data: $ {
                            error.message
                        }

                        `
                                                        }), 'error');
                                                    }).getStartupData();

                                                    setupSettingsTabs();
                                                    addPriceCalculationTriggers();
                                                    addQuickAddPriceTriggers();
                                                    initializeReservationDragDrop();

                                                    setupSettingsTabs();
                                                    addPriceCalculationTriggers();
                                                    addQuickAddPriceTriggers();
                                                    initializeReservationDragDrop(); // ← Move this INSIDE DOMContentLoaded

                                                    // Auto-calculate price when form fields change
                                                    const reservationForm = document.getElementById('newReservationForm');

                                                    if (reservationForm) {
                                                        reservationForm.addEventListener('change', () => {

                                                            // Trigger price calculation
                                                            setTimeout(() => {
                                                                wizard.collectAndCalculatePrice();
                                                            }

                                                                , 300);
                                                        });
                                                    }
                                                }); // ← Single closing brace for DOMContentLoaded

                                                // ==========================================
                                                // PDF GENERATION FUNCTION (already defined above, but included here for reference)
                                                // ==========================================
                                                // The generateAndDownloadPdf function and manualRefreshData function should remain here

                                                // --- REPLACE ALL FUNCTIONS IN YOUR MOORING SCRIPT SECTION ---

                                                function fetchMoorings(callback) {
                                                    console.log("fetchMoorings: Called.");

                                                    // Check cache first
                                                    if (isCacheValid('moorings') && ALL_MOORINGS.length > 0) {
                                                        console.log("fetchMoorings: Using cached data.");

                                                        if (!document.getElementById('manage-moorings-view').classList.contains('hidden')) {
                                                            renderMooringMap(ALL_MOORINGS);
                                                            renderMooringTable(ALL_MOORINGS);
                                                        }

                                                        if (typeof callback === 'function') callback();
                                                        return;
                                                    }

                                                    showLoading(true, "notifications.loading", {
                                                        item: _t('nav.moorings')
                                                    });

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response && response.success) {
                                                            ALL_MOORINGS = response.moorings || [];
                                                            updateCacheTimestamp('moorings'); // Update cache timestamp
                                                        }

                                                        else {
                                                            const errorMessage = response ? response.error : 'Invalid data or null response from server.';

                                                            showNotification(_t('notifications.error', {
                                                                message: `Error fetching moorings: $ {
                                errorMessage
                            }

                            `
                                                            }), 'error');
                                                            ALL_MOORINGS = [];
                                                        }

                                                        if (!document.getElementById('manage-moorings-view').classList.contains('hidden')) {
                                                            renderMooringMap(ALL_MOORINGS);
                                                            renderMooringTable(ALL_MOORINGS);
                                                        }

                                                        if (typeof callback === 'function') callback();

                                                    }).withFailureHandler(err => {
                                                        showLoading(false);

                                                        showNotification(_t('notifications.failed', {
                                                            message: `Failed to fetch moorings: $ {
                            err.message
                        }

                        `
                                                        }), 'error');
                                                        ALL_MOORINGS = [];
                                                        if (typeof callback === 'function') callback();
                                                    }).getMooringsData();
                                                }

                                                /**
                                                 * Renders the visual map of mooring spots based on the provided data.
                                                 * UPDATED: Displays the boat name instead of the client name.
                                                 * @param {Array<object>} moorings - The array of mooring data.
                                                 */
                                                function renderMooringMap(moorings) {
                                                    const container = document.getElementById('mooringMapContainer');
                                                    if (!container) return;

                                                    // Reset all rentable spots to their default "available" state
                                                    container.querySelectorAll('.mooring-spot.rentable').forEach(spot => {
                                                        spot.className = 'mooring-spot rentable status-available'; // Reset classes
                                                        const nameSpan = spot.querySelector('.client-name');
                                                        if (nameSpan) nameSpan.textContent = '';
                                                        // Set the default click action to open the form for a new mooring at that spot
                                                        spot.onclick = () => openMooringFormModal('add', null, spot.dataset.placeId);
                                                    });

                                                    // Populate the map with data for occupied spots
                                                    moorings.forEach(m => {
                                                        const spot = container.querySelector(`.mooring-spot.rentable[data-place-id="${m.place}"]`);

                                                        if (spot) {
                                                            const nameSpan = spot.querySelector('.client-name');

                                                            if (nameSpan) {
                                                                // *** CHANGE: Display boat name instead of client name ***
                                                                nameSpan.textContent = m.boatName || 'Unknown Boat';

                                                                // Add a tooltip to show both client and boat for clarity on hover
                                                                nameSpan.title = `Client: $ {
                                m.clientName
                            }

                            \nBoat: $ {
                                m.boatName
                            }

                            `;
                                                            }

                                                            // Determine the spot's color based on payment status
                                                            let statusClass = 'status-paid'; // Default to paid
                                                            if (m.paymentStatus === 'Due') statusClass = 'status-due';
                                                            if (m.paymentStatus === 'Overdue') statusClass = 'status-overdue';

                                                            spot.classList.remove('status-available');
                                                            spot.classList.add(statusClass);

                                                            // Set the click action to show details for the existing mooring
                                                            spot.onclick = () => showMooringDetails(m.mooringId);
                                                        }
                                                    });
                                                }


                                                function renderMooringTable(moorings) {
                                                    const tableBody = document.getElementById('mooringsTableBody');
                                                    if (!tableBody) return;

                                                    const searchTerm = document.getElementById('mooringSearch').value.toLowerCase();
                                                    const expiryFilter = document.getElementById('mooringExpiryFilter').value;

                                                    const filteredMoorings = moorings.filter(m => {
                                                        const searchMatch = !searchTerm || Object.values(m).some(val => String(val).toLowerCase().includes(searchTerm));
                                                        const expiryMatch = !expiryFilter || (m.nextPaymentDate && m.nextPaymentDate <= expiryFilter);
                                                        return searchMatch && expiryMatch;
                                                    });

                                                    tableBody.innerHTML = '';

                                                    if (filteredMoorings.length === 0) {
                                                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500" >No mooring records found.</td></tr>`;
                                                        return;
                                                    }

                                                    filteredMoorings.sort((a, b) => new Date(a.nextPaymentDate) - new Date(b.nextPaymentDate));

                                                    filteredMoorings.forEach(m => {
                                                        const row = tableBody.insertRow();

                                                        let statusClass = '';
                                                        if (m.paymentStatus === 'Due') statusClass = 'bg-yellow-100 text-yellow-800';
                                                        else if (m.paymentStatus === 'Overdue') statusClass = 'bg-red-100 text-red-800';
                                                        else if (m.paymentStatus === 'Paid') statusClass = 'bg-green-100 text-green-800';

                                                        row.innerHTML = ` <td class="px-4 py-3 text-sm" >$ {
                        m.clientName
                    }

                    <div class="text-xs text-gray-500" >$ {
                        m.clientPhone || ''
                    }

                    </div></td> <td class="px-4 py-3 text-sm" >$ {
                        m.boatName
                    }

                    <div class="text-xs text-gray-500" >$ {
                        m.boatLength ? m.boatLength + 'm' : ''
                    }

                    </div></td> <td class="px-4 py-3 text-sm font-mono" >$ {
                        m.place
                    }

                    </td> <td class="px-4 py-3 text-sm" ><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}" >$ {
                        m.paymentStatus
                    }

                    </span></td> <td class="px-4 py-3 text-sm" >$ {
                        m.nextPaymentDate || 'N/A'
                    }

                    </td> <td class="px-4 py-3 text-sm space-x-1" > <button onclick="showMooringDetails('${m.mooringId}')" class="text-indigo-600 hover:text-indigo-900 p-1" title="View Details" ><i data-lucide="eye" class="h-4 w-4" ></i></button> <button onclick="openMooringFormModal('edit', '${m.mooringId}')" class="text-yellow-600 hover:text-yellow-900 p-1" title="Edit" ><i data-lucide="edit-2" class="h-4 w-4" ></i></button> <button onclick="confirmDeleteMooring('${m.mooringId}', '${m.clientName}', '${m.place}')" class="text-red-600 hover:text-red-900 p-1" title="Delete" ><i data-lucide="trash-2" class="h-4 w-4" ></i></button> </td> `;
                                                    });
                                                    if (lucide) lucide.createIcons();
                                                }



                                                function showMooringDetails(mooringId) {
                                                    const mooring = ALL_MOORINGS.find(m => m.mooringId === mooringId);
                                                    if (!mooring) return;

                                                    const modalBody = document.getElementById('mooringDetailsBody');

                                                    document.getElementById('mooringDetailsTitle').textContent = `Mooring Details: $ {
                mooring.place
            }

            `;

                                                    let statusClass = '';
                                                    if (mooring.paymentStatus === 'Paid') statusClass = 'status-paid';
                                                    if (mooring.paymentStatus === 'Due') statusClass = 'status-due';
                                                    if (mooring.paymentStatus === 'Overdue') statusClass = 'status-overdue';

                                                    modalBody.innerHTML = ` <dl class="mooring-details-grid" > <dt>Client</dt><dd>$ {
                mooring.clientName
            }

            </dd> <dt>Contact</dt><dd>$ {
                mooring.clientPhone || 'N/A'
            }

            / $ {
                mooring.clientEmail || 'N/A'
            }

            </dd> <dt>Boat</dt><dd>$ {
                mooring.boatName
            }

            ($ {
                    mooring.boatLength || '?'
                }

                m)</dd> <dt>Payment Status</dt><dd class="${statusClass}" >$ {
                mooring.paymentStatus
            }

            </dd> <dt>Insurance Paid</dt><dd>$ {
                mooring.insurancePaid
            }

            </dd> <dt>Next Payment</dt><dd>$ {
                mooring.nextPaymentDate
            }

            </dd> <dt>Value</dt><dd>€$ {
                (parseFloat(mooring.value) || 0).toFixed(2)
            }

            </dd> <dt>Notes</dt><dd style="white-space: pre-wrap;" >$ {
                mooring.notes || 'None'
            }

            </dd> </dl> `;

                                                    document.getElementById('mooringDetailsEditBtn').onclick = () => {
                                                        closeModal('mooringDetailsModal'); openMooringFormModal('edit', mooring.mooringId);
                                                    }

                                                        ;

                                                    document.getElementById('mooringDetailsDeleteBtn').onclick = () => {
                                                        closeModal('mooringDetailsModal'); confirmDeleteMooring(mooring.mooringId, mooring.clientName, mooring.place);
                                                    }

                                                        ;

                                                    openModal('mooringDetailsModal');
                                                }

                                                function openMooringFormModal(mode, mooringId = null, placeId = null) {
                                                    const form = document.getElementById('mooringForm');
                                                    form.reset();
                                                    document.getElementById('mooringFormMode').value = mode;
                                                    document.getElementById('originalMooringId').value = mooringId || '';

                                                    if (mode === 'add') {
                                                        document.getElementById('mooringFormTitle').textContent = _t('moorings.form.titleAdd');
                                                        document.getElementById('mooringFormSubmitBtn').textContent = 'Save Mooring';
                                                        if (placeId) document.getElementById('mooringPlace').value = placeId;
                                                    }

                                                    else {
                                                        document.getElementById('mooringFormTitle').textContent = _t('moorings.form.titleEdit');
                                                        document.getElementById('mooringFormSubmitBtn').textContent = 'Update Mooring';
                                                        const mooring = ALL_MOORINGS.find(m => m.mooringId === mooringId);

                                                        if (mooring) {
                                                            form.elements.clientName.value = mooring.clientName || '';
                                                            form.elements.boatName.value = mooring.boatName || '';
                                                            form.elements.clientPhone.value = mooring.clientPhone || '';
                                                            form.elements.clientEmail.value = mooring.clientEmail || '';
                                                            form.elements.place.value = mooring.place || '';
                                                            form.elements.boatLength.value = mooring.boatLength || '';
                                                            form.elements.value.value = mooring.value || '';
                                                            form.elements.paymentStatus.value = mooring.paymentStatus || 'Paid';
                                                            form.elements.insurancePaid.value = mooring.insurancePaid || 'No';
                                                            form.elements.nextPaymentDate.value = mooring.nextPaymentDate || '';
                                                            form.elements.notes.value = mooring.notes || '';
                                                            form.elements.recordedBy.value = mooring.recordedBy || '';
                                                        }
                                                    }

                                                    openModal('mooringFormModal');
                                                }

                                                document.getElementById('mooringForm')?.addEventListener('submit', function (event) {
                                                    event.preventDefault();
                                                    handleSaveMooring();
                                                });

                                                // --- Add this new function to your client-side script ---

                                                function generateSingleStaySheet(reservationId) {
                                                    console.log('generateSingleStaySheet called with ID:', reservationId);
                                                    console.log('ALL_RESERVATIONS length:', ALL_RESERVATIONS.length);

                                                    // Ensure reservations are loaded
                                                    if (!ALL_RESERVATIONS || ALL_RESERVATIONS.length === 0) {
                                                        showNotification('Reservations not loaded yet. Please wait and try again.', 'error');

                                                        // Try to load reservations
                                                        fetchReservations(() => {
                                                            // Retry after loading
                                                            const reservation = ALL_RESERVATIONS.find(r => r.reservationId === reservationId);

                                                            if (reservation) {
                                                                generateAndDownloadPdf({
                                                                    reservationId: reservationId
                                                                }

                                                                    , 'singleStaySheet');
                                                            }

                                                            else {
                                                                showNotification('Reservation not found after reload.', 'error');
                                                            }
                                                        }

                                                            , 'For Stay Sheet');
                                                        return;
                                                    }

                                                    const reservation = ALL_RESERVATIONS.find(r => r.reservationId === reservationId);

                                                    if (!reservation) {
                                                        showNotification(`Reservation $ {
                    reservationId
                }

                not found in loaded data.`, 'error');
                                                        console.error('Available IDs:', ALL_RESERVATIONS.map(r => r.reservationId));
                                                        return;
                                                    }

                                                    // Generate the PDF
                                                    generateAndDownloadPdf({
                                                        reservationId: reservationId
                                                    }

                                                        , 'singleStaySheet');
                                                }

                                                function handleSaveMooring() {
                                                    const form = document.getElementById('mooringForm');
                                                    const formData = new FormData(form);
                                                    const mooringDetails = Object.fromEntries(formData.entries());
                                                    const mode = mooringDetails.mooringFormMode;
                                                    const mooringIdToUpdate = mooringDetails.originalMooringId;

                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification(`Mooring record $ {
                                mode==='add' ? 'saved' : 'updated'
                            }

                            !`, 'success');
                                                            invalidateCache('moorings'); // ✅ ADD THIS LINE
                                                            closeModal('mooringFormModal');
                                                            fetchMoorings();
                                                        }

                                                        else {
                                                            showNotification(`Error: $ {
                                response.message || 'Could not save mooring.'
                            }

                            `, 'error');
                                                        }

                                                    }).withFailureHandler(err => {
                                                        showLoading(false);

                                                        showNotification(`Failed to save mooring: $ {
                            err.message
                        }

                        `, 'error');
                                                    }).saveMooring(mooringDetails, mooringIdToUpdate);
                                                }

                                                function confirmDeleteMooring(mooringId, clientName, place) {
                                                    const mooring = ALL_MOORINGS.find(m => m.mooringId === mooringId);

                                                    if (!mooring) {
                                                        showNotification('Mooring record not found', 'error');
                                                        return;
                                                    }

                                                    const details = [];

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="user" class="h-4 w-4" ></i><strong>Client:</strong> <span class="ml-auto" >$ {
                    mooring.clientName
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="ship" class="h-4 w-4" ></i><strong>Boat:</strong> <span class="ml-auto" >$ {
                    mooring.boatName
                }

                ($ {
                        mooring.boatLength || '?'
                    })</span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="map-pin" class="h-4 w-4" ></i><strong>Place:</strong> <span class="ml-auto font-mono font-bold" >$ {
                    mooring.place
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="calendar-clock" class="h-4 w-4" ></i><strong>Next Payment:</strong> <span class="ml-auto" >$ {
                    mooring.nextPaymentDate || 'N/A'
                }

                </span></div>`);

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="euro" class="h-4 w-4" ></i><strong>Annual Value:</strong> <span class="ml-auto" >€$ {
                    (parseFloat(mooring.value) || 0).toFixed(2)
                }

                </span></div>`);

                                                    let statusBadge = '';
                                                    if (mooring.paymentStatus === 'Paid') statusBadge = '<span class="px-2 py-1 bg-green-100 text-green-800 rounded text-xs font-semibold">Paid</span>';
                                                    else if (mooring.paymentStatus === 'Due') statusBadge = '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded text-xs font-semibold">Due</span>';
                                                    else if (mooring.paymentStatus === 'Overdue') statusBadge = '<span class="px-2 py-1 bg-red-100 text-red-800 rounded text-xs font-semibold">Overdue</span>';

                                                    details.push(`<div class="flex items-center gap-2" ><i data-lucide="credit-card" class="h-4 w-4" ></i><strong>Status:</strong> <span class="ml-auto" >$ {
                    statusBadge
                }

                </span></div>`);

                                                    showCustomConfirm({

                                                        title: 'Delete Mooring Record?',
                                                        message: `Are you sure you want to delete the mooring record for <strong>$ {
                    clientName
                }

                </strong> at place <strong>$ {
                    place
                }

                </strong>?`,
                                                        details: details,
                                                        warning: 'This action cannot be undone. All mooring history for this spot will be permanently deleted.',
                                                        confirmText: 'Yes, Delete Mooring',
                                                        confirmColor: 'red',
                                                        icon: 'danger',
                                                        onConfirm: () => {
                                                            deleteMooringAction(mooringId);
                                                        }
                                                    });

                                                    setTimeout(() => {
                                                        if (lucide) lucide.createIcons();
                                                    }

                                                        , 100);
                                                }

                                                function deleteMooringAction(mooringId) {
                                                    showLoading(true, "notifications.processing");

                                                    google.script.run.withSuccessHandler(response => {
                                                        showLoading(false);

                                                        if (response.success) {
                                                            showNotification('Mooring record deleted successfully.', 'success');
                                                            invalidateCache('moorings'); // ✅ ADD THIS LINE
                                                            fetchMoorings();
                                                        }

                                                        else {
                                                            showNotification(`Error: $ {
                                response.message || 'Could not delete mooring.'
                            }

                            `, 'error');
                                                        }

                                                    }).withFailureHandler(err => {
                                                        showLoading(false);

                                                        showNotification(`Failed to delete mooring: $ {
                            err.message
                        }

                        `, 'error');
                                                    }).deleteMooring(mooringId);
                                                }

                                                function renameCompanyBoat(element) {
                                                    const nameSpan = element.querySelector('.client-name');
                                                    const currentName = nameSpan.textContent;
                                                    const newName = prompt("Enter the new name for this boat:", currentName);

                                                    if (newName && newName.trim() !== "") {
                                                        nameSpan.textContent = newName.trim().toUpperCase();
                                                    }
                                                }


                                                const pdfMenuButton = document.getElementById('pdf-menu-button');
                                                const pdfExportOptions = document.getElementById('pdf-export-options');

                                                pdfMenuButton?.addEventListener('click', () => {
                                                    pdfExportOptions.classList.toggle('hidden');
                                                });

                                                document.getElementById('generateMooringsMapPdfButton')?.addEventListener('click', (e) => {
                                                    e.preventDefault();

                                                    generateAndDownloadPdf({}

                                                        , 'mooringsMap');
                                                    pdfExportOptions.classList.add('hidden');
                                                });

                                                document.getElementById('generateMooringsTablePdfButton')?.addEventListener('click', (e) => {
                                                    e.preventDefault();

                                                    generateAndDownloadPdf({}

                                                        , 'mooringsTable');
                                                    pdfExportOptions.classList.add('hidden');
                                                });

                                                // Hide dropdown if clicked outside
                                                window.addEventListener('click', function (e) {
                                                    if (!pdfMenuButton?.contains(e.target) && !pdfExportOptions?.contains(e.target)) {
                                                        pdfExportOptions?.classList.add('hidden');
                                                    }
                                                });



                                                let lastRefreshTime = 0;

                                                function manualRefreshData() {
                                                    // Prevent refresh spam (rate limiting)
                                                    const now = Date.now();

                                                    if (now - lastRefreshTime < 3000) {
                                                        // 3 second cooldown
                                                        showNotification('Please wait a moment before refreshing again.', 'info', 2000);
                                                        return;
                                                    }

                                                    lastRefreshTime = now;

                                                    invalidateAllCaches();
                                                    showNotification('Cache cleared. Data will refresh on next view.', 'info', 2000);
                                                    // Refresh current view
                                                    const currentView = document.querySelector('.view-content:not(.hidden)');

                                                    if (currentView) {
                                                        const viewId = currentView.id.replace('-view', '');
                                                        showView(viewId);
                                                    }
                                                }

                                                // Refresh Lucide icons whenever view changes
                                                const originalShowView = showView;

                                                showView = function (...args) {
                                                    originalShowView.apply(this, args);

                                                    setTimeout(() => {
                                                        if (lucide) lucide.createIcons();
                                                    }

                                                        , 100);
                                                }

                                                    ;

                                                /**
                                                 * Renders notifications for overdue and due-soon mooring payments.
                                                 * @param {Array<object>} moorings - The array of all mooring data.
                                                 * @param {number} [dueSoonDays=15] - The number of days to consider "due soon".
                                                 */
                                                function renderMooringNotifications(moorings, dueSoonDays = 15) {
                                                    const notificationContainer = document.getElementById('mooring-notifications');
                                                    if (!notificationContainer) return;

                                                    notificationContainer.innerHTML = ''; // Clear previous notifications

                                                    const today = new Date();
                                                    today.setHours(0, 0, 0, 0); // Normalize to start of day

                                                    const notifications = [];

                                                    moorings.forEach(m => {
                                                        if (!m.nextPaymentDate || m.paymentStatus === 'Paid') {
                                                            return; // Skip if paid or no date
                                                        }

                                                        const nextPaymentDate = new Date(m.nextPaymentDate.replace(/-/g, '/'));
                                                        nextPaymentDate.setHours(0, 0, 0, 0);

                                                        const timeDiff = nextPaymentDate.getTime() - today.getTime();
                                                        const dayDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                                                        if (dayDiff < 0) {

                                                            // Overdue
                                                            notifications.push({
                                                                type: 'overdue',
                                                                days: Math.abs(dayDiff),
                                                                clientName: m.clientName,
                                                                boatName: m.boatName,
                                                                place: m.place,
                                                                date: m.nextPaymentDate
                                                            });
                                                        }

                                                        else if (dayDiff >= 0 && dayDiff <= dueSoonDays) {

                                                            // Due soon
                                                            notifications.push({
                                                                type: 'due',
                                                                days: dayDiff,
                                                                clientName: m.clientName,
                                                                boatName: m.boatName,
                                                                place: m.place,
                                                                date: m.nextPaymentDate
                                                            });
                                                        }
                                                    });

                                                    // Sort notifications: overdue first, then by how soon they are due
                                                    notifications.sort((a, b) => {
                                                        if (a.type === 'overdue' && b.type !== 'overdue') return -1;
                                                        if (a.type !== 'overdue' && b.type === 'overdue') return 1;
                                                        return a.days - b.days;
                                                    });

                                                    if (notifications.length === 0) {
                                                        notificationContainer.innerHTML = ` <div class="flex items-center p-4 text-sm text-green-800 rounded-lg bg-green-50 border border-green-200" role="alert" > <i data-lucide="check-circle-2" class="flex-shrink-0 inline w-5 h-5 mr-3" ></i> <div> <span class="font-medium" >All Clear !</span> No upcoming or overdue mooring payments within $ {
                dueSoonDays
            }

            days. </div> </div> `;
                                                    }

                                                    else {
                                                        notificationContainer.innerHTML = ` <h3 class="text-lg font-semibold text-gray-700 flex items-center" > <i data-lucide="bell-ring" class="h-5 w-5 mr-2 text-indigo-600" ></i> Payment Reminders </h3> ` + notifications.map(n => {
                                                            if (n.type === 'overdue') {
                                                                return ` <div class="flex items-start p-4 text-sm text-red-800 rounded-lg bg-red-50 border border-red-200" role="alert" > <i data-lucide="alert-triangle" class="flex-shrink-0 inline w-5 h-5 mr-3" ></i> <div> <span class="font-bold" >Overdue by $ {
                            n.days
                        }

                        day(s):</span> Payment for <strong>$ {
                            n.clientName
                        }

                        </strong> (Boat: $ {
                                n.boatName
                            }

                            , Place: $ {
                                n.place

                            }) was due on $ {
                            n.date
                        }

                        . </div> </div> `;
                                                            }

                                                            else {

                                                                // 'due' type
                                                                const dayText = n.days === 0 ? 'Today' : `in $ {
                            n.days
                        }

                        day(s)`;

                                                                return ` <div class="flex items-start p-4 text-sm text-yellow-800 rounded-lg bg-yellow-50 border border-yellow-200" role="alert" > <i data-lucide="clock" class="flex-shrink-0 inline w-5 h-5 mr-3" ></i> <div> <span class="font-bold" >Due $ {
                            dayText
                        }

                        :</span> Payment for <strong>$ {
                            n.clientName
                        }

                        </strong> (Boat: $ {
                                n.boatName
                            }

                            , Place: $ {
                                n.place

                            }) is due on $ {
                            n.date
                        }

                        . </div> </div> `;
                                                            }
                                                        }).join('');
                                                    }

                                                    if (lucide) lucide.createIcons();
                                                }

                                            </script>
</body>

</html>
